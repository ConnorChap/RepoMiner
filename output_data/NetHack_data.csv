id,title,author,created_at,closed_at,labels,body
2882365560,Fix typo in encyclopedia,alebahn,2025-10-02 16:38:06+00:00,2025-10-04 00:37:19+00:00,{},
2805946684,Make weaker artifacts less likely for better sacrifices,NDusN1,2025-09-07 10:19:20+00:00,,{},"It's weird that, with the current code, two sacrifice gifts meeting the same criteria has an equal chance of generating from a high-value sacrifice, which is noticeable from this short quote from #1429: 
> test your RNG with high-difficulty corpses that can still vend more early-game artifacts.

This PR makes it so that the chance of an artifact generating would be affected by its innate gift value versus max_giftvalue, the bigger the difference, the less the chance: a difference 10 or above would mean extremely unlikely.
"
2777003280,config.nh: fix example MENUCOLOR regex,Feyorsh,2025-08-27 02:46:01+00:00,2025-08-28 00:37:15+00:00,{},"The parsing of `MENUCOLOR`s uses POSIX extended regular expressions through C++'s `std::regex`, which will interpret parentheses as a capture group instead of literal parentheses. It's unclear to me whether the docs for this have always had this minor inconsistency or if it was correct before the change in regex engine (it doesn't matter either way I suppose)."
2705543607,Fix mace/Demonbane generation for angelic beings,Umbire,2025-07-29 23:38:40+00:00,2025-08-07 02:37:15+00:00,{},as part of addressing #1432
2606547051,Add gender preference (same or opposite) and check it in could_seduce(),greg-kennedy,2025-06-20 07:58:17+00:00,,{},"This PR adds two bits to monsters that track gender preferences - a 90% chance for ""opposite"" and a separate 10% for ""same"" - and these preference bits are checked in `could_seduce()` during a ""seduction attack"" against the defender's gender to determine whether the monster will seduce or not.

From the player's perspective, this simply means that 9/10 opposite gender foocubus will make a pass and 1/10 of the same will - same overall odds, just not 10/10 to 0/10.

**Gay incubus?**
Yes.  It makes any foocubus (or nymph) 81% hetero, 9% homo, 9% bi and 1% asexual.  Happy Pride!

**But I'm not into men?**
Grow up."
2551991829,remove redundant assignments on join(),argrath,2025-05-29 11:51:35+00:00,2025-10-04 00:37:19+00:00,{},The values assigned there are overwritten by later code.
2455407171,Fix a couple of incorrect names in the Terry Pratchett tributes,rbsec,2025-04-12 12:44:43+00:00,2025-04-12 22:37:15+00:00,{},"Fix a couple of incorrect character names (""Nobby"" and ""Vimes"") in the Discworld tribute quotes."
2438339130,Implement iflags.use_menu_glyphs for curses and tty.,NullCGT,2025-04-04 00:56:05+00:00,2025-04-27 00:37:28+00:00,{},"Implements iflags.use_menu_glyphs in both the curses and tty window ports. Results are identical to those of 3.4.3-based implementations of this feature. 

![Screenshot from 2025-04-03 19-54-48](https://github.com/user-attachments/assets/94379379-ba05-43cd-913e-9422a1005623)
"
2432485961,Silver maces,disperse,2025-04-01 19:55:39+00:00,2025-04-09 22:37:18+00:00,{},"Added the silver mace to be the base weapon type of Demonbane.  It is appropriate that an artifact weapon designed to slay Demons would be made of (or plated with) silver.  This helps to offset the damage reduction when Demonbane was changed from a longsword to a mace and makes it more specialized against silver-haters.

Set the probability to 2, equal to that of a silver spear. Increased the weight of the silver mace by 120% -- equal to the weight increase from a normal spear to a silver spear. (Assuming the weapon is silver plated rather than made entirely out of silver.)

Increased the base cost to 60, a similar increase as spear to silver spear, to be an even number between silver spear and silver saber.
 
Monsters will prefer silver maces over regular maces.

Otherwise, identical in function to a normal mace."
2427650315,Reset stat abuse / exercise counter on attribute change,greg-kennedy,2025-03-30 17:26:01+00:00,,{},"* When an attribute changes, reset its corresponding abuse / exercise counter to 0 (i.e. all attribute changes are ""whole number"" changes)
* Potion / spell of restore ability removes abuse only - exercise level unchanged.  (If negative, `AEXE(i)` is changed to 0 during stat restoration logic.)"
2426863996,Fix: buffer overflow in gamelog with an extremely long wish string,copperwater,2025-03-29 11:22:45+00:00,2025-03-29 17:37:18+00:00,{},"This was discovered when a game of xNetHack crashed with stack smashing detected during dumplog creation after an ascension. I traced the problem to a wish with a very long string the player had made much earlier in the game (""greased very blessed holy rustproof unlit historic thoroughly +5 very cloak of protection named it would be a shame if something happened to me wearing this cloak""), which is further recorded in an even longer form in the chronicle as 'wished for ""X"", got ""Y""'. That string does get truncated, but since the gamelog strings are dynamically allocated, they can be longer than BUFSZ.

When show_gamelog was subsequently called, it didn't use any bounds checking, which allowed its stack-allocated buffer to overflow. Changing the offending sprintf to snprintf and limiting it to the buffer size appears to fix this issue. It will truncate the string at BUFSZ-1 characters and therefore will be expressed in the dumplog as an incomplete string, but 1) that was happening anyway because the gamelog string already doesn't capture the entire ""wished for X, got Y"" message on such a wish, and 2) this should only ever happen for very long wishes."
2396564569,"Add ""Murphy"" to list of random ghost names",greg-kennedy,2025-03-17 02:53:43+00:00,2025-04-13 00:37:21+00:00,{},"This patch adds ""Murphy"" to the list of randomly generated ghost names, allowing lucky characters to occasionally encounter ""Murphy's ghost"" in the dungeon.

""Murphy's Ghost"" is a recurring fixture of the long-running ""Wizardry"" series of classic dungeon crawler video games.  In the first game (1981), he is an early ""boss"" of the first dungeon level, with a very weak attack but lots of HP and difficult to hit.  Since he granted a lot of XP when killed (and could be killed repeatedly by leaving and re-entering the dungeon), Murphy's Ghost was frequently farmed for levels by new characters making him an extremely memorable encounter.  His popularity with players was so great that he appeared in multiple other games in the series, and other games / media (esp. in Japan) had ""Murphy's Ghost"" references too.

In fact, this would not be the first Wizardry reference added to Nethack - the randomized scroll description ""MAPIRO MAHAMA DIROMAT"" is taken directly from an incantation in Wizardry I, which teleports the party back to the starting town."
2392087501,Fix: a number of unblock_points shouldn't unblock unconditionally,copperwater,2025-03-13 21:36:32+00:00,2025-03-14 18:37:16+00:00,{},"Initially diagnosed in an xnethack fuzzer crash - unblock_point shouldn't be called when a closed door becomes non-closed, because it's possible that there's a gas cloud on the space which means it still blocks vision. These always need to be recalc_block_point. A number of them were fixed, but when I went through all the xnethack ones, I found some that were unchanged from upstream NetHack. I reproduced the sanity check impossibles usually by breathing gas at a door as an iron golem and then opening or destroying the door to trigger the unblock_point call.

The use of recalc_block_point in wizterrainwish was not triggering this bug, but the previous code there basically duplicated recalc_block_point."
2386455146,"Add ""I have reached Mine's End"" epitaph",chappg,2025-03-11 22:40:06+00:00,2025-04-12 23:37:15+00:00,{},"Adding a (hopefully clever) epitaph as a hello-world commit.

Epitaphs.txt seems to be alphabetically sorted based upon batch commit. I added mine to the inside of the last alphabetically sorted list but it could go on the end (or perhaps the entire file could use an alphabetic sort)."
2370710154,"split ""swallowit"" on throwit() into a separate function",argrath,2025-03-04 12:42:37+00:00,2025-03-05 17:37:22+00:00,{},
2365902046,add a short README for test/,argrath,2025-03-01 06:08:14+00:00,2025-03-01 16:37:17+00:00,{},cf. #1369
2365489811,Fix: map random y-placement used its width instead of height ,copperwater,2025-02-28 22:38:25+00:00,2025-03-05 17:53:11+00:00,{},"Not sure how long this has existed without triggering any issues, but
when I was testing out a themed room wider than it was tall, I ran into
rn2-of-a-negative-number impossibles. Traced it to here, where it was
trying to subtract the width of the mapfrag from ROWNO to figure out
which y-value it should place the map on. The correct behavior is to
subtract the height of the mapfrag.

This pull request also contains a small unrelated lua.adoc update."
2364827427,fix Makefile.nmake when USE_DLB=N,argrath,2025-02-28 15:22:55+00:00,2025-02-28 22:37:39+00:00,{},
2352322833,Enable generating specific themed rooms for debugging,copperwater,2025-02-23 20:51:27+00:00,2025-04-12 04:37:28+00:00,{},"A common pain point I encounter when working on themed rooms is making specific rooms generate. The only ways to do this were mass commenting out the rooms not being tested, or hacking in different room frequency values (even more annoying when testing a fill, not a room, or testing pure-function rooms/fills that have no frequency).

This change solves that problem by allowing a wizard-mode user to define THEMERM or THEMERMFILL environment variables to make specific rooms or fills generate.

The first part of this change is converting all themed rooms and fills that were plain functions into tables, and converting their comment names into actual names in those tables. The names are not intended to be shown during gameplay, but instead serve as values that THEMERM or THEMERMFILL can be matched to to generate those rooms. It's no longer possible to have a function themeroom; this will raise an impossible. As far as I'm concerned, this is a good change because it allows some code simplification of themerooms_generate and makes it easier to add difficulty or eligibility parameters to rooms.

The second part of this change is adding a new nh.debug_themerm function to make the environment variable values accessible to themerms.lua. I looked for an existing way to do this but didn't see one (nh.variable is the closest but appears to be for variables that get saved).

The final part is inserting behavior into the actual themeroom generation code that changes how they generate when either a room or a fill is set. I don't think it's safe to generate every single room with the requested type or fill - that might lead to cases where the stairs or a magic portal cannot generate. So it creates ordinary rooms half of the time, which still results in plenty of themed rooms on levels.

Another thing to note is that any themed room using filler_region will still only pick a fill 30% of the time. If one specifies both a fill and a room that uses filler_region, many of those rooms will appear without a themed fill.

Here's an example of a level that generated with `THEMERM=""Circular, small""` and `THEMERMFILL=""Garden""`:

![screenshot-2025-02-23-14-08-48](https://github.com/user-attachments/assets/f64cd7d2-d343-4f05-a9cb-6e0824ec131e)"
2345654533,Fix: sitting on bidirectional teleportation traps,copperwater,2025-02-19 22:16:42+00:00,2025-03-05 17:53:32+00:00,{},"It is possible to create a bidirectional teleportation trap by making a pair of teleportation traps with a fixed destination of each other's coordinate. Moving or hurtling onto such a trap correctly materializes the hero on top of the other trap without triggering it, but for some reason I didn't dig into, sitting down to trigger the first trap does also trigger the second one at the destination end, causing you to counterintuitively teleport twice and end up back where you started.

Fix this by stopping tele_trap() from doing anything if it's called recursively, using a static variable like spoteffects() does for the same purpose. I had to adjust a bit of other tele_trap code to remove its sole early return."
2321304240,Fix: gremlin cry of pain could be heard while deaf,copperwater,2025-02-07 01:53:06+00:00,2025-02-10 09:37:49+00:00,{},"Main problem was there was no condition applied to this message, so anyone would hear it even if they were deaf. Even assuming a cry of pain is something that could be seen, the message was still printed when the hero couldn't see the gremlin.

This puts both a deafness check and a range check on that cry (if a gremlin somehow takes light damage on the other side of the map behind many walls, it doesn't make much sense to hear its cry), and provides an alternate message if the hero can't hear it, but can see it. The alternate message does rely on the hero being able to /see/, not just spot, the gremlin and the light it's shying away from -- if you can only sense it, there is no special message."
2321253558,Clean up hardcoded material constant in water vault themerm,copperwater,2025-02-07 01:16:00+00:00,2025-02-10 09:38:08+00:00,{},"This implements a TODO to return an object's material as text rather than as an int when a Lua file requests all the details about an object's objclass. That is as simple as looking it up in materialnm[].

With that done, it's possible to clean up the one use where a Lua file looks up the material of an object it generated, in the ""water-surrounded vault"" themed room, previously an inflexible 19 but which can now be compared directly to ""glass"". It also enables shortening the comments that follow since the branches of the if statement are now obvious."
2321191608,Livelog when a player breaks petless conduct,copperwater,2025-02-07 00:27:46+00:00,2025-03-05 17:53:40+00:00,{},"If a player initially goes petless then later obtains a pet, it's absent from the game chronicle. Fix that by adding a livelog for it.

This required a bit of restructuring in create_familiar() that I wanted to do anyway: removing the kludge of decrementing u.uconduct.pets when a figurine has been deployed but isn't actually going to come out tame. Calling initedog() /after/ deciding whether it's needed or not prevents a first-pet livelog being produced for a figurine that didn't come out tame.

The guardian angel code, which avoids calling initedog(), can never be the hero's first pet anyway because it only appears tame when the hero has already broken petless conduct. But while checking, I noticed a duplicate comment, so I removed that."
2321074086,Make pline_mon work if youmonst is passed to it,copperwater,2025-02-06 23:00:54+00:00,2025-03-05 17:53:54+00:00,{},"I was working on another patch involving a message that could be printed for either a monster or the player (using a struct monst * variable that either holds the monster or &gy.youmonst), but wasn't able to easily use pline_mon for the message since the mx and my of youmonst aren't kept updated as the hero moves. (In my testing, they were always 0, but it's not clear if they will remain 0 throughout the game, or if that's a bad assumption to make.)

Allow this in the future by checking for youmonst in pline_mon and setting the coordinates to 0,0 explicitly so no relative coordinate message gets printed when it's about the hero.

I'm not sure if it's a reasonable assumption that no messages that could ever be passed to pline_mon for a player would ever need to note ""(here)"" when accessiblemsg is turned on. If that's the case, the correct thing would be to set the coordinates to u.ux, u.uy instead of 0,0."
2321014808,Fix: ghoul and ettin zombie mis-ordered in monster list,copperwater,2025-02-06 22:15:48+00:00,2025-02-14 23:16:50+00:00,{},"An assumption of monster generating code is that monsters within a class appear in increasing order of difficulty. This wasn't the case in the Z class which went: human zombie (diff 5) -> ettin zombie (diff 7) -> ghoul (diff 5).

As a result, ghouls would not randomly generate when they should have at certain level difficulties (where a ghoul is weak enough to generate but an ettin zombie would be too strong).

Fix this by swapping the two monsters, which makes the difficulties in the Z class monotonically increase again."
2303553443,Remove useless call to `wakeup` in `bhitm` routine,mathewhodson,2025-01-29 02:36:39+00:00,2025-03-05 17:55:58+00:00,{},"`wakeup(mtmp, TRUE)` is called at the end since `wake` is set."
2279717330,add sanity check on parse_status_hl2(),argrath,2025-01-15 17:23:15+00:00,2025-03-05 17:37:22+00:00,{},"dt is initialized with -1, and it's not so obvious that it will be always overwritten later."
2278264389,"use blood for ""Vlad was here"" engravings",vultur-cadens,2025-01-15 04:30:37+00:00,,{},A hero in vampire form using a finger to engrave scrawls in blood; so should Vlad.
2276699767,use coordxy for the arguments of flood_fill_rm(),argrath,2025-01-14 13:07:38+00:00,2025-01-14 19:37:16+00:00,{},
2272985327,second argument of check_version() can take NULL,argrath,2025-01-13 05:02:32+00:00,2025-01-13 17:37:19+00:00,{},"There is a code path starting at restore.c line 830.

    (void) validate(nhfp, (char *) 0, FALSE);"
2272385401,change the type of xytod()'s return value to int,argrath,2025-01-12 05:38:20+00:00,2025-01-13 17:37:19+00:00,{},"xytod()'s return value is an index, so its type should be int, not coordxy."
2258597558,Remove dented pot encyclopedia matching on 'helmet',copperwater,2025-01-03 01:01:40+00:00,2025-01-06 16:12:58+00:00,{},"Dented pots got their own encyclopedia entry, so they shouldn't still match to ""helmet"". Even without this change, they match the ""dented pot"" entry correctly, but only by virtue of it appearing earlier in the encyclopedia.

Inverting the match to ""~dented pot"" isn't necessary since it isn't something that would otherwise match ""helmet"", so just remove it."
2258595067,Fix: quantum mechanics' tele attack had inverted negation check,copperwater,2025-01-03 00:56:25+00:00,2025-01-06 16:12:49+00:00,{},"Noticed when I summoned a quantum mechanic in wizard mode with a starting character who should have no armor protection against their teleport attack, but every touch resulted in ""You are not affected"". It turns out the if statement checking for armor protection is backwards, so you were never affected when you have no protection and were almost always affected when you had good protection.

This appears to date back to when the all-purpose 'negated' variable was removed and ""You are not affected"" moved to after the negation check; the new conditional kept the ! by mistake."
2257297941,Enable more ways to specify monster inventory in special levels,copperwater,2025-01-02 02:06:38+00:00,2025-01-03 00:39:14+00:00,{},"This originated with a bug in NerfHack in which the developer specified an inventory for a quest nemesis, but neglected to include the Bell of Opening in it. Since monsters' inventory contents from makemon() were tossed out completely, this caused a situation where the Bell was deleted and the game was unwinnable. The first part of this change is guarding against that by adding mdrop_special_objs before discarding the inventory. This does create a possibility where if the programmer *does* specify a nemesis get the Bell item in their inventory, while neglecting to remove its special case generation in makemon.c, it would generate twice - but two Bells is better than none.

Working on that fix led me to think about a limitation of the current sp_lev.c behavior. You could either have a monster generate with its species-typical inventory by not specifying an inventory for it, or you could have it generate with custom inventory but then have to use that to clumsily reproduce the normal inventory's complex chances and conditionals in mongets(). So the remainder of this commit implements another flag for des.monster(), keep_default_invent, that allows for more flexibility in two ways:

1. When des.monster() contains an inventory function and keep_default_invent is true, the monster will retain everything it gets from makemon() and the objects in the inventory function are in ADDITION to those. This is useful for augmenting a monster's default kit with something to make them more threatening, or just more loot.
2. When des.monster contains no inventory function and keep_default_invent is false, the monster will get NO inventory even if its species is normally supposed to. I'm not sure where exactly this would be used, but it doesn't hurt to have it available.

When keep_default_invent is not specified at all, the behavior remains the same as it is now - if inventory is provided, default items are discarded, and if not, they are kept. This doesn't add the flag to any monsters, so it's currently always unspecified.

Tested all six combinations of inventory (specified or not) and keep_default_invent (true, false, unspecified) with hobbits because they always get at least one item by default, so its absence when it should be suppressed was easy to verify."
2257135256,Fix: brides of Dracula not generating in their niches,copperwater,2025-01-01 16:58:27+00:00,2025-01-03 00:39:42+00:00,{},"When the des.monster() statements for the vampire ladies were changed to use the lua-table form, the coordinate argument was not given the coord= name in the table, so the lua loader was ignoring it and the vampire ladies were placed on random spaces on the level. Fix this by supplying the coord=; testing shows that they now appear back in the niches.

Also lowercase the monster species id ""Vampire Lady"" to ""vampire lady"". The uppercase didn't affect the species being generated but having the id be the same case as in monsters.h is consistent with how it's done everywhere else."
2257126233,Fix: ravens specified as hostile on Medusa's Island could be peaceful,copperwater,2025-01-01 16:31:46+00:00,2025-01-03 00:40:39+00:00,{},"Noticed when testing the recent bec de corbin change which makes ravens generate as peaceful; if you happened to enter medusa-3 while wielding one, all the ravens are peaceful. Even without one, if you entered the level as a neutral character, some of them would randomly be peaceful due to matching alignment. But in the medusa-3.lua file, the ravens are all unconditionally flagged as hostile.

The reason for this behavior is that the lua loading code does not recognize ""hostile"" (instead peaceful=0 needs to be set), so it does nothing and leaves the ravens to generate as if it had been unspecified. It appeared to affect only these ravens; no other des.monster() uses hostile=1 instead of peaceful=0.

This bug has been around in the 3.7 development branch since the change to Lua, but doesn't happen in 3.6 because the des parser does interpret ""hostile"" as meaning never peaceful.

I considered augmenting lspo_monster so that it could handle ""hostile"" and treat it like peaceful=0, but figure it's probably better not to have two different booleans that control the same flag (what if someone specified peaceful = 1 and hostile = 1?)"
2257119678,Fix some bigroom wall corners to how they display in-game,copperwater,2025-01-01 16:13:04+00:00,2025-01-03 00:41:44+00:00,{},"Noticed a few corners in some bigroom maps were | instead of -, which doesn't have any gameplay effect but was mildly annoying for what I was doing at the time (copying the maps out into documentation that is supposed to show what the maps look like in-game).

There are other special levels out there that still use | for corners; this doesn't address those, only the bigrooms."
2256433427,Revise dlb.6 man page (and a bit of recover.6),g-branden-robinson,2024-12-31 12:54:39+00:00,2025-01-07 20:37:18+00:00,{},"- doc/dlb.6: Use correct scaling unit for ems
- doc/{dlb,recover}.6: Disable dead dynamic code
- doc/dlb.6: Revise synopsis
- doc/dlb.6: Revise description"
2254227753,"Tidy up ""dlb"" man page (and a bit of ""recover""'s)",g-branden-robinson,2024-12-28 18:16:28+00:00,2024-12-31 12:50:16+00:00,{},
2213207624,Alphabetize bogusmon.txt,todb,2024-12-03 16:28:49+00:00,,{},"Case-insensitive sorting of all the bogus monsters.

As time goes on and this file reaches several million entries (since NetHack will never disappear), it'll be handy to have it alphabetized, namely to make adding duplicate entries less likely for future generations of hackers.

Note that this scheme handily puts proper noun monsters at the top of the list, thanks to the punctuation."
2208583893,Refresh worm segments when (un)taming,entrez,2024-11-30 22:33:25+00:00,2024-12-01 05:37:33+00:00,{},"Because newsym() would be called only on the head position of the worm,
if hilite_pet was on, the segments and head of a long worm would have
mismatched highlighting in the immediate aftermath of taming or
untaming.
"
2208457971,Various fixes and additions for cross compilation to WebAssembly,guillaumebrunerie,2024-11-30 17:36:00+00:00,2024-12-01 01:37:18+00:00,{},"Hello,

I have been working on a browser/mobile port of NetHack 3.7 using cross-compilation to WebAssembly (it is very playable already, you can try it at https://guillaumebrunerie.github.io/nethack/).

![Screenshot_20241130-183417](https://github.com/user-attachments/assets/7ccd8fe6-03c2-4c5d-9f5d-64094bda63e6)


The existing code for compiling to WebAssembly was a great help, although it wasn’t fully up to date and was missing a number of things in order to be able to create a proper window port (for instance there was no way to set `iflags.window_inited` to true, `print_glyph` was not working properly as its signature changed, and various other things).

This pull request contains various fixes and additions that I found were needed/helpful.

Changes:
- export more constants/pointers/globals,
- fix various types that are incorrect,
- disable compression of save files, as it uses fork which isn’t supported in WebAssembly,
- include `genl_player_setup` when `SHIM_GRAPHICS` is defined, in order to make it possible to reuse the existing player selection code,
- move initialization of JavaScript global constants up, as I was running in some issue when `raw_print` was being called before initialization,
- change various compilation options for Emscripten, in particular it now generates an ES6 module (easier to use in a modern Javascript project) and exports more methods from Emscripten (for instance to be able to use the virtual file system when saving).
- simplify the implementation of the main loop to avoid `setTimeout` which can be pretty slow in the browser when called many times,
- change the way pointer arguments are being sent to JavaScript in `getArg` (they were being sent as a pointer to the pointer itself on the stack, which doesn’t really make sense, now the pointer itself is sent)

Ping @apowers313 who first implemented cross compilation to WebAssembly (#385), and @Anhijkt who I see recently fixed an issue that I ran into as well (#1328)."
2196327051,change CHDIR definition conditions,Anhijkt,2024-11-23 17:28:23+00:00,2024-11-24 04:37:18+00:00,{},"Compiling to WASM target on non-Mac system will result in a binary that does not work correctly. Since filesystem in WASM environment is different, chdir to HACKDIR cannot be executed properly. "
2182430693,split eval_offering() into a separate function,argrath,2024-11-15 19:16:06+00:00,2024-11-15 23:37:16+00:00,{},
2175052815,unify to early return on offer_corpse(),argrath,2024-11-12 14:38:18+00:00,2024-11-14 00:37:17+00:00,{}," * remove redundant `else`
 * reduce indent"
2172407781,shrink scopes of some vars on offer_corpse(),argrath,2024-11-11 10:00:28+00:00,2024-11-11 20:37:19+00:00,{},
2171499694,"omit return value of offer_corpse(), as it is always ECMD_TIME",argrath,2024-11-10 15:33:37+00:00,2024-11-10 19:37:17+00:00,{},
2170765952,split offering a corpse into a separate function,argrath,2024-11-09 05:01:39+00:00,2024-11-10 00:37:17+00:00,{},
2170394094,Alloc: Remove in tree heaplogging and avoid adding align to mallocs,mkuoppal,2024-11-08 19:53:28+00:00,,{},"- Remove MONITOR_HEAP as there is adequate external tooling to cover similar functionality.
- Avoid aligning mallocs to give full control to memory access debug tooling"
2165847078,split offering negative valued items into a separate function,argrath,2024-11-06 18:34:46+00:00,2024-11-07 20:37:26+00:00,{},
2163160966,early return when `value` == 0 on dosacrifice(),argrath,2024-11-05 13:59:34+00:00,2024-11-05 21:37:18+00:00,{},"`calc_value()` returns a non-negative value, and there is no code that sets `value` to 0 after this point."
2161241690,early return on dosacrifice(),argrath,2024-11-04 16:00:55+00:00,2024-11-04 22:37:17+00:00,{},... to reduce indents and prepare further refactorings.
2159578115,"split ""got_target"" on use_leash() into a separate function",argrath,2024-11-03 10:04:04+00:00,2024-11-03 18:37:18+00:00,{},
2155654272,split calculating sacrifice value into a separate function,argrath,2024-10-31 07:10:59+00:00,2024-11-03 18:37:18+00:00,{},
2147830821,split a message of a rock disappearing into a separate function,argrath,2024-10-27 18:29:51+00:00,2024-11-03 18:37:18+00:00,{},... to prepare further refactoring
2144681861,util: match fopen_datafile function prototype,mkuoppal,2024-10-24 23:18:54+00:00,2024-10-30 03:37:17+00:00,{},The prototype for fopen_datafile() is different if it is used for util/dlb. Add the missing integer parameter and assert that it is only used for dataprefixes.
2142129866,Remove magic members from instance globals,mkuoppal,2024-10-23 21:09:32+00:00,2025-03-05 17:37:22+00:00,{},"We ought to trust compiler and we have other
tools to check oob access."
2123682609,"split ""assess_dmg"" on passiveum() into a separate function",argrath,2024-10-14 18:46:51+00:00,2024-10-24 17:37:19+00:00,{},
2117770770,"split ""dopush"" on moverock_core() into a separate function",argrath,2024-10-10 14:01:24+00:00,2024-10-24 17:37:19+00:00,{},
2104402637,Gluten free conduct,mlehotay,2024-10-02 22:38:08+00:00,2024-10-04 00:00:26+00:00,{},https://www.reddit.com/r/nethack/comments/1fsajaa/gluten_free_conduct/
2097170414,"split ""nopushmsg"" on moverock_core() into a separate function",argrath,2024-09-28 17:45:54+00:00,2024-09-29 17:37:24+00:00,{},
2085195888,"split ""finishi_splitting"" into a separate function",argrath,2024-09-22 13:32:39+00:00,2024-09-29 17:37:25+00:00,{},
2081398858,split making pits on do_earthquake() into a separate function,argrath,2024-09-19 16:06:29+00:00,2024-09-21 21:37:18+00:00,{},... and eliminate some gotos on it
2074567590,"split ""cannot_push"" on moverock_done() into a separate function",argrath,2024-09-16 17:46:58+00:00,2024-09-21 21:37:17+00:00,{},
2069472773,split moverock_core() into a separate function,argrath,2024-09-12 20:00:35+00:00,2024-09-14 18:37:23+00:00,{},... to force a call to moverock_done() at the end.
2063081102,Improve Guidebook *roff formatting and markup,g-branden-robinson,2024-09-10 11:32:42+00:00,2024-09-14 19:37:19+00:00,{},"Turning on _groff_ warnings can help document maintainers spot and correct bugs.  Get `Guidebook.mn` (and `tmac.nh`) into good shape for this purpose.
"
2048451311,Add swallow and explosion glyphs to glyph_to_cmap,ars3niy,2024-09-01 22:45:42+00:00,2024-09-14 18:37:22+00:00,{},"This makes custom S_sw_tc etc. from Enhanced1 symset actually work,
yielding nice smooth outlines for swallowers and explosions.

While looking at where else glyph_to_swallow was used, I noticed that
parse_id subtracted S_sw_tl from glyph_to_swallow, even though it
returns 0 to 7. This looks like it would cause out-of-bounds access and
perhaps a segfault when trying to customise glyphs for individual
monster swallow glyphs (or whatever it is parse_id is used for), but
I haven't tried to confirm nor change this because who would ever do
such thing?

Convert glyph_to_cmap from macro to function. 
Even if nethack is meant to support compilers that do not know about
inline functions, this one was frankly too long to be a macro already,
and I'm about to make it longer still.
"
2047876887,Typo Fixes,klorpa,2024-08-31 21:01:32+00:00,2024-09-14 17:37:18+00:00,{},Fixes some spelling and punctuation errors.
2046560485,Some fixes to make NetHack compile and run on MacOS Sequoia (15.0) using Xcode 16 (beta 3),RetepV,2024-08-30 14:29:36+00:00,2024-09-03 21:30:42+00:00,{},"For NetHack 3.7.0-106 Work-in-progress

Some fixes to make NetHack compile and run on MacOS Sequoia (15.0) using Xcode 16 (beta 3):

1) The project file was missing a few links to source files.
2) There were a few missing 'Copy' build phases.
3) 'makedefs' needed (ad-hoc) codesigning to be able to run, so added a build phase. Did the same for 'dlb' and 'recover', although I think they are not being used.
4) Lua needs to be downloaded through 'https:', not 'http:'.
5) Added defines ""-DCURSES_UNICODE"" and ""-D_XOPEN_SOURCE_EXTENDED"" to make NetHack properly compile with curses."
2036077788,"unify moverock() to ""early return"" style",argrath,2024-08-25 15:33:57+00:00,2024-09-04 11:37:16+00:00,{},... to prepare further refactorings.
2026328210,"YANI: Add option to start without inventory, skills and spells",ars3niy,2024-08-19 20:28:11+00:00,2024-08-30 04:06:48+00:00,{},"You know how it goes – you have been heralded from birth to be a hero who saves the world and your hour of destiny has come, but you haven't prepared very well. You come from a poor family and could not afford any training or equipment, so the only thing you bring with you into this dungeon is your potential. Empty-handed and with only your underwear on you, go bravely with your god!

The proposed option (tentatively called ""broke"" here) makes you not only start with no inventory (for which you could just drop everything on turn 1) but also with every skill at Unskilled and no spells. You do, however, start with knowledge of all the objects you would normally be guaranteed to know, which is actually mostly because of the healer: without healing potions at least discovered they would have too little reason to call themselves a healer at all. A rogue still knows what a sack is, a wizard knows all level 1 spellbooks.

You may think that this makes all roles too similar since starting inventory is a big part of what makes each role what they are. However, even with such start every role still has its defining features: archeologist is good with touchstones (admittedly they may never find one) and can become expert in pick-axe, barbarian is strong and gets Cleaver, caveperson can eat cats and is good with spears, and so on.

Best used in conjunction with !bones, lest you find early bones of your own role. I've played several roles like this and found it quite refreshing.

This patch as-is has a problem: starting with no inventory seems to interfere with rendering when using curses, so one has to do something on turn 1 then hit Ctrl+R on turn 2 and then play normally. But because at this point I do not know if the developers or any variant developers are interested in including this, I'll leave it as it is but can fix should the need arise."
2025085968,test - no substantive changes,edz314,2024-08-19 08:30:06+00:00,2024-08-19 08:30:41+00:00,{},"test setup, no substantive changes at all."
2014295917,"split ""moverock_done"" into a separate function",argrath,2024-08-12 06:26:25+00:00,2024-08-18 05:37:16+00:00,{},
1985878688,"split ""getcad"" into a separate function",argrath,2024-07-24 16:59:35+00:00,2024-08-18 05:37:16+00:00,{},
1979831826,"split ""poof"" in potion_dip() into a separate function",argrath,2024-07-21 07:56:26+00:00,2024-08-18 05:37:15+00:00,{},
1956039984,split returning from throwit() into separate function,argrath,2024-07-06 14:22:38+00:00,2024-07-14 07:37:16+00:00,{},
1933051656,win/curses: Check input range in menu selection fallthrough,mkuoppal,2024-06-21 20:01:09+00:00,2024-06-23 11:37:17+00:00,{},"curletter is screened to be in valid range in all
other switch/case branches except in the default case, which is fallthrough.

Add check for valid range in here also, otherwise
array might be addressed with invalid offset.

This should fix the following, found
with UBSAN and #debugfuzzer:

../win/curses/cursdial.c:1558:49: runtime error: index -154 out of bounds for type 'char [256]' 0x5f3857eff140 in menu_get_selections ../win/curses/cursdial.c:1558 0x5f3857ef78c8 in curses_display_nhmenu ../win/curses/cursdial.c:801 0x5f3857edd390 in curses_select_menu ../win/curses/cursmain.c:768"
1922693650,Merchant role,ratanvarghese,2024-06-16 09:28:33+00:00,2024-06-16 09:29:49+00:00,{},"Adds a new role, the Merchant."
1909303072,win/wintty: Limit how many digits count can hold,mkuoppal,2024-06-07 14:00:28+00:00,2024-06-10 01:37:17+00:00,{},"Debugfuzzer will end up pushing such amount of characters into the count gatherer that we eventually overflow long type.

Limit the count to what signed int could hold. This still allows 8 digits and that should be enough
for practical purposes.

This will prevent long overflow and spurious ubsan reports."
1899682564,hints/linux.370: Add support for ubsan (undefined behaviour sanitizer…,mkuoppal,2024-06-02 19:26:18+00:00,2024-06-09 18:46:25+00:00,{},"hints/linux.370: Add support for ubsan (undefined behaviour sanitizer for gcc

This will add an option to compile and link nethack executable with ubsan and catch undefined behaviour errors on runtime."
1858613657,Add missing hardware shop string,disperse,2024-05-07 16:00:35+00:00,2024-05-07 20:37:17+00:00,{},"I noticed, when testing shops in the overview menu, that hardware store was just listed as ""shop"".

The TOOLSHOP case was missed in the switch statement in the shop_string function."
1857043157,room_discovered was never called for shops,disperse,2024-05-06 21:51:45+00:00,2024-05-07 21:37:18+00:00,{},"This may not have been discovered because calling #overview while in a shop will register the shop as seen separately. This made the issue hard to test as the shops would sometimes show up in #overview and sometimes not.

I was going to make it so shops only show up if we enter them when not blind and deaf (or shopkeeper is mute) but it seems the player knows when they enter a shop regardless so I went with the easier fix.
"
1856369997,When making an invalid move (stepping diagonally out of doorway) still warned about traps in destination square,disperse,2024-05-06 15:03:08+00:00,2024-05-06 23:37:16+00:00,{},"Steps to reproduce the issue:
1. Place a trap diagonally from a doorway
2. Stand in the doorway
3. Move toward the trap

Expected results:
You can't move diagonally so nothing will happen.

Actual results:
You get the ""Really step onto that fire trap/hole/etc."" message
"
1853437829,YANI: Brides of Dracula,NullCGT,2024-05-03 13:22:26+00:00,2024-05-31 22:37:15+00:00,{},"In the original Bram Stoker novel, Dracula has three brides, colloquially referred to as the [Brides of Dracula](https://en.wikipedia.org/wiki/Brides_of_Dracula). I thought it would be a nice touch for NetHack to quietly reflect this by ensuring three of the vampires of his court are vampire ladies. While this technically increases the difficulty of Vlad's Tower, the vampires in Vlad's court are not necessary to fight, and the experience level of a hero at this point in the game is likely to cause them to spawn as vampire lords or ladies in any case.

No established names exist for these characters, so I have left them unnamed."
1844029228,Fix: zapping a wand of fire down while water walking on a pool,disperse,2024-04-27 17:48:51+00:00,2024-04-28 06:37:16+00:00,{},"This is my first PR for NetHack so feedback and constructive criticism is greatly appreciated!

Test case: You're wearing water walking boots and standing on a pool of water and zap a wand of fire down (hopefully with fire resistance).

Current behavior: The water evaporates and a pit is created but not revealed, if you look down it looks like a normal floor until you search or step off and back on the space.

Fix: I put trapeffect_pit into extern.h so it could be called from zap.c. This allows all the edge cases to be handled (zapping down while flying, falling in a pit while polymorphed into a pit fiend, etc.)."
1843986269,Fix: bill_dummy_obj billed excessively for stacks,entrez,2024-04-27 15:34:01+00:00,2024-04-28 10:37:16+00:00,{},"Add a way to request that unpaid_cost() produce the cost for a single
item, which is necessary for the price adjustment made in
bill_dummy_object.  Another option would be to simply divide by quan in
bill_dummy_object, but this might be more future-proof in case
unpaid_cost ever involves more than simple multiplication by quan
(e.g. the use of alternate units vs the base price, as are used for
globs).

Fixes #1236
"
1842083112,fix typos,RainRat,2024-04-26 04:05:03+00:00,2024-04-26 17:07:29+00:00,{},
1818924860,Un-defer shimmering dragons.,NullCGT,2024-04-11 23:10:56+00:00,,{},"A comment in the codebase indicates that shimmering dragons are deferred because monster displacement has not yet been implemented. Seeing as that is no longer the case I believe they should be added back in, particularly because shimmering dragon scale mail presents another interesting ascension kit item.

I added a bit of code to ensure that like displacer beasts, shimmering dragon and baby shimmering dragon corpses grant temporary displacement upon consumption. Corpses of full grown dragons grant a large number of turns of displacement in order to reward a player that deals with the additional challenge of one spawning in the castle, and also to present an interesting option for something to wish for before entering the planes."
1815514781,fix typos,RainRat,2024-04-10 07:47:07+00:00,2024-04-14 15:37:18+00:00,{},
1785375101,split monster escaping the dungeon into separate function,argrath,2024-03-21 20:46:30+00:00,2024-05-31 21:37:23+00:00,{},
1785160475,Fix typo in linux.370 hint file,nikolas,2024-03-21 18:46:11+00:00,2024-05-07 18:37:18+00:00,{},
1780660366,Update `history` to sync with the Guidebook,argrath,2024-03-19 19:35:17+00:00,2024-05-13 21:37:20+00:00,{},
1769385828,Make the curses windowport able to interpret glyph color adjustment,FredrIQ,2024-03-13 06:28:44+00:00,2024-03-24 00:37:17+00:00,{},"The ncurses library only has 256 color support, but the curses windowport is limited even beyond this, to 16 colors. This commit allows curses to do a limited interpretation of the glyph user color adjustment to the basic NetHack colors. Two examples:

This works:

    OPTIONS=glyph:G_pet_female_kitten:U+0066/red

This does not since it tries to invoke a 24bit color:

    OPTIONS=glyph:G_pet_female_kitten:U+0066/255-0-0

Something I was also contemplating, unrelated to implementation of this support in curses, would be the ability for the following:

* allow defining colors if other symbol handling modes are used (possibly limited to the standard 16 colors)
* allow defining attributes (for example: glyph:G_pet_female_kitten:U+0066/red/underline)
* allow specifying glyphs as wildcards for defining global color/attribute changes"
1766196003,followup fix for github issue #1157.,elunna,2024-03-11 17:12:51+00:00,2024-03-14 01:37:22+00:00,{},For some reason the cansee check wasn't working to see the monster zapping the wand. Changed it to canseemon and tested getting zapped and it auto-identifies now.
1751413534,Fix buffer overflow in crashreport_init,liferooter,2024-03-01 10:23:47+00:00,2024-03-05 04:37:17+00:00,{},
1748926451,fix typos,RainRat,2024-02-29 04:16:19+00:00,2024-02-29 17:37:50+00:00,{},
1737713691,Give Orion ammo that fits launcher,Umbire,2024-02-21 21:15:15+00:00,2024-05-13 21:37:21+00:00,{},Very simple change code-wise - if he's gonna use a yumi a hunter of his expertise should presumably have the projectiles match.
1733622841,"Refactor, unify, and nerf item destruction",elunna,2024-02-19 21:40:59+00:00,2024-02-21 15:18:19+00:00,{},"From xNetHack commit a0a6103bea:

Original author aosdict.

'The original goal: nerf item destruction using a method I initially proposed for
 SpliceHack, in which the number of items subject to damage from any single source is
 limited by the amount of damage the effect caused. The intent was to be more fair all
 around and prevent aggravating situations where, for instance, a chest shock trap zaps you
 for 4 damage and immediately ten of your rings and wands blow up.

 Problem 1: no easy way to limit the items destroyed without biasing heavily towards the
 start of the invent chain. The old code was able to get away without bias by just
 indiscriminately destroying everything eligible with a 1/3 chance. Here, I had to
 introduce reservoir sampling in a somewhat more complex form than I've applied it
 elsewhere, since there are a pool of potential items.

 Problem 2: destroy_item no longer worked remotely like destroy_mitem, which still
 destroyed 1/3 of items indiscriminately. Commence the process of squishing them into one
 function that handles both the player and monsters. (Which required making a lot of
 adjustments to destroy_one_item, now named maybe_destroy_item, on nits such as messaging
 and when to negate damage. An annoying consequence of the merge is that in the player
 case, their HP is deducted and they can be killed directly, but for monsters they need to
 add up the destruction damage and return it.)

 Unifying destroy_item and destroy_mitem has some advantages: in addition to the obvious
 code duplication removal, it ensures monsters now take the same damage as players for
 destruction (previously they took a piddly 1 damage per destroyed item). Now when you hit
 something with Mjollnir and their coveted wand of death breaks apart and explodes, you at
 least get the satisfaction of knowing they took the standard amount of damage from it.
 Monsters also now get symmetry with players in having extrinsic elemental resistance
 protect them from item destruction, and damage negation from item destruction if they were
 appropriately resistant.

 Problem 3: a lot of callers didn't preserve the ""amount of incoming damage"" that this
 refactor relies on. E.g. if the defender resisted that element, the local dmg variable
 would be set to 0. So I had to do some wrangling with callers to save that original damage
 value. The rule of thumb is: all *incoming* damage counts. So that includes the player's
 spellcasting bonus if applicable, but not things like half damage, negation due to
 resistance, or extra damage due to being vulnerable to cold/fire.

 Then I figured, while I'm here let's get rid of all those silly cases
 where destroy_items is called multiple times for various different
 object classes, and cut the object class parameter out of it. This has a
 few minor effects:
 - Places where different object classes previously rolled independently for destruction to happen at all now roll once. (Which, by my calculation, generally means less incidences of destruction - a fire attack now won't have three separate chances to hit your scrolls, potions, and spellbooks. On the flip side, a lucky roll will no longer save an entire object class in your inventory.)
 - Callers can no longer specify different probabilities for destroying different object classes. The only place this was really used was to call destroy_item with a slightly lower probability on SPBOOK_CLASS. With the nerf in this commit, less of them ought to be destroyed anyway.
 - A very edge case of where explosion-vs-monster damage was totted up differently for golems, which could result in differences of a hit point here or there.
 - All object classes being processed in one go means that less items are destroyed than would be if they were still processed independently. This is not really visible compared to the old baseline of just destroying 33% of everything, but would be a marked difference versus a copy of the game that still called destroy_items separately for different object classes. To compensate, I adjusted my planned damage-to-destruction-limit scaling factor down from 8 to 5.

 Not done: merging in ignite_items(), though that would probably be really easy now.'

Notes from porting from xNetHack:
- There are places where items are destroyed we could argue the player should take damage. For example, in a fire trap the player could have fire resistance, but still have items destroyed. These items usually deal some secondary damage from being destroyed, however, I left them aligned with the previous behavior to avoid confusion.
- It may also be necessary to reexamine all the conditional checks for calling destroy_items. Because item destruction is much more restrained and uses the actual damage from an effect, we could remove the 'if (!rn2(3))' and similar checks in all the places item destruction occurs. For this commit none of these checks were remove."
1680504704,"Rephrase ""rotten"" non-rottable items",bitofhope,2024-01-16 09:34:48+00:00,2024-01-22 20:37:18+00:00,{},"A little tweak to #1202 / c134a128acc59f40b2d6cfe9654d77aefae774e0

Also describe rotten plastic (eatable by fire elementals) as ""Awful"" instead of ""Rotten"" and do the same if other non-rottable materials become edible in the future."
1677282264,Guard against out of bounds access to level locations,mkuoppal,2024-01-12 21:20:32+00:00,2024-06-09 22:23:30+00:00,{},"Replace levl macro and direct access to the room locations with a loc(x, y) macro which will direct 
access into a static inline function with type and optionally, if DEBUG is enabled, boundary checking.

This will reveal out of bounds access to the gl.level.locations

I have found multiple callsites that do access rm[] with y >= 21  (ROWNO)  and seen also -1 as index.
Obviously future work could be to extend this kind of hardening to objects and mon array accesses.

I dont know if this kind of large patch causing churn is desirable in this stage of development. In that case this can be used as out of tree debugging aid if someone is interested of hunting the all callsites down. And to handle the varying callsites in 'Issues', one backtrace per issue.

debugfuzzer will usually find out of bound access within a minute or two with this applied.

Thoughts?
"
1672662199,dothrow: Check for LOW_PM before accessing mon array,mkuoppal,2024-01-10 15:31:05+00:00,2024-01-11 21:37:17+00:00,{},"on toss_up() when checking for touch_petrifies, add a check for corpsenm >= LOW_PM as EGG can be without corpse reference.

This prevents:
dothrow.c:1266:29: runtime error: index -1 out of bounds for type 'permonst [384]'

Full trace:
dothrow.c:1266:29: runtime error: index -1 out of bounds for type 'permonst [384]'
    #0 0x555556c87a17 in toss_up /home/miku/src/NetHack/src/dothrow.c:1266
    #1 0x555556c93fcf in throwit /home/miku/src/NetHack/src/dothrow.c:1533
    #2 0x555556c73c2e in throw_obj /home/miku/src/NetHack/src/dothrow.c:264
    #3 0x555556c7c7d2 in dofire /home/miku/src/NetHack/src/dothrow.c:571
    #4 0x555556ad353e in rhack /home/miku/src/NetHack/src/cmd.c:4999
    #5 0x5555569b2994 in moveloop_core /home/miku/src/NetHack/src/allmain.c:494
    #6 0x5555569b33c3 in moveloop /home/miku/src/NetHack/src/allmain.c:547
    #7 0x555557703c22 in main ../sys/unix/unixmain.c:310
    #8 0x7ffff74280cf in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #9 0x7ffff7428188 in __libc_start_main_impl ../csu/libc-start.c:360
    #10 0x5555568a07e4 in _start (/home/miku/src/NetHack/src/nethack+0x134c7e4) (BuildId: 2859e16e0bfb335e7769d0a0eb34c115734c0345)"
1672358229,early return when kicking a door on dokick(),argrath,2024-01-10 12:37:41+00:00,2024-01-26 18:22:40+00:00,{},
1670680938,split damage from acid potion into separate function,argrath,2024-01-09 13:54:33+00:00,2024-03-09 18:37:20+00:00,{},
1669765169,src/trap: Fix isclearpath out of bound access on levl array,mkuoppal,2024-01-08 23:23:37+00:00,2024-01-09 04:37:18+00:00,{},"Do isok check apriori to accessing the levl array to filter out dx/dy that have grown too large.

This fixes:
trap.c:3455:19: runtime error: index 80 out of bounds for type 'rm [80][21]'

trap.c:3455:19: runtime error: index 80 out of bounds for type 'rm [80][21]'
    #0 0x55555752ee50 in isclearpath /home/miku/src/NetHack/src/trap.c:3455
    #1 0x55555752df40 in find_random_launch_coord /home/miku/src/NetHack/src/trap.c:3383
    #2 0x55555752e333 in mkroll_launch /home/miku/src/NetHack/src/trap.c:3415
    #3 0x5555574fccec in maketrap /home/miku/src/NetHack/src/trap.c:508
    #4 0x555556f42f4b in mktrap /home/miku/src/NetHack/src/mklev.c:1848
    #5 0x55555740deee in create_trap /home/miku/src/NetHack/src/sp_lev.c:1820
    #6 0x5555574358b3 in lspo_trap /home/miku/src/NetHack/src/sp_lev.c:4369
    #7 0x55555779b212 in luaD_precall (/home/miku/src/NetHack/src/nethack+0x2247212) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)
    #8 0x5555577aa3b4 in luaV_execute (/home/miku/src/NetHack/src/nethack+0x22563b4) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)
    #9 0x55555779b52c in luaD_callnoyield (/home/miku/src/NetHack/src/nethack+0x224752c) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)
    #10 0x55555779a3e2 in luaD_rawrunprotected (/home/miku/src/NetHack/src/nethack+0x22463e2) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)
    #11 0x55555779b913 in luaD_pcall (/home/miku/src/NetHack/src/nethack+0x2247913) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)
    #12 0x555557797de4 in lua_pcallk (/home/miku/src/NetHack/src/nethack+0x2243de4) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)
    #13 0x5555570deb44 in nhl_pcall /home/miku/src/NetHack/src/nhlua.c:1900
    #14 0x5555570df2f8 in nhl_pcall_handle /home/miku/src/NetHack/src/nhlua.c:1924
    #15 0x5555570e014d in nhl_loadlua /home/miku/src/NetHack/src/nhlua.c:2037
    #16 0x5555570e0c77 in load_lua /home/miku/src/NetHack/src/nhlua.c:2158
    #17 0x55555745d696 in load_special /home/miku/src/NetHack/src/sp_lev.c:7046
    #18 0x555556f66dc1 in makemaz /home/miku/src/NetHack/src/mkmaze.c:1127
    #19 0x555556f37e0d in makelevel /home/miku/src/NetHack/src/mklev.c:1087
    #20 0x555556f3da30 in mklev /home/miku/src/NetHack/src/mklev.c:1384
    #21 0x555556bb85f2 in goto_level /home/miku/src/NetHack/src/do.c:1669
    #22 0x555556bbd26a in deferred_goto /home/miku/src/NetHack/src/do.c:2035
    #23 0x5555569b2a05 in moveloop_core /home/miku/src/NetHack/src/allmain.c:497
    #24 0x5555569b33c3 in moveloop /home/miku/src/NetHack/src/allmain.c:547
    #25 0x5555577032e9 in main ../sys/unix/unixmain.c:310
    #26 0x7ffff74280cf in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #27 0x7ffff7428188 in __libc_start_main_impl ../csu/libc-start.c:360
    #28 0x5555568a07e4 in _start (/home/miku/src/NetHack/src/nethack+0x134c7e4) (BuildId: 903e3f1003850a814e470c2e0f9b0752dcb0d06a)"
1667762830,Always have doors allocated,mkuoppal,2024-01-07 14:23:12+00:00,2024-01-08 00:37:18+00:00,{},"save assumes that there is gd.doors allocated. If there is level without any doors, gd.doors is NULL as no doors were added.

Fix this by always having gd.doors allocated when level is created.

Prevents: 
"
1660720204,Fix out of bound access in uhpinc and ueninc.,mkuoppal,2023-12-31 19:34:00+00:00,2023-12-31 20:49:07+00:00,{},"uhpinc and ueninc are indexed by u.ulevel. ulevel can reach MAXULEVEL (30), which means that the 0-29 range of uhpinc and ueninc arrays is not enough and out of bounds by one will result:

exper.c:245:25: runtime error: index 30 out of bounds for type 'xint16 [30]'
exper.c:263:25: runtime error: index 30 out of bounds for type 'xint16 [30]'

Fix this by increasing both arrays by one, which allows u.ulevel indexing (and leaving index 0 as unused)"
1652445759,Refactor give_u_to_m_resistances,entrez,2023-12-20 17:11:37+00:00,2024-05-31 21:37:21+00:00,{},"I think that using two arrays in tandem like give_u_to_m_resistances
originally did is frequently considered a bad idea, because one can
easily be added to or subtracted from without modifying the other --
that could obviously cause problems."
1652435932,Make pets unwilling to eat all polymorphing corpses,entrez,2023-12-20 17:03:39+00:00,2024-07-16 11:37:17+00:00,{},"Don't limit the hestitation to eat a corpse to shapeshifter corpses; apply it
to all corpses that will polymorph the creature eating them.  Fixes #1183.

- Rename polyfodder() to polyfood()
- Make pets unwilling to eat all polyfood() corpses
"
1650912381,Remove NODUMPENUMS config option,softdevca,2023-12-19 18:50:55+00:00,2024-02-27 18:16:41+00:00,{},"Remove NODUMPENUMS config option as the memory savings is trivial, especially as ENHANCED_SYMBOLS is set by default,
"
1650797742,Remove support for external options programs used by the Amiga,softdevca,2023-12-19 17:29:25+00:00,2024-02-27 18:16:41+00:00,{},"Remove support for external options programs used by the Amiga, gated by OPTION_LISTS_ONLY."
1646500121,add sanity check on choose_classes_menu(),argrath,2023-12-15 19:16:11+00:00,2024-01-12 05:37:18+00:00,{},"If class_list contains an illegal char for mon/obj class (even if it should not happen), it might cause out-of-bound access."
1646378771,Copyedit PYEC encyclopedia entry,entrez,2023-12-15 17:45:11+00:00,2024-01-23 05:37:18+00:00,{},"I initially went in here to change the description of ""unreadable"" text
on the card, since it has been possible to read it in-game since commit
870b124 in 2015.  Then I also ended up making some edits to stylistic
issues I noticed, primarily varying vocabulary to eliminate the
repetition/reuse of words in phrases like ""an /ancient/ artifact...
inscribed with /ancient/ runes"" and ""when /carried/, it grants the one
who /carries/ it ESP, and reduces all spell damage done to the
/carrier/"".  The result is a little bit tighter and I think reads
somehwat better.
"
1644663222,Saving a bones file should not free memory; the function really_done …,janne-hmp,2023-12-14 18:02:28+00:00,2024-01-23 05:37:17+00:00,{},"…will be using that information after the call to savebones, resulting in a heap-use-after-free error (and possibly later in a double-free in nh_terminate if things get that far)."
1642883786,Corpsenm fixes,mkuoppal,2023-12-13 17:51:41+00:00,2024-01-07 03:37:20+00:00,{},"This pull requests fixes handful of callsites where corpsenm was used
into the permanent monster array. As corpsenm for TINs and EGGs can be -1
 (reported by ubsan), we need to adjust with >= LOW_PM check as adviced
by the obj.h:

    /* note: sometimes eggs and tins have special corpsenm values that
       shouldn't be used as an index into mons[]                       */

Please consider all or cherrypicking one-by-one basis.
"
1642857111,Clean up trapeffect code a little bit,entrez,2023-12-13 17:30:26+00:00,2024-01-23 05:37:18+00:00,{},"Some minor cleanup of artifacts from the splitting up of trap effects
into the various trapeffect_foo functions: consolidate redundant
variables in trapeffect_pit (tt vs ttype), and simplify the definition
of 'inescapable' traps a couple functions (since the functions are now
specialized to a particular trap, it's unnecessary to check ttype
there in determining whether it's an inescapable Sokoban pit or hole).
"
1641867252,remove unnecessary null-check on gold_detect(),argrath,2023-12-13 06:55:10+00:00,2024-01-09 09:37:19+00:00,{},"`sobj` here is always non-null, otherwise it leads segv at earlier code."
1640285541,remove unused argument on display_trap_map(),argrath,2023-12-12 09:05:58+00:00,2023-12-12 19:37:21+00:00,{},
1638080923,remove unnecessary null-check on hmon_hitmon_poison(),argrath,2023-12-11 05:08:49+00:00,2023-12-11 20:37:18+00:00,{},"`obj` here is always non-null, otherwise it leads segv at earlier code."
1634428465,split 'nothing_special' of arti_invoke() into separate function,argrath,2023-12-07 12:53:08+00:00,2024-05-31 21:37:22+00:00,{},
1634363425,Avoid calling Curses after it is shut down,chasonr,2023-12-07 12:09:45+00:00,2023-12-07 19:37:18+00:00,{},"curses_wait_synch may call Curses functions after Curses is shut down. For the DOSVGA Curses, this causes a crash on exit. The crash is harmless, as the save file is already complete, but it is still worrying to the user. This patch adds a check for Curses being active."
1633733744,"Abbreviate Dungeons of Doom as ""Doom"", not ""Dlvl""",g-branden-robinson,2023-12-07 05:29:47+00:00,2024-09-10 11:19:30+00:00,{},"The significance of ""dungeon level"" is not well motivated to the novice player; it mostly affects internal game computations involving the difficulty of monsters and traps created.  (It's also a holdover from really old school D&D with simplistic dungeon topologies.)  This has a few weird consequences: the summary of the hero's location shifts from the somewhat abstract to the much more concrete as soon as any dungeon branch (or the endgame) is entered.  Another is that players tend to forget the name of the primary setting of the game; they're merely ""dungeon levels"", not ""the Dungeons of Doom"" (DOOM!), a part of the Mazes of Menace (an under-used moniker in game lore).  Changing the abbreviation from ""Dlvl"" to ""Doom"" reinforces the nature of DoD as a place, and increases the amount of flavor in the status display without losing information.  Finally, in some quests and the endgame, the application of the term ""dungeon level"" is arguably inappropriate (even if, again, the topology of these places is shockingly similar to that of the finite rectangles used for every other place).

* src/botl.c (describe_level):
* src/dungeon.c (query_annotation):
* win/tty/wintty.c (shrink_enc): Do it.

* win/curses/cursstat.c: Update code comments.

* doc/Guidebook.mn:
* doc/Guidebook.tex: Update Figures 1 and 2 accordingly.  Recharacterize this part of the status display as ""Location"" (a term already in use for this concept) instead of ""Dungeon Level"".  Recast the description of this datum in a non-spoilery way."
1632585468,Fix crashes and weirdness in VESA text mode,chasonr,2023-12-06 14:08:52+00:00,2023-12-07 19:37:18+00:00,{},"Set t_row[cx].bgcolour in vesa_redrawmap, so vesa_WriteTextRow has a valid index for vesa_palette.

Set t_row[cx].inverse in vesa_redrawmap, so vesa_WriteTextRow reverses the colors only when it should."
1631648419,remove unnecessary null-check on get_table_mapchr_opt(),argrath,2023-12-06 03:54:31+00:00,2023-12-10 20:37:19+00:00,{},"`name` here is always non-null, otherwise it leads segv at earlier code."
1630476333,sp_lvl: fortify selection_getbounds,mkuoppal,2023-12-05 14:14:09+00:00,2023-12-13 21:30:30+00:00,{},"All callsites for selection_getbounds use NhRect from stack. If selection is not set, remember to set all rect values (to zero) as the callsites do not check for selection before iterating thru NhRect.

This prevents random values from stack ending up being used in temporary NhRects."
1629116492,Fix memory leak in sp_lvl:lspo_region,mkuoppal,2023-12-04 21:19:03+00:00,2024-01-07 00:06:31+00:00,{},"We have cloned a selection, free it in order
to avoid memory leak."
1628985307,Ice and fumbling-related tweaks,entrez,2023-12-04 19:56:30+00:00,2023-12-05 00:37:20+00:00,{},"This came out of an IRC discussion about how ice uses fumbling internally, and it can cause some unexpected effects.

- Fix: fumbling vs losing footing in earthquake
- Refine ice fumbling effects vs mounted hero
- Check whether steed will slip on ice if mounted
"
1628286915,remove unnecessary null-check on bhitm(),argrath,2023-12-04 13:16:16+00:00,2023-12-04 20:37:19+00:00,{},"`otmp` here is always non-null, otherwise it leads segv at earlier code."
1625999036,"Add rumors related to sink, hand-washing changes",entrez,2023-12-01 16:31:44+00:00,2024-01-07 04:37:18+00:00,{},"These can hint at some of the changes that make it possible to dip
potions in sinks to potentially get a hint to their identity, and wash
your hands in sinks, pools, and fountains.  I also mentioned rings in
the potion/sink rumor since there didn't seem to be a rumor about the
sink ring ID mechanic already (though there may be one in coded language
that my grepping didn't catch).  The false rumor about hand-washing felt
to me like a good spot for a Macbeth reference.
"
1625914781,"Call hallu high priest ""grand poohbah"", not ""high""",entrez,2023-12-01 15:44:26+00:00,2023-12-09 04:37:21+00:00,{},"""Grand poohbah"" is a common term while ""high poohbah"" is not, and it
seems appropriate for hallucinogen-distorted high priests.  (It seems to
most commonly be spelled ""grand poobah"" but I left that alone; ""poohbah""
seems like a decent compromise between that and the spelling of the
character's name in the Mikado).
"
1624104822,remove unnecessary condition on save_mtraits(),argrath,2023-11-30 17:07:24+00:00,2023-11-30 21:37:18+00:00,{},"`mtmp->data` here is always non-null, otherwise it leads segv at earlier code."
1622807524,Fix: msg_window:combination and TTY getlin() ^P,entrez,2023-11-30 00:35:01+00:00,2023-12-10 20:37:19+00:00,{},"The ability to use ^P from within a getlin prompt didn't work with
msg_window:combination: it's a combination (unsurprisingly) of 'full'
and 'single', but getlin() was treating it like 'full': i.e.  expecting
everything to be displayed at once, doprev_message() to return only once
the user was finished reading.  I didn't even know ^P was supposed to be
accessible from a getlin prompt until Pat's recent commit 5120764,
because I have always used msg_window:combination -- I had come up with
a system where I'd name a potion thrown at me ""xx"", check the previous
messages with ^P, and then rename it from the discoveries list.  This
will be a lot easier!
"
1622135658,Don't grant tame djinni from lamps/potions if player is petless.,elunna,2023-11-29 15:59:54+00:00,2023-12-01 07:06:12+00:00,{},"From xNetHack git commit 9ee7a0e:

'This is similar to the Astral angel not appearing if the player is petless. Strictly speaking, players attempting to play petless could control this simply by not rubbing any lamps or quaffing any smoky potions, but that has a rather large impact on the game just for maintaining a conduct.

It doesn't change the overall probability of a hostile or wish-granting djinni; a petless player will simply get the neutral ""You freed me!"" djinni twice as often.

This could technically deny a djinn pet from players who actually wanted one, but since such players would have to have the pet option turned off and acquire no other pets along the way to making the djinn come out, it's probably an extreme edge case.'"
1611911464,Rework erinyes into avenging Furies,entrez,2023-11-21 23:58:36+00:00,2024-01-11 11:37:20+00:00,{'++EDITLEVEL when merging': 1},"Based on conversations on IRC with paxed, bhaak, K2, and Umbire.  This is an idea based on the role of the erinyes in Greek myth: punishers of oathbreakers, hosts who harm their guests, murderers, and others who have violated important ancient social mores or customs.  This is reflected in NetHack by the erinyes becoming more dangerous as you abuse your alignment -- something like killing a peaceful monster does seem consistent to me with things that bring down the Furies in mythology.  The alignment abuse metric that determines the difficulty of the erinyes is tracked separately from alignment record, and only counts negative adjustments to alignment: 'adjalign(-5); adjalign(10); adjalign(-5);' would leave you with an alignment record of 0, but alignment abuse value of 10.

If extinction allows, one or more erinyes are also (edit: potentially, based on a roll against abuse value) summoned when you don a helm of opposite alignment (since you're breaking your oath to your god, so it especially incites them).  The helm of opposite alignment also causes brief confusion, and #offering is made impossible while confused, in order to make this a potential challenge on Astral rather than something which can easily be blown past by #offering the amulet on the next turn.

This could use more testing and conversation about possible changes or extensions (or alternatives), but I think it's at a point now where I am comfortable submitting the patch in its current state and starting some discussion around it.
"
1609834273,Fix: latent bug with finish_meating on catchup,entrez,2023-11-20 21:11:41+00:00,2023-12-01 06:37:17+00:00,{},"Some players of 3.6 recently noticed that sometimes, mimics in shops
seemed to have moved around even before the player had entered the shop
or done anything to uncloak them.  I found that this was because
finish_meating was being called for all non-eating monsters when
restoring a level (monsters that weren't eating anything would have
meating == 0 so always pass the 'imv > meating' check).  This would
uncloak mimics -- but not all the time, because the 'mappearance != 0'
test meant mimics disguised as strange objects weren't uncloaked.  I
think that was meant to be an additional check to confirm the monster
really did have a disguise, but in reality it meant that M_AP_OBJECT
""strange object"", M_AP_MONSTER ""giant ant"", etc disguises wouldn't be
removed by finish_meating.

As it turns out, this was mostly fixed by coincidence in 221e4a7, which
fixed the ""exclude actual mimics"" check in finish_meating.  So at this
point in 3.7 it's largely a latent bug, but it still had the potential
to improperly uncloak non-mimics who can disguise themselves (like the
Wizard of Yendor, maybe?), and could cause other problems if
finish_meating were updated to have additional effects, or if some
monster types were made to disguise themselves as a strange object when
eating a mimic.
"
1609322522,delete ancient commented out codes on wall_angle(),argrath,2023-11-20 15:21:51+00:00,2024-01-07 04:37:17+00:00,{},"These codes have been commented out since 3.4.3, at least."
1607655205,Add WANT_SOURCE_INSTALL to linux.370 hints file,entrez,2023-11-18 17:53:31+00:00,2023-12-31 05:37:18+00:00,{},"WANT_SOURCE_INSTALL=1 can be specified when compiling to build NetHack
within the repo/source tree, rather than in the normal system install
location.  I find it useful for development on OSX, but it wasn't
present in any other hints files, so I've been using a custom hints file
on Linux for a while that adds the same option.  The code is based on
the macOS.370 hints file.
"
1607634426,avoid potential out-of-bounds access on choose_classes_menu(),argrath,2023-11-18 16:38:37+00:00,2023-11-23 15:37:18+00:00,{},"If `category` is neither 0 nor 1, `buf` is not initialized."
1605645930,Ignore loot/multidrop 'A' if no filter specified,entrez,2023-11-17 04:10:39+00:00,2023-12-31 04:37:17+00:00,{},"The 'A' option in the #loot or 'D'rop menu selecting every selectable
item when used on its own has been the cause of many bag of holding
explosions and other typo-related frustration.  Now that it operates on
other filters rather than overriding them, actually require some other
filter be selected for it to have any effect.  This means that 'A' on
its own will do nothing, but 'A'+'a' will still act like 'A' alone
previously did.  I think this will reduce the rate of serious typo
accidents in games, without being intrusive and while still maintaining
'A' as a useful option (which I think it is, in it's 3.7 incarnation --
I use it all the time in combination with other filters, especially
justpicked).
"
1605326175,Print current level annotation when restoring,entrez,2023-11-16 22:08:49+00:00,2023-11-17 11:37:18+00:00,{},"Sometimes I annotate a level with a note like ""watch out, chameleon
below"", which is useful to remind myself of some danger or thing to
remember when returning to the level -- but if saving and restoring on
the level itself there's no reminder of that annotation.  If you restore
on a level with an annotation, print it as part of the ""welcome back""
message.
"
1604790802,Rust gauntlets when washing hands even if Glib and fix #dipping hands from menu,entrez,2023-11-16 16:43:30+00:00,2023-12-01 07:37:18+00:00,{},"Make it so that washing your gloved hands in a fountain, pool, or sink
can still rust your gauntlets even if it successfully removes the grease
from your fingers.  There wasn't much logic behind the two effects being
mutually exclusive, since the oily fingers of the Glib effect don't
normally protect against water damage like the item being 'greased'
does, and this introduces a possible tradeoff that could make whether or
not to clear Glib by washing your hands a more interesting tactical
decision.

Also make #dipping hands (and other possible future 'hands'-accepting
actions) work with OPTIONS=force_invmenu or selecting '?'/'*' from the
getobj prompt.
"
1604724119,"Add option to exclude dropped items from autopick, and to autopick stolen items",entrez,2023-11-16 16:09:44+00:00,2023-12-09 04:37:21+00:00,{},"This is based on a feature in UnNetHack (and I think some other variants
as well).  If the hero intentionally drops an item with 'pickup_dropped'
disabled, don't autopick it back up when walking over that square again.

Typically when the player drops an item, it's because she doesn't want
it in her inventory any more, and this option stops autopickup from
defeating that goal (especially useful for tasks like stash management
without a container).  Players have come up with workarounds to this
problem like toggling autopickup when approaching their stash pile or
adding name-based autopickup exceptions to allow them to exclude
individual items from autopickup, but this behavior should reduce the
need for those things.

I think 'pickup_dropped' is a little unfortunate because it suggests
equivalence to 'pickup_thrown' (i.e. any dropped items will be
automatically picked up regardless of autopickup exceptions).  Calling
it something like 'nopick_dropped' might be better, but as far as I can
tell options cannot start with the word 'no' because it's interpreted as
a negation of the rest of the option name.
"
1603866532,split 'postmov' of m_move() into separate function,argrath,2023-11-16 07:47:53+00:00,2023-12-01 16:37:19+00:00,{},
1603422833,Reword feedback for repeated confuse monster use,entrez,2023-11-15 23:34:38+00:00,2023-11-30 00:37:19+00:00,{},"I didn't like ""your hands begin to glow red even more"" very much (the
hero's hands aren't really 'beginning' to glow if they already have an
active confuse monster effect, and ""glow red even more"" was an awkward
turn of phrase on top of that).  Rephrase it to ""The red glow of your
hands intensifies.""
"
1603114986,Some more changes related to magical digging->furniture destruction,entrez,2023-11-15 19:31:55+00:00,2023-11-30 00:37:19+00:00,{},"The long-awaited sequel to #1057.

- Remove unneeded furniture vs earthquake hack
- Improve digging vs furniture messaging
- Make destruction of altar incite its god's wrath
- Streamline digactualhole messaging
- Blame hero for broken digging wand shop damage"
1602102459,remove unnecessary condition on use_offensive(),argrath,2023-11-15 08:25:00+00:00,2023-11-29 23:37:18+00:00,{},"`otmp` here is always non-null, otherwise it leads segv at earlier code."
1599812967,Tweak encumbrance messages,AndrioCelos,2023-11-14 00:28:37+00:00,2023-11-21 01:37:18+00:00,{},"This branch proposes a minor change to the messages related to encumbrance in `lift_object` and `pickup_object`:

- In the `pickup_burden` prompt, keep the message _'You have a little trouble lifting...'_ for becoming burdened, but change it to _'You have trouble lifting...'_ for becoming stressed. This better informs the player how badly encumbered you are when it's set to `unencumbered`, since those two encumberance levels are the only ones that shared a message. Furthermore, the speed reduction and other effects of being stressed are more than what I could call 'a little trouble'.
- Use the prefix _'You have trouble lifting/removing...'_ etc. for picking up each object at any encumbrance level. I'm not sure why this was used only when burdened but not worse, and would consider either showing this at any encumbrance level or never. I chose to show it because it informs the player which objects crossed encumbrance thresholds without using `pickup_burden`."
1599070178,early return on do_play_instrument(),argrath,2023-11-13 15:22:10+00:00,2023-11-30 23:37:20+00:00,{},
1597509877,remove unnecessary condition on optfn_pickup_types(),argrath,2023-11-11 19:33:08+00:00,2023-11-15 00:37:18+00:00,{},"`opts` here is always non-null, otherwise it leads segv at earlier code."
1597390543,split wand explosion into separate function,argrath,2023-11-11 13:29:39+00:00,2023-11-13 19:37:18+00:00,{},
1595839689,split discarding broken wand into separate function,argrath,2023-11-10 09:13:25+00:00,2023-11-10 18:37:19+00:00,{},
1595592347,Better align drop_throw with hero ammo breakage,entrez,2023-11-10 05:35:01+00:00,2023-11-11 13:37:17+00:00,{},"There is a comment above the function indicating that it should be
aligned with hero ammo breakage, but this wasn't the case.  One big
difference is that any monster-thrown or -shot object would be deleted
unconditionally if it hit another monster trapped in a pit.  I don't
know why that was in there, but it's not present in hero ammo breakage
chances, and it meant that a monster could sling the Mines luckstone at
the hero, hit a monster in the pit, and permanently lock the hero out of
getting the luckstone (as just happened to a player during the current
tournament).  This pulls the hero breakage rules out into their own
function and uses that for monster breakage as well, to make sure they
are aligned.  I also refactored drop_throw a bit to reduce the number of
separate variables tracking whether the object was deleted (was create,
objgone, and retvalu), and changed its (and ohitmon's) type to boolean.
"
1594400913,remove unnecessary condition on parseoptions(),argrath,2023-11-09 13:17:40+00:00,2023-11-10 18:37:19+00:00,{},"`opts` here is always non-null, otherwise it leads segv at earlier code."
1592818598,Null-check argument `bl` before using it,argrath,2023-11-08 15:11:52+00:00,2023-11-08 19:37:19+00:00,{},
1591689759,Limit bugle notes to the actual bugle scale,entrez,2023-11-08 02:02:32+00:00,,{},"Bugles have a much more limited range than other instruments due to
the way they are constructed and played.  Make bugles in NetHack reflect
this.

I think it is very likely that tooled horns would behave the same way,
but I let them be for now because it's not entirely clear what a ""tooled
horn"" is meant to be.  Giving both tonal scaring instruments limited
ability to open the Castle might be interesting, though, since it would
give players a reason to actually hang on to wooden flutes and harps.

This also has a additional effect of explicitly rejecting characters
entered by the player that aren't associated with the musical scale.
Previously it would pass those to Hero_playnotes along with the real
notes.
"
1591646936,Require some body weight for steps on the ground to wake zombies,entrez,2023-11-08 01:05:21+00:00,2023-11-10 22:37:18+00:00,{},"I'm not sure if the first commit here is necessary (""Make WT_foo defines
unsigned""), as I explain in the commit message.  The real point here is the
second commit, so it's a very small PR."
1590042130,streamline dosacrifice(): early return when offering other than corpse,argrath,2023-11-07 07:43:39+00:00,2023-11-10 10:37:19+00:00,{},
1589540108,Some mention_decor-related fixes,entrez,2023-11-06 22:22:32+00:00,2023-11-08 04:37:20+00:00,{},"- Revert part of ""Fix: hurtling into wall of water""
- pooleffects messaging vs mention_decor
- Fix: mention_decor preposition vs unusual terrain
"
1589388045,Improve maintainability of Guidebook.mn,g-branden-robinson,2023-11-06 20:30:06+00:00,2023-11-07 01:37:23+00:00,{},
1587715908,Remove unused assignments,argrath,2023-11-06 02:16:29+00:00,2023-11-08 04:37:20+00:00,{},
1586937786,Split sacrificing same race into separete function,argrath,2023-11-04 06:01:32+00:00,2023-11-06 03:37:19+00:00,{},
1586555021,Follow up on disturbing buried zombies,entrez,2023-11-03 18:28:06+00:00,2023-11-06 10:37:18+00:00,{},"Change 852f8e4 by requiring a minimum impact before a buried zombie
nearby will be disturbed: light, but still excluding things like
scrolls, if it's a violent impact (dropped while levitating, thrown, or
kicked), and fairly heavy if the hero is just placing the item on the
ground normally.

Moving the call out of flooreffects meant it no longer applied to
pushing boulders around, so have moverock disturb nearby zombies.  I
additionally had wake_nearby do the same thing.

Finally, I renamed check_buried_zombies (which doesn't really reflect
what it does) to disturb_buried_zombies.
"
1584835278,clean up Guidebook.mn,g-branden-robinson,2023-11-02 18:19:37+00:00,2023-11-03 01:37:19+00:00,{},Simplify.  No change in generated _Guidebook.txt_ or _Guidebook.ps_ documents per my build test.
1584454661,Fix: hurtling into wall of water,entrez,2023-11-02 14:34:10+00:00,2023-11-03 23:27:10+00:00,{},"A hero hurtled into a wall of water while levitating, flying, or wearing
water-walking boots wouldn't be stopped by it unless it was on the Plane
of Water.  Make it stop hurtling heroes immediately no matter the
location.

I also noticed that once I was hurtled safely into the wall of water, it
was described as a ""pool"" when I examined it with ':'.  Fix that, too,
even though I think it shouldn't really be encountered in-game.
"
1580087575,Make mstate flag checks more mutually consistent,entrez,2023-10-31 01:48:09+00:00,2023-11-08 23:37:18+00:00,{},"Various places checking for whether a monster was on the map based on
mstate flags were inconsistent about which ones they checked (and then
place_monster() was additionally inconsistent with all of them about
which bits were cleared when placing a monster onto the map).  I think
some places were also more convoluted than is now necessary because they
date back to mstate being an alias for mspare1, which it shared with
migflags before those became two separate dedicated fields (MSTATE_MASK
also dates back to this and is no longer used, so I removed it).

I tried to go through all the MON_foo mstate bits, understand when/why
they are set, and make the various functions I noticed more consistent
(with each other, and with my understanding of how the bits work) about
how they are treated.  I don't know for a fact that I understood
everything right -- some diagnostic bits that aren't used for much of
anything, like MON_OBLITERATE, had me mystified until I read the 5ee78c5
commit message -- but this patch hasn't caused any new problems (sanity
check or otherwise) with the fuzzer in my testing so far.  All the same,
it could probably use review by someone who has a good sense of what the
mstate bits mean.
"
1577221946,Slightly refactor level_tele level selection,entrez,2023-10-27 21:27:01+00:00,2023-11-06 03:37:19+00:00,{},"This reorganization of the if/else chain for level selection is somewhat
cleaner and doesn't involve repeating the code for a Confusion ""oops""
result.
"
1576990980,doc: add note that USE_XPM can be defined otherwise,bernhardreiter,2023-10-27 17:53:24+00:00,2023-11-03 14:37:18+00:00,{}, * Add an additional hint to win/X11/NetHack.ad that `USE_XPM` can be defined outsite of `config.h` as it is the case with `hints/linux-x11`-
1576982626,Doc: fix xpm scaling example in config.h,bernhardreiter,2023-10-27 17:46:40+00:00,2023-11-03 14:37:18+00:00,{}," * Add conversion back to xpm in the example command, otherwise the error message is `Failed to load x11tiles: XpmFileInvalid`"
1571860199,Enable hero to wash hands in fountains and pools (and sinks!),entrez,2023-10-24 22:38:55+00:00,2023-11-10 05:37:24+00:00,{},"Dipping hands (with '-') or currently-worn gloves in a fountain or pool
will cause the hero to wash her hands, washing away any oil and clearing
the Glib intrinsic timeout.  This does mean bare hands can be used to
fish for fountain effects, without having to pick up a stray arrow and
carry it around as a dipping item, but having your hands be the only
thing that does not activate those effects felt weird.  If that would be
too unbalancing this could be scrapped.

With further commits this now also adds a system for #dipping items into
a sink, which can aid in potion identification (much like dropping a
ring into the sink can).  This is based on code from xNetHack written by
@copperwater, with additions and amendments.  It also means you can wash
your hands in a sink.
"
1567215275,Explore mode authorization fixes,entrez,2023-10-20 18:59:52+00:00,2023-11-08 04:37:20+00:00,{},"With SYSCF defined, EXPLORERS was being checked for explore mode authorization
when using #exploremode or resuming a previous normal game (if explore mode was
requested via command line or options), but if launching a new game with
OPTIONS=playmode:explore or -X, EXPLORERS was not evaluated or used.  Check it
before entering explore mode under all circumstances.

There was also an issue with the way failed wizard mode authorization would
push the game into explore mode when resuming a previous normal game, which
interfered with iflags.deferred_X and caused problems.

- Remove pw check in authorize_wizard_mode
- Apply sysconf EXPLORERS restriction on startup
- Fix: shunt to explore mode after wizmode auth fail
"
1559304481,Database suggestions (re: #1108),entrez,2023-10-16 20:03:12+00:00,2023-11-06 03:37:18+00:00,{},"These are suggestions I made in review comments on #1108, but they weren't seen
or acknowledged prior to Pat merging the PR.  I'm opening this separate PR with
them now because I do think they'd be improvements to the recent data.base
changes, and I'm not sure if they just got overlooked in merging the pull
request.  If they were seen and intentionally ignored, let me know and I can
close the PR.

Reasoning for the data.base suggestions is in comments on #1108 as well as in
the commit message.

- Miscellaneous tweaks to PR #1108
- Encyclopedia lookup: check all existing fruitnames
"
1542564995,Add missing database entries.,NullCGT,2023-10-04 21:46:45+00:00,2023-10-15 13:37:19+00:00,{},"The goal of this PR is to add entries to the database for all items and monsters that currently lack entries.

Entries that were missing before this PR was opened: https://bilious.alt.org/~paxed/nhdev/dataref.txt
Script to determine which entries are missing: https://bilious.alt.org/~paxed/nhdev/dataref-370.pl.txt

The entries I've added thus far are suggestions. I've tried to shoot for literary quotes that do not duplicate existing database entries. The current quotes I've suggested are fairly biased towards the western literary canon, so I'm especially interested in finding quotes from a more diverse set of sources to fill out the database with."
1540455095,Flipping coins.,NullCGT,2023-10-03 17:59:27+00:00,2023-10-14 12:37:25+00:00,{},"Applying one or more gold pieces now flips one of them, which will cause it to come up heads or tails. This is NetHack, so there are special cases for flipping a coin underwater or while fumbling or greasy.

I've tried to future-proof this commit so that the code will not need to be modified if other items are eventually added to the coin class.

If memory serves, there was a patch for this on the bilious patch database, but I was unable to locate it or who the original author was. If someone is able to find the original patch, please let me know. In any case, the code is entirely original."
1540402333,Object lookup via inventory menu.,NullCGT,2023-10-03 17:20:55+00:00,2023-10-13 10:37:18+00:00,{},"Adds an option to the inventory item menu which allows a user to look up an item in the database. This uses the existing whatis command, and as such is bound to the '/' key.

A minor secondary change is switching the failed database lookup message to second person. The use of a first person pronoun here has always struck me as strange, and switching to second person centers the player in the action."
1533396865,potion of sickness hit effect,vultur-cadens,2023-09-28 03:44:06+00:00,2023-11-03 22:37:18+00:00,{},"The potion of sickness would previously always print the message ""\<mon\> looks rather ill."" when hitting a non-poison-resistant monster, even if all effects were resisted due to monster magic resistance.

To make the potion more useful against high-MR monsters, this change removes the dependence on monster MR, but also removes the halving of maximum HP to prevent it from being overpowered.  Hitting with a potion of sickness now reliably halves only the current HP of non-poison-resistant targets.

The effect of poisoned projectiles, which can be created from a potion of sickness, is not resisted by monster MR, so it does not make much sense for the potion effect to be subject to monster MR.  There is also code to make Pestilence suffer the sickness effect when hit by a potion of healing, but due to monster MR, it had no practical effect other than printing a misleading message."
1532727409,Fix: map refresh in #terrain,entrez,2023-09-27 16:02:33+00:00,2023-10-03 20:43:55+00:00,{},"When the map was refreshed in #terrain mode (from ^R or because of
SIGWINCH, etc), it wouldn't honor the #terrain constraints.  Use
iflags.terrainmode to continue to apply the terrainmode restrictions
when docrt() is called, so that resizing or refreshing the map in
#terrain mode will not lose the #terrain view.
"
1531630363,Fix: clipping on horizontal window resize,entrez,2023-09-27 04:13:19+00:00,2023-09-27 07:49:22+00:00,{},"Clipping mode was not activated when a comfortably-sized game window was
resized horizontally to become too narrow to display the entire map,
causing various display errors and bugs if the window was resized like
that.  I think the horizontal resize check was removed by mistake in
d1dade164ef220a011bf89fa445a8b0012bf38df.
"
1529521202,Disambiguate b_trapped null bodypart value,entrez,2023-09-25 21:10:15+00:00,2023-09-27 07:45:44+00:00,{},"b_trapped was treating 0 as a null value for its bodypart parameter, but
0 is actually the value of ARM, so b_trapped(..., ARM) would be treated
as intending no A_CON abuse.  Add NO_PART = -1 to the bodypart_types
enum, and use that instead of 0 as the ""no body part"" value in
b_trapped, so that ARM can be passed to it without any ambiguity.

aosdict identified this issue in xNetHack and handled it differently; he
added NO_PART with a value of 0, incremented the existing bodypart_types
values, and padded the body part arrays so the actual body parts would
start at index 1.  I think using NO_PART = -1 is simpler, but that's an
alternative approach that can be used instead -- it is advantageous in
that it automatically fixes any other places where 0 is assumed to be a
non-body-part value that I may have overlooked.
"
1527543528,Updating FMOD channels and FMOD System Updater,MrEveryDay98,2023-09-23 23:35:14+00:00,2023-10-02 21:46:48+00:00,{},"This fixes an issue where sounds would stop playing over each other after a few seconds and instead interrupt the currently playing sound. This was done by changing `static FMOD_CHANNEL channel1` to an array called `static FMOD_CHANNEL channelsA[256]` and having the sound player increment in the array by 1 every time a sound is played. In addition, `FMOD_System_Update(systemvar)` which enabled this fix."
1524095867,Extensions to commit bda0b3b/PR #1093,entrez,2023-09-21 05:01:50+00:00,2023-09-23 09:37:18+00:00,{},"Pat suggested these changes as possible future extensions to the
thitmonst/finish_quest code path along the lines of PR #1093 (commit
bda0b3b) in 14c7b20.  They sounded interesting to me so I took a crack
at them, though I'm sure there are improvements that could be made (to
the specific language used by the quest leader, for one; it's tough to
write a single message that sounds like it could be believably spoken by
any of the quest leaders, from the Master of Thieves to King Arthur,
though I did try to be appropriately vague without being totally limp
and lifeless).

- Have quest leader ID thrown unknown fake Amulet
- Have leader keep already-used invocation items

"
1519971155,Allow quest leader to catch and return unique item,entrez,2023-09-18 17:51:37+00:00,2023-09-20 23:37:19+00:00,{},"It's been possible for a while to throw your quest artifact to your
quest leader, completing the quest (he will then throw the object back
to you).  The quest leader will also react to being brought the Amulet
of Yendor (i.e. having it in inventory when you approach or #chat), but
tossing it over like the quest artifact was treated as a hostile act and
would cause the quest leader and guardians to become hostile and attack
the hero.

Make throwing the Amulet of Yendor at the quest leader work like
throwing the quest artifact, and treat the invocation items similarly
just in case people try throwing those (maybe because they are lost,
unsure what to do, and have already seen their quest leader catch and
react to the quest artifact -- regardless of the reason, throwing over
the Book of the Dead is almost certainly not intended to be an attack).
Doing so for invocation items will ID them but not do much more than
that.  The Amulet of Yendor triggers the existing quest pager message.
"
1494388699,Fix: undoing monsters' permablindness by accident,entrez,2023-08-29 20:33:31+00:00,2023-09-07 17:37:19+00:00,{},"Monsters can become permanently blind (in very narrow circumstances -- I
think limited only to a very short-range camera flash), in which case
they have both mon->mblinded and mon->mcansee set to 0.  Such
permanently blinded monsters can counterintuitively regain their sight
by being blinded a second time from a different source: for example, by
being hit with a cream pie.  That second blinding will increase
mon->mblinded (which functions as a blindness timeout) by some amount,
and when it runs out the monster will regain its sight.  Try to make
sure that doesn't happen by skipping any blinding attacks if the monster
has already been permanently blinded.
"
1492801174,Fix: rising from the grave as a zombie,entrez,2023-08-28 22:05:58+00:00,2023-09-07 17:44:50+00:00,{},"When the hero is killed by a zombie, she is supposed to arise from the
grave as a zombie of a type matching her race.  Commit 580c5a6 broke
this inadvertently -- done_in_by was passing gy.youmonst.data to
zombie_form() and relying on the old behavior where it attempted to
include the hero's race in is_elf, is_orc, etc if the permonst matched
the hero's role.  Because this no longer works, zombie_form was only
returning PM_HUMAN_ZOMBIE when passed the role permonst of an
unpolymorphed hero.  Use gu.urace.zombienum instead.  This would have to
be a little more sophisticated (falling back to zombie_form() if Upolyd)
if a polymorphed hero with unchanging could die via done_in_by but
that's not currently possible as far as I can tell.
"
1492381260,Adjust seenres when observed attack succeeds,entrez,2023-08-28 16:39:00+00:00,2023-08-29 09:08:09+00:00,{},"If a monster sees an elemental attack succeed from some other creature
or environmental danger, it will be willing to try those attacks again.
"
1490213089,Adjust seenres on visible gear removal,entrez,2023-08-25 19:27:46+00:00,2023-08-26 11:20:02+00:00,{},"If a monster sees you remove some piece of gear that grants a
resistance, it will remove that resistance from its list of remembered
resistances and be willing to try attacking you with that adtyp again.
This avoids the situation where you put on a ring of cold, get hit with
one cold attack, and then can remove it because all the monsters nearby
will permanently remember you as being cold resistant (but even after
this change a wily hero could still step into a niche and do it without
any monsters seeing, so trick them into thinking she's still cold
resistant...).  The hero could still be resistant if there were multiple
sources to begin with, of course, but the monsters will test it and
learn that again if necessary.

It's a little weird that the monsters can recognize the intrinsic
granted by the item being removed, but they display knowledge of
unidentified (by the hero) objects in many other circumstances too, so I
hope it's forgivable in the pursuit of having them act more cleverly
about resuming previously-resisted attacks like this.  Another approach
that avoids the gear recognition, blanking seenres on any gear change,
can result in odd situations like orcs treating their own cloaks as
potential sources of many different resistances, which also seems silly.
"
1486933939,Fix: name confusion after MB cancels shapeshifter,entrez,2023-08-23 19:30:50+00:00,2023-08-25 23:37:18+00:00,{},"The cancellation effect of Magicbane can cause shapeshifters to change
to their base forms.  Since the name of the monster being attacked is
cached earlier, the name used for subsequent messages from Mb_hit would
be outdated after this happened.  For example, as encountered in a
recent game: ""The magic-absorbing blade cancels the vampire bat! The
vampire bat turns into a vampire lord! The vampire bat is confused.""
Insert the new name into hittee[] if cancellation caused the targeted
monster to change form.
"
1475304295,Release obufs used by sortloot,entrez,2023-08-15 01:03:48+00:00,2023-08-16 02:37:18+00:00,{},"Some further application of e43ec0c logic, which was intended to fix odd
messages produced by obufs clobbered by inventory updates (like ""the
ogre lord yanks Cleaver from your corpses!"").  That issue was still
lurking around because sortloot(), via sortloot_cmp(), was continuing to
call for obufs via loot_xname() without releasing them immediately.  It
was going through the entire inventory doing that, much like
display_pickinv() was prior to Pat's fix in e43ec0ce, so could cause
the contents of obufs to still be clobbered by perm_invent updates.
This changes sortloot_cmp() to releases the obufs it calls for as soon
as possible so that won't happen any more.
"
1431885495,Qt: remove window size debug print statement,entrez,2023-07-12 19:46:04+00:00,2023-07-13 13:37:20+00:00,{},"A printf call was introduced in 20fb008012 that caused the terminal
window to be filled with repeated debugging messages as the window
containing the Qt windowport was resized.  I removed it because I
assumed it was meant to be temporary and was left in the commit by
mistake, considering it isn't mentioned in the commit message; if it was
meant to be permanent it'd probably be good to block it out with #ifdef
DEBUG or something at least, because it produces a real deluge of
terminal output if the player spends any time resizing the window by
hand.
"
1431859661,Fix: wrong glyphs for clouds and water on Planes,entrez,2023-07-12 19:23:12+00:00,2023-07-12 23:37:17+00:00,{},"ff727e9 introduced an issue where unseen water and cloud on the
respective planes were shown with open and closed drawbridge glyphs
instead of the appropriate glyphs.  This is because they fall into cmap
section B, but the translation from symbols/cmap index to glyphs was
being done as though they were in cmap section A (ff727e9 manually used
that particular cmap section macro instead of the general cmap_to_glyph
to work around some compiler warning).
"
1426352905,Sit to trigger squeaky board even if flying,Ardub23,2023-07-09 15:53:23+00:00,2023-07-10 02:37:18+00:00,{},"If the hero sits on the floor while flying over a squeaky board, then either they're trying to squeak it on purpose or they haven't noticed it. Either way, sitting should trigger it instead of producing ""You notice a loose board below you."""
1425857154,fixed menu color for 'cursed + being worn',erwindon,2023-07-08 08:09:47+00:00,2023-07-10 02:37:19+00:00,{},"cursed items that are worn did not get the intended color.
escape regexp syntax to fix that"
1416541842,add a statushilite option for critically low HP,vultur-cadens,2023-07-02 03:19:09+00:00,2023-07-14 02:37:26+00:00,{},"This allows players to specify a highlight for critically low HP in the config file, for example:

OPTIONS=hilite_status:hitpoints/criticalhp/purple&inverse

This will cause the hitpoints field to be highlighted when HP is low enough to be considered a major trouble.  The new ""criticalhp"" setting only applies to the hitpoints field.

Since the critical HP threshold changes with level (and most of the fractions are not integer percents) it was impossible to set highlights to match the critical HP threshold using percentage settings.

---

One of the common questions from new players is ""I prayed when I had low HP; why didn't my god heal me?"", and the answer to that is usually ""Your HP wasn't low enough"", and then the natural follow-up question is ""How low is low enough?"".  This pull request allows players to set an option to highlight the HP field when HP is low enough to be considered a major trouble.  This will save players who already know about the critical HP threshold from having to calculate it (having to look up the relevant HP fraction for their experience level, and then doing some arithmetic) every time they are considering praying to heal."
1416360460,writing an unknown spellbook when the spell is known,vultur-cadens,2023-07-01 20:29:12+00:00,2023-07-07 23:37:19+00:00,{},"Allow hero to write an unknown spellbook if the spell is freshly known (from divine knowledge).  If the spell is going stale, the chance of successfully writing the spellbook depends on Luck, but only rnl(5) (like a Wizard) instead of rnl(15).  Forgotten spells do not help when writing unknown spellbooks.

---

You can already write a book, with certainty, about a spell you that don't know, if you have formally identified the spellbook. Actual knowledge of the spell seems like a deeper understanding of the topic than just knowing what the book looks like, so it should surely help you write the book, even if you don't know the book's appearance.

e3490743e071f18bda26c21f43a4c57240a7d79a says, 
> for a spell implanted from scratch, the book remains unknown.  That's ok; it's actually more interesting than discovering a book you haven't seen yet.

So I did not simply add makeknown() in the code where the hero receives the spell."
1413703247,Sit to trigger squeaky board even if flying,Ardub23,2023-06-29 17:20:16+00:00,2023-07-09 15:23:08+00:00,{},"If the hero deliberately sits on the floor while flying over a squeaky board, then either they're trying to squeak it on purpose or they haven't noticed it. Either way, sitting should trigger it."
1402093468,fix MENUCOLOR non-attribute overriding,Xdminsy,2023-06-21 17:06:20+00:00,,{},"One may make their wearing and wielding items underlined.
`MENUCOLOR=""(being worn|wielded)""=gray&underline`

But the latter matching rules only setting a color will change
the line's attribute none. It forces players to manually copy
their rules and add underlined versions.
`MENUCOLOR=""(robe)""=bright magenta`
`MENUCOLOR=""(robe).*worn""=bright magenta&underline`

So if the matching rule's attr is ATR_NONE, we keep searching
back previous rules to find the first matching rule which provides
an attribute.

This may slightly influence the performance due to more regex_match.
But makes the config more concise if one has many MENUCOLORs."
1387244962,"Allow wish for ""high altar"" in wizard mode",entrez,2023-06-10 19:23:53+00:00,2023-09-07 17:57:02+00:00,{},"This would make it more convenient to test of things that treat or
affect normal altars and high altars differently, e.g. altar coloration,
something that can destroy a normal altar but not a high altar, etc: the
developer can wish for a ""high altar"" or ""lawful high altar"" and so on
to interact with one without levelporting to the Sanctum or Astral and
dealing with the monsters there.

The syntax is pretty rigid (""high lawful altar"" doesn't work) -- I do
have another commit locally that is much more flexible in that regard
but since this is strictly a debug command and that adds more complexity
to the code I figured it's probably better to keep it simple.
"
1386350858,Restore altar destruction from (some) magical digging,entrez,2023-06-09 15:04:24+00:00,2023-07-07 22:37:24+00:00,{},"Especially powerful magic is meant to be able to destroy altars
(breaking a wand of digging or using a drum of earthquake), but it was
being blocked by a check added to maketrap() in a7f6460 designed to
prevent wizard-mode trap wishing from overwriting stairs.  The check was
refined in 6a3d82c to add an exception for digging up graves, but
continued to prevent the destruction of other types of
previously-destructible terrain.

Since this block was a side effect of an attempt to add some guard rails
to wizmode terrain wishes, and the code to explicitly permit the
destruction of other furniture with especially powerful magic is still
present, it doesn't seem like it was actually intended.  Open up terrain
destruction by digging magic a bit more by excluding only
non-destructible terrain, not all furniture other than graves, from
being overwritten by pits and holes.

Also, use AM_SANCTUM to more precisely identify non-destructible high
altars in dig_check() rather than checking whether the hero is on the
Astral or Sanctum levels.
"
1385844010,gray and darkgray,duwling,2023-06-09 09:24:26+00:00,2025-10-01 19:22:33+00:00,{},"### The bug

Instead of my choosen gray, the tty port uses the terminals foreground color. The curses port additionally swaps them in menus.

![gray bug](https://github.com/NetHack/NetHack/assets/118310042/3ee8b228-e1e1-4abb-8c40-9185162308b5)

Things called gray have no color. CLR_GRAY should be used for silver.

### Pallid

Long ago it got the default to use darkgray for black, but CLR_DARKGRAY can be one more to use the whole palette. With <code>option=black:n</code> players can change the intensity of CLR_BLACK, at runtime.

![17 colors](https://github.com/NetHack/NetHack/assets/118310042/8f346bf6-4b6a-4b4a-809b-9afcfe42c95d)

We have the 16 colors palette, plus 3: the foreground color (no color), the background color (colors are easier to distiguish an black), and the cursor color. Give back <code>option=setpalette</code>
"
1385788951,count gray to the colors,duwling,2023-06-09 08:50:15+00:00,2023-06-09 09:18:10+00:00,{},"Hardly noticeable if gray is set to differ from foreground, here slategray 0x708090.
+ curses swaps gray and no-color
+ tty hardcodes gray to fg and ignores terminal setting

![gray bug](https://github.com/NetHack/NetHack/assets/118310042/bcf9f6f5-878b-45e4-bc36-600549a6d43c)

Changing gray to NO_COLOR leaves CLR_GRAY for silver.

![gray silver](https://github.com/NetHack/NetHack/assets/118310042/8f0c8ae1-a7f6-4f80-9b85-88da01991590)"
1385709534,color interface,duwling,2023-06-09 08:01:24+00:00,2023-06-18 06:26:48+00:00,{},"In my opinion, these would make interface more friendly."
1385636775,count gray to the colors,duwling,2023-06-09 07:17:43+00:00,2023-06-09 08:48:58+00:00,{},"Hardly noticeable if gray is set to differ from foreground, here slategray 0x708090.
+ curses swaps gray and no-color
+ tty hardcodes gray to fg and ignores terminal setting

![gray bug](https://github.com/NetHack/NetHack/assets/118310042/bcf9f6f5-878b-45e4-bc36-600549a6d43c)

Changing gray to NO_COLOR leaves CLR_GRAY for silver.

![gray silver](https://github.com/NetHack/NetHack/assets/118310042/8f0c8ae1-a7f6-4f80-9b85-88da01991590)"
1385375848,Fix: levltyp[] desynchronization,entrez,2023-06-09 02:20:25+00:00,2023-07-05 10:37:19+00:00,{},"The ""temporary?"" levltyp[] array became desynchronized from the level
types enum with the addition of lava walls.  This caused all level types
past that to be given the wrong description when it was used.

Add an explicit length to the array so that future additions to the enum
should produce a compiler warning if it's not updated at the same time.
"
1383463387,Provide escape item in water-surrounded vaults,entrez,2023-06-07 22:32:04+00:00,2023-07-07 21:37:18+00:00,{},"Water vaults are one of the few places that can/will generate completely
sealed off in a normal level.  Other such spots are designed to provide
a guaranteed means of escape (vault guard, scrolls of teleportation in
niches, etc) -- water vaults were an exception that didn't do this, so a
hero who fell into one from above could have ended up in a position
where she had no choice but to wait to starve to death or #quit. Provide
an escape item in one of the vault's chests to give a hero more options
in that position.

Also fix a minor mistake (I'm pretty sure, though I'm not a Lua expert
enough to be certain) in an nhlib.c comment describing how to use
obj.addcontent() -- when called as box.addcontent(contents) as the
comment suggested it produces an error, but works OK when called as
box:addcontent(contents) or obj.addcontent(box, contents)."
1383118209,Add correct Cyclops pluralization,entrez,2023-06-07 17:45:10+00:00,2023-07-05 10:37:18+00:00,{},"The correct plural of ""Cyclops"" is ""Cyclopes"", not ""Cyclopses"".  I don't
know if anyone would actually use that as a fruitname, but it wouldn't
hurt to add it -- especially since a Cyclops does appear in the game.
"
1378091703,Fix memory errors in qt_tilewidth and qt_tileheight,chasonr,2023-06-05 02:18:52+00:00,2023-06-05 09:37:18+00:00,{},"* qt_tilewidth and qt_tileheight are allocated with alloc() and need to be freed with free().
* Don't use them after they're freed. Instead, retrieve the size from the glyphs object."
1377971966,Qt: Support Unicode supplementary characters,chasonr,2023-06-04 22:19:51+00:00,2023-06-05 09:37:18+00:00,{},"The QChar class looks like it should accept a UTF-32 code point; in fact, it accepts only a 16 bit code point. To support supplementary characters, it is necessary to convert to UTF-16.

Discovered during testing: fix compile with Qt 4; the sound functions were not properly excluded."
1375529863,Silvergrey,duwling,2023-06-02 10:28:36+00:00,2023-06-09 07:17:27+00:00,{},"A bug, hardly noticeable if gray is set to differ from foreground, here slategray 0x708090.
+ curses swaps gray and no-color
+ tty hardcodes gray to fg and ignores terminal setting

![gray bug](https://github.com/NetHack/NetHack/assets/118310042/bcf9f6f5-878b-45e4-bc36-600549a6d43c)

The fix actually adds gray to the colors. When the game calls something ""gray"", it means no special appearence in color compared to the other (i.e. gem/gray stone). So that leaves it for silver exclusive.

![gray silver](https://github.com/NetHack/NetHack/assets/118310042/8f0c8ae1-a7f6-4f80-9b85-88da01991590)
![silver dragon](https://github.com/NetHack/NetHack/assets/118310042/9a9a39c3-a9b0-493c-99b7-8de2c42f02a6)

Usually gray does not differ much from foreground by default. Should I revert the wipe of dragon-silver?

![seagreen dragon](https://github.com/NetHack/NetHack/assets/118310042/eb0b8430-8a55-4b16-9b43-e91db3fe3abd)
"
1372262115,silvergrey,duwling,2023-05-31 13:50:04+00:00,2023-06-02 09:56:12+00:00,{},"Monsters, objects, and menu colors
+ curses: swaps gray and foreground color
+ tty: hardcodes gray to the same as foreground color, and ignores terminal setting

It turned out that the fix actually adds gray to the colors."
1370180972,Color gray,duwling,2023-05-30 10:11:41+00:00,2023-05-31 13:47:12+00:00,{},"In v3.6, colors were hardcoded. Now, terminal settings are kept. Most can set the 16 colors and fg/bg. So grey might be one too. `#696969` `#808080` `#a9a9a9` `#778899`

+ On linux ncurses, no-color and gray was swapped, which could be considered a light bug.
+ In bare tty interface, gray was no-color, terminal setting ignored.<br>Should there be another <code>if(use_darkgray)</code>before<code>free(hilite[CLR_GRAY])</code>?
+ On some OSX gray was black"
1369729659,Make loadstone useful,vultur-cadens,2023-05-30 03:09:23+00:00,2024-09-30 03:19:38+00:00,{},"#906 had loadstones give steadfastness (preventing knockback), but loadstones are still too heavy to be practically useful.

This pull request contains 3 commits, so parts of it may be picked if you don't like all of them:
1. Reduce the weight of blessed loadstones to 100 units, 1/5 of their normal weight.  They are magically heavy items, so it makes sense for a blessing to change how the magic acts.
2. Allow putting a loadstone in a bag without it autocursing, if it does not leave your inventory.  This allows players to put a loadstone away to protect from the curse items spell when they don't need steadfastness.  The loadstone autocurse condition is changed to be the same as crysknife reversion condition, so dropping a bag containing a loadstone will degrade the loadstone's beatitude.
3. Prevent loadstones (and bags containing them) from being put in bags of holding, so that they will still be a decent load to the hero when not being used for steadfastness.  Loadstones will not explode bags of holding since we don't need more bag-exploding things; they will just refuse to be put in.  This can be explained by loadstones being smart enough to not want to go in a bag of holding (because they would rather be a load to the hero), just like they are smart enough to not want to leave the main inventory when they are cursed.  As a side effect, attempting to put a sack containing a loadstone and a wand of cancellation into a bag of holding will not explode the bag of holding, because the loadstone will prevent it before the explosion.

Loadstones are still an early-game trap for players without a means of uncursing them.  Players who accidentally pick up a loadstone and then dump it as soon as they uncurse it should not notice any difference.  But this pull request does give players a reason to carry a loadstone if they are able to bless it.  A blessed loadstone is also heavier than Giantslayer, has the risk of causing encumbrance if it gets cursed, and can't be put in a bag of holding to reduce weight, so it doesn't make Giantslayer useless either.
"
1360396240,Fix: use-after-free when applying an object that got destroyed,copperwater,2023-05-23 00:53:21+00:00,2023-05-24 02:37:18+00:00,{},"Found this running the fuzzer with address sanitizer. After applying an object, the game checks whether it's a talking artifact so that it can speak to you afterwards.

If, however, the object got destroyed in the process of applying it, this will read and dereference obj after they have been freed. I found this with a cream pie, which is always destroyed when someone applies it.

To fix this, I tracked the obj pointer for what I think are the only two cases in the big switch statement that don't track this - royal jelly and cream pie. Royal jelly is only conditionally destroyed depending on further input, so its function had to be refactored to take a struct obj**, but cream pies are unconditionally destroyed so it can just be set to null."
1359658859,split offering fake amulet into separate function,argrath,2023-05-22 17:47:27+00:00,2023-07-05 09:37:20+00:00,{},
1358382005,Fix and guard against out-of-bounds writes in splev code,copperwater,2023-05-22 01:05:32+00:00,2023-07-05 04:37:20+00:00,{},"I traced a memory corruption bug in xNetHack to a themed room that looked something like this:

    function()
       des.room({ type=""themed"", contents = function()
          des.feature({ type='sink' })
          ...
       end })
    end

Placing a feature at a random spot within a room or region is a reasonable thing for the parser to handle, but the code was not equipped to handle it, and so the unspecified x and y set as -1 got passed directly to SP_COORD_PACK, ending up as coordinates way off the map. Since sel_set_feature does not do an isok() check, this ended up writing data to unrelated memory.

This commit does the following things:

- Enables des.feature() with no coordinates specified, both via a table with 'type' set, and as the single string argument. When no coordinates are specified, it will pick a random normal-floor spot within the enclosing room or region if there is one, or anywhere on the level if there isn't.
- Prevents sel_set_feature from corrupting memory outside g.level.locations. Additionally, if EXTRA_SANITY_CHECKS is defined and this gets attempted, it causes an impossible.
- Guards the existing ""door coord not ok"" Lua error with an immediate return from lspo_door.
- Adds similar ""coord not ok"" errors to all the other locations in sp_lev.c which did not already check for a unspecified/invalid coordinate and for which a random coordinate is nonsensical: des.terrain(), des.drawbridge(), and des.mazewalk()."
1358341250,"Implement builds_up correctly, resolving its FIXME",copperwater,2023-05-21 22:22:47+00:00,2023-07-05 03:37:18+00:00,{},"The FIXME comment noted that builds_up would return an incorrect false value for a dungeon branch that builds upwards but is only 1 level, but that this is a latent problem because no such branch exists in NetHack. Such a branch does exist in xNetHack, and it causes the debug fuzzer to crash (""mon_arrive: no corresponding portal"" because it can't find the correct-direction stairs), so I figured I might as well fix it upstream."
1358071800,"Allow des.object ""trapped"" field to be a boolean",copperwater,2023-05-20 23:38:54+00:00,2023-07-05 03:37:17+00:00,{},"I thought there were more object fields that currently only accept ints but ought to accept booleans, but when I checked I found that most of them do already, and the ones that take ints are the ones that the number carries meaning (spe, recharged, etc).

Except for trapped. In struct obj, otrapped is a 1-bit flag, so there's no good reason for the level parser to treat it as a type error if someone intuitively makes a des.object call with trapped=true or trapped=false. Change it to an optional boolean argument, like the other boolean flags (locked, greased, etc).

Note that get_table_boolean_opt still accepts ints, so existing uses of trapped=0 or trapped=1 won't be affected."
1358070825,Fix chained selection xor and subtraction operations,copperwater,2023-05-20 23:30:03+00:00,2023-07-05 02:37:19+00:00,{},"Something that's reasonable to expect to see in Lua files is something like:

    local sel4 = sel1 - sel2 - sel3

or more generally, producing a selection from subtraction that will then be used in subsequent selection math.

I discovered this wasn't actually working correctly, and that it also applied to the xor operation. The reason behind this is that l_selection_sub and l_selection_xor create a new selection from nothing, which by default has ""lower"" bounds of COLNO, ROWNO and ""upper"" bounds of 0,0. Iterating across the intersecting rectangle of both selections does not reliably set the bounds of the resulting selection properly, since the first selection_setpoint with a value of 0 will cause the selection's bounds_dirty flag to be set, at which point they will cease to change as more points are added.

Then this selection with its incorrect boundaries is pushed back onto the Lua stack, and becomes the first operand of the next subtraction (i.e. selr in the first l_selection_sub becomes sela in the second l_selection_sub). Depending on how broken the bounding box is, results may vary, but if the bounding box is still (COLNO,ROWNO,0,0), the resulting selection will have no points selected at all.

This fixes this problem by forcibly recalculating the bounds of the result selection, so any subsequent operations on it will be valid."
1356629208,move VDECL definition to vmsconf.h,argrath,2023-05-19 05:59:36+00:00,2023-05-31 13:37:17+00:00,{},"As VDECL macro is used only in sys/vms, move its definition to vmsconf.h."
1355038411,Support Curses on NetHackW,chasonr,2023-05-18 02:08:39+00:00,2023-05-30 07:37:21+00:00,{},"To compile: build with MinGW and give WANT_GUICURSES=1 on the command line. This switches the Curses implementation to PDCursesMod (mainline PDCurses does not provide a Windows GUI version) and links both the console and Windows GUI versions.
To run: set OPTIONS=windowtype:curses in .nethackrc and run NetHackW.
Various adjustments are made to enable NetHackW to select the Curses interface, and to fix a few minor bugs."
1347901962,Keep track of movement points between saves,saltwaterterrapin,2023-05-12 00:21:02+00:00,2023-05-24 22:37:18+00:00,{},"Currently, whenever a saved game is loaded, a character is granted a flat 12 movement points, which they immediately use to move. This means that any movement points they had when saving are wasted, meaning saving has an in-game disadvantage---a small one, but possibly noticeable if you care about turncount or you save in a dangerous situation to think about your options. For instance, if you are burdened and not fast, moving after saving always takes two turns. If you are unburdened and fast, moving after saving always takes one turn. 

This commit keeps track of your movement points between saves in the least elegant way possible, and definitely breaks saves. But it works!"
1346397295,Add true rumor re. intrinsics/extrinsics,Kufat,2023-05-11 04:09:38+00:00,2023-07-05 09:37:19+00:00,{},"Some extrinsics (telepathy, speed) are more powerful than their intrinsic versions, and some properties are only available as extrinsics."
1344140306,convert glyph_to_cmap() macro into a real function,argrath,2023-05-09 17:48:18+00:00,2024-09-14 18:37:23+00:00,{},...to make debug easier.
1315292732,Fix: breathless monsters always generate in water in special levels,copperwater,2023-04-16 01:06:01+00:00,2023-04-16 07:00:17+00:00,{},"... unless explicitly specified to generate at a specific point or within a specific area. But if they are permitted to generate anywhere on the level, and it contains water, they always end up in the water. I noticed this when trying to explicitly specify ghouls to generate anywhere on a level with a minimal amount of water.

This was due to the definition of ""amphibious"" being conflated with ""breathless"", such that all breathless monsters counted as amphibious. There are plenty of breathless monsters in the game that decidedly don't normally inhabit water, such as undead, but they would pass the amphibious() check in pm_to_humidity and thus the game decides that they must generate in wet terrain if there is any available.

This fix takes the approach of changing amphibious() so that it no longer checks the M1_BREATHLESS flag and only considers M1_AMPHIBIOUS, then updating the places where amphibious() and Amphibious are used accordingly. I also added a new macro cant_drown() which wraps up swimming, amphibiousness, and breathlessness because these three things are frequently checked together in the context of whether something should drown.

Places where amphibious() or Amphibious did NOT have an extra breathless() or Breathless check added on, and thus where behavior has been changed:
- The pm_to_humidity function (to fix the bug).
- Player vs water in goodpos; it didn't seem like being polymorphed into a breathless non-amphibious monster should make it fair game to randomly teleport into water even though it's technically safe.
- Awarding extra experience when killing an eel. (So the hero will get the extra experience if they are polymorphed into a breathless non-amphibious monster and don't have magical breathing. Very much an edge case.)"
1305529772,Split bestowing artifact into separete function,argrath,2023-04-07 04:37:17+00:00,2023-04-16 06:56:12+00:00,{},
1305180645,Adjust statue traps to be biased toward more difficult monsters.,NullCGT,2023-04-06 19:26:28+00:00,2023-07-03 03:37:17+00:00,{},"This is originally from the YANI archive as well, but dovetails nicely with the recent change to bias figurines toward more difficult monsters. The purpose of this change is to make statue traps somewhat dangerous, as they currently suffer from a problem similar to the one that figurines used to.

I experimented with biasing all statues toward more difficult monsters, but I ultimately decided against it. From a flavor perspective, it feels odd to see a statue of something that does not normally appear on the level, and it could also potentially unbalance the game in favor of players that can cast stone-to-flesh. Additionally, if only statue traps are more difficult, the savvy player can pick out statue traps before triggering them."
1305135422,Doppelgangers mimic top ten list members.,NullCGT,2023-04-06 18:37:01+00:00,2023-07-03 02:37:18+00:00,{},"I saw this idea in the YANI archive, and I thought it was a fairly interesting feature. Doppelgangers in D&D are known for committing identity theft, but in NetHack they are almost indistinguishable from other shapeshifters, at least for the average player. This commit makes them a bit more interesting, I think.

The canseemon check exists because otherwise the player might run into a random monster named after a top ten list character, and be slightly confused. While it might have been a bit cleaner to rechristen the monster after every shapechange, that would present its own set of issues. 

If the game cannot find a top ten list member, the doppelganger simply changes into a random player monster, as they do currently.

(cherry picked from commit 2ba9c96f1df2093669c20d869730b2a4a1bdc3ea)"
1304326276,prevent free()ing static buffer on save_luadata(),argrath,2023-04-06 08:30:48+00:00,2023-04-06 13:37:19+00:00,{},
1300717287,Don't drop aklys on the floor due to slippery fingers,copperwater,2023-04-03 21:28:09+00:00,2023-04-16 06:49:43+00:00,{},"Aklyses uniquely have a tether attached to one's wrist, which would stay secure even when one's fingers are slippery. Therefore, it doesn't make for the weapon to be dropped completely, tether and all, when Glib.

However, the game doesn't have a way to model a weapon that's on the floor at your feet but still attached to your arm. (Technically the uball and uchain code does do this sort of thing already, but it can't be used here - what if you have an aklys slipping out of your grasp and are punished at the same time?) So the next best thing is to give aklyses immunity to slipping from one's hand."
1293831798,livelog shopkeeper deaths,vultur-cadens,2023-03-29 01:30:56+00:00,2023-07-02 14:37:18+00:00,{},"The livelog message includes the shopkeeper's shop type, since the livelog for stealing also mentions the shop type.

This also adds a revival counter for each shopkeeper."
1293786906,Give a message when a monster is zapped with make invisible,copperwater,2023-03-29 00:14:29+00:00,2023-04-01 07:04:12+00:00,{},"Every other case I'm aware of where a visible monster that the hero can see turns invisible has some associated message, but not when zapping it with the wand of make invisible and lacking see invisible. This adds a message ""[monster] vanishes!"" in this case, which is the same as the most common message one gets for zapping a monster with teleportation, by design to keep the wand's identity ambiguous.

Technically, prior to this commit, there was a leak of information if one zapped a wand that made a monster disappear: the identity of the want could be determined immediately by the presence or absence of a vanishing message. Practically, though, it was easy to check if there was a new invisible monster in the same spot or not.

Also, zapping teleportation at a monster and having it land somewhere visible to the hero now has attention explicitly drawn to it with a message (in prior versions it didn't, so it could potentially be a different monster appearing by some other means), so I additionally made the wand of teleportation automatically identify itself when the hero sees the monster appear as a result of their zap."
1281367952,"Make ""cookie-only"" rumors explicit in rumors file",copperwater,2023-03-18 22:26:27+00:00,2023-04-01 07:16:56+00:00,{},"The prior behavior was an ugly kludge that treated rumors as only-eligible-to-appear-from-fortune-cookies if they contained the string ""fortune"" or ""pity"". This commit gets rid of that system and introduces a system where each rumor can be specified as such by prefixing it with ""[cookie]"".

In order to avoid changing existing behavior, I have applied the [cookie] prefix to all the rumors which were affected under the old rules. However, several rumors seem like they were misclassified under the old rules, and I am in favor of changing them as follows:

Should be made cookie-only (they only really make sense in context of eating a fortune cookie):
- ""Ouch. I hate when that happens.""
- ""PLEASE ignore previous rumor.""
- ""Suddenly, the dungeon will collapse...""
- ""Unfortunately, this message was left intentionally blank.""

Should be made non-cookie-only (they make sense if they appear as engravings or artifact whispers):
- ""They say that a gypsy could tell your fortune for a price.""
- ""They say that fortune cookies are food for thought."""
1281367898,Remove the manual 50% vertical swap of doors in Baalzebub level,copperwater,2023-03-18 22:26:08+00:00,2023-04-01 07:12:14+00:00,{},"This was added before level flipping, and its purpose effectively was to randomize the interior secret door layout (and thus the entire level, because the rest is vertically symmetric) by manually flipping it. Now that the entire level can be flipped and produce this same effect, this is no longer necessary."
1277582318,Fix stair travel not redrawing screen on windows,mataamad,2023-03-15 21:58:21+00:00,2023-03-22 21:02:10+00:00,{},Fixes #997
1268236147,update readme with latest release version,nulla-git,2023-03-08 17:57:13+00:00,2023-03-08 22:37:25+00:00,{},"version 3.6.6 isn't the latest version anymore, it'd make sense to update it to 3.6.7 to avoid any possible confusion."
1259518593,Prevent curses 'More' (>>) from overwriting msg,entrez,2023-03-01 22:22:58+00:00,2023-03-04 00:37:17+00:00,{},"In some scenarios where a message prompted a 'more' (in curses shown as
'>>'), the '>>' could overwrite the last one or two characters of the
message.

This could happen if a single message on its own was the length of the
message space minus 2 (e.g. for an 80 character terminal, ""h - a concave
amulet named this is an amulet name, it is very long, and so on.""), or
if an addition to an existing line brought it to the length of the
message space minus 1 or 2 (e.g. ""You materialize on a different level!
You remember this level as testlevlname."").  The two scenarios had
slightly different causes.

I think this fixes both of those scenarios.  I believe this is the
cause of the problem described in GitHub issue #990 but there isn't
enough detail to know that for a fact.
"
1259430991,Initialize scrollbar 'framecolor' before use,entrez,2023-03-01 20:58:16+00:00,2023-03-02 01:37:17+00:00,{},"Caused an asan crash because the value is used to index an array.
"
1257094794,Enable statue traps with specific statues of monsters,copperwater,2023-02-28 13:00:09+00:00,,{},"Previously, attempting to specify a statue trap would have it unconditionally create a statue of a random monster in maketrap() on top of the trap, which is no good if one wants a certain type of monster to be the statue trap. (A poor workaround would be to add another statue of the desired monster on the same space since statue traps animate the topmost statue, but since this would create a pile of statues, it would be readily apparent.)

This commit lets the level designer create a statue trap by specifying the ""trapped"" field on a statue created with des.object. Instead of setting otrapped on the statue, it will create a statue trap on the floor underneath it.

A des.trap('statue') will still always create a statue of a random monster. I originally implemented an extra flag to pass into des.trap that would disable this behavior, but then figured that a statueless statue trap still needs a des.object('statue') statement to make the statue, which could just be specified as trapped in the first place. So it wouldn't really add anything.

Internally, this moves the statue creation out of maketrap(), so that a trapped statue can call maketrap(STATUE_TRAP) without side effects. This means that responsibility for making a statue now falls to the caller of maketrap, which is only relevant in 3 places (generic mktrap(), wizard mode trap wishing, and adding random traps to a maze)."
1254643528,Fix: using a selection in a lit des.region modified it,copperwater,2023-02-26 23:52:29+00:00,2023-03-01 15:32:52+00:00,{},"The intuitive behavior when passing a selection to des.region, e.g.

    local foo = selection.area(07,02,10,24)
    des.region(foo, ""lit"")

is that foo will remain unmodified for further use. However, this wasn't the case whenever making a lit region from it, because in order to light walls adjacent to the lit area, the selection was having a grow transformation applied as well. (This also seems like a problem - it grows the selection even if what is being lit is not surrounded by walls. I added a note in lua.adoc about this behavior.)

This fixes the selection mutation by cloning the passed-in selection and growing the clone which leaves the original one unaffected.

This should not affect any special levels currently because the only instance of des.region being used with a selection appears to be in bigrm-2, which specifies *unlit* areas, which did not get grown.

I started writing a patch to change the behavior of selection_do_grow when it's being used for lit areas extending to walls to only apply to terrain types which are not `SPACE_POS`, but decided not to until I know whether it's truly unintended behavior."
1253058103,fix: add build patch for osx build,chenrui333,2023-02-24 10:55:34+00:00,2023-02-24 17:35:26+00:00,{'3.6': 1},relates to https://github.com/Homebrew/homebrew-core/pull/124039
1239699869,Don't anger target via mon vs mon zap/breath,entrez,2023-02-13 22:16:07+00:00,2023-02-14 07:24:09+00:00,{},"dobuzz() was modified in 677b32c2a7 to anger the target, but beams
handled by dobuzz() don't necessarily originate from the hero.  Monsters
can zap wands that hit other monsters, dragons can use their breath
attacks, etc.  Those things were causing the targets to become angry at
the hero.
"
1239514288,Fix: message when pet moves from water to eat,entrez,2023-02-13 19:36:45+00:00,2023-02-14 07:20:49+00:00,{},"The <x,y> params of dog_eat are the pet's starting position that turn,
not necessarily the position of the object being eaten.  If the pet is
doing a combined move-and-eat action, <x,y> will be its original spot,
but it will have already moved to <mtmp->mx,mtmp->my>, where the food
object also is.

The attempt to check whether the eating was happening out-of-sight
underwater (to suppress the message in that case) was checking the pet's
starting location, not its new location/the location of the food object.
So if a pet moved from water to land to eat something, the chowing-down
message would be improperly suppressed (and presumably the message for a
pet moving from land to water to eat would be improperly left
_un_suppressed, though I didn't actually try to reproduce that).
"
1238787735,Split kicking a door into a separate function,argrath,2023-02-13 10:52:20+00:00,2023-02-14 07:17:41+00:00,{},
1237345111,Invert the behavior of selection.gradient,copperwater,2023-02-10 22:29:52+00:00,2023-02-14 07:16:07+00:00,{},"selection.gradient has some pretty unintuitive behavior, in that it
selects points that are NOT close to the defined center. I've used
gradient selections several times and so far all of them have had to be
negated, because I wanted to select points close to the center with a
decreasing probability further out.

This implements that behavior, and also fixes a bug in which the x,y
coordinates of the gradient center(s) were not converted properly when
used within a des.room or des.map. Also updated the lua documentation
for gradient.

I removed the ""limited"" argument, as it was previously used to control
whether the rest of the map outside the max given distance would be
included in the selection; now that the area beyond maxdist is naturally
never in the selection, it doesn't have much use. (And I can't think of
a reasonable use case for the inverse: wanting to select points close to
the center, with decreasing chance towards maxdist, but then select the
entire map beyond maxdist.)

Currently this does not affect any special levels or themed rooms
because none of them use selection.gradient.

This pull request also contains a commit to drop the `isqrt()` math for gradients, which removes some bias and chunkiness from them."
1237160548,x_monnam: use 'the' with adjective + given name,entrez,2023-02-10 19:28:37+00:00,,{},"Most x_monnam articles retained the given article for an adjective +
name phrase, and y_monnam/ARTICLE_YOUR would drop the article even if
there were adjectives before the name.  Some of the resulting messages
and phrases like ""Invisible Fido appears"" (for ARTICLE_YOUR) or
""interior of an invisible Worm Boy"" (for ARTICLE_AN) sound wrong to me;
normally if I am using an adjective with a given name, I will include
use a definite article (""the invisible Sally"").  If there's a given name
combined with adjectives, use ""the"" (and continue to drop the article if
there's a given name on its own).

I have done some testing with this and the results sound more
idiomatic/natural to me, but hard to say for sure there wouldn't be any
strange results given the myriad different circumstances in which
monster names are used.
"
1237145836,"Avoid ""It turns into [Name]"" on vamp engulf",entrez,2023-02-10 19:13:19+00:00,2023-02-21 01:37:19+00:00,{},"Apply a similar fix as a791b4b and f441696 ended up settling on for
normal vampire transformation to the vampire transformation that happens
when their shapeshifted form is engulfed.
"
1235898708,Set up *roff hyphenation more carefully.,g-branden-robinson,2023-02-09 23:52:12+00:00,2023-02-10 14:33:47+00:00,{},"* doc/Guidebook.mn: Remove workaround, in favor of...
* doc/tmac.n: ...setting automatic hyphenation mode appropriate to hyphenation systems used by AT&T-descended troffs on the one hand (""suftab"") and groff (TeX hyphenation patterns) on the other."
1235645404,Fix: 'A'+'P' regression when dropping by type,entrez,2023-02-09 19:53:07+00:00,2023-02-10 04:37:22+00:00,{},"Selecting both 'P' (the just-picked-up items category) and 'A' (the
'auto-select relevant items' flag) when dropping items by type with 'D'
was automatically dropping every item in inventory instead of only items
that were marked as just having been picked up.  Basically, it was
causing 'A' to act like it did before b65c93c amended its functionality.

This commit is more-or-less identical to 991e739, both in terms of the
problem and the fix, except that it applies to dropping items instead of
looting."
1235416888,Tweak maybe_unhide_at() a bit more,entrez,2023-02-09 16:43:10+00:00,2023-02-10 03:37:19+00:00,{},"A monster may be unhidden if it's caught in a trap, but maybe_unhide_at
was checking mtmp->mtrapped across the board, which wouldn't work for
the hero.  Use u.utrap instead under those circumstances.  Also refactor
a bit so it shouldn't need the repeated guards against mtmp being null.
"
1230899705,Fix #969: dying in shared shop wall,entrez,2023-02-06 18:47:56+00:00,2023-02-08 14:57:25+00:00,{},"inherits() only examined the first item in u.ushops, so wouldn't work
correctly in some cases where the hero died in a shared shop wall and
neither shopkeeper had been robbed.  This seems to work in some basic
tests of behavior in a shared wall, but I haven't done extensive testing
on all the different combinations of robbed shopkeeper elsewhere in
level, shopkeeper angry but not robbed, etc.

Fixes #969 
"
1229762957,Bogusmon from The Culture (Iain M. Banks),Kufat,2023-02-06 02:57:48+00:00,2023-02-26 12:37:18+00:00,{},Add the antagonistic undecagonstring from The Hydrogen Sonata as a hallucinatory monster.
1229453527,Wand of speed gives player temporary speed and potion gives intrinsic,copperwater,2023-02-05 13:50:39+00:00,2023-04-16 06:47:23+00:00,{},"paxed said to submit a PR for this, so here it is. This is a port of https://github.com/copperwater/xNetHack/commit/33a63aa.

This aims to fix the issue in which there are way more wands of speed monster in the game than the player has any use for. Usually, one is enough for the whole game (unless a player has a lot of pets they want to speed up) but since they're an item monsters can generate with, it's typical to see eight to twelve of them, useless for anything besides polypiling into other wands since they just grant an intrinsic that's usually obtained early in the game.

By making the wand effect (on the player) temporary very fast speed, it becomes desirable to keep the wand around again. By adding a lightweight source of very fast speed, it also helps diversify character builds away from always relying on speed boots. And importantly, it becomes an item the player can use situationally early in the game to enhance their odds in a fight or run away from danger.

Meanwhile, the speed-intrinsic-granting has been moved to the potion, and the potion is still superior to the wand in the duration of very fast speed it grants (100 + d10 turns for an uncursed potion or 160 + d10 turns for a blessed one, versus 50 + d25 turns for the wand).

Since monsters don't have a concept of very fast speed, this doesn't change the wand or potion effects on them. They will still gain permanent intrinsic speed by either method."
1229255517,Fix: default lregion exclusion area occupied real space on the map,copperwater,2023-02-04 20:51:32+00:00,2023-02-05 05:51:17+00:00,{},"The intuitive behavior of des.levregion or des.teleport_region when ""exclude"" is left unspecified is that there is no exclusion area. However, this wasn't actually the case: since l_get_lregion defaulted the exclusion area to (0,0,0,0) and exclude_islev to 0, this meant that the 0,0 space on the map would always be excluded from regions. In cases where a region was specified with its inclusion area constrained to the 0,0 space of the map, this would create a ""Couldn't place lregion"" impossible message.

This fixes that issue by defaulting the exclusion area to (-1,-1,-1,-1), and if the exclusion area is left unspecified, forces exclude_islev=1. This means that the exclusion zone will be outside the walkable space of the level where it can't cause any problems.

If a level designer puts negative coordinates in their inclusion or exclusion parameters, this might not work correctly, but negative region coordinates aren't currently used anywhere and probably shouldn't be supported anyway."
1220150329,Split offering to different alignment alter into a separate function,argrath,2023-01-28 05:20:14+00:00,2023-02-07 04:37:18+00:00,{},
1217075849,Fix: use-after-free in dog_eat(),entrez,2023-01-25 20:16:32+00:00,2023-01-26 15:40:37+00:00,{},"I think moving the m_consume_obj call (which will free the eaten item)
further down should fix this without causing any really wacky message
sequencing issues, but if maintaining the exact order is important
obj->unpaid and its price could be cached before the free instead.
"
1217033049,Split offering the real amulet into a separate function,argrath,2023-01-25 19:39:58+00:00,2023-01-26 20:37:20+00:00,{},
1215609959,Substitute non-ASCII chararacters in Makefile.nmake,argrath,2023-01-24 19:35:04+00:00,2023-01-25 00:37:18+00:00,{},
1214557949,Avoid casting time_t to int,argrath,2023-01-24 05:36:24+00:00,2023-01-24 10:37:17+00:00,{},"As time_t may not fit int, cast -1 to time_t instead."
1214234880,Adding FMOD sound support,MrEveryDay98,2023-01-23 23:13:47+00:00,2023-09-16 20:37:18+00:00,{},"Resubmitting this since I think I finally understand how Git works lol

~~Anyway, currently this does not produce sound (that's why this is a draft), but it compiles without errors as long as the dependency requirements are met. I'm not much of a programmer so I would appreciate any help with this.~~

Sound now functions as intended.
For now, sound files beginning with `music_` will play on loop in their own sound channel. All other sound files play in another channel

**Building with VS:** 
1. Download fmod 2.02.11 from https://www.fmod.com/download (no direct link available)
2. Add <fmod-path>\api\core\inc to VS additional inclusions
3. Add <fmod-path>\api\core\lib\x64 to additional libraries
4. Add fmod_vc.lib to additional dependencies
5. replace SND_LIB_WINDSOUND in preprocessor definitions with SND_LIB_FMOD
6. change `assign_soundlib(soundlib_windsound);` to `assign_soundlib(soundlib_fmod);`"
1199524184,Replace Win32API playSound function with FMOD,MrEveryDay98,2023-01-16 21:41:30+00:00,2023-01-22 18:56:59+00:00,{},"Replaces the Win32API playSound function with FMOD, allowing for more robust audio playback (example, background music).

Documentation recommendation:
""Music files should have their filename contain 'music_', this way the game will play the file on loop until another 'music_' file is loaded"
1199151206,Replace Win32API sound player with FMOD,MrEveryDay98,2023-01-16 15:13:10+00:00,2023-01-16 16:24:12+00:00,{},Replaces the very limited Win32API playSound function with the FMOD library
1186924562,Fix: underwater vision update frequency,entrez,2023-01-05 18:39:52+00:00,2023-01-21 23:37:28+00:00,{},"Underwater vision was updated only once per turn, so if the hero had
more than one move per turn it could cause some spots to be left behind
on the map.  For example, after moving around underwater while very fast
for a while:

            }
          }}}
          }}}}
       }  }}@}
      }    }}}

Not only does the radius of vision appear to ""smear"" temporarily, but if
the hero moves fast enough, isolated spots can be left entirely behind
(since the normal underwater vision update only clears nearby spots, not
the entire map).  Both these effects are visible in the example above.

The fix in this commit is to update the frequency of underwater vision
updates to ""once-per-time-taken"" rather than ""once-per-turn"", so that it
updates with every move.  I'm not sure if it needs to happen more
frequently than that (i.e. in the ""once-per-input"" section) but I might
be overlooking something.

Also add missing punctuation to the message for applying a lamp
underwater.
"
1172892021,Guidebook: formatting for '#repeat' heading,entrez,2022-12-20 22:20:42+00:00,2022-12-21 12:37:17+00:00,{},"Minuscule change.  #repeat was not monospaced like the other extended
commands.
"
1158171706,Clean up dangling pointers when freeing glyphmap,chasonr,2022-12-10 22:02:00+00:00,2022-12-11 02:37:18+00:00,{},Partially fixes issue #941.
1157898727,Improve processing of Unicode glyph IDs,chasonr,2022-12-10 17:41:44+00:00,2022-12-11 02:37:18+00:00,{},"I am building up to a mapping of every glyph that can be generated to a code point in the Private Use Area at U+E000-U+F9FF. Such a mapping amounts to a tile set that can be displayed in the TTY or the Curses port. This mapping has, at present, 5719 glyphs. Without changes to the code, such a large mapping becomes impractical for the DOS port running under DOSBox, and for other configurations on slow platforms.

These changes speed the processing of Unicode glyphs, and make the described mapping practical.

I am not including the mapping itself in the pull request, because the list of glyphs may change.

* Load the glyph ID cache when switching symbol sets
* Reimplement the glyph ID cache as a hash table
* Maintain a tail pointer for the linked list of glyphs, to avoid quadratic   time complexity when building that list
* Bypass match_sym for symbols beginning with G_
* Use strcpy in preference to snprintf to construct glyph IDs

Another change fixes handling of -dumpglyphids on Unix."
1156617574,"Don't refer to type-named hat as ""helmet"" (etc...)",entrez,2022-12-09 20:01:03+00:00,2022-12-14 19:37:18+00:00,{},"When a non-metallic hat like a cornuthaum or dunce cap was type-named
""foo"", xname would call it a ""helmet called foo"".  Calling a soft hat a
""helmet"" like that sounded a bit off to me, especially since many other
parts of the game already distinguish between ""hats"" and ""helms"" when
describing headgear -- do the same in xname_flags for type-named hats.

The use of helm_simple_name() means hard helmets are described as
""helms"" instead of ""helmets"".  I'm not sure if that is a big problem.
An inline ternary with ""hat""/""helmet"" could be used instead, but I
figured doing it this way would keep the verbiage consistent if the
""hat"" vs ""helm"" rules in helm_simple_name() were ever updated, and the
additional needless change was probably worth it for that.  Others may
disagree...
"
1150482242,Fix: billing shop boulder pushed thru shared wall,entrez,2022-12-07 02:35:46+00:00,2022-12-14 22:37:18+00:00,{},"I realized that the ""move the boulder billing to 'used-up items'"" part
of 20392a6 didn't properly handle boulder movement from one shop to
another via a gap in a shared wall, becuase it wasn't looking at the
complete in_rooms() array (plus, it only triggered if the new spot
wasn't in any shops at all).  When I tried to fix that, I realized that
stolen_value() was similarly not working reliably when passed a location
shared between two shops, and for the same reason: it was only using the
first character of the in_rooms() array.

I think this patch fixes both those things, but it would be worth
examining the change to stolen_value() carefully, to ensure getting the
roomno via the shkp won't change anything about its normal functioning.
I'm not totally sure about that -- I didn't notice any problems in some
brief tests of typical stolen_value() uses, but it seems like it
probably has some tricky edge cases.

At the very least, passing a boulder fully through a shared wall between
two shops one way, then back the other way, no longer triggers an unpaid
obj sanity check in my testing.
"
1150074765,Limit graves to produce only one corpse/undead mon,entrez,2022-12-06 22:14:21+00:00,2023-01-24 00:37:18+00:00,{},"Graves could produce multiple undead and/or corpses.  For example, as a
sort of worst-case-scenario, for a grave in a bones level: the grave was
generated with the former hero's corpse on top of it.  Then a new hero
engraves on the headstone with a wand of digging and wakes an undead
creature from the grave.  Then the hero digs up the grave with a pick
and finds another corpse or undead monster inside.  That's three corpses
or undead creatures associated with a single grave.

Use the existing 'disturbed' field (actually alias for 'horizontal') to
track whether the grave ought to be empty (i.e. whether it has already
produced a corpse somehow), and check its value before creating more
corpses or undead from a particular grave.
"
1143594234,Some shopkeeper chatting tweaks,entrez,2022-12-02 18:15:31+00:00,2023-01-01 01:37:17+00:00,{},"A mute shopkeeper shouldn't be able to verbally tell you the prices of
objects.  For normal chatting, on the other hand, shk_chat can handle a
mute shopkeeper (by changing from speech to ""indications"" -- hand signs,
body language, etc), so allow execution to reach that even if the
shopkeeper is mute (in a silent polyform).

Also more generally allow a shopkeeper to continue chatting with normal
shopkeeper responses if polymorphed into another creature, since they
apparently retain their minds (are able to tell you prices, can
transact, etc).

This is mostly inspired by the fact shk_chat has extensive handling for
mute shopkeepers, but it was unreachable as far as I can tell.  It is
also funny to think of a newt or something wriggling around to indicate
it's been making a lot of money lately.

Also, use verbalize() for verbal price checks."
1140784689,Fix autodescribe after reading a cursed scroll of gold detection,vultur-cadens,2022-11-30 19:26:30+00:00,2022-12-01 08:38:06+00:00,{},"Autodescribe was not updating during browse_map() when the cursor was moved over a gold glyph that was actually a trap, causing the trap to be described as the previous square that the cursor was on (probably ""unexplored area"") instead of as gold pieces.  This was especially noticeable when using OPTIONS=whatis_coord:m, because the coordinate was not updating when moving the cursor over the trap."
1138399352,Add a funny message for smelling yourself,entrez,2022-11-29 04:02:49+00:00,2023-01-01 00:37:17+00:00,{},"I know this is inane, especially for a little-used debug-mode-only
command, but I can't get it out of my head...

The use of the actual monster data instead of the glyph as a proxy ought
to make it somewhat more consistent as well (e.g. hallucination and
'showrace' won't affect the results), though I think that'd hardly be
worth it were it not for the incredibly funny message.
"
1138219713,Fix: potential use-after-free in expels(),entrez,2022-11-28 23:00:53+00:00,2022-12-01 03:37:17+00:00,{},"An engulfing monster can expel you onto a level teleporter or other
level-changing trap, in which case it may (under highly specific
circumstances[1]) no longer have been in memory by the time mtmp->mx/my
were accessed to see whether the ""Brrooaa"" message should be printed.
It also doesn't make much sense to print that message by the time you've
already fallen through a portal, trapdoor, etc, onto another level, so I
think moving it before the spoteffects() call kills two birds with one
stone.

[1] The highly specific circumstances: you must die due to illness or
some other timeout (or generally die on your own turn rather than the
monsters' turn, since this ensures the level change isn't deferred until
the end of the turn), while engulfed above a level teleporter [or maybe
another similar trap -- I tested with a level teleporter], and be
lifesaved, while positioned such that the engulfer can't follow you
through the levelport after expulsion (e.g. surrounded by other
monsters).  It may happen under some other conditions too, but even if
so it's pretty rare and was tough to reproduce.
"
1138135219,A couple fountain things,entrez,2022-11-28 21:23:04+00:00,2022-12-01 01:37:16+00:00,{},"Some minor fountain things.  Or grease things, I guess, depending on how 
you look at it. Fix a use-after-free when dipping a potion of acid into 
a fountain, and print a message when water damage removes grease from an 
object in your inventory.

- Tell player when water damage removes grease
- Fix: use-after-free when fountain dipping
"
1128834927,Restore compatibility with Qt 4 and older Qt 5,chasonr,2022-11-19 14:59:21+00:00,2022-11-24 02:37:17+00:00,{},"The test system is Slackware 14.2, which uses Qt 4.8.7.

* WANT_WIN_QT4 is defined, and has the expected meaning. Qt 5 is still the default.

* The QT_NO_SOUND macro now excludes all headers and declarations relating to sound; the multimedia package is not needed to build (on any Qt 4, 5 or 6).

* A new function, nh_qsprintf, replaces QString::asprintf, for Qt older than 5.5. These versions do not have QString::asprintf.

* DYNAMIC_STATUSLINES is disabled for Qt older than 5.9. These versions do not have QSplitter::replaceWidget."
1127084721,remove the code to silence lint,argrath,2022-11-18 06:42:04+00:00,2022-11-19 13:37:21+00:00,{},"Warning facilities on recent compilers are incredibly improved, so the code to silence ""good-old"" lint is much less sense."
1125072521,Don't leak ID of magic tools in charging prompt,entrez,2022-11-16 21:02:11+00:00,2022-11-19 13:37:20+00:00,{},"The getobj prompt for charging was presenting any chargeable tool in the
hero's inventory as a suggested charging target, even tools which were
unidentified and undistinguishable from their mundane counterparts
(e.g. bag of tricks, magic harp, horn of plenty...).  This leaked
information about the identity of these items and made it possible to
determine whether a generic 'harp' was magic or not.

When suggesting chargeable tools, include only those which are actually
known to be chargeable (unidentified or unseen chargeable tools can
still be selected, they just won't be suggested targets).  Basically the
same as what's done for a potion of oil in the apply prompt.
"
1122152274,'mdistu' macro and dry rattle message,entrez,2022-11-14 23:58:13+00:00,2022-11-19 12:37:46+00:00,{},"Tries to avoid the message ""a dry rattle comes from its throat"" when you 
can't see a canceled spitting monster, and adds 'mdistu' as shorthand 
for getting the distance between the hero and a monster.

Those may seem unrelated; the reason they're on one branch is because I 
tried to use 'mdistu' in the ""dry rattle"" commit only to realize it 
didn't exist. I really thought something like that was in use already, 
but the evidence seems to suggest I imagined it.

- Fix: ""a dry rattle comes from its throat""
- Add 'mdistu' macro
"
1121988747,Charge hero for making off with shop-owned boulder,entrez,2022-11-14 21:13:29+00:00,2022-11-19 12:37:47+00:00,{},"Pushing a shop-owned boulder out of the shop wouldn't charge the hero
anything.  If the hero pushes a shop-owned boulder out of the shop,
charge for it (and remove it from the bill if the hero then pushes it
back in).  Also tried to handle a couple other uncharged boulder ""theft""
scenarios: pushing a boulder into lava or water, pushing it into a
trapdoor/hole, and pushing it into a level teleporter (various other
traps already charge for the boulder -- it was pretty inconsistent).

I externified onbill() for this, since relying on otmp->unpaid by itself
impossibles if you push a boulder through a gap in a wall between two
adjoining shops.
"
1117085724,Fix parsing of Unicode symsets,chasonr,2022-11-10 03:50:45+00:00,2022-11-24 00:37:17+00:00,{},"At present, if the symbols file has two or more Unicode symsets, selecting any of them will import all settings from all Unicode symsets. This change makes Unicode symsets behave like other kinds: only the selected symset is imported.

It doesn't seem to work with the Rogue level. I guess that's a change for another day.

A use-after-free caused by shuffling gem appearances is also fixed."
1111802095,"Add Unicode, IBMgraphics, DECgraphics and Curses graphics to X11",chasonr,2022-11-05 22:42:52+00:00,2022-11-06 03:37:18+00:00,{},"This adds Unicode support to the X11 front end. It also provides conversions so that IBMgrpahics, DECgraphics and Curses graphics work.

Supplementary characters are not supported. X11 seems capable only of loading PCF fonts, and PCF does not provide for code points greater than 0xFFFF."
1111728812,remove GCC_WARN (again),argrath,2022-11-05 17:45:50+00:00,2022-11-09 00:37:19+00:00,{},"Now, the only usage of GCC_WARN is for the guard of PRINTF_F in wincurs.h.
This guard can be removed safely, as PRINTF_F is already used unconditionally in extern.h."
1110222127,Old software compatibility,chasonr,2022-11-03 23:45:28+00:00,2022-11-06 03:37:18+00:00,{},"* Don't use __attribute__((printf(...))) with function pointers unless GCC is at least 3.1. Older GCCs understand it with functions only.
* Older X servers don't understand ""Fuchsia"", causing impossibles. Use ""magenta"", which is the same as ""Fuchsia"" in the current Xorg.

This pushes back the minimum GCC version to 3.0. NetHack compiled with these changes works with XFree86 4.2.0 and possibly earlier versions as well."
1110045603,Make paralysis intefere with seduction attempts,entrez,2022-11-03 19:41:49+00:00,2022-12-31 23:37:17+00:00,{},"tinklebear on IRC noticed that a hero paralyzed by a floating eye was
still ""charmed"" and capable of ""removing her armor"" as part of a nymph's
theft attack.  The same thing was true of foocubus seduction: a
paralyzed hero was still able to respond to the questions about whether
particular pieces of armor should be removed (and also do whatever else
may be involved in a successful attack...).

I think paralysis should prevent both those things.  Nymph theft will
still work, unless she needs the hero's active cooperation in removing a
bulky piece of armor.  Foocubus attacks will be prevented entirely by
paralysis, making it interfere like unconsciousness already does.

Apply a similar constraint to hero vs monster seduction, as well.
"
1108338800,"Use ""delphi"" as ""oracle"" levelport alias",entrez,2022-11-02 14:27:08+00:00,2022-11-09 00:37:18+00:00,{},"Permit levelport by name to ""delphi"".  That is what the Oracle calls the
level (or at least her room) in-game, so it seems like a natural guess
for the name of the level.
"
1105629415,Message for giving unnameable monster blank name,entrez,2022-10-31 16:52:04+00:00,2022-11-02 04:37:17+00:00,{},"The message for trying to (re)name an unnameable monster was weird when
the player entered a blank name (a name consisting of only spaces), in
an attempt to delete the monster's existing name rather than give it a
new one.  Several of the normal messages looked incomplete due to using
the blank string as the ""new name"" (e.g., ""I'm Feyfer, not .""), and the
one which didn't include the name still seemed a little off (""calling
names"" is almost the opposite of what the player is doing).  Add a new
message for attempting to erase the name of one of the special
unnameable monsters, e.g. ""Juiblex would rather keep his existing name""
or ""The Oracle would rather keep her existing title"".

I also noticed that the message for trying to give an unrenameable
monster the name it already has (e.g. trying to name Death ""Death"") was
revealing the genders of the Riders with personal pronouns.  This is
avoided elsewhere (e.g. using ""the way"" in mdisplacem, ""its"" baked
into the message in mhitm_ad_deth), so I also added a slightly rephrased
alternate message for Riders which avoids any pronouns.  For the
unnaming message, on the other hand, I just used ""its"" for the Riders,
since I couldn't think of a way to phrase it that avoided pronouns
entirely.
"
1104922051,remove the code for embedding SCCS ID,argrath,2022-10-31 06:58:52+00:00,2022-10-31 22:37:24+00:00,{},"This code is for UNIXy build, but current UNIXy builds define GCC_WARN, so this is never used.

(After all, embedding SCCS ID itself is out of date.)"
1103776138,Some displacer beast swapping tweaks,entrez,2022-10-29 02:10:10+00:00,2022-10-30 11:37:23+00:00,{},"When fighting an unseen displacer beast mapped as an 'I' glyph on the
map, its typical ability to swap places with you was disabled and
replaced by it being treated like ""thin air"".  This was because
execution reaches domove_fight_empty when the target swaps places with
you.  Other than the displacement passive, this function is typically
only reached if there's no monster on the target square, so it prints
the ""thin air"" message and wastes a turn if you'd ""expect"" to attack
something (either because the player used an 'F' prefix, or because
there is an 'I' mapped on the destination square being moved into).

Hitting ""thin air"" seems like OK behavior for force-fighting a displacer
beast, since you are explicitly not trying to move into its spot (though
you could probably make an argument that the displacement should happen
even then, since it's the displacer beast initiating it), but the mon
being mapped as an 'I' doesn't seem like a good reason to disallow the
actual displacement from happening.

Don't treat an 'I' as ""thin air"" in domove_fight_empty if there's
actually a monster there, since it means there's a displacer beast
trying to swap places with you.

A couple other related changes: put an 'I' down on the map when an
unseen displacer beast swaps places with you, and use 'something' in the
'it swaps places with you' message when you didn't even realize there
was a monster there to begin with, so there's no context for the 'it' (I
used Some_Monnam at first, but the 'something' felt a little weird when
you were intentionally attacking an 'I' or warning glyph; this limits
the usage of 'something' further than Some_Monnam does).
"
1102443301,Use idPressed signal for Qt 6,chasonr,2022-10-28 01:54:07+00:00,2022-10-28 11:25:02+00:00,{},"Qt 5.15 introduced the idPressed(int) signal and deprecated buttonPressed(int). buttonPressed(int) disappeared in Qt 6, with the result that dialog buttons don't work. This change uses idPressed(int) where it is available."
1102201084,Update Guidebook #showgold info,entrez,2022-10-27 20:03:11+00:00,2022-10-28 06:37:18+00:00,{},"The #showgold command now does mention known contained gold in your
inventory, so the various lines in the Guidebook which explicitly state
that it doesn't needed to be updated.  Wish I had noticed this in time
to put it into the previous Guidebook patch I submitted, but what can
you do.
"
1101743399,"Remove urace test from is_elf, etc, macros",entrez,2022-10-27 13:59:21+00:00,2022-10-27 18:37:21+00:00,{},"Reverts 690e072, which changed the various is_foo macros from this:

```c
#define is_elf(ptr) ((((ptr)->mflags2 & M2_ELF) != 0L)
```

to this:

```c
#define is_elf(ptr) ((((ptr)->mflags2 & M2_ELF) != 0L)     \
                     || ((ptr) == g.youmonst.data &&       \
                         !Upolyd && Race_if(PM_ELF)))
```

This is a problem because g.youmonst.data is not unique to the hero:
the '(ptr) == g.youmonst.data' test will also be true of all player
monsters of the same role.  For this reason, any of those player
monsters will be treated as sharing the hero's race, producing strange
results.  For example, if the player is an elven ranger, any ranger
player monster generated will be considered 'elven' too (so will get a
to-hit bonus when attacking orcs, etc) -- but only while the hero is
unpolymorphed.

There are already other ways of checking the hero's race in addition to
her current polyform, most notably the maybe_polyd() macro.  maybe_polyd
or something similar is already used in nearly all the cases where the
hero's race is being evaluated, meaning Race_if gets used instead when
the hero is in her natural form.  So I think the check of the hero's
race in is_foo had very little effect except for the unintended
side-effects on player monsters.

In reviewing all the uses of is_{elf,dwarf,gnome,orc,human}, I noticed
only one case that relied on the hero-race-checking behavior.  That has
been changed in this commit to use maybe_polyd (there's another 'raw'
is_human(g.youmonst.data) a few lines down, but it doesn't need
maybe_polyd since it already distinguishes between 'hero in nonhuman
polyform' vs 'nonpolyd or human polyform').  same_race(mondata.c) is
another case where &g.youmonst.data can be passed to is_foo, but
everywhere that calls it for the hero also calls your_race() or
same_race(&mons[Race_switch]) to handle the racial case.
"
1101084976,Support Unicode on Qt,chasonr,2022-10-27 02:35:04+00:00,2022-10-27 18:37:21+00:00,{},Tested on Linux Mint with Qt 5 and on Mac OS with Qt 6.
1096813584,Remove null characters from Qt y/n prompt,chasonr,2022-10-24 02:11:36+00:00,2022-10-26 02:37:17+00:00,{},Fixes issue #566.
1096415939,Rename update_mon_intrinsics to ...extrinsics,entrez,2022-10-23 02:05:37+00:00,2022-10-23 11:37:27+00:00,{},"There was a TODO about this; not exactly a great challenge but it feels
like a worthwhile change since the name was misleading.  I also updated
the name of the do_intrinsics parameter of extract_from_minvent(worn.c),
since it was in a similar situation (and directly related, since it
controls whether to call update_mon_{in/ex}trinsics).
"
1096263873,Carrying a blessed loadstone bestows steadfastness,Theyflower,2022-10-22 17:24:41+00:00,2022-10-23 11:37:26+00:00,{},I was poking around to read the source code of the new knockback change and mentioned to some people that holding Giantslayer prevents the wielder from being knocked back. Many of them mused possessing a loadstone should also grant steafastness. This is my attempt at implementing such a change.
1092560717,Fix: duplicate invlet from throwing obj with count,entrez,2022-10-19 15:48:18+00:00,2022-10-23 11:37:27+00:00,{},"Specifying a count of 1 when throwing an object could leave you with two
stacks sharing one inventory letter.  The second stack gets split off
when the player specifies a count (e.g. 't1o'), but keeps its original
invlet.  Some early returns, like trying to throw at yourself with '.',
could fail to unsplit the stack.  Theoretically, specifying multiple
items to multishot and then failing to throw them all could also leave a
partial stack; I don't think this is actually possible right now with
't' but I tried to make sure it won't become a problem if greater counts
than 1 are ever allowed.

The fix doesn't affect 'f', which can be a combined ""create a quiver
stack and throw"" action and doesn't have the issue with duping invlets.
Specifying a count to split off a new quiver stack with 'f' shouldn't be
reverted if the throwing fails or only part of the stack is thrown,
because the newly created stack may be intended for continued use as the
quiver in future turns.  This slightly changes the behavior of the
existing unsplit when cancelling the throw (which previously unsplit the
newly created quiver and quivered the entire parent stack), but I think
this actually makes more sense -- the player only declined to throw the
new stack, not to create it (as if they canceled earlier in the action).

I routed a couple early returns through the stack unsplitting that
shouldn't actually need it (like Mjollnir and welded items) for
consistency's sake; I don't think it hurts anything.
"
1090095749,Support Unicode on Win32,chasonr,2022-10-18 00:57:08+00:00,2022-10-23 20:37:19+00:00,{},"This change adds Unicode support, with colors, to the Win32 port. It supports copying Unicode to the clipboard and saving it to a file.

While testing the clipboard support, I found some crashes. This change fixes the crashes."
1088463944,The word 'Current' is unnecessary here (and in general).,zomGreg,2022-10-16 18:11:18+00:00,2022-12-21 11:37:18+00:00,{},"On the enlightenment output, the word Current is superfluous. In general, the word Current is unnecessary. "
1088149749,Provide characters missing from Terminus fonts,chasonr,2022-10-15 13:10:29+00:00,2022-10-15 21:37:18+00:00,{},"The provided symbols file uses three characters that the Terminus fonts do not provide. This change extends makefont.lua to accept multiple input files, and provides the missing characters."
1081265051,Support Unicode symbols in the DOS TTY port,chasonr,2022-10-09 13:07:15+00:00,2022-10-09 17:37:35+00:00,{},"Use the same external fonts as the Curses port, and compile these unconditionally. Include support for 24 bit color in VESA mode."
1081090625,Avoid null dereference in VESA initialization,chasonr,2022-10-08 19:44:36+00:00,2022-10-09 16:37:18+00:00,{},"If the VESA mode chooses a mode with 8 bit pixels, but the tile set has too many colors for that, a null dereference can result when trying to set up the nonexistent palette. Catch this condition and refuse to set VESA mode instead."
1080628162,Some autounlock option tweaks,entrez,2022-10-07 17:28:29+00:00,2022-10-13 04:37:18+00:00,{},"A couple changes related to 'autounlock' option: the way the in-game 
option handler menu is presented, and a fix to the error handling for 
the rcfile parsing.

- Remove explicit 'none' opt from autounlock handler
- Fix: error handling for invalid autounlock value
"
1078156521,Make #attributes gold info match #showgold,entrez,2022-10-06 03:20:32+00:00,2022-10-13 04:37:17+00:00,{},"The #showgold command now mentions (known) gold socked away in
containers in your inventory as of 706b1a9.  Since the gold info in the
attributes display and dumplog matches the output of #showgold
otherwise\*, update it to do the same thing.  Also refactored doprgold a
bit to be a little more compact, as opposed to enumerating all the
different combinations of gold/no gold in open inventory/containers.
This eliminated some string constants that were broken up into multiple
constants/lines (like ""line 1 "" ""line 2""), which NetHack code style
seems to prefer to avoid.

Maybe there's a reason this is not wanted in #attributes, but since it 
acts basically like a version of the statusline info with additional 
supplementary information, it doesn't seem too out of place to me (that 
seems to be a model used by other #attributes lines as well).  And it 
does match the new and improved #showgold, too.

\* Other than shop billing info.

"
1077633851,"Don't repeatedly print ""skates!"" during ice travel",entrez,2022-10-05 17:23:42+00:00,2022-10-07 08:44:38+00:00,{},"This is presumably a debug pline that got left in by mistake.  It would
print repeatedly when a Valkyrie tried to travel over ice (e.g. in her
quest), or other circumstances in which the hero was considered to
be 'wearing skates' on ice.
"
1076613102,Fix: nonadjacent grabber after move,entrez,2022-10-04 23:31:05+00:00,2022-10-09 04:37:18+00:00,{},"A monster which has grabbed you could move away without becoming unstuck
if it hit the ""move and shoot"" or ""helpless"" conditions in the dochug
MMOVE_MOVED case (since those lead to early return or break), leaving
the hero stuck to a monster which is no longer adjacent.  Put the
'grabber moved away -> become unstuck' stuff at the top of the block so
that it will always be evaluated if a grabber has moved.

I would have liked to move the whole ""grabber checks"" block up, but I
think it'd change behavior to have the u.uswallow attack come before the
early return for a helpless monster, so I split it up instead.
"
1076570331,Fix: 'weaken target' spell vs poly'd hero can leave hero with negative health,entrez,2022-10-04 22:24:31+00:00,2022-10-09 04:37:18+00:00,{},"losestr can subtract HP, but doesn't directly kill its target.  The
caller is responsible for possibly killing the hero if losestr reduces
her HP to 0 or lower; most callers do this by combining losestr with a
losehp call, which can kill off the hero if necessary.

MGC_WEAKEN_YOU calls done_in_by if u.uhp < 1 after losestr, but didn't
handle the Upolyd u.mh case, so could leave a polymorphed hero with
negative health.

The simple fix to this is in the first commit (I don't think the second 
would do any harm, either), and it may be that is really all that's 
wanted/needed.  The ones after that ended up turning into another 
approach which I think is more robust in some ways, but also has some 
downsides.  It moves the responsibility of handling death/rehumanization 
from the caller to losestr, so reduces the potential for error there, 
but messes somewhat with how death from the 'weaken target' spell 
works/is described."
1076306570,Fix HANGUPHANDLING ifdef for TTY,entrez,2022-10-04 17:24:27+00:00,2022-10-05 02:37:18+00:00,{},"The SIGHUP handling for the TTY windowport added in 594cb5f was wrapped
in '#ifdef HANGUP_HANDLING', but the actual define is 'HANGUPHANDLING'
without the underscore.
"
1074006017,Provide Unicode support to DOS Curses port,chasonr,2022-10-03 01:05:47+00:00,2022-10-06 21:37:21+00:00,{},"These changes offer support for Unicode in the DOS Curses port, and also
close issue #886.

1) Offer PDCursesMod as an alternative implementation of PDCurses for the DOS port.

PDCursesMod is available at https://github.com/Bill-Gray/PDCursesMod . This fork of PDCurses offers an implementation that works through the VGA graphical modes, offering greater resolutions and support for Unicode-capable fonts.

This change loads PDCursesMod at lib/pdcursesmod (or lib/pdcurmod if building natively on DOS). If WANT_DOSVGA=1 is specified to the make command, the build will look for PDCursesMod and its ""dosvga"" port. If not, the build will look for mainline PDCurses as before.

TODO: PDCursesMod also offers a ""wingui"" port that can work with Windows.

2) Provide the UTF-32 code point to the windowing code

A field utf32ch is added to struct unicode_representation. This gives the Unicode code point from the symbols file. Curses and many other user interface libraries more easily work with this code point than with UTF-8.

TODO: Use this to prove Unicode support for X11, Windows graphical and the DOS TTY interface.

3) Call the wide character function to display a Unicode map symbol. When H_IBM is in effect, convert from IBM437 to Unicode.

4) Provide external fonts for the DOS Curses build

These fonts are derived from the Terminus font project, hosted at https://sourceforge.net/projects/terminus-font/ . A program, makefont.lua, is provided to convert the BDF files to the PSF form that PDCursesMod expects. Because building the fonts from the cross-compile proved overly complicated, I have provided the compiled fonts in binary form.

TODO: The DOS TTY port could use all of these fonts in VESA mode, and the 8x16 fonts in 16-color mode.

5) Fix the native build for DOS, and make it accept WANT_WIN_CURSES and WANT_DOSVGA as the cross-build does."
1073588522,Fix: possible themed room shop where shopkeeper permanently blocks entry,copperwater,2022-10-01 15:32:50+00:00,2022-10-09 04:37:19+00:00,{},"Reported by every for xNetHack. This bug is latent in vanilla, but can easily start to present itself if themed rooms of a certain shape are added. Ultimately, it comes from an assumption that shops will always be rectangles of at least size 2x2, and the shopkeeper will always be able to step diagonally backwards from their normal position just inside the door in order to get out of the player's way.

Themed rooms introduce the possibility of shops where the shopkeeper has only 1 square adjacent to their normal position to move to - effectively, the shop entrance is a narrow corridor. When this happens, they have nowhere to go to allow the player to enter or leave the shop, leaving it permanently blocked unless the hero teleports or falls in or out.

This fixes that by adjusting the shop algorithm to detect when a shop candidate room is set up like this, and excludes it from becoming a shop.

Test case for this: insert the following into the themed rooms array (this is a room from xNetHack, minus the 1400 frequency).
```lua
   -- Four-way circle-and-cross room
   { frequency = 1400, contents = function()
      des.map({ map = [[
xxxx---xxxx
xxxx|.|xxxx
xxx--.--xxx
xx--...--xx
---.....---
|.........|
---.....---
xx--...--xx
xxx--.--xxx
xxxx|.|xxxx
xxxx---xxxx]], contents = function(m)
         centerfeature = percent(15)
         des.region({ region = {5,1,5,1}, irregular=1,
                      type=centerfeature and ""themed"" or ""ordinary"" })
         if centerfeature then
            des.terrain(5, 5, percent(20) and 'T' or '{')
         end
      end })
   end },
```"
1072026387,Fix: X11 extcmd menu heap buffer overflow,entrez,2022-09-30 00:37:48+00:00,2022-09-30 20:37:19+00:00,{},"Instead of allocating space for ((n + 1) * size) (to make room for all
entries plus terminator), it allocated space for (n * size + 1).
init_extended_commands_popup would therefore write past the end of the
memory allocated for command_list and command_indx when trying to store
their respective terminator entries.  This meant the X11 windowport
would crash when accessing the extended command menu, if NetHack had
been compiled with -fsanitize=address.

I also did some minor cleanup/refactoring to eliminate variables and
lines that were made redundant or useless by 9d64d13, which changed the
way the function worked and removed the need for things like tracking
indices in the source and destination arrays with separate variables.
"
1069370655,Digestion attack can grant hero intrinsics,entrez,2022-09-28 01:58:26+00:00,2022-10-09 03:37:19+00:00,{},"Monster purple worms can now gain intrinsics from swallowing foes whole,
so maybe the hero should be able to do so too.  Intrinsics aren't
granted immediately upon swallowing (that would probably have been
easier), but only once a corpse is created and then entirely digested.

I'm not sure if this is too powerful and was being avoided deliberately
for that reason, since it includes potential level gain from wraith
corpses in addition to other intrinsics.  That's consistent with monster
purple worms but may be a bit too much in the hands of the hero, though
it is limited by needing the corpse creation roll to succeed.  Putting 
it out here to see what people think about it.
"
1069350809,A couple genocide prompt tweaks,entrez,2022-09-28 01:20:18+00:00,2022-09-29 02:37:17+00:00,{},"Treat hitting Enter on an empty line consistently between genocide and class
genocide prompts, and use flags.cmdassist to decide whether to show additional
help.
"
1069344751,Fix undefined behavior when exiting Curses,chasonr,2022-09-28 01:08:57+00:00,2022-09-29 02:37:16+00:00,{},"* When saving: curses_exit_nhwindows calls curses_uncurse_terminal, which calls endwin. curses_exit_nhwindows then calls raw_print, which calls more Curses functions after endwin has been called. Fix this by having curses_raw_print use puts if window_inited is false.

* When dying, quitting, etc.: really_done opens the ""Goodbye"" window, which refreshes the other windows when it closes. But the status window (and possibly the map and message windows) are gone by that point. The window pointers are properly NULLed, but the NULL is then passed to touchwin. Fix this by checking window pointers for NULL.

These bugs manifest as crashes on exit when the @Bill-Gray fork of PDCurses (https://github.com/Bill-Gray/PDCursesMod) is linked to a cross-compile to MS-DOS. This fork has the potential to offer a much-improved Curses port on DOS, but I also uncovered some bugs in PDCursesMod."
1063501697,Hole/trap door destination fixes,entrez,2022-09-22 00:43:01+00:00,2022-09-22 08:38:13+00:00,{},"Attempted fixes for various issues stemming from 05761ba, mostly interactions
between holes/trapdoors and bones files: e.g. holes can deposit you backwards,
onto a higher level than you started on, or into the Sanctum prematurely (even
after applying ccaadaa).

- Fix: antigravity trap doors
- Have monsters' hole destination match the hero's
- Prevent hero from falling past end of dungeon
- Refine attempt to clamp trap door fall destination
- Apply dest. limit to monster trap door usage
"
1060991078,Fix: starving herbivore pet vs polymorphing corpse,entrez,2022-09-20 02:37:11+00:00,2022-09-21 23:37:19+00:00,{},"The special handling of polymorphing corpses included an ""is acceptable
food if starving"" rule which ignored the pet's other food preferences,
so a starving herbivorous pet would become willing to eat a
non-vegetarian corpse iff the corpse would polymorph it when eaten.
Along the same lines but latent: if there were a vegan polymorphing
corpse, a carnivorous pet would eat it not only if starving, but also if
maltreated and on the verge of becoming feral.

Instead of trying to fix this by reimplementing all the herbi vs carni
rules specifically for polymorphing corpses, just have a ""don't eat
polymorphing corpses if neither starving nor almost untame"" rule, and
fall back to the normal palatable corpses tests once it's been
determined that the pet is willing to eat even a polymorphing corpse.

I rephrased the comment just to make it negative (about avoiding
polymorph, rather than polymorph being OK under certain circumstances)
to match the new form of the rule.
"
1059263624,"Use a space instead of a hyphen in ""disintegration-resistant""",vultur-cadens,2022-09-17 06:49:01+00:00,2022-09-21 01:37:18+00:00,{},"This is for consistency with the other resistance insight messages, which use spaces instead of hyphens."
1059230391,Fix: impossible from splitting named stack on bill,entrez,2022-09-17 02:56:54+00:00,2022-09-20 06:37:18+00:00,{},"Trying to split an unpaid stack of named items in a shop, with
perm_invent enabled, would cause an impossible 'unpaid_cost: object
wasn't on any bill' because copy_oextra -> oname triggered an inventory
update while the newly created split stack was marked unpaid but before
the billing information had been split to match.  Defer the copy_oextra
call until the billing info has already been split.
"
1055303487,Sundry fixes for DOS 16-color VGA mode,chasonr,2022-09-14 00:01:12+00:00,2022-09-14 07:37:18+00:00,{},"To test 16-color mode, specify OPTIONS=video:vga explicitly; autodetect will choose a VESA mode if it can.

* Draw tiles correctly when redrawing from panning or from changing the map mode among text, tiles and overview. Previously, this would draw everything with the tile at the hero's position.

* Draw corridor walls with the stone tile.

* Map the statue colors to the nearest neutral tone among the main 16 colors. This mainly affects altars and female cats.

* Fix the code that shows statues as the generic statue tile. This code could be deleted, but the statues don't draw with the full range of gray tones.

* Document the option OPTIONS=video:vesa."
1052137385,Improve description of invisible mon revival,entrez,2022-09-10 03:44:29+00:00,2022-09-21 01:37:18+00:00,{},"An invisible monster reviving would be called ""it"" (as in, ""It rises
from the dead!"").  Improve on this a bit by instead saying that ""the
troll corpse disappears!"" (similar to the messaging used when undead
turning is used on an invisible monster's corpse), or calling the
revived monster ""something"" (as in ""something escapes from a sack!"")
instead of ""it"".  Distinguish between the original location of the
corpse and the location of the revived monster when describing seeing
things that have happened to the corpse, since revival may not place it
on the corpse's location.
"
1051095859,Hobbit Zombies and Mummies,klorpa,2022-09-09 04:32:19+00:00,2024-08-18 21:03:25+00:00,{},"Adds zombie and mummy versions of hobbits. Also adds ""is_kobold"" and ""is_hobbit"" functions, fixes spelling errors, and standardizes some spellings to American English."
1049491287,Spelling Fixes and Standardizations,klorpa,2022-09-08 04:14:07+00:00,2022-09-08 19:37:18+00:00,{},
1045743509,Make replace_terrain respect fromterrain='w',copperwater,2022-09-04 16:38:52+00:00,2022-09-23 11:37:18+00:00,{},"Noticed that an attempted terrain replacement wasn't taking hold even
though 'w' is supposed to mean ""match any stone or wall""; this was
because w converts into non-terrain-type MATCH_WALL and replace_terrain
was doing a simple comparison on whether the potentially replaced
terrain matches that type. Add a special check here for w so it will
match the terrain types it's supposed to.

Note that using replace_terrain with 'w' now WILL match stone, since
this is the documented behavior of w, to match IS_STWALL rather than
just IS_WALL. If a level designer really wants to exclude stone, they
can work around this by either making a selection and filter out stone
terrain, or doing two replace_terrains with '-' and '|'.

Tested this by turning 40% of bigrm-1 walls to lava."
1045566857,Move levitation potion headache false rumor into true rumors,jpsenior,2022-09-03 22:18:25+00:00,,{},"Quaffing a cursed potion of levitation does indeed cause a headache, up to d10 damage.  Assuming one was quaffing 'many' unidentified potions, it's possible one of them is indeed cursed when the player hits their head on the ceiling.

https://github.com/NetHack/NetHack/blob/f5a9901db1d9e7ebc97f4ad1fdffebb695ca2b79/src/potion.c#L1182"
1043568441,Make des.mineralize use default probabilities,copperwater,2022-09-01 11:06:38+00:00,2022-09-01 14:16:52+00:00,{},"Calling des.mineralize() with no arguments was equivalent to calling it
and manually specifying gem_prob = 0, gold_prob = 0, etc. Which meant
that no mineralization would actually happen.

Instead, make this match the intuitive behavior, and pass in -1
probabilities as defaults -- which the mineralize() function interprets
as the caller wanting to use the standard probabilities for a level of
that depth, as if it were not a special level.

This change does not affect any special level files since des.mineralize
is not currently used in any of them."
1042646243,Fix inaccessible spaces and shop backdoors in Bustling Town,copperwater,2022-08-31 17:07:01+00:00,2022-09-01 14:14:21+00:00,{},"Perennial problem: since Bustling Town consists of a fixed map which was
shorter than the moveable area overlaid onto a cavern fill, sometimes
the cavern fill made spaces above or below the walled edges of the town,
which then got cut off when the town was placed. Since one of the valid
ways to generate a way out of an inaccessible space is to create a door
connecting it to an accessible space, this meant rooms in Minetown,
including shops, could get a second door leading into that tiny space.
And if it was a shop, the shopkeeper could not block exit from the
second door.

This fixes that issue by expanding the map vertically so that it will
overwrite the whole cavern fill in the town area of the map segment
where it might create cut-off spaces like this. (Not the whole area -
since we now have the 'x' mapchar to leave existing terrain in place,
areas adjoining open space where inaccessible pockets won't get
created can retain any existing fill to keep the town from being exactly
the same every time)."
1041530229,Some minor read_simplemail improvements,entrez,2022-08-30 22:20:24+00:00,2022-09-01 14:09:49+00:00,{},"Make admin message use urgent_pline so it's less likely to be skipped
and inadvertently missed, make ending punctuation conditional on message
itself not containing any (similar to what's done for T-shirt messages
in read.c), guard against printing an empty message (from a line like
""name:\n""; it does mean that subsequent messages in a single batch will
be discarded, but that's true of the existing guard against malformed
lines as well, and it should make the overwriting of characters past the
'msg' ptr safer).
"
1038909180,Move 'major events' section in dumplog,entrez,2022-08-28 15:55:26+00:00,2022-08-29 02:37:18+00:00,{},"The sections of the dumplog can be broadly organized into two
categories: 'current state' and 'game overview'.  Current state includes
information about what exactly was happening when the game ended: the
map, recent messages, current inventory, and current attributes.  Game
overview is more like a history of the game up to that point: vanquished
monsters, extinct species, conducts, and dungeon overview.

All the current state sections are listed first, followed by the game
overview sections -- I'm not sure if this was a deliberate move to break
the dumplog into two distinct 'chapters', but it's convenient for
readers who may only want to know the circumstances of a death without
seeing the nitty-gritty details of the entire game up to that point.

The one section that wasn't ordered with its category was major events,
which was positioned near the top of the 'current state' group, above
the inventory listing.  This commit moves it into the 'game overview'
group.  I put it at the top, since it can serve as a sort of summary of
the game for those who are interested but don't care about some of the
details of monsters killed, etc.
"
1038872152,Enhance feedback from detect unseen,copperwater,2022-08-28 12:54:23+00:00,2022-08-28 15:45:58+00:00,{},"I was never too happy with how this was a silent effect that required
you to watch the map to see if anything changed. It might count as
an accessibility issue as well, not sure.

This change adds specific feedback for all the possible things that
might get revealed by detecting unseen. If you reveal a secret door or a
trap, you now get a message indicating that."
1038866447,"Remove ""danger sense"" message for a monster you can already see",copperwater,2022-08-28 12:25:36+00:00,2022-08-28 15:42:53+00:00,{},"If you had both warning and ESP, you would get the message ""Your danger
sense causes you to take a second look close by"" when moving next to a
monster that is technically ""undetected"" (according to mundetected) but
was actually apparent to the player via ESP. For instance, moving next
to an eel hiding in the water would produce this.

Since there was no follow-up message (""You find a <monster>"".) and no
new information being given to the player, the ""danger sense"" message
was pointless, and so I removed it in this case when the warning doesn't
lead you to find anything new."
1038693551,Fix: overwriting stairs in movement tests,entrez,2022-08-27 19:19:46+00:00,2022-08-31 15:25:02+00:00,{},"Like some of the other coordinates in testmove.lua (addressed in
70008fc), the attempt to overwrite the stairs was targeting a spot
one space to the left of the actual position of the stairs, causing it
to have no effect (discussion suggested this may have been a result of
99715e0).  Update it so the stairs are properly erased and won't
interfere with movement tests by stopping a running/rushing hero early.

Discussed this with paxed already on IRC so it may be that a fix is 
already planned or on its way, but since it's been a day or so without 
any movement and I had already made this branch locally, I thought I'd 
open a PR in case it makes things easier.
"
1036161228,Fix: IS_SUBROOM_INDEX range,entrez,2022-08-25 02:07:14+00:00,2022-09-29 01:37:24+00:00,{},"The macro (currently unused, I think) for checking whether a particular
index designates a subroom was off by one on the maximum allowable
value.

Because of the dedicated extra space for the g.rooms array terminator
flag (hx == -1), subroom indices in g.rooms are set out in the range
[MAXNROFROOMS+1, MAXNROFROOMS*2], inclusive.

Also some minor formatting tweaks.
"
1035793948,Describe engulf attacks a bit more consistently,entrez,2022-08-24 17:30:41+00:00,2022-09-21 04:37:17+00:00,{},"Use verbiage for mon vs mon and hero (mostly hero) engulf attacks that
matches recent changes to monster vs hero engulf attacks more closely
(e.g. ""swallows whole"" instead of ""engulfs"" for purple worm, other
changes in b07fe59...).  Also ensure non-AD_DGST engulf attacks
(e.g. from revamped trapper or lurker above polyforms) aren't treated as
""eating"" (or as involving ""debris"").

Also change the enfolds and digests macros so they produce booleans
rather than attack pointers (I got a compiler warning about casting
struct attack * to boolean when I did 'boolean b = digests(ptr);').
"
1031623589,Fix: levelport by name to unconnected branch,entrez,2022-08-19 23:04:19+00:00,2022-08-29 04:37:17+00:00,{},"(unconnected to the current dungeon branch, that is)

Level teleporting allows you to type in the name of a level instead of
its number.  This normally only works for levels within your current
dungeon branch (main dungeon <-> Gehennom levelports are the exception):
entering ""medusa"" as a destination won't work while the hero is in the
Gnomish Mines, but it will work fine to get to the Medusa level from
elsewhere in the main dungeon.

Teleporting to a particular branch entrance didn't apply the same
restriction.  The teleport would still happen even if the destination
branch was unreachable from the current branch, and in such a case the
game would just try to get the hero to the depth of the branch entrance,
within the current branch.  For example, entering ""quest"" as a
destination within the Gnomish Mines would bring the hero to Mines' End,
since that's the closest depth-wise it's possible to get to the quest
portal level.  Apply the same heuristics to branch entrances as exist
for named levels, excluding destinations that are unreachable from the
current branch.

I'm not sure if this commit is the best way to apply the rule
consistently; an alternative option would be to just place one test at
the end, with structure somewhat along the lines of this diff (against
the commit in this PR):

```diff
diff --git a/src/dungeon.c b/src/dungeon.c
index 95e40bfe8..792930543 100644
--- a/src/dungeon.c
+++ b/src/dungeon.c
@@ -2025,11 +2025,9 @@ lev_by_name(const char *nam)
 
     if (mseen || slev) {
         idx = ledger_no(&dlev);
-        if (dlev_in_current_branch(dlev)
-            && (/* either wizard mode or else seen and not forgotten */
-                wizard
-                || (g.level_info[idx].flags & (VISITED))
-                       == VISITED)) {
+        /* either wizard mode or else seen and not forgotten */
+        if (wizard
+            || (g.level_info[idx].flags & (VISITED)) == VISITED) {
             lev = depth(&dlev);
         }
     } else { /* not a specific level; try branch names */
@@ -2051,12 +2049,11 @@ lev_by_name(const char *nam)
                     idx = idxtoo;
                 dlev.dnum = ledger_to_dnum(idx);
                 dlev.dlevel = ledger_to_dlev(idx);
-                if (dlev_in_current_branch(dlev))
-                    lev = depth(&dlev);
+                lev = depth(&dlev);
             }
         }
     }
-    return lev;
+    return (lev && dlev_in_current_branch(dlev)) ? lev : (schar) 0;
 }
 
 #undef dlev_in_current_branch
```

It made me a little nervous to use 'lev' as a proxy for whether 'dlev'
has been initialized, though, since I'm not sure if they'd necessarily
always have to be so tightly coupled in the future.  That might be
(and probably is) pointless and unnecessary fretting...
"
1030414506,"Don't describe sleep explosion as a ""ray""",entrez,2022-08-18 20:01:15+00:00,2022-08-19 01:37:18+00:00,{},"When breaking a wand of sleep, don't print the message ""the sleep ray
hits you!"" since it produces an area effect/explosion rather than a ray.
For a couple other wands, !ordinary (wand breakage) effects don't
produce a message (I assume because the do_break_wand feedback is
considered sufficient), but I put in an alternative message for the
explosion since I think it's important to inform the player the hero has
fallen asleep.
"
1029054760,remove `GCC_WARN`,argrath,2022-08-17 16:21:47+00:00,2022-09-06 17:24:26+00:00,{},"It's unlikely to use gcc without enabling warnings, so:
 * substitute `GCC_WARN` to `__GNUC__` in sources
 * remove them from hints"
1026957543,Fix: double documentation for 'tilenm' in PCHAR2,copperwater,2022-08-15 22:30:07+00:00,2022-08-19 17:37:17+00:00,{},Documented twice; remove the second less discriptive one.
1026087237,remove unnecessary `if`,argrath,2022-08-15 06:09:54+00:00,2022-08-19 22:38:59+00:00,{},
1025789981,Fix a couple latent bugs with initial rings/other charged items,copperwater,2022-08-14 11:58:23+00:00,2022-08-15 06:07:14+00:00,{},"These bugs are currently latent only because no role's starting
inventory happens to satisfy the conditions under which it would show
up. This commit contains the xNetHack fixes for them.

Bug 1: if a role received a specific charged ring (versus a random
ring), it would be possible for that ring's charge to be <= 0, since the
code currently only caught this case for random rings. Move that clause
outside the if (UNDEF_TYP) clause.

Bug 2: non-ring oc_charged items of UNDEF_TYP that randomly rolled a
starting charge/enchantment <= 0 would always be enchanted, sometimes
very highly, because their enchantment was getting set to rne(3) by
hitting this case, which is only intended for rings as a comment
indicates. In particular, Archeologists' starting pick-axe would hit
this case after moving it out of the UNDEF_TYP block, but it would also
apply to any role receiving a random tool or weapon-tool at the start
of the game."
1025701359,"Level teleporters always print ""momentarily disoriented"" message",copperwater,2022-08-14 01:53:45+00:00,2022-09-25 02:37:17+00:00,{},"Removing the message ""You are momentarily blinded by a flash of light""
and keeping the alternate message that was formerly shown only when
blind. There are three reasons:
1. This effect doesn't actually blind you.
2. This effect *does* momentarily disorient you (i.e. confuse you.)
3. This is the exact same message as the summoning/blinding effect of a
   magic trap, and it's easy to conflate the two."
1025697314,Remove obsolete find_skates function,copperwater,2022-08-14 01:12:49+00:00,2022-08-14 07:15:01+00:00,{},"find_skates was still in use for its one intended case, but objdescr_is
has been around for a few years now and can do just as good a job
without having to hardcode the first and last boots in objects[]."
1025685196,Fix: prevent traps in shops in the Tourist quest,copperwater,2022-08-14 00:10:04+00:00,2022-09-23 11:37:18+00:00,{},"The Tourist locate and goal levels have 2 shops each, and also have
various traps randomly placed on the level. Unfortunately, this does not
account for placing them in the shops, so it was possible to wind up
with a magic trap or falling rock trap or whatever inside the shop,
which the shopkeeper would not clean up.

This commit makes selections that exclude the shop areas, and picks the
traps from those selections, keeping the shop floors trap-free as their
customers expect."
1025488945,Fix: engulf/digest intrinsic granting,entrez,2022-08-13 02:14:37+00:00,2022-08-24 06:37:16+00:00,{},"Engulfing pets were getting a double chance to get an intrinsic from a
digestion attack, because they got the mon_givit call in mhitm_ad_dgst
and then also the one in mdamagem.

There is a bit of inconsistency here, in that mhitm_ad_dgst requires
corpse creation to grant nutrition, but the non-nutrition effects of
eating a corpse like polymorph, extra health, etc, in mdamagem don't
have any such requirement.  As a result, one of the mon_givit calls
required a corpse to be ""created"" before granting an intrinsic, and the
other didn't.   In choosing which one to remove, I figured intrinsic
granting is probably closer to those special effects than providing
nutrition (and also putting it in mhitm_ad_dgst is not ideal w/r/t
message ordering: it causes the 'intrinsic granted' message to appear
before the monster kill message).
"
1024017693,Monster looting improvements,NullCGT,2022-08-11 15:32:16+00:00,2023-04-11 17:38:42+00:00,{},"- Implemented cursed bag of holding behavior for when monsters loot a cursed bag of holding.
- Allow monsters to loot containers at their location instead of picking them up.

I avoided adding behavior for monsters unlocking containers. It would not be difficult to add, but the number of times we would need to iterate through a monster's inventory for such a niche behavior was difficult for me to justify."
1022709352,Fix: m-prefix looting a container,entrez,2022-08-10 13:24:50+00:00,2022-08-10 16:56:10+00:00,{},"Using #loot with the 'm' prefix would claim there was nothing to loot
even if the hero was standing on a box, as long as there was no adjacent
monster.  'm' prefix is an explicit request to select a direction so
make it work regardless of whether a monster is there.  Once I did that
I noticed that it was providing no feedback for using '.' or '>' as the
direction if no container was available, so adjust that to give the
""there is nothing here to loot"" feedback.
"
1022706387,"Describe engulf attack by animal as ""swallowing""",entrez,2022-08-10 13:22:21+00:00,2022-08-10 16:57:14+00:00,{},"Suggested by aosdict: instead of describing all gulp attacks as
""engulfing you"", say ""The <monster> swallows you whole"" for purple worms
(or any other animal engulfer) to visibly differentiate between
engulfing and swallowing.
"
1022133754,Improve feedback for trying to bribe the watch,entrez,2022-08-10 02:01:10+00:00,2022-08-10 16:58:10+00:00,{},"Members of the watch can never be bribed, no matter how much gold is
thrown at them, but when a bribe was attempted they would say ""that's
not enough"" (implying incorrectly some higher amount would be enough to
pacify them).  Also, an already-peaceful mercenary would take on an
unusually aggressive tone when given any amount of gold, giving the
player the same message to ""beat it"" as when a bribe succeeds in
pacifying them.

Adjust the mercenary bribery code a bit so that a more friendly message
is given if the monster is already peaceful, and so that unbribeable
monsters don't imply they are just not being given enough gold.  I think
the actual effects of bribery shouldn't be affected by this commit, just
the messages/feedback.
"
1020815667,"Refer to non-damaging gas cloud as ""steam""",copperwater,2022-08-08 22:14:58+00:00,2022-08-10 16:59:04+00:00,{},"You can create steam clouds that are gray and deal 0 damage when zapping
fire at or over water sources. If you happen to be in the cloud, it
produced the ""You are enveloped in a cloud of noxious gas!"" line, and
steam isn't noxious.

Other uses of ""gas cloud"" could have potentially been changed, but I
left them alone."
1017871709,Fixes related to command counts,entrez,2022-08-04 18:03:17+00:00,2022-08-06 13:46:30+00:00,{},"Fix some regressions caused by 3.7 refactors: using a count with an altmeta
meta key command, and specifying a count greater than 2 (this would not fail
exactly but would never repeat the requested command more than twice).

- Fix: get_count and altmeta
- Fix: command counts greater than 2
"
1015581944,Lua test-related changes,entrez,2022-08-02 20:43:05+00:00,2022-08-26 15:18:24+00:00,{},"Some changes to improve the Lua tests.  Some of them I'm not too sure about:
they fix problems for me, but I'm not certain if it's the 'proper' fix (in one
case because it seems like there's some context I'm missing for how it came to
be the way it is, and in another because the NHL_SANDBOX system is complex and
I'm not sure if I'm using the flags correctly).

- Allow lua test files to call error()
- Fix: movement tests
- Fix: test_src -eaux plurals
- Add makesingular to test_src
"
1013039040,Remove operator with side effect (increment) from array index accessing,un-ch,2022-07-31 14:29:00+00:00,2022-08-01 22:24:07+00:00,{},
1012198004,Some lit corridor display tweaks,entrez,2022-07-29 17:18:10+00:00,2022-08-10 17:00:46+00:00,{},"A couple small tweaks to how lit corridors are displayed in various scenarios,
intended to address some minor issues I've noticed recently.

- Don't show corridors as lit in #terrain
- Update lit corridor display if dark_room toggled
"
1011060740,Fixes related to running and traps,entrez,2022-07-28 16:40:37+00:00,2022-08-10 17:01:52+00:00,{},"I noticed some issues(?) with how traps interact with running: one recent-ish
change to behavior when running which removed an existing way for players to
override the normal run-stopping (using runmode 1), and a problem that
prevented the trap check from being evaluated most of the time in lookaround.

- Restore old behavior for running onto trap
- Fix: lookaround trap detection
"
1008868381,Shopkeepers hold a grudge against past thieves,entrez,2022-07-26 19:02:51+00:00,2022-08-10 17:03:38+00:00,{},"When you steal from a shop, its shopkeeper will remember you as a thief
and charge you higher prices in the future (as well as be more curt and
less polite in interactions with you, though not outright hostile) even
if you pacify them, or die on the level and revisit it later as a bones
file.  This was an idea aosdict had, and I think it makes sense that a
shopkeeper doesn't forgive and forget, immediately returning to treating
you exactly like anyone else, just because you were terrorized into
paying her back.  Paying a shopkeeper off may cause her to stop actively
attacking you, but it feels like she'd have her eye on you as a known
thief going forward (and maybe would hang up a sign with your picture,
saying something like ""DO NOT ACCEPT CHECKS FROM THIS HERO"").

This surchage already existed, but since it was tied to active anger
(which typically causes a shopkeeper to quickly abandon their shop to
follow you) it was somewhat rare to see it in action.

I did not implement it here, but one possible further tweak might be to
clear the surcharge if the shopkeeper is pacified via taming magic
(which more-or-less magically brainwashes the target to feel positively
towards the hero) but not if you simply pay your debts."
1004402080,"split ""letknow"" into separate function",argrath,2022-07-21 16:04:40+00:00,2022-07-23 01:37:17+00:00,{},
998350188,Fix: getpos cmap vs typ/glyph confusion,entrez,2022-07-16 04:45:16+00:00,2022-07-24 04:37:17+00:00,{},"When some parts of getpos were rearranged in 7404597, tests of terrain
types and glyphs were moved to a loop which iterated through the defsyms
array without being updated to handle cmap values instead.  Consequently
they weren't excluding certain terrain types from being 'jumped to' as
intended.  (Though it seems as though they actually worked by chance to
some extent, just because there's some overlap between terrain types and
defsyms in terms of where the 'walls/doors' blocks start and end.)

I also noticed that cmap_to_type was missing S_darkroom (it fell through
to the default case so that the function returned STONE), so I added it.
"
998347496,Silence some -Wunused-but-set-variable warnings,entrez,2022-07-16 04:26:17+00:00,2022-07-16 16:37:18+00:00,{},"If NH_DEVEL_STATUS was set to NH_STATUS_RELEASED or NetHack was compiled
without DEBUG defined, the 'vlen' variable in a couple pline.c functions
wasn't used.  This could trigger compiler warnings.
"
997293115,Prevent amorphous mon from carrying hero into door,entrez,2022-07-15 02:46:04+00:00,2022-07-23 02:37:17+00:00,{},"An amorphous engulfer like a fog cloud could engulf the hero, then carry
him into a closed door.  If it was killed or decided to spit out the
hero, he would be left occupying the same spot as a closed/locked door.
Make an amorphous monster unable to move into a door if currently
engulfing the hero.

Something more complicated could be done along the lines of allowing the
move if the hero is himself in an amorphous polyform, but that verges on
being a little too silly, maybe.

I also included fixes to a couple miscellaneous, unrelated formatting
issues that I noticed recently.
"
992326490,Merge scimitar skill into saber skill,Kufat,2022-07-10 00:36:05+00:00,2022-07-24 10:37:18+00:00,{},"Deleted scimitar skill, changed scimitar to use saber skill.
Adjusted Barbarian's max saber mastery basic->skilled for consistency with former scimitar skill.

In-universe reasoning: Sabers and scimitars are similar weapons, used similarly.

Out-of-universe reasoning: NH has historically had too many skills. It's a problem that's being addressed (by e.g. merging javelin into spear) so this seemed like a good opportunity. The game currently contains one scimitar and one normal saber (plus artifacts) so even after the merge this skill won't have an excessive number of applicable weapons."
985529478,split starving dog into separate function,argrath,2022-07-02 13:52:50+00:00,2022-07-21 02:37:17+00:00,{},
985453073,Log the weapon that breaks weaponless conduct,vultur-cadens,2022-07-02 04:23:24+00:00,2022-07-06 00:37:17+00:00,{},"...because I think it would be interesting to see how many monks break
it with a pick-axe.

Also fix a bug related to logging the conduct:

* If the first hit was a joust that didn't kill the monster, the
  conduct would be double-logged.

I lifted the call to first_weapon_hit() out of mhurtle_to_doom() in
order to log the weapon before it broke."
985145811,Fix #812: recovered stair dlevel,entrez,2022-07-01 16:35:30+00:00,2022-07-01 18:18:45+00:00,{},"Stair dlevels weren't being restored with the correct values when
recovered after the game crashed, apparently because they weren't being
reset back to their 'absolute' level from a 'relative' level.  I'm not
totally sure of why this affected only recovered games (maybe that's the
only time when the 'relative' stair values are used?) but this fix seems
to work.

Fixes #812"
983242390,Don't describe 'more info' prompt in #glance help,entrez,2022-06-30 00:54:46+00:00,2022-07-04 05:37:17+00:00,{},"When using #glance, the player is never prompted about whether she wants
'more info' about something on the map, even if flags.help is true and
she has pressed '.' -- the 'more info' prompt is exclusive to #whatis.
getpos_help already changed its description of '.' based on whether
'help' was on or off; adjust those criteria so that the description of
the 'more info' prompt is only included for #whatis, where it is
actually relevant.

I recently looked at the help while using #glance and got confused
about why the 'more info' prompt was never appearing, so hopefully this
should help forestall that sort of thing.  #glance also prompts only
once, so there's some other information about ""moving to another spot""
in the help text which is not relevant -- that could definitely be
addressed as well but I think it's less likely to be confusing, so I
didn't bother with it in this commit.
"
983137627,Fix: non-swimming pets eating underwater food,entrez,2022-06-29 21:35:47+00:00,2022-07-04 04:37:19+00:00,{},"Commit 32234b1d in 2003 mentioned in its commit message that pet dragons
shouldn't be able to eat underwater food items.  This was mostly true:
non-swimming pets wouldn't select underwater food as a goal, and
wouldn't spend an action eating something unreachable on their current
position.  But the ""combined eat and move"" case in dog_move didn't check
could_reach_item, so if a non-swimming pet happened to move to a spot
with underwater food for some reason, they could eat it on that turn
anyway.  This commit should close this loophole and prevent non-swimming
monsters from eating underwater food (or other unreachable food) even if
they happen to fly over its position.
"
980128629,Improve some interactions with gold and justpicked,entrez,2022-06-27 14:17:43+00:00,2022-07-04 04:37:18+00:00,{},"Just-picked-up gold was included in the list of items in the just-picked
category for most category-based menus like 'D' or #loot, but special
handling of gold for 'I'/#inventtype (to accomodate the 'goldX' option)
caused it to be excluded from consideration as a just-picked item.
Include recently picked up gold in 'P'/justpicked when doing type
inventory, consist with other category-menu-based actions.

Edit: I also just added another commit on a similar topic to the branch,
that actually considers gold's BUCX status, based on the goldX option,
when combining justpicked and BUCX categories/filters for some
category-based action (like #droptype).  Currently it is always included
when justpicked is combined with some other BUCX category, and can never
be filtered out via BUCX status.  So I guess I will retitle the PR.
"
979323669,Fix underflow in free_window_info,bacam,2022-06-26 14:38:54+00:00,2022-06-26 19:37:26+00:00,{},"At the end this is called after `WIN_MESSAGE` is reset to `-1`, so we
need a check here.

This is mostly harmless but can fail if some form of strict memory access checking is present; for example, I originally saw this with NetHack 3.6 on an experimental Arm Morello architecture machine."
977408222,Restore and expand wizmgender functionality,entrez,2022-06-23 16:47:41+00:00,2022-07-04 04:37:18+00:00,{},"Restore the wizmgender highlight on female monsters and statues on the map
(and expand it to curses).  Add gender to corpse/statue names when it's
enabled.
"
972138402,remove unnecessary code on destroy_one_item(),argrath,2022-06-20 12:02:03+00:00,2022-06-29 00:37:32+00:00,{},"`physical_damage` is initialized to FALSE, and no codes change it."
970708834,Don't prompt to continue eating with one bite left,entrez,2022-06-17 14:58:34+00:00,2022-07-03 02:37:17+00:00,{},"There was already handling in place to prevent showing the ""continue
eating?"" prompt for one-gulp food (like a wraith corpse), since the hero
would finish eating the food on that turn regardless of what the player
answered to the prompt.  Resuming an interrupted multi-bite meal with
only a single bite remaining had the same problem, but wasn't accounted
for in the special ""one gulp"" handling.  Modify the condition so it
checks for the number of bites remaining in the food, not the number of
bites total, and show the prompt only when there's more than one bite
left.
"
969746606,remove unnecessary  `if` on help_dir(),argrath,2022-06-16 20:14:40+00:00,2022-06-22 08:48:19+00:00,{},"If `viawindow` is false, `prefixhandling` is always true.
So, inner `if` statement is unnecessary."
969486843,Allow travel on water with IDed water walking,entrez,2022-06-16 15:46:42+00:00,2022-07-03 02:37:17+00:00,{},"If you have a known source of water walking (i.e. are wearing formally
IDed water walking boots), allow travel to path you over water and allow
running over water.  A transition from land to water will still cause
the hero to stop in modes other than the shift+dir ""move until you hit
something"" running mode, so that you don't careen across the entire
level unless you really want to.

Also, fix running over water when levitation or flying is equipped.
This stopped working after f88dce6, only allowing the hero to move
one square at a time.  And prevent travel from pathing the hero into a
wall of water even if flying or levitation is equipped, since they don't
allow you to bypass that terrain.

Edit: I originally had cause_known in here to check for known water
walking, but reconsidered since it's fairly expensive and the boots are
currently the only available source of water walking.  I changed it back
to check the hero's boots directly (as swim_move_danger already does)."
968691712,Make monsters trigger landmines based on weight,entrez,2022-06-15 22:34:15+00:00,2022-07-03 02:37:16+00:00,{},"The 1/3 likelihood of a monster setting off a landmine seemed a little
arbitrary to me, especially in that it applied equally to all monsters,
from giants to insects.  Change the flat 33% chance to one based on the
monster's body weight, so that lightweight monsters have little to no
chance of setting off a mine, with the likelihood increasing from there
with the monster's weight.

With a trigger weight of 400, as it is in this commit, a dingo has a 0%
chance of setting off a landmine, a gelatinous cube the same 33% chance
as before, an elf a 50% chance, a human a 72% chance, and something the
size of a dragon (ignoring the reduced likelihood for flying monsters) a
91% chance.
"
968498365,split displaying trap map into separate function,argrath,2022-06-15 18:35:48+00:00,2022-06-29 00:37:31+00:00,{},
964770872,"The length of strncmpi for ""the "" in insight.c fixed",janne-hmp,2022-06-11 13:52:40+00:00,2022-06-12 02:37:16+00:00,{},"Changed the comparison length of ""the "" from 3 to 4 to account for the space in the end."
964243633,Fix: running through quest expulsion,entrez,2022-06-10 15:00:13+00:00,2022-06-30 05:37:18+00:00,{},"If a player was in the process of running past the quest leader when she
got expelled from the quest, she would continue running out of the quest
portal on the portal level.  Interrupt any running (or other multi-turn
action) when expelling the hero from the quest level.
"
963148361,Let fleeing monsters dig pits in undiggable floor,entrez,2022-06-09 17:17:34+00:00,2022-07-30 03:37:18+00:00,{},"When the hero zaps a wand of digging down in an undiggable level, it
creates a pit.  When a fleeing monster did the same thing, it had no
effect.  Bring this closer to the behavior experienced by the hero: if a
monster tries to use a wand of digging to create a hole in an undiggable
floor, a pit will be made (and the monster will fall into it, if not a
flyer).
"
962281853,Fix: vampire shapeshifting in a door,entrez,2022-06-09 00:27:42+00:00,2022-06-09 08:37:21+00:00,{},"Someone mentioned in #nethack today that a vampire had turned into a fog
cloud, moved under a door, then turned back into a vampire while still
sharing a space with a closed door.  There already existed some code
intended to prevent this in cases where the vampire is killed in one
form and revives in another, but voluntary transformations (from
decide_to_shapeshift) weren't included.  The existing code in mondead
and vamp_stone also apparently missed a minor edge case: because the
code between the definition of in_door and its use included an expels
call, it would be outdated/incorrect in cases where expels() placed the
fog cloud onto a closed door.
"
960863744,remove unnecessary null-check on parsesymbols(),argrath,2022-06-07 20:29:10+00:00,2022-06-09 09:37:19+00:00,{},"`strval` here is always non-null,
because the null-check is done in earlier code."
959588896,Allow intrinsic gain from pet's digestion attack,entrez,2022-06-06 20:33:32+00:00,2022-06-30 05:37:18+00:00,{},"Add possible pet intrinsic gain from swallowing a monster in one gulp
(in situations where a corpse is created and eaten by the engulfer),
making it equivalent in this regard to eating the corpse off the floor.

One possible extension or modification would be to reduce the chance of
receiving an intrinsic when the corpse is consumed via digestion attack,
similar to how the corpse nutrition is 50% of its normal value.  I
didn't incorporate that into this commit since the chance of receiving
an intrinsic is tied to monster level rather than nutrition, so I wasn't
sure if it made sense.
"
959578716,split cleaning-up on gd_move() into separate function,argrath,2022-06-06 20:25:41+00:00,2022-06-11 19:37:18+00:00,{},
957774893,Fix: wished-for doors in wizmode always vertical,entrez,2022-06-03 19:17:19+00:00,2022-06-03 23:37:19+00:00,{},"Wishing for a door is intended to retain the existing 'horizontal' value
of the surrounding wall or door (see comment in the wizterrainwish
'door' case).  However, the field was being reset by mistake, causing
all door wishes to create vertical doors.  Preserve it as intended.
"
957763666,Fix: segfault on wizmode terrain wish,entrez,2022-06-03 19:03:37+00:00,2022-06-03 23:37:19+00:00,{},"The new livelogging of wish results caused a segfault when attempting to
handle the results of a wizard mode terrain wish, since a successful
terrain wish returns a nonzero obj which nonetheless is just a dummy
object.  Move the existing check for that further up to skip all the
livelogging stuff entirely, since such wishes will never happen in a
real game and exist purely for debugging purposes.
"
956305478,Reset justpicked only when picking up items,entrez,2022-06-02 20:00:02+00:00,2022-06-04 00:37:18+00:00,{},"With reset_justpicked called unconditionally near the top of pickup, it
was impossible to pick up some items, walk over to a chest, and use 'P'
to deposit the items with autopickup on: pickup is called with every
move, and autopickup allowed execution to reach the reset_justpicked
call whenever the hero stepped on a square with an item in it.  As a
result, stepping onto a square with a container would clear all the
justpicked flags in inventory (pressing ',' and then declining to pick
anything up would have a similar effect).

Instead, call reset_justpicked only when the hero (or autopickup) has
actually selected an item to pick up.  This makes the code a bit more
complicated than before -- I don't think there's a way to do it with
just one reset_justpicked call any more, due to the structure of pickup
and the need to call reset_justpicked before actually putting any items
into inventory -- but it means that justpicked info will be much less
ephemeral and more useful when managing stashes, etc.
"
953811618,fix memory leaks related to selection_new(),argrath,2022-06-01 12:42:31+00:00,2022-06-01 21:37:17+00:00,{},"selection_new() returns an address of malloc()'ed buffer.
If ov is null, this value is discarded without freeing the buffer.
To avoid this, move null-checks before calling selection_new().

Also, remove null-check of the return value of selection_new()
because it always returns non-null."
950140338,"split ""act_on_act"" into separate function",argrath,2022-05-28 21:43:53+00:00,2022-06-09 09:37:18+00:00,{},
950081698,Various small fixes and code smell removals,copperwater,2022-05-28 15:10:16+00:00,2022-05-28 22:37:17+00:00,{},This pull request is for the small fixup items on my list of things I've noticed while browsing the code that do not affect behavior whatsoever. I hope the commits are self-explanatory.
949859513,Have newcham() give messages when monsters polymorph in more cases,copperwater,2022-05-28 01:04:39+00:00,2022-05-29 04:37:17+00:00,{},"This is a descendent of an earlier patch I wrote. The main idea is still
to clearly communicate to the player *what* something is turning into,
without the need to farlook afterwards, and give them the opportunity to
add MSGTYPE for when something jumps on a polymorph trap and becomes an
arch-lich. If it happens out of sight, the player also might get a whiff
of the monster's smell, giving a bit of advance warning.

There is one new case in here, in normal_shape(), which came about
because I noticed a weird message sequence: ""The magic-absorbing blade
cancels the python!  You kill the chameleon!"" with no intervening
message indicating the python reverted to a chameleon."
949836951,Fix some issues with 'P'/justpicked loot category,entrez,2022-05-27 23:53:41+00:00,2022-05-29 04:37:17+00:00,{},"When using 'A'/autopick with the 'items you just picked up' category,
instead of autoselecting all items within that category, it selected
every item in your inventory (like it used to work before 3.7).  Just
blew up a bag of holding because of this.

While testing the fix for that, I noticed 'P' wasn't working at all
with menustyle:traditional -- you could select it as a filter, but it
didn't actually get applied to anything, so it would end up prompting
you for every item in inventory.  Fix both those things.

Edit: I originally had these as two separate commits, but squashed them into one since they're dealing with such similar issues (and both are very small)."
949692934,Fix: mdisplacem stoning and gloves,entrez,2022-05-27 19:53:23+00:00,2022-05-28 00:37:19+00:00,{},"Apparently this is a bug that's existed since mon-vs-mon displacement
was introduced in 2003 (in 89c785e): if a monster displaced a footrice,
having gloves on would make it vulnerable to being stoned, while having
bare hands would protect it.  Switch it around so wearing gloves blocks
petrification, as it does under other circumstances.

Also add a message explaining why the displacing monster was stoned (if
the displacement attempt is visible to the hero), so the ""Foo turns to
stone!"" message has some context.
"
947294849,Fix: invisible pudding globs,entrez,2022-05-25 17:44:55+00:00,2022-05-26 14:59:35+00:00,{},"When a pudding was killed by a monster (player-caused deaths were exempt
because of a 'backup' newsym call in xkilled), and the resulting glob
ended up on the pudding's square (whether because there were no adjacent
globs, or because the adjacent glob merged into the new one rather than
vice-versa), the glob wouldn't be drawn onto the map until the squre was
redrawn with ^R or similar.  This was because the early return for globs
in make_corpse skipped the typical newsym call near the end of the
function.

In this commit I just added a newsym call to the glob case in
make_corpse, but adding a newsym call to monkilled as a guard against
similar cases (equivalent to the one in xkilled) seems like a possible
extension.  I wasn't sure if there's a particular reason it's not
included in monkilled, so I didn't mess with it.

Example (using m-prefix `#wizkill` -- `#wizkill` without the m-prefix doesn't have the same problem, due to the `newsym` call in `xkilled` mentioned in the commit message):

https://user-images.githubusercontent.com/40038830/170329426-139efbf9-b538-4c81-a56d-ec5deab43449.mp4"
943568432,Move check for starting L1 spellbook to include non-random spellbooks,matteverett,2022-05-22 04:46:03+00:00,2022-06-12 03:37:16+00:00,{},"A wizard's starting equipment should include a blessed spellbook of force bolt and a random non-force bolt spellbook of level 3 or lower.

Currently, a wizard's second spellbook is always level 1. A previous change ensures that any character's first (random) spellbook is always level 1. Since a wizard's first spellbook is non-random, however, the got_sp1 flag is not set, and the second spellbook is always level 1 as well.

The proposed change moves the level 1 spellbook check so that it is performed on both random and non-random spellbooks, so the second spellbook is level 3 or lower as intended."
943338020,Livelog refused wishes and (non-cursed) genocides,vultur-cadens,2022-05-21 03:10:02+00:00,2022-06-02 18:37:17+00:00,{},
943166800,Handle -eaux plurals in makeplural/makesingular,entrez,2022-05-20 21:13:28+00:00,2022-05-21 06:44:55+00:00,{},"I noticed a comment about -eau pluralizing as -eaux, e.g. ""gateau"" ->
""gateaux"", was not consistent with the actual output of makeplural.
Same thing with ""VAX"" -> ""VAXen"" in the line below it; they're very old
comments, so maybe they were originally meant to point out some plurals
makeplural got wrong?  Since they predate the addition of ""oxen"" and
""geese"" to one_off[] (and the array itself), it seems like the other
special cases mentioned in the comments would also have been wrong at
the time they were written.

Address this horrifying pastry-related oversight by adding handling for
'-eaux' plurals to makeplural, with an exception for 'bureau' (plural
'bureaus'; according to the dictionary, 'bureaux' is an acceptable
variant but 'bureaus' is more common, at least in American English).
There's also an exception for 'Bordeaux' (as in a bottle of the wine),
since the singular and plural are the same.

A bit surprised this wasn't already in there, since 'gateau' is a real
food item and seems like a much more likely fruit name than some of the
inedible items makeplural has special rules for.

Also add "" au "" to compounds[] in singplur_compound, so that 'gateau au
chocolat' will pluralize correctly to 'gateaux au chocolat'.  Without
that change, the result is 'gateau au chocolats'."
940262843,split fixing curse trouble into separate function,argrath,2022-05-18 17:44:53+00:00,2022-05-21 02:37:18+00:00,{},
936778493,Make some quest nemeses leave poison clouds when they die.,vultur-cadens,2022-05-15 15:55:56+00:00,2022-05-15 23:37:16+00:00,{},"The Archeologist, Caveman, and Priest quest texts describe the
nemesis's body producing a cloud of noxious fumes/gas when killed.

----

I could have implemented this by checking for the hero's role instead of the nemesis's permonst pointer, but I decided that somebody who changes the quest text will probably also rename the nemesis.  Referencing the specific nemesis makes it less likely that some variant author who revamps the quest accidentally leaves in the poison gas cloud when their replacement quest text doesn't call for it.

----

The relevant quest texts:
Archeologist: https://github.com/NetHack/NetHack/blob/3a0a92764a37c6465ed5251b50bdef1915cebee1/dat/quest.lua#L295-L296
Caveman: https://github.com/NetHack/NetHack/blob/3a0a92764a37c6465ed5251b50bdef1915cebee1/dat/quest.lua#L758-L760
Priest:  https://github.com/NetHack/NetHack/blob/3a0a92764a37c6465ed5251b50bdef1915cebee1/dat/quest.lua#L1634-L1638"
936210923,Fix: loot not drawn on map when mon dies,entrez,2022-05-13 18:40:56+00:00,2022-05-13 18:46:38+00:00,{},"When a monster died, any loot it carried would not be drawn onto the map
until the square was refreshed in some other way, because the newsym
call was moved (as part of the introduction of mon_leaving_level in
6880d37b3) to before the point its inventory items are actually placed
onto the map.  Move mon_leaving_level to after the relobj call in
m_detach so the new symbol will take into consideration any items placed
onto the map from the monster's inventory.
"
936105267,Prevent hero from writing Pratchett books,entrez,2022-05-13 16:20:44+00:00,2022-05-14 03:37:17+00:00,{},"The hero's ability to channel Pratchett and write his books with a magic
marker once she had read or IDed at least one of them seemed strange,
especially cases like an illiterate hero doing it as her first
introduction to the written word.  Block the hero from writing random
novels with a marker.

The image of the hero sitting down in the dungeon to write a novel is
funny, so it feels like a good spot for a funny message.  I'm not
sure if what I have there is perfect, but it can always be changed.
"
935976954,kickobjnam on dokick() is assigned only kicking object,argrath,2022-05-13 14:09:40+00:00,2022-05-14 03:37:17+00:00,{},
931635979,split getting damages with a kick into separate function,argrath,2022-05-09 20:54:42+00:00,2022-05-10 01:37:19+00:00,{},
931063136,split adjusting attributes into separate function,argrath,2022-05-09 11:44:19+00:00,2022-05-09 17:37:19+00:00,{},
930272716,split kicking empty space into separate function,argrath,2022-05-07 12:17:20+00:00,2022-05-09 17:37:18+00:00,{},
927132830,Fix autounlock sometimes not working,FredrIQ,2022-05-04 00:01:56+00:00,2022-05-05 06:37:20+00:00,{},Caused by an unconditional u.dz check.
927114633,Tie door-kick prompts to autounlock,entrez,2022-05-03 23:15:06+00:00,2022-05-05 06:37:20+00:00,{},"Similar to the prompt to automatically #force a box when you have no
unlocking tool, toggling off 'autounlock' should disable the prompt to
kick down a locked door.

As it was, players with autounlock turned off would be prompted to kick
down every locked door they walked into, even when they had an unlocking
tool.

Also, reduce scope of unlocktool variables for autounlocking doors and
containers."
925003655,add msghandler support for win32,argrath,2022-05-01 18:58:48+00:00,2022-05-04 02:37:35+00:00,{},
924705372,"Mark high altars in altarmask, fix display of unaligned temple altars",entrez,2022-04-30 18:30:56+00:00,2022-05-09 17:37:19+00:00,{},"I noticed I had a branch from a few months ago with this change to altarmask,
which I don't *think* I ever submitted to the devteam (my apologies if I did
and just forgot about it!).  I looked it over and it seemed like a decent idea
to me, so I thought I may as well send it in now -- and if there's some big
mistake or other reason I never submitted it that I've since forgotten,
hopefully that will become apparent. :)

While testing that commit, I also noticed that altars in unaligned temples
(like the one in the Valley) weren't being displayed as the right color.

- Designate high altars with dedicated altarmask bit
- Fix coloring of unaligned temple altars
"
924432398,remove redundant condition on tty_add_menu(),argrath,2022-04-29 21:00:39+00:00,2022-04-30 10:37:17+00:00,{},"`newstr` is assigned to `str` or `buf`.
`buf` is an address of an array, and `str` is guarded,
so both are non-NULL."
920082949,Fix: force-fight 'unknown obstacle' descriptions,entrez,2022-04-27 02:53:38+00:00,2022-04-28 13:37:16+00:00,{},"This is intended to address a couple quirks with force-fighting an
unoccupied spot that I noticed:

 * Now that furniture is considered 'solid', an object is much more
   likely to be sitting on the square, obscuring the terrain glyph.  As
   a result, the current glyph is no longer sufficient to accurately
   describe the contents of the spot -- e.g., an altar with a corpse on
   top of it was being described as ""an unknown obstacle"", even when the
   hero knew exactly what furniture was there.

 * When blind and attacking an unexplored 'solid' square, the attacked
   position would always be described as 'the stone', even something
   like a fountain or sink which didn't seem likely to be confused with
   a stone wall.

 * The feedback for attacking stone was previously changed from 'solid
   rock' to 'stone' in order to be consistent with the feedback for
   attacking an unseen wall, but they still weren't quite the same
   (""stone"" vs ""the stone"").

 * The 'stone' feedback for all STONE/SCORR spots was incorrect on
   levels flagged as arboreal, where stone is rendered and described as
   trees.

This relies on back_to_glyph for positions where the hero is aware of
the terrain and certain other spots (like stone, walls, etc) for which
back_to_glyph produces good results even if they're unseen, and falls
back to the generic ""unknown terrain"" in other cases.

Pretty long commit message for such a small commit, but oh well...
"
917322179,Allow specifying object classes in the object name given to des.object(),vultur-cadens,2022-04-24 00:28:37+00:00,2022-04-24 11:37:18+00:00,{},"Allow specifying object classes in the object name given to des.object()
and actually do so in the lua files.

Before this, it was not possible to specify (for example) ""scroll of
teleportation"" in des.object() because there is actually no object
defined in objects.h named ""scroll of teleportation"", so
find_objtype() failed to find it.  Instead, one had to request
""teleportation"", but that is ambiguous, and find_objtype() would find
the first defined item with that name instead (ring of teleportation).

In cases of ambiguity, I referred to the des files from 3.6.6 (before
the lua conversion).

----

I was somewhat surprised to find that the code that handles the object names from des.object() didn't use the same logic as the wish parser.  I assume there's a technical reason for that since the existing FIXME comment in find_objtype() mentioned wish handling."
917169184,remove unnecessary null-check on wc_set_window_colors(),argrath,2022-04-23 09:51:31+00:00,2022-04-24 12:37:24+00:00,{},"mungspaces() returns its argument itself, so `newop` is assigned to `buf`, and always non-null.
`tfg` and `tbg` is assigned to (some addition of) `newop`, so these are also always non-null."
914470081,remove unnecessary code,argrath,2022-04-20 17:21:11+00:00,2022-04-21 21:36:46+00:00,{},"`mode` is initialized to 0, and the codes changing it are always breaking the loop.
So, the conditions of these `if` statements are always false."
912964998,remove redundant condition on adj_pit_checks(),argrath,2022-04-19 11:08:45+00:00,2022-04-20 11:37:17+00:00,{},"`supporting` is never null, as outer if statement checks it."
912406332,"Fix: ""in the the purple worm's entrails""",entrez,2022-04-18 21:28:16+00:00,2022-04-20 11:37:18+00:00,{},"The message printed if the hero threw gold while swallowed by an animal
used ""the <mon_nam>'s entrails"", which produced a doubled 'the'.  It
could also use the wrong possessive form, since it doesn't take
advantage of any of the special case handling in s_suffix.  I think the
only way that could ever be a problem with the current cast of engulfers
is if the hero was swallowed by a purple worm while hallucinating, but I
changed it to use s_suffix anyway.
"
911665226,Monster AI Improvements and monmove.c refactoring.,NullCGT,2022-04-18 03:37:10+00:00,2022-08-11 05:48:33+00:00,{},"This pull request contains a number of minor AI tweaks and improvements:

- When the player is on a set of stairs, tame monsters acts as if the player is carrying a treat. This reduces the frustration experienced by many players when they attempt to bring their pets with them, while still allowing for intentionally leaving pets behind on other dungeon levels.
- Enable offensive use of wands of teleportation by monsters. While comments in the code indicate that this behavior was disabled simply because it never occurred, I have found that in practice, this is not the case. When this code is enabled, monsters zap wands of teleportation at players standing on staircases, exactly as intended.
- Allow piranhas to eat corpses in the same manner that purple worms do. In pop culture, piranhas are infamous for their ability to skeletonize animals remarkably quickly, and I thought this would be nice to represent in NetHack.

This pull request also contains some significant refactoring and readability improvements for monmove.c:

- Pull illithid mind blast behavior into its own function. This shouldn't create much overhead, and enormously improves the readability of dochug().
- Eliminate a number of gotos in movemon.c.
- Replace magic numbers in movemon.c with constants.

I'm far from done with refactoring movement code, but I think this pull request is a good place to start. Dochug() is arguable the worst spaghetti code in the entire codebase, and I think that addressing it starts with making it more legible."
911143838,Fix: repeating 'free' actions with ^A takes time,entrez,2022-04-15 22:56:42+00:00,2022-04-15 23:38:21+00:00,{},"The do_repeat function returned ECMD_TIME whenever it found something to
try to repeat, including 'free' actions like checking inventory, or
even pressing a key that's not bound to any function.  Returning ECMD_OK
has the opposite problem; repeating an action never takes time, even if
it otherwise would.

Add a new return value, ECMD_PASS, which preserves the relevant
variables set by the actual action being repeated rather than resetting
or modifying them, so that actions which take time will still take time
when repeated and 'free' actions won't.
"
910583918,Unidentified gem selling prices,vultur-cadens,2022-04-15 05:01:06+00:00,2022-09-29 01:37:24+00:00,{},"Make the token selling prices for unidentified gems not depend on how
many items were defined before FIRST_GEM.  Now the unidentified gem
selling prices will depend only on the number and defined order of the
types of gems, and won't inexplicably change when objects are added,
or depend on compile-time options such as MAIL.

Also don't do the regular item price reduction for unidentified gems,
since they are already not based on the actual value.  This restores
the pre-3.6 behavior, allowing players to gain a bit more information
from the nominal selling prices of unidentified gems.

Whoever first introduced this special handling for gems probably
intended for players to be able to gain information from gem prices
this way, but probably nobody has been doing it since 3.6.

----

I came across this when I was looking at the wiki:
https://nethackwiki.com/wiki/Gem#By_color

As a wiki editor, I don't want unrelated changes (like adding a new object) to automatically make the information on the wiki out of date."
906513483,Separate some codes for desecratintg high altar,argrath,2022-04-11 21:41:04+00:00,2022-04-30 10:37:18+00:00,{},... and remove one goto.
903101003,Fix: object detection vs mimic statue disguise,entrez,2022-04-07 19:00:10+00:00,2022-04-08 21:37:18+00:00,{},"Cursed potions of object detection were showing all mimics disguised as
statues as 'i' glyphs, because object_detect used PM_TENGU as the
corpsenm of any mimic disguise.  Instead, use MCORPSENM when available
so that hidden mimics will be mapped with glyphs corresponding to their
actual disguises."
902997772,Add message for failed fountain monster detection,entrez,2022-04-07 17:09:15+00:00,2022-04-08 21:37:18+00:00,{},"When the fountain quaffing monster detection effect was triggered on a
level without any monsters, no message would be printed.  I think this
was the only scenario where drinking from a fountain wouldn't print
anything, so it stood out as unusual.

Print a messsage in the case monster detection fails, to make it
consistent with other fountain effects and ensure it's clear the hero
did still drink from the fountain on that turn.  I used ""the water
tastes like nothing"" for the (sort of tenuous) connection to there being
nothing living on the level, but there might be a better message to put
in there.
"
901719181,Make sure xstart and ystart are always zero when not in_mklev,copperwater,2022-04-06 16:37:24+00:00,2022-04-08 21:37:18+00:00,{},"Running #wizloadlua to run Lua scripts that use coordinates in any way
would work differently if you were on certain levels for the first time
versus leaving and returning to them. This is because various bits of
level creation routines can leave xstart and ystart set to non-zero
values, which are then zeroed at some point when leaving and returning
to the level.

Since xstart and ystart are only relevant to level creation and lua
commands, this fixes the problem by zeroing them after leaving mklev
routines. (Saving them with the level doesn't work because xstart and
ystart are relative to the last used des.map, of which there could be
multiple, e.g. in Asmodeus's level or if two map-based themed rooms
happen to generate. I can envision a more complex solution in which
every des.map used in the level can be associated with an identifier,
whose xstart and ystart are saved for use by later post-level-creation
lua scripts, but currently I just want to make them consistent between
level visits.)"
900521174,Fix: monster gender could not actually be specified in lua files,copperwater,2022-04-05 17:19:52+00:00,2022-04-08 21:37:18+00:00,{},"Noticed when I tried to create a male monster of a species that permits
both males and females (i.e. not a single-gender or neuter species),
half the time the monster ended up female anyway. This was because
get_table_montype picks a random monster gender for such species, and
lspo_monster just sets it to that, making it impossible to deliberately
have a monster of a certain gender.

This fixes that by defaulting the ""female"" table argument to random
instead of false, and then checking to see whether the level file set it
to something other than random. If so, it uses that value.

I debated whether this should allow a level designer to make a monster
of a gender that conflicts with their species, such as a male nymph, but
erred on the side of respecting the species. So attempting to specify a
male nymph, etc. will still result in a female one."
896950895,"fix ""pertrified"" typo",vultur-cadens,2022-04-01 05:41:53+00:00,2022-04-01 21:37:17+00:00,{},
889931795,Separate function for offering too soon,argrath,2022-03-25 21:47:17+00:00,2022-04-08 21:37:17+00:00,{},
889157675,Add initializer on use_tinning_kit(),argrath,2022-03-25 06:49:35+00:00,2022-03-25 16:37:23+00:00,{},"If poly_when_stoned() is true, an uninitialized buffer kbuf[] is passed to instapetrify().
Although instapetrify() doesn't access it in that situation for now,
it should be initialized anyway for readability."
887599535,Move null-check on savelev(),argrath,2022-03-23 19:17:48+00:00,2022-03-25 16:37:23+00:00,{},Move null-check of ttmp before its first use.
886657092,Make nh.getmap() return information relative to the most recent des.map,copperwater,2022-03-23 01:20:34+00:00,2022-08-31 15:26:32+00:00,{},"There are many possible use cases for nh.getmap during level creation,
but it's rendered mostly unusable by virtue of always returning data
about the exact x,y coordinate in g.level.locations. (In particular,
it can't currently be used in themed rooms at all, because the themed
room could be anywhere on the level.) This is inconsistent with how most
other coordinate-based functions work following a des.map, which use
coordinates relative to the 0,0 point of the map.

This changes it so that during level creation only, if nh.getmap is used
following a des.map statement, it will look up the coordinates relative
to the origin of the map, consistent with the other functions."
886503595,"Handle spiders, cockatrices in mbodypart",entrez,2022-03-22 20:59:12+00:00,2022-03-23 01:37:18+00:00,{},"Spiders and cockatrices were using the default animal_parts, which was
noticeably inaccurate in describing certain parts of their bodies.  Add
specific handling for both types of monsters: for spiders, add a
spider-specific body part list (the best I could figure out from online
sources, not being a spider anatomy expert), and for cockatrices, use
bird_parts with ""scales"" from snake_parts thrown in to emphasize their
unusual nature.
"
884324456,Add safeguard to catch non-table coord being given in Lua,copperwater,2022-03-21 01:37:59+00:00,2022-03-22 09:07:42+00:00,{},"Frequently when working on special level lua files, I end up writing something like:
```
local antarea = selection.area(45,10,61,16)
des.monster({ id=""soldier ant"", coord=antarea:rndcoord(1) })
```
and then say ""what the heck why are the ants spawning in random places all over the map"". The correct usage is this:
```
des.monster({ id=""soldier ant"", coord={antarea:rndcoord(1)} })
```
because it expects a table and rndcoord does not return a coord, just a pair of ints. (I don't particularly think that behavior should change.) The problem is that it's a little too easy to miss this and wind up with a level not generating the way it was intended.

So to address that, this adds a lua error if coord is specified as something non-nil, but it is anything besides a table. (The existing get_coord code ensures that when it *is* a table, it must be a table of exactly 2 integers). In the case of forgotten braces around rndcoord, coord's type ends up as a number, so it gets caught by this."
884035547,Fix: repeated 'hit with a wielded weapon' logging,entrez,2022-03-19 19:42:28+00:00,2022-03-20 05:37:18+00:00,{},"The ""hit with a wielded weapon for the first time"" livelog line could be
produced repeatedly: it was triggered by hitting a monster with a
wielded object of any sort, but the u.uconduct.weaphit counter was only
incremented if hitting with an actual 'weapon' (a WEAPON_CLASS or
is_weptool item).  As a result, if a non-weapon-using hero whipped out a
non-weapon item -- a cockatrice corpse, for example -- and started going
to town on some monsters, the livelog message would be repeated with
every hit.
"
883965779,Add explicit cast to void,argrath,2022-03-19 11:52:05+00:00,2022-03-19 20:37:24+00:00,{},All other these calls not using a return value have a cast.
883020414,Collisions while hurtling can stone participants,entrez,2022-03-18 01:07:50+00:00,2022-03-18 04:44:37+00:00,{},"Hurtling into a monster is described as ""bumping into"" it, so it makes
sense that hurtling willy-nilly into a cockatrice (or vice-versa) could
result in petrification.  Since hurtling for the hero usually involves
""floating in the opposite direction"" (presumably backwards) after
throwing an item, check whether the hero is wearing any body armor which
would cover their torso rather than looking for gloves.  Do the same for
monsters on the general basis that it's a bodily collision, and for the
sake of consistency.

https://user-images.githubusercontent.com/40038830/158918345-8b427077-1d4c-4670-b6db-da07da79d6aa.mp4"
880764251,Fix: levitating/flying monsters moving over liquid,entrez,2022-03-15 22:36:32+00:00,2022-03-16 05:41:28+00:00,{},"Commit c1a6dd4 was meant to prevent flying, levitating, and clinging
monsters from considering walls of water as acceptable movement
destinations, even outside of the Plane of Water.  However, it was
evaluating the monster's starting position instead of possible places to
move to, and the evaluation was 'backwards' (the equivalent of
IS_WATERWALL, instead of !IS_WATERWALL).

The result was that non-swimming monsters could only move onto any kind
of water or lava square if the position they were moving from was a
WATER square.  Change this so that instead of the starting position,
each potential destination spot's status as a wall of water is evaluated
in turn, and reverse the effect of the test so that it blocks walls of
water instead of allowing them.
"
879663138,"Fix selection ""random"" grow direction, and other code cleanup",copperwater,2022-03-15 01:11:59+00:00,2022-03-15 05:49:24+00:00,{},"Noticed that when I set a selection to grow in a random direction, it
instead grew in all directions, which is not what I wanted. Turns out
the -1 random dir ended up being passed straight to the code which
checks bitmasks, without any form of randomizing among directions.

So this adds code to do that, and defines W_RANDOM as -1 rather than
using a magic number. In the process I also noticed that specifying
""random"" as the wall for a door in a room made it rerandomize the
direction every iteration of its loop, essentially rolling two rn2(4)s
and only proceeding if they matched. That was pointless so I cleaned it
up a bit.

Also added safety checks in the form of an impossible for des.corridor()
being called with ""random"" as either walldir, because this is not
implemented currently.

And lastly, I noticed that create_secret_door was entirely unused
(secret door creation is handled in create_door), so I deleted it.

The only behavior change caused by this is that the Valkyrie quest lava
pools will be a little smaller, which is the only place grow is
currently used. If it's desired to keep them the same, that should be
changed to ""all""."
879204925,Implement selection addition and difference,copperwater,2022-03-14 15:29:54+00:00,2022-03-14 17:07:54+00:00,{},"Selection difference is something I have found myself wanting a lot when
working on levels, and have had to defer to a clunkier xor-then-and
approach. This commit implements the TODO-ed addition and subtraction
operators on two sets.

I don't see how the addition operator would be any different from
logical or, so it just calls l_selection_or rather than implement a new
function."
879116594,Reduce eucalyptus leaf nutrition to 1,copperwater,2022-03-14 14:18:35+00:00,2022-03-15 05:42:55+00:00,{},"Eucalyptus leaves are famously inedible except by certain animals such
as koalas. I consider it very strange that a single leaf in NetHack
gives you six meatballs' worth of calories.

I considered making it 0 nutrition, but am not sure if a 0-nutrition
comestible would end up violating some assumption that all food is at
least 1 nutrition. If that's overly cautious and it's safe to do this, feel free
to make it 0 instead of 1."
879083176,Externify trycall() and replace many docall() calls with it,copperwater,2022-03-14 13:50:08+00:00,2022-03-14 14:17:17+00:00,{},"trycall() is a short docall() wrapper that is a no-op if the item is
already identified or the player has called the object type already. For
some reason, many calls to docall() did those same exact checks
beforehand.

This commit eliminates that redundancy by converting those calls into
trycall(), which is now made extern rather than local to do.c. No
behavior should be changed by this commit; I've checked that none of the
affected places could take a different code path now that the
oc_name_known and oc_uname checks are removed."
877576623,Remove redundant null-check on untrap_prob(),argrath,2022-03-11 15:48:38+00:00,2022-03-11 22:37:17+00:00,{},"`ttmp` should not be NULL here, otherwise this function will crash at earlier code."
875739622,Add explicit cast on somexy() call,argrath,2022-03-09 21:12:35+00:00,2022-03-10 18:37:19+00:00,{},All other somexy() calls not using a return value have a cast.
872635381,corrected spelling of metaphor,zomGreg,2022-03-07 02:45:50+00:00,2022-03-08 03:37:18+00:00,{},I think this is the generally accepted way of spelling these words.
863703717,Move arguments validation on place_object() before their first use,argrath,2022-02-25 18:38:35+00:00,2022-02-26 11:37:18+00:00,{},
861689703,Fix: monster hurtling and liquid,entrez,2022-02-23 18:03:40+00:00,2022-02-24 12:59:30+00:00,{},"A monster hurtling over liquid would drown immediately the instant it
touched the first square of water, even if normally it would have kept
moving (e.g. hurtling over a short moat).  Additionally, its placement
on liquid would not take into consideration other monsters, so it could
overwrite an existing monster on that spot and lead to an impossible,
and/or two monsters occupying a single position.

Fix these issues, so that liquid effects like drowning only happen if
the monster ends up in liquid at the end of the hurtle, and so that
other monsters in the way will stop it early even if they're floating
over or swimming on a pool/water/lava square.

Also use canspotmon instead of canseemon for the wiztelekinesis debug
command.
"
858912399,Add missing initializer on tally_BUCX(),argrath,2022-02-20 21:26:48+00:00,2022-02-21 03:37:16+00:00,{},
857786675,Make ravens oviparous,entrez,2022-02-18 22:37:21+00:00,2022-02-20 06:37:18+00:00,{},"Ravens are birds, so they should be able to lay eggs.
"
847080284,Remove redundant null-check on christen_orc(),argrath,2022-02-11 07:53:26+00:00,2022-02-11 18:37:33+00:00,{},"rndorcname() returns buf2 itself, so orcname is never NULL."
845340277,Check the return value of nhl_init() on com_pager_core(),argrath,2022-02-10 14:15:12+00:00,2022-02-12 20:37:16+00:00,{},nhl_init() can return NULL.
844288033,Move null-check on tin_details(),argrath,2022-02-09 20:18:36+00:00,2022-02-10 01:37:19+00:00,{},Move null-check of obj and buf before their first use.
844102976,move null-check on savelev(),argrath,2022-02-09 16:30:22+00:00,2022-02-10 01:37:19+00:00,{},Move null-check of nhfp before its first use.
843319848,Fix: tty map weirdness after 'full-screen' menu,entrez,2022-02-08 23:02:47+00:00,2022-02-12 19:37:17+00:00,{},"When a 'full-screen' (cw->offx and cw->offy both 0) menu was immediately
followed by an offset menu -- as in the case of selecting certain
options from the options menu, or using loot to take out/put in items
after using ':' to describe the contents of a very full container --
there were some odd interactions with the map.

Only certain parts of the map near/under the menu window would be
redrawn if the first offset menu was followed by another one, while
a getlin prompt would cause the entire map to be redrawn, with parts
intersecting the window being drawn on top of it and obscuring it.
Flushing the display immediately after the docrt call when closing a
full-screen menu seems to fix both these issues.

It's a little hard to describe the 'weirdness' so here are some illustrative videos:
Before:

https://user-images.githubusercontent.com/40038830/153090341-45180ef1-09a3-44fa-9225-c20f976fb072.mp4

After:

https://user-images.githubusercontent.com/40038830/153090352-0646ae37-2730-4b0f-9a10-ad04519fe7c4.mp4



"
843234873,Add null-check on repairable_damage(),argrath,2022-02-08 20:55:28+00:00,2022-02-09 01:37:17+00:00,{},Add null-check of dam before its first use.
842531316,Add null-check on fill_special_room(),argrath,2022-02-08 08:22:25+00:00,2022-02-08 17:37:18+00:00,{},Add null-check of croom before its first use.
840848102,Remove redundant code on find_guard_dest(),argrath,2022-02-05 11:34:07+00:00,2022-02-05 18:37:16+00:00,{},"The values of lx and ly are always assigned just before their usage.
So, assignments in advance are redundant."
838630541,Use verbalize for player monster speech,entrez,2022-02-02 19:28:20+00:00,2022-02-03 00:37:17+00:00,{},"Attempting to chat with a player monster would inspire a witty retort,
but it was presented without quotation marks and so differed from other
types of monster speech.
"
832833788,cmake support for NetHack 3.7,heiner,2022-01-26 21:38:37+00:00,,{},"Hey!

I don't think you will want to immediately (or perhaps ever) merge this, I just thought it might be good to document somewhere how to build NetHack 3.7 via cmake out-of-source. I also have a [cmake version for NetHack 3.6](https://github.com/heiner/NetHack/tree/NetHack-3.6-cmake) (harder, as it requires dealing with `dgn_comp`, `lvl_comp` etc).

This doesn't yet include building the Guildebook or flags like `WANT_LIBNH` but they would be easy to add if there is interest.

To build:

```sh
mkdir build && cd build 
cmake .. -GNinja && ninja && cmake --install .
./nethack
```"
829746697,Net hack 3.7 mingw32,feiyunw,2022-01-23 13:15:08+00:00,2022-01-28 13:00:54+00:00,{},"For my MSYS2/mingw32 to build properly:
```
wangfy@DESKTOP-8KQFTRT MINGW64 /d/prj/NetHack/src
$ mingw32-make -f Makefile.gcc all
----
NOTE: This build will include tile support.
----
gcc -c -mms-bitfields -I../include -I../sys/windows -I../lib/lua-5.4.3/src    -DTILES -DMSWIN_GRAPHICS -DWIN32CON -D_WIN32_IE=0x0400 -D_WIN32_WINNT=0x0601 -DWINVER=0x0601 -DDLB -DSAFEPROCS -DGUISTUB  -oo/guistub.o ../sys/windows/stubs.c
gcc -c -mms-bitfields -I../include -I../sys/windows -I../lib/lua-5.4.3/src    -DTILES -DMSWIN_GRAPHICS -DWIN32CON -D_WIN32_IE=0x0400 -D_WIN32_WINNT=0x0601 -DWINVER=0x0601 -DDLB -DSAFEPROCS -oo/windsys.o  ../sys/windows/windsys.c
In file included from D:/msys64/mingw64/x86_64-w64-mingw32/include/minwindef.h:163,
                 from D:/msys64/mingw64/x86_64-w64-mingw32/include/windef.h:9,
                 from D:/msys64/mingw64/x86_64-w64-mingw32/include/windows.h:69,
                 from ../sys/windows/win32api.h:40,
                 from ../sys/windows/win10.h:8,
                 from ../sys/windows/windsys.c:14:
../sys/windows/win10.h:14:16: error: redefinition of 'struct DPI_AWARENESS_CONTEXT__'
   14 | DECLARE_HANDLE(DPI_AWARENESS_CONTEXT);
      |                ^~~~~~~~~~~~~~~~~~~~~
D:/msys64/mingw64/x86_64-w64-mingw32/include/windef.h:155:1: note: originally defined here
```
and
```
Linking ../binary/NetHack.exe...
gcc   -o../binary/NetHack.exe o/windmain.o o/windsys.o o/win10.o o/safeproc.o o/nhlan.o o/ntsound.o o/dlb.o  o/allmain.o  o/alloc.o    o/apply.o    o/artifact.o o/attrib.o   o/ball.o     o/bones.o    o/botl.o o/cmd.o      o/dbridge.o  o/decl.o     o/detect.o o/dig.o      o/display.o  o/do.o       o/do_name.o o/do_wear.o  o/dog.o      o/dogmove.o  o/dokick.o o/dothrow.o  o/drawing.o  o/dungeon.o  o/eat.o o/end.o      o/engrave.o  o/exper.o    o/explode.o o/extralev.o o/files.o    o/fountain.o o/hack.o o/hacklib.o  o/insight.o  o/invent.o   o/isaac64.o o/light.o    o/lock.o     o/mail.o     o/makemon.o o/mdlib.o    o/mcastu.o   o/mhitm.o    o/mhitu.o o/minion.o   o/mklev.o    o/mkmap.o    o/mkmaze.o o/mkobj.o    o/mkroom.o   o/mon.o      o/mondata.o o/monmove.o  o/monst.o    o/mplayer.o  o/mthrowu.o o/muse.o     o/music.o    o/o_init.o   o/objects.o  o/objnam.o   o/options.o  o/pager.o    o/pickup.o o/pline.o    o/polyself.o o/potion.o   o/pray.o o/priest.o   o/quest.o    o/questpgr.o o/random.o o/read.o     o/rect.o     o/region.o   o/restore.o o/rip.o      o/rnd.o      o/role.o     o/rumors.o o/save.o     o/sfstruct.o o/shk.o      o/shknam.o o/sit.o      o/sounds.o   o/sp_lev.o   o/spell.o o/steal.o    o/steed.o    o/symbols.o  o/sys.o o/teleport.o o/timeout.o  o/topten.o   o/track.o o/trap.o     o/u_init.o   o/uhitm.o    o/vault.o o/vision.o   o/weapon.o   o/were.o     o/wield.o o/windows.o  o/wizard.o   o/worm.o     o/worn.o o/write.o    o/zap.o o/cppregex.o   o/version.o o/nhlua.o    o/nhlsel.o    o/nhlobj.o o/topl.o     o/getline.o  o/wintty.o o/consoletty.o o/tile.o \
        o/guistub.o o/date.o o/conres.o  o/lua-5.4.3.static.a \
        -lgdi32 -lwinmm -lshell32 -lole32 -luuid -lbcrypt -static -lstdc++
D:/msys64/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/11.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: o/windsys.o:windsys.c:(.bss+0x160): multiple definition of `getreturn_enabled'; o/windmain.o:windmain.c:(.bss+0x100): first defined here
D:/msys64/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/11.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: o/guistub.o:stubs.c:(.bss+0x0): multiple definition of `GUILaunched'; o/consoletty.o:consoletty.c:(.bss+0x34): first defined here
collect2.exe: error: ld returned 1 exit status
mingw32-make: *** [Makefile.gcc:895: ../binary/NetHack.exe] Error 1
```"
827732697,Indicate to players that monsters are sleeping.,NullCGT,2022-01-20 16:50:57+00:00,2022-02-23 00:37:17+00:00,{},"This pull request makes the following changes:

* When a player looks at a monster, they can tell whether or not that monster is asleep.
* Display a message when a monster wakes up within sight of the player.
* Add YAFM for waking up a flesh golem.

Note that none of these changes do not consistently impact monsters put to sleep by wands of sleep, since wands of sleep alter mcanmove and mfrozen when putting a monster to sleep for a nonzero number of turns, rather than setting msleeping to 1.

The rationale for these changes is that up until this point, there has been no way to tell whether or not a monster is asleep aside from its lack of movement."
826690126,Add option to link to Homebrew ncurses for macOS hints file,perryprog,2022-01-19 16:30:47+00:00,2022-05-28 00:37:20+00:00,{},"It's probably possible to conditionally check if the directory where Homebrew curses lives exists, but that feels a bit iffy for me, and also isn't very easy to do in a Makefile. This solution is simpler, albeit a bit harder to find."
823923358,Fix typo in Makefile.gcc,feiyunw,2022-01-16 14:57:39+00:00,2023-02-16 23:55:49+00:00,{'3.6': 1},"Unmatching "")""s in Makefile.gcc."
823917130,Multiple definitions of getreturn_enabled and GUILaunched,feiyunw,2022-01-16 14:24:21+00:00,2022-01-18 11:10:33+00:00,{},"This patch is to fix the following linking error when I was porting NetHack to MSYS2/mingw-w64:
D:/msys64/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/10.3.0/../../../../x86_64-w64-mingw32/bin/ld.exe: o/winnt.o:winnt.c:(.bss+0x160): multiple definition of `getreturn_enabled'; o/windmain.o:windmain.c:(.bss+0x100): first defined here
D:/msys64/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/10.3.0/../../../../x86_64-w64-mingw32/bin/ld.exe: o/guistub.o:stubs.c:(.bss+0x0): multiple definition of `GUILaunched'; o/nttty.o:nttty.c:(.bss+0x24): first defined here"
822911553,Don't 'fall' and self-stone when flying down,entrez,2022-01-14 16:56:31+00:00,2022-01-15 01:37:16+00:00,{},"When a flying hero deliberately ""swoops"" through a trap door or hole,
consider the movement down to the next level to be controlled flight
rather than falling, preventing the sort of inadvertent touching of a
carried cockatrice corpse that happens when falling between levels.
"
822769362,Fix: unpaid_cost regression,entrez,2022-01-14 14:54:41+00:00,2022-01-15 02:37:16+00:00,{},"Recent commit 5c14f3e fixed an issue with unpaid_cost when the hero is
in two shops at once (e.g. phasing through a shared wall), but
introduced new problems with finding the cost of a container with unpaid
contents -- an unpaid item in a player-owned container would generate
the same ""unpaid_cost: object wasn't on any bill"" impossible as the
issue the commit fixed.

The main issue was that finding the bill entry used to depend on finding
the shopkeeper, but after the change, finding the shopkeeper depended on
finding the bill entry; for a container with unpaid items which has a
shopkeeper, but no bill entry, this caused issues.

Revert part of 5c14f3e and tackle the problem another way, which should
correctly handle unpaid items in inventory or a container, even if they
belong to a mixture of different shops and/or the hero is on a space
shared between multiple shops.
"
820143309,"Remove gendered mons indices from roles, races",entrez,2022-01-12 22:44:12+00:00,2022-01-15 02:37:17+00:00,{},"There are no longer distinct gendered versions of monsters, so femalenum
is unused (i.e. set to NON_PM) for all roles and races. Take a pass at
removing all uses of/references to femalenum, and rename 'malenum' to
'mnum' since it no longer has any particular association with
gender or sex.
"
817576202,Fix typo in Guidebook.tex,argrath,2022-01-10 12:34:58+00:00,2022-01-10 17:37:19+00:00,{},
814349981,Fix single-character engraving not dulling the weapon.,vultur-cadens,2022-01-05 02:56:31+00:00,2022-01-06 14:37:20+00:00,{},"When engraving was made an occupation, the implementation converted the behavior of dulling the weapon by (characters/2) points rounded down, but failed to account for the case when 1 character is engraved, resulting in 1-character engravings having no cost.

First reported on NetHackWiki by Pescepalla: https://nethackwiki.com/wiki/Talk:Scroll_of_enchant_weapon#Reducing_artifact_enchantment

This change restores the cost of engraving 1 character from before it was made an occupation: https://github.com/NetHack/NetHack/blob/NetHack-3.6/src/engrave.c#L1102"
805993857,Anti-magic field damage,vultur-cadens,2021-12-19 04:35:21+00:00,2022-07-13 08:49:22+00:00,{},"Make magic-resistant anti-magic field damage asymptotically approach
u.uhpmax as the ratio of drained energy to max hp increases, with a
maximum of u.uhpmax-1.

Addresses #533.

Although this takes some inspiration from @actual-nh's suggestion, ""Perhaps multiply drain if being used for HP by maxHP/max(1,maxPW)?"", I didn't quite like that idea because it would mean that a not very magical character with high HP and low Pw might be drained of a large amount of HP.  This change retains the behavior of high Pw characters taking relatively more damage, but prevents them from going from full HP to dead with no warning.

If a maximum of u.uhpmax-1 is still too harsh, the 'maxhp' argument can be changed, but I think that is not necessary.  Even at an extreme Pw/max HP ratio of 4, anti-magic traps will at worst only do around (1-exp(-2))=86% -- let's round it to 90% -- of max HP.  Still potentially quite dangerous, but instadeath is avoidable by having near max HP when running around."
805809074,Correct the genders of DCSS bogusmons,RojjaCebolla,2021-12-18 08:07:23+00:00,2021-12-30 18:40:33+00:00,{},Reference: https://github.com/crawl/crawl/blob/master/crawl-ref/source/mon-data.h
803901110,libnethack compilation with TARGETPFX,dextercd,2021-12-15 22:09:46+00:00,2021-12-28 18:37:17+00:00,{},"Found a couple issues when compiling libnh while using the `TARGETPFX` option.

I tested that these changes work when using `TARGETPFX` option and also when leaving the option unchanged.

Only the Linux hints file was tested, since I don't have access to a MacOS machine. Maybe someone else can test it. I could also remove the changes from the MacOS hints file if that's preferred."
794219389,Fix: expanded-glyphs hero color regression,entrez,2021-12-03 02:26:48+00:00,2021-12-04 07:37:17+00:00,{},"When showrace is enabled, the hero's normal glyph is forced to use the
color white, overriding the normal monster color.  Following the
expanded-glyphs changes, this color adjustment was accidentally applied
to any glyph on the hero's square, including steeds, objects, furniture,
wand zaps, explosions, etc.  Restrict the color change only to normal
monster symbols on the hero's square, as was the case prior to the
expanded-glyphs changes.
"
794167130,"Fix: gender, historicity of stoned monster statue",entrez,2021-12-03 00:12:05+00:00,2021-12-18 04:37:18+00:00,{},"The way statues of stoned unique monsters were marked as ""historic"" was
not changed when mkcorpstat flags were updated in 04a8ddc, resulting in
unique statues which were no longer marked as historic and were instead
marked as female.

While fixing that, also use the gender-related mkcorpstat flags to
assign the gender of a stoned monster to the resulting statue.
"
792781172,Fix: 'you owe It for goods lost',entrez,2021-12-01 14:45:59+00:00,2021-12-02 07:37:17+00:00,{},"Some messages about owing a shopkeeper money would use 'it' when blind,
with weird results such as ""You owe It 267 zorkmids for goods lost.""  It
seems maybe like these were missed in 6591f8b since they were outside of
shk.c/shknam.c.  Bring those messages into alignment with most other
shopkeeper-related messages, which use the shopkeeper's name even if the
hero is blind or can't see them at the moment.

Some of the 'it gets angry' ones don't seem so bad, but similar 'gets angry' messages in shk.c use Shknam so I changed those as well for consistency's sake."
792052520,Fix: zoo monsters spawning in hallways,entrez,2021-11-30 20:41:31+00:00,2021-12-01 01:37:18+00:00,{},"If a random G_[SL]GROUP monster was generated in a zoo, the resulting
group of monsters could spill out into nearby hallways and other
surrounding areas.  Disregard G_GROUP flags when filling a zoo with
monsters to avoid this problem.

Example of the issue:
<img width=""170"" alt=""Screen Shot 2021-11-30 at 1 42 51 PM"" src=""https://user-images.githubusercontent.com/40038830/144124748-9e719b82-39a5-48ce-bc1c-c647d88aa9dd.png"">

"
791270863,add loongarch support,hanjianju,2021-11-30 03:22:09+00:00,,{},
787351997,Use %d for short,argrath,2021-11-23 21:31:20+00:00,2021-11-24 02:37:18+00:00,{},"obj->otyp is short, so corresponding format string is %d.

(from Coverity Scan)"
783272072,Using the() with monster name,entrez,2021-11-18 01:05:08+00:00,2021-11-25 01:50:30+00:00,{},"the() treats most capitalized words as proper names, which caused
problems when it was used to prepend 'the' to a monster name.

Using the() with monster names is intentionally avoided in most places
for this reason, but there are still quite a few spots where it's used,
e.g., formatting killer names, applying a stethoscope to a statue,
hitting something with a monster egg, attempting to polymorph into an
invalid form...  Rather than replacing all these uses of the(), have it
check whether the string is an exact match for a non-pname monster name,
and if so, ignore capitalization.
"
781790558,Magical breathing helps fish survive out of water,entrez,2021-11-16 15:17:58+00:00,2021-11-19 07:37:16+00:00,{},"The hero in an aquatic polyform loses HP for time spent out of the
water; allow magical breathing to prevent this, just as it allows the
hero in her non-aquatic natural form to breathe underwater.

Also add a similar rule for monster fish-out-of-water HP loss, even
though currently monsters can't use amulets of magical breathing and
there's no non-breathing fish/eel -- just in case this changes at some
point.
"
778975442,Update NetHackW.c,amelkerson,2021-11-11 23:36:51+00:00,2021-11-14 17:37:17+00:00,{},Updated some comments that referred to an old file name. 
778942600,Allow bullwhips to grab items when flying,RojjaCebolla,2021-11-11 22:21:03+00:00,2021-12-03 17:37:18+00:00,{},"Generally Flying is ""levitation, but better"", and this is reflected by it
occupying a more valuable item slot, an amulet rather than a ring. One case
where that is not yet true is when an item is submerged in water. The item
can be grabbed by a levitating player, but not a flying player."
770845478,Remove duplicate code,argrath,2021-11-01 20:09:08+00:00,2022-09-22 04:37:17+00:00,{},"Here, `then` clause and `else` clause is identical."
770012576,Don't erase Elbereth when monster steps into a pit or hole dug by you,Vivit-R,2021-10-31 20:44:14+00:00,2021-12-30 18:53:48+00:00,{},"Elbereth was fading when offscreen monsters stepped into pits or holes dug elsewhere on the level. This was happening because monsters falling into traps set by you were calling setmangry() as if you had just attacked them. The behavior made it unsafe to use Elbereth if you've dug down _anywhere else_ on the level, making it a bit harder to get archeologists off the ground. This branch alters that behavior.

I don't think it makes much sense for monsters to recognize a the handiwork of a newcomer to the dungeon setting a trap (let alone _digging a hole with a wand of digging_) in the first place, but I've opted for the more conservative change. If you agree with me, feel free to just remove lines trap.c:3114-3118 altogether instead."
769636580,Turn cancelled bags of holding into sacks,Vivit-R,2021-10-30 03:12:14+00:00,,{},"A wand or spell of cancellation zapped at a bag of holding now turns the bag into a sack. A wand of cancellation placed directly into a bag of holding now, instead of exploding the bag, just uses one charge and cancels the bag. This is not checked for recursively; you can put a wand of cancellation into a sack and then safely put the sack into a bag of holding.

The biggest consequence of this (other than making wands of cancellation less of a hassle to carry) has to do with looting cursed bags of holding from bones. Formerly, you could just cancel the bag and pick it up. You can still do this to safely retrieve the items, but you don't get to keep the bag of holding. If you want to keep the bag, you have empty it first and risk losing some of the contents. There is now an opportunity cost."
768757021,Fix: bad cast making sp_lev chameleon light source,entrez,2021-10-28 22:06:30+00:00,2021-10-29 02:37:17+00:00,{},"Giving new_light_source '(genericptr_t) mtmp' leads to the light
source's id.a_monst being set to 'mtmp->nmon' rather than 'mtmp',
since that's what is stored in the initial byte of the monst struct.
When mtmp->nmon == 0x0 this can cause a segfault in do_light_sources.
"
768653628,Add missing `const`,argrath,2021-10-28 19:15:04+00:00,2022-01-27 16:20:28+00:00,{},"If you want to declare a pointer which the address pointed to is constant,
you should declare it as like `static const char *const var = ""..."";`.

This commit supplies missing `const` and prevents some programming
error in the future."
764959228,The return value of weight_cap() should be non-zero,argrath,2021-10-24 22:25:37+00:00,2021-10-26 02:37:17+00:00,{},"The return value of weight_cap() should be non-zero, because
it is used as a divisor on try_lift()."
764684867,Make amnesia drain training to appropriate level,amateurhourrrr,2021-10-23 13:39:25+00:00,2021-12-30 19:05:11+00:00,{},"When amnesia drains your skills the skill training would be set
to a random amount rather than a random valid amount for the new
level of skill.

This meant that, for example, you could have Master skill level in
martial arts but with the training amount of Basic.

Attempts to retrain to level martial arts to Grand Master would
then take an extraordinary amount of time compared to usual.

Fix taken from Evilhack"
764418926,Use %lu for unsigned long,argrath,2021-10-22 18:20:24+00:00,2021-10-22 23:37:17+00:00,{},"`curr->tid` is unsigned long, so use `%lu`.

(from Coverity Scan)"
763486341,Guard lua_close(),argrath,2021-10-21 17:18:34+00:00,2021-10-21 21:37:16+00:00,{},"nhl_done() can be called with L == NULL.
So lua_close() should be guarded."
763226003,Initialize attknum,argrath,2021-10-21 12:32:24+00:00,2021-10-21 17:37:18+00:00,{},"`attknum` is declared without initialization, and is used on
find_roll_to_hit().  This leads unexpected result.

(from Coverity Scan)"
763143092,Revert MAX_RADIUS change,argrath,2021-10-21 10:49:48+00:00,2021-10-21 17:37:18+00:00,{},"On 59818fb, MAX_RADIUS was changed from 15 to 16 to intend to support
""radius 0"".  But MAX_RADIUS doesn't means the range but outer bound of
the radius table, so it should not be changed, and this change led
possible out-of-bound access on view_from() and do_clear_area() in
vision.c.

This commit reverts the change and avoids the problem.

(from Coverity Scan)"
763049548,Fix pointer precedence error,argrath,2021-10-21 08:55:57+00:00,2021-10-21 17:37:18+00:00,{},"Here, the value `flagcounter` pointed to should be incremented, not `flagcounter` itself.

(from Coverity Scan)"
760782126,Have the '$' command include gold in your pack,Vivit-R,2021-10-18 19:17:06+00:00,2021-12-30 19:13:08+00:00,{},"In verbose mode, the gold in your wallet is totaled separately from that in containers in your pack, and the two are listed separately. In terse mode, just print the total of both. Only known gold is mentioned."
760668499,"Have neutral sacrifices disappear in a puff, not a cloud, of smoke.",Vivit-R,2021-10-18 16:49:26+00:00,2022-12-22 03:37:17+00:00,{},"The other two messages, ""flash of light"" and ""burst of flame"", each have an evocative onomatopoetic noun describing a sharp, abrupt release of light and flame, respectively. If law is represented by light, chaos by flame, and balance by smoke, the natural word is _puff,_ not _cloud._"
759692455,"Rename ""huge chunk of meat"" to ""giant meatball""",Vivit-R,2021-10-16 17:15:01+00:00,2022-09-28 01:37:17+00:00,{},"A number of reasons:
- This makes the relationship with boulders clearer. Boulders roll, so they are clearly round, and ""chunk"" does not suggest roundness.
- Its name parallels the names of the other items produced by the stone-to-flesh spell: rings become meat rings, wands become meat sticks, stones become meatballs, and boulders become giant meatballs.
- ""Meatball"" sounds more appetizing than ""chunk of meat"", making this more consistent with the message ""You smell a delicious smell.""
- The image of a giant meatball in the dungeon is amusing in a way that's consistent with NetHack's wry sense of humor."
757847110,"Fix: whipping peaceful, unarmed monster",entrez,2021-10-13 23:43:30+00:00,2021-11-30 15:03:07+00:00,{},"With the 'safedog' option enabled, applying a whip towards a peaceful
monster without a weapon wouldn't attack it, and would produce odd
messages (""You flick your whip towards Malasgirt.  You stop.  Malasgirt
is in the way!"") if the monster was undisplaceable (sleeping, in a shop,
hero is punished, etc).  Use g.context.forcefight to skip the
displacement checks if attacking with a whip, since applying a whip is a
deliberate attack already.
"
754431526,Correct the imp's period-speak,Vivit-R,2021-10-09 03:25:20+00:00,2021-10-16 19:37:18+00:00,{},"The imp's insults all seem to be grammatically correct Early Modern English, with one major exception: the phrase ""I wouldst fart."" The second-person modal verb _wouldst_ does not agree with the first-person subject _I_. I've corrected this, and also changed the verb from _would_ to _should_ to conform more closely to older distinctions between _should_ and _would_.

The other change I've made is more minor; I've changed _thy_ in ""thy odor"" to _thine_ as the word appeared before vowel sounds (consistently with ""Thou disgracest this noble court with thine impure presence""). I also changed the _-or_ to _-our_ because it was really bugging me to see a very modern American English spelling mixed in with Early Modern English, but that I can change back if it's a rule that all of NetHack is supposed to use American spellings."
754298718,Merge item stacks regardless of bknown,Vivit-R,2021-10-08 19:53:09+00:00,,{},"Currently, items that have been #named stack with items that have not, with the unnamed item stack acquiring the name of the named item stack as soon as the two meet each other in your inventory. This means that it's strictly better to have a stackable item _informally_ BUC-identified than it is to have it formally BUC-identified, because then other items with the same beatitude you find later will stack with it and become (informally) BUC-identified as well.

This results in strategies like dropping only _one_ dart on the altar and #naming the stack according to the results. To remove this tedium, I've tweaked the behavior so that formal BUC-identification behaves the same way as informal BUC-identification. Some variants already implement this change—I know Fourk does, but I'm not sure about 4.

A more radical possibility I considered was doing the same for the knowledge of the enchantment/fooproofing of an item, effectively removing the effect of ID status completely (except _maybe_ dknown when the player is blind) on the stackability of items, but that's a larger change, so I'm saving it for a different PR."
746908759,Fix: artifacts silently removed from the game ,entrez,2021-09-30 17:33:05+00:00,2021-10-26 23:37:17+00:00,{},"Prevent some cases where artifacts may be generated and then immediately deleted, with the effect that they are permanently removed from the game (as pointed out by @copperwater).  Use `artifact_exists(..., FALSE)` to ""unmake"" artifacts in these scenarios, and formally prevent artifacts from showing up randomly in boxes (has effectively been the case already, but was not explicitly blocked).  This should prevent situations where an artifact is counted as ""generated"" without actually being added to the game."
746722227,Fix: baalz_fixup didn't account for level rotation ,entrez,2021-09-30 13:50:45+00:00,2021-10-28 03:37:18+00:00,{},"Because some spots in the fly's 'legs' on the Baalzebub lair level are
specified as pools in the level file, then later converted to walls in a
post-generation fixup routine, monsters can be generated on those spots
and then left walled up and inaccessible, Cask of Amontillado style.
For the love of God, makemon-tresor!

Some code already existed to relocate these monsters after generating
the level, but it depends on misorientated 'leg segments' being fixed up
in a particular way.  That wasn't being triggered because it didn't
account for the possible rotation of the level; as a result, the
monsters in the leg segments wouldn't be relocated, and the leg segments
themselves would continue to have the wrong orientation.

Account for possible level rotation so that the monsters are relocated
properly (and the leg segments are 'fixed')."
746623164,Fix: chameleon quickmimic not reset after eating,entrez,2021-09-30 11:55:23+00:00,2021-12-30 19:15:59+00:00,{},"finish_meating was checking whether the monster in question was a
chameleon/shapechanger, rather than whether it was a mimic, in deciding
which monsters should be allowed to maintain their current appearance
once they finish eating.  This meant that true mimics had their
appearance reset, while a chameleon, vampire, etc, who ate a mimic
would maintain their appearance as a tripe ration even after they had
finished eating and resumed their normal behavior.  The result?  An
amazing living tripe ration which followed the hero around throughout
the level:


https://user-images.githubusercontent.com/40038830/135450633-e0245073-85a8-49f0-954f-c28ef56cfad7.mp4

"
742956140,Fix out-of-bounds access of xdir and ydir in farlook,copperwater,2021-09-26 22:05:40+00:00,2021-10-16 18:37:31+00:00,{},"In commit db68395, most of the instances of xdir and ydir here were
changed to u.dx and u.dy, but not all of them. The remaining ones are
out-of-bounds on xdir and ydir, because i is always set to 12 from an
earlier loop and is no longer involved in handling user input. They
should be u.dx and u.dy like the rest."
742695784,Supply missing changes on Guidebook.tex,argrath,2021-09-25 14:29:21+00:00,2021-09-26 17:37:19+00:00,{},"Some changes applied to Guidebook.mn were not applied to Guidebook.tex.
This commit supplies them."
740728251,delete extra lines in Guidebook.mn,argrath,2021-09-22 18:35:12+00:00,2021-09-26 17:37:19+00:00,{},"Guidebook.mn has some extra lines.
This PR deletes them."
728883346,Fix: running on ice sent hero in weird directions,copperwater,2021-09-07 19:15:14+00:00,2021-09-26 17:37:19+00:00,{},"It's because ice was being treated as a type of
corridor rather than a ROOM space, and running has rules for following
similar terrain. In reality it's not a corridor and should behave like
normal room for running purposes.

This was obvious in the valkyrie quest upper levels with ice fields, in
which running into the edges of the map obliquely, or into the corners
of the map, would send the hero flying around the edge in a different,
probably unintended direction."
727084986,Fix: 'Suddenly you cannot see it',entrez,2021-09-03 21:00:59+00:00,2021-09-05 01:37:16+00:00,{},"Updates to m_dowear_type(worn.c) in 5a09a01a13 inadvertently reversed
the effect of an xor near the end of the function, causing it to go from
testing whether a monster's status as 'seen' or 'unseen' changed over
the course of the function to testing whether it remained the same.

As a result, whenever an unseen, invisible monster donned a piece of
armor anywhere on the map, the message 'suddenly you cannot see it'
would be printed.  Fix the xor so that it goes back to testing whether
visibility changed since the start of the function.
"
726733014,Disambiguate blunt weapons,copperwater,2021-09-03 11:35:02+00:00,2021-09-05 02:37:15+00:00,{},"Currently weapons are set up as piercing, slashing, or whacking, using
their object's oc_dir field, with the intention that certain weapons
can classify as both. However, since oc_dir is only 2 bits and WHACK is
0, there's no way to unambiguously express some of these combinations.
Certain weapons such as the lucern hammer are defined as combination
piercing/blunt weapons, but the game just sees it as a piercing weapon.

This commit adds a third bit to oc_dir and promotes the WHACK constant
to its own bit. Nothing should be affected by this (wand directions and
the like should remain working as usual) other than the
blunt-and-something-else weapons being defined properly."
725920694,Fix: replace_terrain used wrong y2 coordinate,copperwater,2021-09-02 13:39:12+00:00,2021-09-03 05:28:52+00:00,{},"It erroneously uses x2 again instead of the y2 value. It looks like in most cases where replace_terrain is specified with a region, the region goes to the bottom of the screen, and this effect wasn't noticed; but there are some cases like in Orcish Town where it might have been knocking down the wrong walls."
717420503,Remove requirement of object probs adding to 1000,copperwater,2021-08-23 01:15:06+00:00,2021-08-28 14:08:26+00:00,{},"When discussing the recent commit that removed makedefs -o from the
build process, nhmall pointed out that a sanity check ensuring all
objects within one class add up to 1000 probability had been removed as
well. This requirement was a perennial thorn in the side for anyone
doing anything that touches object probabilities, because allocating
probability to something meant deciding what to take it away from,
without a good way to evenly distribute that across all the other
members of the object class.

I had gotten around this in xNetHack by removing the sanity check and
making mkobj() total up the probability within an object class and then
using that instead of 1000. This commit takes a similar approach, but
instead of inefficiently recalculating the sum every time mkobj() is
called, it instead computes it at the start of the game and stores it in
a global variable.

This fixes a slight bias problem with rings - they are all supposed to
be of equal probability, but there are 28 of them and 1000 is not evenly
divisible by that, so the old formula made the later rings slightly more
likely. Now instead of a 35/1000 or 36/1000 chance, they are all
uniformly 1/28. (Internally they have a oc_prob of 1 now, not 0).

Gems are also weird, because their oc_prob values change every level.
This ought to have still worked without a change, because the arcane
formula for assigning the probabilities would still end up with them
adding to 1000. But I added in code to reset the total gem probability
anyway; this may help make the formula less arcane in the future.

There is still a sanity check against object classes having zero total
probability, in which case the game will not start. I also downgraded
the ""probtype error"" panic in mkobj() to an impossible because it has a
reasonable failure case - return the first item in that class."
717325159,Remove g.monstermoves,copperwater,2021-08-22 15:06:51+00:00,2021-08-29 12:09:16+00:00,{},"It's redundant with g.moves, so there is no more need for it.

Way, way back, it looks like g.moves and g.monstermoves can and did
desync, where g.moves would track the amount of moves the player had
gotten (and would therefore increase faster if the player were hasted)
and g.monstermoves would track the amount of monster move cycles, aka
turns. But this has not been the case for a long time, and they both
increment together in the same location in allmain.c. There are no
longer any cases where they will not be the same value.

This is a save-breaking change because it changes struct
instance_globals, but I have not updated the editlevel in this commit.

Also, fixes #288 (the comment in decl.h is wrong)."
717046607,Count all poly'ing tins as potential sliming cures,entrez,2021-08-20 23:27:59+00:00,2021-08-31 13:25:02+00:00,{},"Popeye, used to check whether eating a particular tin is a potential
lifesaving action, considered tins of chameleon meat a cure for sliming
(since you can polymorph into a fiery monster), but didn't credit the
same possible curative power to other tins which can polymorph the hero.

Use the polyfodder macro (used elsewhere to check whether eating
something will polymorph a monster/pet) to determine whether a tin will
polymorph the hero."
714715718,Fix: gold dragon scale mail remains lit in bones,copperwater,2021-08-18 03:36:36+00:00,2021-08-22 12:54:09+00:00,{},"This is caused by the bones-pile-making routine using artifact_light()
as a test for whether it needs to call end_burn. Gold dragon scale mail
uses artifact_light(), but only returns true when its owornmask is set.
But owornmask was getting zeroed right before artifact_light() is
called. Fix is to move it right after instead.

Tested that Sunsword is not affected by this (created bones while
wearing gold dragon scales and wielding Sunsword in a dark area; when
returning to them, no light was emitted from the gravesite) because it
always returns true in artifact_light() irrespective of owornmask."
708951664,Fix: travel from 'interesting' position,entrez,2021-08-11 13:33:21+00:00,2021-09-26 17:37:19+00:00,{},"(including resuming travel after being interrupted)

Attempting to travel from an 'interesting' spot that would normally
stop travel mid-attempt (next to a door, next to a monster, etc) would
fail to get off the ground, because the 'interesting thing' would halt
travel before taking the first step.

Prior to 433f0cc, initiating travel would immediately trigger a call to
domove in rhack; as part of refactoring travel, the order of events in
rhack was changed so that this didn't happen immediately as before.  Add
domove to the end of dotravel_target to produce a similar effect to the
previous arrangement.

domove also zeroes out g.domove_attempting, which I think is the reason
c0c617c seemed to mitigate some of the issues associated with this
problem (e.g. travel target selection seemingly not registering right
away).

Fixes #559

NB: This is the same thing I was talking about in a comment [here](https://github.com/NetHack/NetHack/issues/559#issuecomment-893099847) a while ago; there's some additional description of the issue and test cases in that comment thread."
708901967,Trapdoor consistency,entrez,2021-08-11 13:02:36+00:00,2021-08-12 17:37:19+00:00,{},"Some minor follow-ups to 1b7c372f intended to ensure objects which land on
trapdoors/holes without falling through are consistently treated differently
than those which fall into pits.

- Permit blind feeling for objects on trapdoor
- Fix up msgs when dropping obj on trapdoor
"
707417025,Fix: m-prefix movement into warning symbol,entrez,2021-08-10 14:40:35+00:00,2021-10-16 19:37:18+00:00,{},"Moving into a position containing a warning symbol with m-\<direction\> to
'safely' move would still attack as though the 'm' prefix was not
specified.  Ensure warning symbols are counted as 'detected' monsters
for this purpose, to avoid falling through to do_attack().
"
706037354,Make enchant armor prompt for target item,amateurhourrrr,2021-08-08 12:43:47+00:00,2025-09-17 17:03:42+00:00,{},"This prompts the player for a worn armor piece to enchant when reading a
scroll of enchant armor.

Although this is more flexible than before, the player must select a
worn piece of armor or opt out entirely - they cannot enchant something
that isn't currently equipped.

This should make it more ergonomic to enchant armor, without having
to derobe and shuffle armour pieces around"
705907143,Display a permanent list of nearby characters,NullCGT,2021-08-07 15:29:12+00:00,2025-03-06 13:58:09+00:00,{},"![2021-08-07_10-26](https://user-images.githubusercontent.com/21296090/128605285-b59bd507-0fcf-4c73-a265-1026681b128e.png)
![2021-08-07_10-25](https://user-images.githubusercontent.com/21296090/128605287-09107c64-0118-4a3f-8a7e-d2c5e7d581cf.png)


## Overview

This pull request adds a window in the curses window port which displays
nearby characters on the map. Pressing a key (bound to ']' by default)
changes whether the window is displaying nearby monsters or nearby
objects.

This pull request is a proof of concept; I am very happy to receive and implement feedback.

## Rationale for Change

This is, first and foremost, an accessibility feature. Prospective NetHack
players are often discouraged by the interface, and the lack of explanation
of various characters and symbols. One way to combat this is by displaying
a permanent list of nearby glyphs. Displaying a list of nearby items and
monsters is a feature in many popular modern roguelikes, such as
Cataclsysm: Dark Days Ahead, Brogue, and Dungeon Crawl Stone Soup. In order
to increase its appeal to new players, NetHack should offer this as an
option as well.

Furthermore, this feature can benefit experienced players as well, allowing
them to determine at a glance whether a magenta h is a dwarf king or a
mind flayer. A nearby characters window should greatly speed up play, as well
as reduce some of the tedium of farlooking monsters in order to determine
their identities.

## Technical Notes

While much of the code for this feature is taken from the look_all code in
pager.c, there are a number of differences. First, coordinates are omitted
from the window. While displaying coordinates is useful, we risk overwhelming
new players by presenting them with too much information (something NetHack
is already quite good at). Second, we visually distinguish peaceful monsters
with a different bullet point. Third, pet attributes and color are displayed
in this window, so it is easier to read at a glance.

I made the decision to deviate from the standard set by cursinvt.c and avoid
saving the text in memory, since that would greatly complicate the code for
little benefit.

I chose to implement a toggle for the type of nearby characters rather than
a scroll button like the one used in the permanent inventory. In the future,
a scroll button could potentially be added.

## Considerations

There are a few considerations about this feature that are important to note.
The first is that updating the list of nearby characters is a potentially
expensive operation. While I do not believe this is of great concern, since
the window is only available in the curses window port, which is likely only
to be run on powerful computers, it is still important to note.

When the permanent inventory and permanent nearby windows are displayed at
the same time, the screen becomes rather cramped. I attempted to stack them
on top of one another, but was unable to determine how to do so.

Finally, I recognize that the existing update_nearby() calls are likely
insufficient, and there may be a number of edge cases where the window updates
late.

## Ports
* Curses: Enabled.
* Qt: Enabled.
* TTY: Functions are stubbed out so the port compiles. Strongly suggest not implementing, since the look_all() functionality accessed with the '/' key essentially duplicates the function of this window, and adding a key to display this window would be an unnecessary duplication of code and functionality.
* Windows: Functions are stubbed out so the port is playable. Not implemented.
* Shim: Functions are stubbed out so the port is playable. Not implemented.
* X11: Functions are stubbed out so the port is playable. Not implemented.

Note that stubbed out functions are written in the manner of perm_invent functions in window ports where that option is not enabled.

## Conclusion

That was a lot of words! Feedback is more than welcome."
703962296,Amplify booze effect if drinking on empty stomach,entrez,2021-08-04 20:21:13+00:00,2021-09-03 03:37:17+00:00,{},"Ok, this is admittedly a sort of silly idea, but has [basis in reality](https://www.nytimes.com/2005/12/06/health/the-claim-never-drink-on-an-empty-stomach.html).

Drinking booze on an empty stomach will amplify its effects
(i.e. increase the duration of the resulting confusion); stuffing
yourself before drinking will have the opposite effect."
700683062,Non-metallic gloves protect worn rings from AD_ELEC in destroy_one_item,splatpope,2021-07-31 09:28:49+00:00,2021-09-06 18:03:31+00:00,{},"Based on a suggestion by luxidream (and a bunch of other good people)

The rationale behind this is that a lot of people feel that the now properly working shocking sphere explosion is imbalanced, causing a lot of grief and bitterness due to the loss of important wands and rings it causes. Even other electrical attacks are now considered under a new, harrowing light.

This is the first and the least disruptive of a series of 3 patches I've come up with to address this apparent (and admittedly minor) imbalance, the rest will be submitted if the reception on this one is favorable.

This PR makes it so that rings worn under non-metallic gloves are protected from destruction by electrical attacks. Because, you know, metals conduct electricity and all.
Since the only metallic gloves are the Gauntlets of Power, which are almost always considered the best choice for any ascension-worthy character, this introduces a new layer of tactical choices (Do I want an easy 25 str or do I want my worn rings to be safe ?)."
695260546,Fix: crash when appending to long engraving,entrez,2021-07-22 14:59:40+00:00,2021-07-28 13:48:41+00:00,{},"If an engraving was appended to repeatedly, it could eventually exceed
BUFSZ and cause a crash.  Add some checks to prevent this from happening
and inform the player when she runs out of space to engrave on a
particular square.
"
694944676,termcap.c: Don't use hilites[CLR_BLACK] = NULL for ANSI_DEFAULT,heiner,2021-07-22 07:47:02+00:00,2021-07-22 08:12:00+00:00,{},"This didn't crash since xputs is defensive and checks if it got a NULL
string, but it also didn't display black entries (dragons, unicorns,
orcish arrows, ...) as black or otherwise different from gray entries."
694696123,Fix: engraving with dry magic marker,entrez,2021-07-21 20:44:41+00:00,2021-07-22 04:22:09+00:00,{},"Engraving with a marker can use up remaining charges to write
semi-permanently in ink, or--if the marker has no remaining charges--can
draw in the dust as with a normal blunt item.  Handling in engrave after
a recent refactor (9c6a5fc423) didn't fully cover this second case, and
as a result using an empty marker to engrave would deduct a charge per
attempt and cause an impossible.  This could be exploited by repeatedly
engraving with the same empty marker to underflow the marker charges."
694520457,Fix: off-by-one error in movecmd,entrez,2021-07-21 16:19:37+00:00,2021-07-21 19:44:29+00:00,{},"The for loop which iterates through the list of movement keys in
movecmd(cmd.c) was updated in 5abf948116 to count down to 0 instead of
up to the end of the list.  This commit inadvertently introduced an
off-by-one error which started the loop one past the actual end of the
array.  On my system this made 'H' stop working as the 'run West' key.
"
691464694,Fix #436: writing type-named scrolls,entrez,2021-07-16 12:49:27+00:00,2022-05-28 01:37:20+00:00,{},"When using a marker, it is possible to write a scroll based on the
type-name assigned to it by the user.  Somewhat unintuitively, this
system broke down if the assigned name was identical to the real name of
a scroll type: trying to write a scroll by its previously-assigned name
'scare mon' or 'id' would be guaranteed to succeed, but this wouldn't be
the case if the user-assigned name was 'scare monster' or 'identify'.

Revise dowrite(write.c) to prefer a user-assigned type-name to the
real name of a scroll that isn't already formally known, while
continuing to prefer the real name of an identified scroll to both.

Fixes #436
"
689848388,Fix #423: Teleportation bhitpos issue,entrez,2021-07-14 11:57:22+00:00,2021-07-15 06:37:19+00:00,{},"(m)bhit uses g.bhitpos to track the current tip of a beam.  When a
teleportation beam hits an object, flooreffects eventually gets called
on the object after it has been randomly relocated (via rloco) -- this
updates g.bhitpos to the object's new location.  g.bhitpos was not being
reset to the old 'tip of the beam' location before returning control to
(m)bhit, and as a result, a teleportation beam would continue from the
object's new location instead of the place where the object teleported
from.

This caused problems in the Astral Plane especially, where a
teleportation beam could hit one of the riders if the teleported object
landed in an unlucky spot (as described in #423), but it also
effectively limited teleportation to only hit a single object before
becoming completely unpredictable.

Reset g.bhitpos before returning control to (m)bhit.

Fixes #423

An earlier explanation of the issue that may or may not be clearer is [here](https://github.com/NetHack/NetHack/issues/423#issuecomment-858843993).
"
688255937,Fix: contradictory series of encumbrance messages,entrez,2021-07-12 23:33:37+00:00,2021-07-15 06:37:19+00:00,{},"...when polymorphing into your base form and ""feeling like a new man"".

The use of encumber_msg in redist_attr, which is only called from
newman(polyself.c), was positioned after the hero's stats were
reconfigured but before their polyform was reset to their original race
(this may also restore attributes to the values they had before
modification by redist_attr).  Because the inventory weight cap is based
on the hero's CON and STR as well as current polyform, checking for
encumbrance immediately after changing hero attributes, then again after
resetting polyform, could cause sequences of messages like this:

    You can barely move a handspan with this load!  You feel like a new
    woman!  Your movements are now unencumbered.

Remove the initial encumber_msg from redist_attr and instead only call
it at the end of newman once all the steps involved in changing form are
complete.

A short video of the issue:

https://user-images.githubusercontent.com/40038830/125368429-31f19b00-e348-11eb-9b31-5f04093790c2.mp4"
687151461,Fixed two index out of bounds errors when eating standard eggs.,janne-hmp,2021-07-10 08:50:45+00:00,2021-07-10 15:37:45+00:00,{}," The corpsenm of standard eggs is -1, resulting in the index being out of bounds in mons array."
683833607,Fire vortices shouldn't extinguish flaming objects in hero's inventory,copperwater,2021-07-05 16:48:21+00:00,2021-07-09 18:37:18+00:00,{},"Small change that just makes sense: if the thing whirling around you is
composed of fire that is burning you to a crisp, your candles, lamps,
and lit oil ought to stay burning instead of being snuffed out."
682972781,implement realtime/wallclock statusline timer,aoeixsz4,2021-07-03 05:50:33+00:00,,{},"this pr implements the ui clock developed by @bhaak in such a way that it can update independently of user input

for tty it uses pselect(), for curses they have their own timeout functionality

i am unsure about the portability of this, only tested on Ubuntu 20.04 with Linux kernel 5.8.0-59-generic"
682071052,Fix: itemized billing and perm_invent,entrez,2021-07-01 18:13:24+00:00,2021-07-03 06:37:19+00:00,{},"When buying multiple items from a shop via itemized billing with
perm_invent enabled, paying for any single item would immediately
conceal the prices of all the remaining unpaid items in the inventory
pane, even those that the player declined to purchase.  In other words,
if holding three items from a shop, paying for one of them via itemized
billing would cause the other two items to be listed in the perminvent
pane as though they had already been paid for as well.

Deactivate iflags.suppress_price before the call to update_inventory in
dopayobj(shk.c) so that the inventory pane's item names accurately
reflect which items are still unpaid.
"
681980046,Don't autoquiver aklys that fails to return,entrez,2021-07-01 15:52:47+00:00,2021-07-11 06:37:23+00:00,{},"Changes to the 'f' command in a71d318 have incentivized keeping an
empty quiver while wielding an aklys.  As a result, it's become more
likely that an aklys which fails to return will fall into the ""quiver
is empty"" case used to determine that a thrown weapon should be
automatically added to the quiver when picked up.

Instead of autoquivering an aklys whenever the quiver is empty,
autoquiver it only when the hero is already wielding another weapon.
"
662358784,Resolves missing dependency in NetHack.sln,reksar,2021-06-05 09:22:26+00:00,2021-06-28 15:45:54+00:00,{},"In short: the NetHack project now depends on tilemap.

When I ran

`msbuild NetHack.sln /t:NetHack:rebuild /p:Configuration=Release;Platform=x64`

I was getting the compilation error, because the `tile.c` was not found."
662046255,"Fix: cursed levitation ""head bump"" effect",entrez,2021-06-04 20:54:27+00:00,2021-06-06 03:37:20+00:00,{},"As of 6ec55a3, the condition leading to the ""go up the stairs"" effect of
a cursed potion of levitation was changed to check whether an up
staircase existed anywhere on the level, rather than checking whether
the hero was standing on the appropriate kind of staircase.  As a
result, quaffing a cursed potion of levitation on any level with an
upstairs would attempt to go up the stairs (leading to ""you can't go up
here"" with no further effects) rather than continuing on to the ""bump
your head on the ceiling"" case, etc.
"
661968094,Fix: menucolor help message showing at wrong time,entrez,2021-06-04 18:17:11+00:00,2021-06-06 02:37:18+00:00,{},"Following 28b7a70b, the help message that is intended to appear when you
add a menu color rule without having the 'menucolors' option enabled was
showing up even if 'menucolors' was on, as long as 'perm_invent' was not
also enabled.
"
657097003,Fix: Baalzebub's level can randomly be lit up,copperwater,2021-05-28 21:07:59+00:00,2021-05-30 00:37:18+00:00,{},"This appears to be because unlike most other demon lairs, Baalzebub
uses a solidfill level_init, without specifying the lit state. This
means that the lit state is randomized, allowing the maze to be fully
lit, which is strange in Gehennom where usually they are dark. Force the
lit state to dark."
655638839,"Correct quest guardian, Valkyrie PM alignments",actual-nh,2021-05-28 01:19:13+00:00,2021-06-02 04:37:18+00:00,{},"Correct to neutral the alignments for Attendants (who can grow up into neutral Healer player monsters), Warriors (who can grow up into Valkyrie player monsters), and Valkyrie player monsters. The first is the most egregious problem; the second and third put them into correspondence with the Valkyrie role."
651821505,Additional vomit effects.,NullCGT,2021-05-25 03:53:50+00:00,2021-07-16 03:37:21+00:00,{},"As @davidssmith mentioned in Issue #510 , vomiting on an altar currently has no effect. Given that the simple act of kicking or sitting on an altar provokes the direct intervention and wrath of a deity, this seems like an oversight. Of course, if we're adding some internal consistency to vomit, we might as well go all the way. This patch makes the following changes:

1. Vomiting on an altar provokes the wrath of a deity.
2. If the player is an acidic monster, vomiting on ice will cause the ice to melt, since they have very strong stomach acid (strong enough to reverse stoning).
3. If the player is a monster with an acidic breath weapon (i.e. a yellow dragon) they are treated as if they have used their breath weapon on themself.

This is, quite possibly, the worst thing I have ever written. I'm going to bed."
645794045,Give different messages for flipping through a novel,copperwater,2021-05-17 11:45:51+00:00,2021-05-19 05:37:19+00:00,{},"Current behavior is when you flip through a novel, you get the standard
messages: ""You flip through the pages of the spellbook. The ink in this
spellbook is fresh."" But a novel is not a spellbook, and its ink doesn't
wear out with repeated reading.

This alters the ""flip"" message to refer to it as just a ""book"", and adds
a second novel-specific message. Attempting to flip through a novel
while hallucinating will give the same message as with regular
spellbooks.

There is also a possible minor bug I noticed here: flipping through the
Book of the Dead while blind and deaf produces ""You sense the pages glow
faintly red"", which seems wrong."
632833585,Fix: deliberate revival of cancelled monster,entrez,2021-05-07 14:14:44+00:00,2021-05-07 23:37:18+00:00,{},"mkcorpstat(mkobj.c) adds a norevive flag to all cancelled non-rider
monsters in order to prevent spontaneous resurrection by monsters with a
revive timer (trolls).  This shouldn't be a problem because norevive is
supposed to only block timed revival, not explicit use of undead
turning, but this rule was only applied to certain scenarios (zapping
undead turning at a monster carrying a corpse in its inventory, for
example).

The more typical use of undead turning -- zapping a corpse on the ground
to revive it -- was not clearing the norevive flag before calling
revive(zap.c), and so cancelled monsters could not be revived in this
way.  Ignore norevive for explicit undead turning of a corpse on the
floor."
631985496,Fix: 'partly eaten' 0 nutrition item,entrez,2021-05-06 22:25:56+00:00,2021-05-07 05:37:18+00:00,{},"This was noticed by @rojjaCebolla in SpliceHack, but the problem applies to NetHack too.

Wishing for a partly eaten wraith corpse or tin caused an impossible, because its nutrition is 0 but its oeaten was being set to 1 by consume_oeaten in order to make it ""partly eaten"", causing an impossible in eaten_stat when attempting to calculate its weight.  Prevent consume_oeaten from modifying an object's oeaten value when its total possible nutrition is 0 to begin with.

I think that the only way for this to happen in-game is to wish for these items, so preventing the call to consume_oeaten in the first place would probably be enough to fix this, but adding this test to
consume_oeaten should guard against it in general."
630975981,Fix: nymph theft vs monster,entrez,2021-05-05 22:52:25+00:00,2021-05-06 15:00:57+00:00,{},"Nymphs' item theft attack against other monsters was broken in 1696019,
when a `break` used to select a particular item in the target monster's
inventory was changed to an early return."
630958672,Fix: uninitialized buffer in mhitm theft feedback,entrez,2021-05-05 22:10:41+00:00,2021-05-06 16:16:49+00:00,{},"If a monster with a theft attack (nymph or leprechaun) stole something from an invisible monster (e.g. while under the influence of conflict), and the attacking monster was not itself invisible, the monster name buffer used when printing the ""\<foo\> suddenly disappears!"" message would be used while still uninitialized.  The attacking monster's name was only copied into the buffer if the defending monster was visible, but would be used regardless to print the pline if the attacking monster was visible and teleported away successfully after the attack.

![uninitialized-buffer-use](https://user-images.githubusercontent.com/40038830/117215828-d0073900-adcc-11eb-83f9-0d6b34a068c8.png)

"
627571444,"Fix: ""it looks very angry"" on entering demon lair",entrez,2021-04-30 15:13:45+00:00,2021-05-04 01:37:19+00:00,{},"Getting close to certain ""boss"" demons while wielding Excalibur or Demonbane angers them immediately, but the message ""%s looks very angry"" was printed regardless of whether you could actually see the demon in question -- even if the hero was blind.

<img width=""557"" alt=""Screen Shot 2021-04-30 at 1 17 45 PM"" src=""https://user-images.githubusercontent.com/40038830/116730431-7e1e7780-a9b6-11eb-8647-4955b88dd3b8.png"">

"
627358206,Fix: impossible from eating zombifying corpse,entrez,2021-04-30 12:47:44+00:00,2021-05-02 06:37:19+00:00,{},"When eating a monster that then was revived as a zombie as you were chowing down, the total possible nutrition would be changed based on the new `corpsenm`, but `oeaten` stayed the same.  As a result, if you hadn't eaten much of the corpse when the revival happened and the zombie form had a lower nutritional value than the original form (as is the case for a frost giant turning into a giant zombie, for example), this could result in `oeaten` being higher than the total possible nutrition, triggering an impossible in `eaten_stat()`.  Set the corpse's `oeaten` to be proportional to the new total possible nutrition to fix this."
620346707,fix typo in insight.c,kscheirer,2021-04-21 16:07:46+00:00,2021-04-29 00:37:18+00:00,{},"typo in `createure`

Fixes https://github.com/NetHack/NetHack/issues/495"
617603381,"Fix: encyclopedia typo of ""Galadrim""",copperwater,2021-04-19 01:52:03+00:00,2021-10-16 14:56:28+00:00,{},"Should be ""Galadhrim"", with an h."
617462592,Fix: use correct behavior for des.line() with one coordinate,copperwater,2021-04-18 10:51:11+00:00,2021-04-19 01:37:18+00:00,{},"One would expect that a line from e.g. (10,10) to (10,10) would contain
only that one point, but I discovered that lspo_line doesn't know what
to do with that input and slices a big diagonal line across the whole
map in both directions from that point. This corrects the behavior to
stop after selecting the one point.

This problem is latent in vanilla NetHack because des.line is never
used."
616057009,Fix: some converted altars did not change color,entrez,2021-04-15 13:35:19+00:00,2021-04-18 04:37:19+00:00,{},"A comment in display.c said it was not necessary to check for the color of a glyph changing, because typically the color won't change unless the glyph itself changes as well.  This is true in most cases.

However, there is an exception to the rule: when the hero is invisible and converts an unaligned altar (which is colored red), the glyph itself doesn't change even though its color does.  When this happened, the color wouldn't be updated until the symbol was redrawn for some other reason.  This problem is even more common in versions of NetHack with a patch applied to color altars according to their alignment (this is the case on several public servers), where it could happen for any altar conversion by an invisible hero.

Check whether the color of a glyph has changed in `show_glyph` even if the glyph itself hasn't been updated, so that an (unaligned) altar converted by an invisible hero will change color appropriately, in line with the ""the altar glows white"", etc, altar conversion messages."
615400288,Improve feedback for unseen boulder traps,entrez,2021-04-14 17:00:25+00:00,2021-04-19 01:37:18+00:00,{},"When an unseen monster triggers a boulder trap, the only feedback given is ""you hear rumbling in the distance.""  This doesn't depend on whether the boulder itself is seen, or its distance from the hero, but only on whether the monster that triggered the trap can be seen.  Because a boulder can block line of sight, this means that a character standing immediately behind a boulder when the trap is triggered gets the ""you hear rumbling in the distance"" feedback.  This ""rumbling in the distance"" pline is also printed if a character sees the trap triggered by an invisible monster that is sensed via ESP/monster detection.

This commit would improve this feedback so that actually seeing the boulder launched would take precedence over ""hearing rumbling"", and so that the rumbling of a totally unseen boulder trap could be described as ""nearby"" or ""in the distance"" depending on how close to the hero the boulder is.  It would also change the criteria for monsters being 'seen', so that an invisible monster that is detected by other means and triggers the trap on a square that is visible to the hero would be considered 'seen'.

Also would adjust the ""Click! The foo triggers something."" message so that the ""Click!"" is only printed when the hero is not deaf.



### Examples of some questionable situations where ""rumbling in the distance"" is currently used:

When the boulder itself blocks line of sight to the trap:

https://user-images.githubusercontent.com/40038830/114747394-caaf5500-9d1e-11eb-8946-d46fb1953437.mp4

When a monster is invisible but detected by some other means:

https://user-images.githubusercontent.com/40038830/114747460-dc90f800-9d1e-11eb-92d7-cfaa7ed292df.mp4


"
613125820,"Fix: lantern-specific message called it a ""lamp""",copperwater,2021-04-11 18:39:16+00:00,2021-04-18 04:37:19+00:00,{},"Running out of power only happens and is only printed for lanterns. Call
it a lantern in the message."
610176036,Fix some minor apply getobj prompt regressions,entrez,2021-04-06 21:18:51+00:00,2021-04-19 13:02:46+00:00,{},"Before the getobj refactor (0b638592) it was possible to identify oil by
applying an unidentified potion and seeing whether you were able to
light it successfully; because the apply_ok callback in the refactor
returned GETOBJ_EXCLUDE by default, it became impossible to apply any
potions other than a formally identified potion of oil.  Additionally,
it became impossible to 'apply' an flint stone or luckstone once it or
a touchstone had been identified.

Another change is that prior to the refactor, attempting to apply an
inappropriate object would produce the message ""Sorry, I don't know how
to use that"" -- because of the GETOBJ_EXCLUDE default in apply_ok, this
changed to ""That is a silly thing to use or apply.""

This restores the previous behavior when attempting to apply an
unidentified potion, as well as in the other cases (which are admittedly
not as important or relevant to a normal player).  It also fixes a small
error in a comment explaining the purpose of GETOBJ_EXCLUDE_SELECTABLE."
608076115,Fix travel to diagonally adjacent square,entrez,2021-04-02 15:14:15+00:00,2021-04-05 04:37:19+00:00,{},"When traveling to a square that is adjacent but cannot be moved to in a
single move, for example in this situation, where `*` is the travel
destination and the hero is carrying too much to squeeze between the
diagonal:

    ..*|.
    ..|@.
    .....

The hero would move a single square and then stop:

    ..*|.
    ..|..
    ..@..

This is because when testing whether an adjacent square can be moved to
in a single move (in which case multimove travel is not necessary),
`g.multi` was being reset to 0 before confirming that the destination was
accessible.  Instead, set `g.multi` to 0 only once the adjacent target is
confirmed to be accessible in a single move.

A video of the issue:

https://user-images.githubusercontent.com/40038830/113428161-4d8df280-93a4-11eb-8620-8b3844d96bc4.mp4

"
607739881,Fix some issues with genetic engineer attacks,entrez,2021-04-02 00:25:03+00:00,2021-04-05 07:37:17+00:00,{},"Genetic engineer attacks don't produce a ""the genetic engineer hits!"" message; when not magic-resistant this isn't such a big deal, because there is typically other feedback (""you are subjected to a freakish metamorphosis""), but when magic-resistant the attack does damage without any feedback at all, meaning the hero's health drops each turn without any explanation or warning.

Additionally, a `sparkle` shield effect is supposed to be shown when magic resistance protects a monster from the polymorph attack, but was not showing up correctly when the hero was targeted due to the use of `g.youmonst.mx` and `g.youmonst.my` when calling `shieldeff` instead of `u.ux` and `u.uy`.

This is a small patch to fix both these issues."
604638228,"Additional checks to prevent ""impossible"" statues",entrez,2021-03-30 23:41:00+00:00,2021-04-01 23:37:18+00:00,{},"Although there is already a test to ensure statues on the Medusa level (which are supposed to be erstwhile victims of Medusa) do not represent stoning-resistant monsters, no such test exists to prevent `poly_when_stoned` creatures such as golems from showing up as Medusa statues.  This patch would add a test to ensure golem statues don't appear on Medusa's level.

It would also apply similar checks to ensure the statues created in a cockatrice nest are not stoning-resistant or `poly_when_stoned` mons.  Normally these statues represent players from the high score list, but when the high score list is empty, cockatrice nests will be filled with random monster statues which currently may be ""impossible"" (stoning-resistant, etc) stoning victims."
603359514,Make homemade tins never give more nutrition than the corpse does,copperwater,2021-03-30 04:32:15+00:00,2021-04-02 02:37:18+00:00,{},"This fixes an oddity in how tins work - homemade tins always gave 50
nutrition points, so if you tinned a bunch of low-nutrition monsters
such as killer bees (5 nutrition points per corpse), the resulting tins
all suddenly give 50 nutrition. Where did the extra nutrition come from?

If the corpse provided >= 50 nutrition, a homemade tin of it still gives
50. Other tins still give their regular amounts of nutrition (a tin of
pureed killer bee is not necessarily made from just one killer bee
corpse, so there's no reason why the corpse nutrition of 5 has to
constrain that)."
586489069,Encyclopedia fixes,jonchang,2021-03-08 06:26:25+00:00,2021-03-17 13:37:19+00:00,{},"While going through the NetHack encyclopedia, I've gone through and fixed some consistency issues with cited sources' authors. I've also added a few entries where it makes sense (c-ration -> k-ration, shield of reflection -> perseus, ochre jelly, tin and magic whistle -> whistle, rubber hose -> kops, club, flail, etc -> weapon, most armors -> armor).

Note there are still a few monsters and items that don't have encyclopedia entries associated with them that I couldn't find a good match for:

* stalker
* all gauntlets
* all helms
* all shields
* all worthless glass
* some foods (pancake, eucalyptus leaf)
* some gems (amethyst, aquamarine, black opal, fluorite, garnet, opal)
* some tools (bell, credit card, lenses, lock pick, stethoscope, skeleton key)
* T-shirt
* alchemy smock
* corpse
* ice box
* iron shoes
* loadstone
* novel
 "
586289101,Fix: segfault after in_lua flag was left set,copperwater,2021-03-07 17:14:54+00:00,2021-03-17 06:37:18+00:00,{},"If the in_lua flag is set during normal gameplay, and the player sets
some invalid option, the config_erradd function goes into a different
block that assumes *config_error_data is valid, which is not true in
playerspace.

The proper solution is to avoid leaving is_lua set, and the place it
should be unset and currently isn't is at the end of makerooms() after
loading themed rooms for a new branch. (Reproducing this required
setting !legacy, since otherwise the com_pager call for the legacy text
will set and unset is_lua.)"
584141965,Two unsaddled steed fixes,entrez,2021-03-03 17:36:45+00:00,2021-03-16 22:37:17+00:00,{},"Would fix a bug/regression introduced in ee76646 that causes a hero riding a steed which becomes unsaddled to continue riding without interruption, rather than falling from the steed (as was the previous behavior).

Also would prevent a hero with levitation or flying (from a source other than their flying steed, e.g. polymorph into a flying monster, ring of levitation...) from taking fall damage when their steed becomes unsaddled or bucks them off."
583634958,Prevent obtaining multiple gold stacks,copperwater,2021-03-03 05:12:11+00:00,2021-03-16 23:37:17+00:00,{},"Two similar bugs here, both discovered with the debug fuzzer.

First split gold case is when attempting to throw a partial stack of gold at itself. throw_obj contains a similar bit of logic to re-merge a split stack for when the prompt is canceled, but it isn't canceled in the ""You cannot throw gold at yourself"" case.

Second split gold case is when attempting to quiver a partial stack of gold.

Solution in both cases is to call unsplitobj() after telling the player they can't do these things."
583463801,Fix impossible/panic when monster dies to self-read scroll of earth,copperwater,2021-03-03 01:27:24+00:00,2021-03-16 22:37:17+00:00,{},"When a monster read a scroll of earth and died to a boulder falling on
its own head, it would immediately drop the scroll to the ground. Then
when m_useup called extract_from_minvent after that, it would see that
the scroll was now at OBJ_FLOOR instead of OBJ_MINVENT and trigger the
impossible.

The panic happens following this because extract_from_minvent gave up
and did nothing when it encountered an object not at OBJ_MINVENT, and
predictably a lot of callers of extract_from_minvent want to free the
object afterwards. This commit hardens it against that case by calling
obj_extract_self even if the object is not in a monster's inventory.

To fix the problem of the scroll falling to the ground and then having
m_useup called on it, I moved the m_useup call to before the boulders
drop. This is consistent with player use of the scroll anyway,
disappearing before the effect happens.

I also did this for the case where a monster quaffs polymorph; I think
in some rare circumstances it can die indirectly after polymorphing by
falling onto a trap or unfavorable terrain."
581349527,Two getobj fixes,copperwater,2021-02-27 15:07:07+00:00,2021-03-20 21:37:18+00:00,{},"Discovered a bug in my refactor of getobj a couple of months ago in which the sub-GETOBJ_SUGGEST cases didn't work for selecting '-', even though they are intended to make it selectable. This, for instance, makes it impossible to select your hands at a getobj prompt if the callback returns GETOBJ_DOWNPLAY - valid but not presented outright as an option.

I also pulled qt's fix of #441 into this pull request, at his request, because why not wrap two getobj fixes together?

Fixes #441 and #442."
576939624,Make player explosion attack wake monsters,copperwater,2021-02-20 13:30:01+00:00,2021-03-29 20:37:18+00:00,{},"This brings a polyselfed player's AT_EXPL attacks into line with
monsters' attacks, in terms of making noise. Previously, exploding at a
monster was entirely silent, and exploding at thin air called
wake_nearby which is an XL-dependent radius (usually much larger than
monsters' sound radius of 7).

Now, both exploding at a monster and exploding at thin air wake monsters
in the same 7 sound radius as monster explosions use."
576190491,Fix: engraving with non-blade dulled the weapon anyway,copperwater,2021-02-19 05:26:59+00:00,2021-02-19 17:37:22+00:00,{},"Due to a logic bug introduced when engraving became an occupation - the
code that tests to see whether the player is writing with a weapon that
will get dulled wasn't correctly checking that they were actually
carving an engraving.

Fixes an impossible that occurs when someone writes with a non-blade."
576080425,"Make ""joined"" in Lua and level structs always take a boolean",copperwater,2021-02-19 00:09:22+00:00,2021-02-19 15:29:57+00:00,{},"It is only ever used as a boolean, and having joined=BOOL for regions and joined=INT for rooms is confusing. So this PR changes all types of joined to booleans:

- g.coder->lvl_is_joined
- joined in struct room
- needjoining in struct mkroom
- and all places that did joined=INT in lua files are changed."
569157959,Make engraving an occupation,copperwater,2021-02-08 05:16:14+00:00,2021-02-11 05:37:19+00:00,{},"Instead of inexplicably paralyzing the player for the duration of their
engraving. Many a character has died by trying to engrave something and
then sitting there diligently writing it while monsters surround and
attack them. (This was especially prominent back in the 3.4.3 era when
repeated Elbereths were viable, but it still occurs today with e.g.
using a hard stone to engrave Elbereth). There were also some other
oddities - for instance, if something teleported the player away while
they were engraving, they would continue to ""engrave"" (be paralyzed) on
their new location, but would not produce any text there; the full
engraving would be placed on their initial position.

In this commit, I have converted engraving to use the occupation
framework, which treats it as an interruptible activity. This
necessitated some logical restructuring, mostly involving the engraving
being written out in chunks as the player spends more uninterrupted time
on it.

I've tried to keep this free of regressions except for those inherent to
the occupation system.

What has NOT changed:
- The rate of engraving is still 10 characters per turn, or 1 character
  using slow methods.
- The formulas for determining how much a bladed weapon or marker can
  engrave before getting exhausted are kept. Though this is a bit
  convoluted, and if it's not considered important to preserve the
  existing behavior, I would recommend simplifying it by decreasing the
  maximum engraving length for weapons by 1 so that each point of
  enchantment simply gets you 2 characters' worth of engraving (e.g. a
  -2 weapon will only engrave 1 or 2 characters before dulling to -3,
  rather than giving it a third ""grace character"".
- The input buffer is still modified based on confusion/blindness/etc
  only at the time when the player inputs it (if they gain a
  debilitating status while engraving, it will not affect the text). My
  personal preference is to make the text affected in scenarios like
  that, but it's not strictly necessary to do here, so I didn't.
- Wand messages such as ""The floor is riddled by bullet holes"", and
  blinding from engraving lightning, still appear before the hero starts
  to take any time engraving. As noted above, getting blinded by the
  wand still has no effect on accurately engraving the text, unless the
  hero was already blind or impaired.

What has changed:
- Moving off the engraving or losing the object being engraved with
  causes the player to stop engraving.
- Wands can still engrave an arbitrary amount of text using a single
  charge, but if the hero is interrupted and decides to start engraving
  again, they will consume a second charge.

As it adds a new field to g.context, this is a save-breaking change."
568583661,Remove chaotic stormbringer peaceful penalty,RojjaCebolla,2021-02-05 20:06:35+00:00,2021-07-17 06:44:33+00:00,{},"    Characters of all alignments, including Knights, can already remove shopkeepers
    and guards without penalty. From the wiki:
    ""The simplest way to get rid of a peaceful human while avoiding the penalty for
    murder is to let your pet do the dirty work. You can also polymorph your victims
    before killing them. Note that a failed polymorph, "" shudders."" (system shock),
    still counts as murder.""
    
    When a player is chosen to ""steal souls"" for the glory of whomever is concerned,
    it's a pretty big flavor glitch for stormbringer to start blasting the user for
    successfully snuffing out a soul with the artifact weapon that encourages murder
    (Not to mention the weird fantasy racism in which elf, orc, & dwarf deaths don't
    cause nearly the same level of punishment as human deaths do.)
    
    And in general, it's weird for chaotics to be god-penalized for any ""crime"".
    
    So the proposed change is that chaotic stormbringer users don't lose huge chunks
    of alignment for hitting peacefuls. I did not mess with the luck penalties, as
    those do not cause artifact blasting. While i find them unnecessary, they don't
    seem like a significant flavor glitch."
566174743,Consent,mlehotay,2021-02-02 18:21:55+00:00,2021-02-02 20:33:58+00:00,{},"WIP - sorry, included too many commits here. ignore the first 21 commits. consent branch starts with 1c6c45d
need to rebase branch, trying to figure out if I can [preserve the comments](https://github.com/isaacs/github/issues/443)

nope - don't think I can keep the comments if I rebase.

closing this pull request, will open another when ready for review."
560709718,Unify code for extracting an object from a monster's inventory,copperwater,2021-01-25 00:22:43+00:00,2021-02-01 19:37:20+00:00,{},"The code for doing this (basically an obj_extract_self() call plus
handling if the object was worn or wielded) was duplicated all over, and
inconsistent - for instance, though all of them updated the monster's
misc_worn_check to indicate it was no longer wearing something in
whatever slot, only one call also set the bit that flags the monster to
consider putting on other gear afterwards.

Under a new function, extract_from_minvent, all this extra handling is
checked in one function, which can simply replace the obj_extract_self
call.

A few callers (such as stealing) have some common code *after* the
object is extracted and some other things happen such as message
printing, such as calling mselftouch if the object was worn
gloves. extract_from_minvent does not handle these cases."
560320584,Allow running over water with IDed water walking,entrez,2021-01-23 04:25:26+00:00,2022-06-16 15:52:25+00:00,{},"Currently, only levitation or flight allow a character to run and use the travel command over water or lava.  The water walking extrinsic doesn't provide the same ability, for fear that it would give players a risk-free way to test whether something provided water walking: wear the item, run at some water, and see whether you're stopped at the edge or not:

https://github.com/NetHack/NetHack/blob/96ee175ce89ab71aa038c33d7d96c538d3debf8e/src/hack.c#L2897-L2900

This risk can be defused, though, by requiring not just water walking, but water walking provided by a known source (i.e. already-identified water walking boots).  Allowing heroes with an identified source of water walking to travel/run across the water doesn't provide the same opportunity for risk-free identification, and can make it a lot more convenient to traverse watery levels.

Identified water walking boots still wouldn't allow running over lava, even if they are known to be fireproof.

This would also add transition points between water/lava and land as ""interesting"" features that will pause running started by <kbd>G</kbd><kbd>k</kbd> or <kbd>g</kbd><kbd>k</kbd> (though not running by <kbd>Shift</kbd><kbd>k</kbd>), regardless of whether the hero can traverse the terrain on the other side of the transition.  This would allow people with water walking boots, a ring of levitation, etc, to use <kbd>G</kbd><kbd>k</kbd> to run within an island on Medusa's level, say, without continuing out into open water by accident.

I also changed the phrasing of the `flags.mention_walls` messages associated with stopping short of one of these transition points, since the previous phrasing of ""you stop at the edge of the %s"" wasn't totally clear about which side of the edge you were on -- since now these transitions between water and land can be approached from either direction, I tried to make the messages clearer about where exactly the character stopped."
560177965,Allow custom increment amounts in #wizintrinsic,entrez,2021-01-22 19:54:40+00:00,2021-01-22 20:38:21+00:00,{},"Let users of `#wizintrinsic` set a specific amount by which they want to increment each particular timeout, by entering a count/typing in numerals before selecting the item in the list.  I think doing it this way should be pretty intuitive to players who are familiar with the 'enter count -> make selection' flow of normal inventory menus in NetHack, and is simpler than using a separate prompt, as was mentioned as a possibility in a comment.

When an intrinsic is selected without entering a count, the increment will continue to default to the previous value of 30; this value is set via the `DEFAULT_TIMEOUT_INCR` macro.

I also deleted a redundant declaration of `wiz_intrinsic`; the duplicate seems to have been added by mistake in ff6139c6c5.

(Edit: merged via 77d4b4c955a9256129b601f0af70033821c3c502)

"
559697543,"Scrap xlogfile flags field, replacing it with ""mode""",copperwater,2021-01-22 04:05:51+00:00,2021-04-16 18:04:13+00:00,{},"As of the recent commit introducing a ""bones"" field in the xlogfile,
there is no more particular need for the 0x4 bit in flags. Its semantics
of ""if flags & 0x4 is set, then this game did NOT load any bones"" were
confusing and unintuitive anyway.

Then, with bones now out of the flags field, the only thing that flags
is used for is marking games as being in wizard mode or explore mode.
Despite the flags encoding function treating them as potentially
independent variables, they seem to be mutually exclusive to me: the
game doesn't allow you to start in both wizard and explore mode, and if
you do #exploremode while in wizard mode you get a warning that you are
leaving wizard mode.

Thus, this commit gets rid of flags entirely, replacing it with a
""mode="" field in the xlogfile. Possible values are ""wizard"", ""explore"",
and ""normal""."
557085469,fix issue 449 - dishwasher gender should be compatible with hero,mlehotay,2021-01-18 23:42:38+00:00,2021-01-19 01:57:46+00:00,{},"assuming the hero is straight

see [issue 368](https://github.com/NetHack/NetHack/issues/368) for related discussion"
552380116,Fix Issue 443 - X11 Support for status_hilite Rules,theexternvoid,2021-01-11 00:56:18+00:00,2021-05-13 20:34:20+00:00,{},"For the X11 UI, I implemented the most important status_hilite rules: colors and invert. Bold, blinking, etc. are still not supported in this update. Also makes X11 honor the number specified in the statushilites config option."
551927100,force_invmenu getobj listings,entrez,2021-01-08 19:49:09+00:00,2021-03-20 21:42:10+00:00,{},"Instead of listing the entire inventory when `force_invmenu` is on and `getobj` flags include `GETOBJ_PROMPT` (as described in #441), only applicable objects will be printed as long as any exist (either suggested or alternative choices).

However, a `getobj` callback that returns `GETOBJ_SUGGEST` for every item in inventory (such as `any_obj_ok`, used for the <kbd>d</kbd>rop command among other things) would produce a list of allowable objects that is in effect identical to the entire player inventory. Because of the way `display_pickinv` works, when this list is passed to it as a list instead of explicitly as the entire inventory, a useless ""* - (list everything)"" item is appended to it.  In order to fix this behavior, this patch would also add a test before adding the '*' item to ensure it will not be included for lists that already encompass the entire inventory.

There's more discussion of the ways `(*lets || *altlets)` is and isn't comparable to `*let` in pre-refactoring `getobj` in #441."
548591258,Refactor getobj() to use callbacks on candidate objects,copperwater,2021-01-05 02:26:29+00:00,2021-01-07 20:37:20+00:00,{},"This replaces the arcane system previously used by getobj where the caller would pass in a ""string"" whose characters were object class numbers, with the first up to four characters being special constants that effectively acted as flags and had to be in a certain order.  Because there are many places where getobj must behave more granularly than just object class filtering, this was supplemented by over a hundred lines enumerating all these special cases and ""ugly checks"", as well as other ugly code spread around in getobj callers that formatted the ""string"".

Now, getobj callers pass in a callback which will return one of five possible values for any given object in the player's inventory. The logic of determining the eligibility of a given object is handled in the caller, which greatly simplifies the code and makes it clearer to read.  Particularly since there's no real need to cram everything into one if statement.

This is related to pull request #77 by FIQ; it's largely a reimplementation of its callbacks system, without doing a bigger than necessary refactor of getobj or adding the ability to select a floor/trap/dungeon feature with getobj. Differences in implementation are mostly minor:

- using enum constants for returns instead of magic numbers
- 5 possible return values for callbacks instead of 3, due to trying to make it behave exactly as it did previously. PR #77 would sometimes outright exclude objects because it lacked semantics for invalid objects that should be selectable anyway, or give slightly different messages.
- passing a bitmask of flags to getobj rather than booleans (easier to add more flags later - such as FIQ's ""allow floor features"" flag, if that becomes desirable)
- renaming some of getobj's variables to clearer versions
- naming all callbacks consistently with ""_ok""
- generally more comments explaining things

The callbacks use the same logic from getobj_obj_exclude, getobj_obj_exclude_too and getobj_obj_acceptable_unlisted (and in a few cases, from special cases still within getobj). In a number of them, I added comments suggesting possible further refinements to what is and isn't eligible (e.g. should a bullwhip really be presented as a candidate for readying a thrown weapon?)

This also removed ALLOW_COUNT and ALLOW_NONE, relics of the old system, and moved ALLOW_ALL's definition into detect.c which is the only place it's used now (unrelated to getobj). The ALLOW_ALL functionality still exists as the GETOBJ_PROMPT flag, because its main use is to force getobj to prompt for input even if nothing is valid.)

I did not refactor ggetobj() as part of this change."
548587044,"Add the monstercolor system, letting players choose monster colors",copperwater,2021-01-05 02:13:07+00:00,,{},"This existed as one of the 3.4.3-nao patches, but rather than porting that patch to the current codebase I started from scratch, because the system as I saw it had two big drawbacks:

1. Mutated mons[], which is just not a great idea in my book.
2. Colors were only settable via config file, not in-game. I envisioned monster colors working like msgtypes or autopickup exceptions, which can be modified in-game.

To that end, monstercolors are settable in-game via a submenu in the ""Other settings"" section of the options, like autopickup exceptions or msgtypes, as well as via ""MONSTERCOLOR=monname:color"" in the config. Also like those settings, they do not persist through saving and restoring, but any config lines will be loaded as normal upon restore.

Instead of directly editing mons[], it edits a new variable 'monstercolors' in instance_globals. I thought this might be unnecessary
at first, but then realized that if it changed mons[].mcolor like the NAO patch, then it would be impossible to count the number of currently set monstercolors because there would be no default to compare against."
547532351,Typo (Hogfather),actual-nh,2021-01-01 00:51:29+00:00,2021-01-01 08:37:20+00:00,{},"Two typos in a quotation from Hogfather; I have checked (Corgi edition (13th printing?), 1997, page 310) and corrected it to match the original."
545845958,Art Contribution: Differentiating gendered monster tiles.,NullCGT,2020-12-27 19:07:22+00:00,2020-12-28 03:37:20+00:00,{},"This pull request is a response to 0c3b9642e4207ed3c0b756585b83477f59116305, in which nhmall expressed interest in contributions that would make gendered tiles visually distinguishable from one another. Since I've spent way too many hours editing NetHack's default tileset and the thought of trying to merge this commit into my variant gives me an absurdly massive headache, I thought I would have a go at it!

Making tiles of different genders distinct in NetHack presents an interesting problem. While it would be fun to create highly distinct tiles for every gender, doing so would reduce the accessibility of the game, since players would have to remember many more tiles, and might end up confusing one monster for another. Visual clarity is key.

Therefore, I had the following goals when creating this pull request:
1. If there is an interesting way to differentiate tiles by gender, do so.
2. Any sort of differentiation should be minor enough that a user can still tell what a monster is at a glance. Essentially, visual clarity comes before differentiation by gender.
3. Try to use a ""TDTTOE method"" of differentiating tiles. For example, female cats are more colorful than males, because generally male cats have only two colors of fur. Basically, I spent a lot of time on wikipedia researching sex characteristics of different species.
4. Try not to fall into ""female = longer hair / eyelashes."" While this feature will unfortunately require some gender-essentialist visual shorthand, this tropes is overdone and exhausting.

Please let me know what you think; I'm totally open to feedback on all of this and happy to make modifications. I've attached the resulting tiles file to this post in png form.

The alterations made in this pull request are as follows:

- Female ants are slightly larger than male ants, just like in real life. I could have added wings to the male ants, but I felt that doing so would lead to some confusion.
- Female wolves are slightly smaller than male wolves. There wasn't a great way to show this without making winter wolves look very similar to winter wolf cubs, so I just made the female wolves tails slightly shorter.
- Calico cats are almost exclusively female, so I turned the female cats into calico cats. The other piece of logic behind this choice was that players will probably really enjoy seeing different variants of their pets.
- Female hobbits, minotaurs, humans, werecreatures, and aleaxes wear slightly different clothing.
- Dwarfs are **not** differentiated in any way whatsoever. According to Terry Pratchett (in Unseen Academicals, if I remember correctly) it is almost impossible to tell what gender a dwarf is, even for fellow dwarfs. I strongly believe that NetHack should follow this tradition.
- Female leprechauns, archons, frost giants, guards, and all types of gnomes are clean-shaven. Although of course not one hundred percent accurate, it's convenient visual shorthand.
- Centaur tiles have no differentiation because the different types of centaurs are already extremely difficult to tell apart from one another.
- Female ogre tyrants and elven monarchs have slightly different crowns.
- Female quantum mechanics have a different hairstyle and no beard. Genetic engineers look the same, because the genetic engineer tile is perfect.
- Female barrow wights look like old grandmothers with flyaway hair. I kept the hair color the same and used a similar quantity of pixels so that they look similar enough to the males that you can tell they are barrow wights.
- Female archeologist tile is a reference to a certain archeologist known for raiding tombs.
![nhtiles](https://user-images.githubusercontent.com/21296090/103177963-6b4b3900-4844-11eb-8cd4-f6105333f318.png)


"
545457869,Fix some dismount loopholes,entrez,2020-12-24 20:22:16+00:00,2021-01-07 22:00:54+00:00,{},"Dismounting doesn't currently test whether the destination spot could be moved to normally, so can be used to squeeze diagonally into a space that would normally be blocked because ""you are carrying too much to get through"". This can be abused in Sokoban to pass through gaps that are normally inaccessible, and even in normal levels can leave the hero in a spot from which they can't escape without dropping items or using a pick-axe. This patch would block dismounting through diagonals which are normally impassible by adding a successful result from `test_move` as a condition of choosing a dismount location.

Additionally, dismounting will opt to place the hero onto a boulder if no other appropriate spots are available. This too can be abused in Sokoban, so these changes would also add the standard luck penalty for using this behavior to pass over boulders on an unsolved Sokoban level."
539326863,Update README.xcode to fix spelling errors,chota,2020-12-14 10:11:08+00:00,2020-12-14 16:37:20+00:00,{},"Two spurious instances of the letter ""g"" were vanquished."
537529944,Improve consistency of polearm targeting rules,entrez,2020-12-11 23:20:04+00:00,2020-12-13 09:06:15+00:00,{},"Multiple functions are involved in the process of targeting and attacking an enemy with a polearm or lance, and these functions currently use inconsistent tests to determine which targets are legal.  For instance, `find_poleable_mon` gives up immediately if the hero is blind, while neither `get_valid_polearm_position` nor `use_pole` care as long as the hero could detect a target on the square (e.g. by ESP).  `find_poleable_mon` considers warning symbols as potential
targets, but `use_pole` discards them.  `get_valid_polearm_position` considers moats and pools to be illegal targets, but `use_pole` lets the hero successfully hit a monster on those squares; on the other hand, `get_valid_polearm_position` marks squares that are not visible and do not contain a known monster as legal targets, while `find_poleable_mon` and `use_pole` exclude them.

Obviously this is inconsistent and could introduce confusion for polearm users, who may potentially need to explicitly target squares marked `(illegal)` at some point over the course of their game, among other problems.  This commit makes polearm targeting tests more consistent; the following rules are applied to positions within the appropriate range:

* Monsters which are detected by any means that reveals an actual monster glyph are legal to target, even if the hero is blind

* Monsters the hero cannot detect, but is aware of -- i.e. those represented by an `I` -- are similarly legal to target

* Monsters detected via warning are not legal targets, since the hero does not have as strong a sense of where exactly they are, their shape and size, etc

* Statues are legal targets, but will not be suggested by `find_poleable_mon` unless the hero is impaired (confused, stunned, or hallucinating); the same is true of tame/peaceful monsters

* Apparently empty squares, including those containing an undetected monster, are legal to target unless they cannot be seen (whether due to blindness or a very dark room/level)

* Positions which are otherwise legal but are blocked by an obstruction like a tree or pillar are not legal targets"
537411588,Add liquid flow to land mine explosions,entrez,2020-12-11 21:12:14+00:00,2021-01-07 05:43:05+00:00,{},"Land mine explosions currently do not call `liquid_flow(dig.c)`, and as a result the pit created by an exploding land mine will never fill with adjacent water or lava, as pits created by other sources -- digging, breaking a wand, and earthquake -- can do.

This commit adds the appropriate calls to `liquid_flow` and `fillholetyp` to `blow_up_landmine` so that land mine explosions may fill with water like other pits do.

The call to `losehp` in `dotrap` had to be moved from after to before `blow_up_landmine`, since waiting to call `losehp` when the pit can fill with water could lead to silly messages (\`\`That was a close one. You die...'').  After this change, a land mine that killed a character would be retained unexploded in a bones file, because death would occur before the call to `blow_up_landmine`.  To avoid this issue, the land mine is converted to a pit before calling `losehp`; `blow_up_landmine` does not check whether the target trap is in fact a landmine so works as usual even if the trap is converted to a pit, and will delete the pit in cases where it should not exist.

(I closed #414 and rebased the branch after recent changes to trap.c introduced merge conflicts that needed to be resolved manually, so this is effectively the same PR as that one)"
536327065,Print a message for the juiblex change,RojjaCebolla,2020-12-10 23:10:14+00:00,2021-04-10 09:26:10+00:00,{},To help clue people in who are using the old strategy.
536126685,Fix counterintuitive towel wetting/drying behavior,entrez,2020-12-10 17:52:42+00:00,2020-12-13 00:37:18+00:00,{},"# Summary

Would allow fire traps/attacks to completely dry wet towels -- which is the original intended behavior as described in the commit message of 4b8db661dd -- and change towel wetting behavior so that dipping a towel in water would no longer have the potential to make it dryer.

# Details

Fire traps currently never fully dry out a wet towel; although a wetness level between 0 and the towel's current wetness inclusive is chosen at random and passed to `dry_a_towel(weapon.c)`, because `dry_a_towel` [interprets 0 as a no-op](https://github.com/NetHack/NetHack/blob/3e183d0c6ad0f3aac42d821b15ada2cc1173bf2c/src/weapon.c#L993) it never actually sets the dryness to that level. As a result, the towel is twice as likely to retain its existing wetness level, and can never be fully dried by a fire trap.  Passing a negative number in the same range instead decrements the result by that amount, allowing fire traps to dry out wet towels completely.

On a similar note, wetting towels by dipping them in water (or falling in) sets their wetness to a completely random level.  This means that dipping a wet towel into water can actually dry it out relative to its previous wetness, which doesn't really make a lot of sense and can be confusing in-game (for example, dipping a wet towel into a moat can visibly turn it into a moist towel).  This commit would change the behavior of towel wetting so that the current wetness is incremented by a random amount instead."
532199226,Add alchemy smock text to game-end disclosure,entrez,2020-12-04 00:13:23+00:00,2020-12-14 15:37:19+00:00,{},"T-shirts and candy bars have their text listed in the end-of-game list of identified possessions, with the stated intent that it can give unspoiled players a hint that these objects can be read. Following the same logic, aprons/alchemy smocks should have their text listed as well."
528903577,"docs: fix simple typo, accomodate -> accommodate",timgates42,2020-11-28 07:04:15+00:00,2020-11-28 18:37:19+00:00,{},"There is a small typo in include/patchlevel.h, outdated/sys/wince/mhmsgwnd.c, win/win32/mhmsgwnd.c.

Should read `accommodate` rather than `accomodate`.

"
524152022,Add liquid flow to land mine explosions,entrez,2020-11-19 18:33:46+00:00,2020-12-11 03:59:42+00:00,{},"Land mine explosions currently do not call `liquid_flow(dig.c)`, and as a result the pit created by an exploding land mine will never fill with adjacent water or lava, as pits created by other sources -- digging, breaking a wand, and earthquake -- can do.

This commit adds the appropriate calls to `liquid_flow` and `fillholetyp` to `blow_up_landmine` so that land mine explosions may fill with water like other pits do.

The call to `losehp` in `dotrap` had to be moved from after to before `blow_up_landmine`, since waiting to call `losehp` when the pit can fill with water could lead to silly messages (\`\`That was a close one. You die...'').  After this change, a land mine that killed a character would be retained unexploded in a bones file, because death would occur before the call to `blow_up_landmine`.  To avoid this issue, the land mine is converted to a pit before calling `losehp`; `blow_up_landmine` does not check whether the target trap is in fact a landmine so works as usual even if the trap is converted to a pit, and will delete the pit in cases where it should not exist."
522920958,"WASM refactoring, fixes",apowers313,2020-11-18 05:21:43+00:00,2020-11-18 17:38:11+00:00,{},"Two changes:
* Set NO_EXIT_RUNTIME in the WASM build so that NetHack can run repeatedly
* Pull the [npm](https://www.npmjs.com/) package and unnecessary out of NetHack so that it's more self-contained and easier to iterate on. I moved the code [here](https://github.com/apowers313/NetHackJS). It might make sense to move this repo back to the NetHack organization -- let me know what you think.
"
520105550,Free hilites entries in termcap.c when ANSI_DEFAULT is set.,heiner,2020-11-12 19:22:43+00:00,2021-01-01 03:37:19+00:00,{},
518366295,Spell cancelling,AndrioCelos,2020-11-10 09:58:46+00:00,,{},"This branch reorganises `spell.c` so that it is now possible to cancel casting most spells at the direction or target prompt.

- `tryspell` checks conditions that would prevent casting, and handles Amulet energy drain.
- `targetspell` prompts for a direction or target (for skilled fireball or cone of cold).
- `spelleffects` now handles the actual spell effects, and assumes the spell is successful.
- `docastspecial` is now used to cast a specific spell via a command other than `Z` instead of `spelleffects`. It can skip the direction/target prompt (for `^T`).

However, there are some considerations regarding these changes:

- Wands aren't changed. If you cancel at the direction prompt when zapping a wand, it does nothing but still uses a charge.
- The message 'Never mind' is normally shown if you cancel at the direction prompt.
- The roll for spell success is still done before the direction prompt, so you can cancel after this roll.
- If you cancel after Amulet energy drain has occurred, it still uses a move. The message is replaced with 'Nothing happens' in this case.
- The jumping spell hasn't been changed. With teleport away, you can cancel at the direction prompt, but not at the prompt for where to teleport to if you have teleport control (doing so still casts the spell, but you don't actually teleport).
- For skilled fireball or cone of cold, picking an invalid target or casting the spell underwater or on the Plane of Water is considered the same as cancelling it. Some messages may need to be changed.

This branch also fixes a minor bug whereby unskilled fireball and cone of cold were subject to half physical damage when cast at yourself, and changes the message 'You don't have enough energy to cast that spell' to 'You no longer have enough energy to cast that spell' if you had enough energy prior to the attempt but didn't after Amulet energy drain."
512594317,`Readable' Hawaiian shirt designs,entrez,2020-10-29 21:59:24+00:00,2021-07-16 20:37:19+00:00,{},"Functionally similar to reading a t-shirt or apron, but rather than actual text printed on the shirt being read and displayed, the design of the Hawaiian shirt is instead described.

<img width=""450"" alt=""``The design features hula dancers on a yellow background''"" src=""https://user-images.githubusercontent.com/40038830/97636408-74b85080-1a0f-11eb-8551-d207c62be65d.png"">
"
512576964,Add a guard for corpsenm in polyfodder macro,amateurhourrrr,2020-10-29 21:21:43+00:00,2020-11-06 04:37:25+00:00,{},"If for example a dog eats a generic egg or a metallivore eats a
tin of spinach this will attempt to index into the mons array with a
negative index

Spotted whilst fuzzing with address sanitizer"
507505321,Prevent sokoban levels being flipped,amateurhourrrr,2020-10-21 12:40:34+00:00,2025-09-17 17:03:42+00:00,{},"Sokoban levels in particular being flipped is a cause of a frustration,
particularly for long-time players whose muscle memory gets confused.

Note that the player confusion is different from if there were new levels
instead (my preferred solution) that must be done.

To a lesser extent it affects new players attempting to follow a guide,
though guides can be independently updated."
506256508,wasm bug fixes,apowers313,2020-10-19 20:26:44+00:00,2020-10-31 17:37:20+00:00,{},"Fixes wasm bugs:
* stray printf
* COPYRIGHT_BANNER_C not defined for cross-compile
* define NO_SIGNAL and wrap it around calls to `sethanguphandler`
* set HACKDIR to `/` and include files at that location
* add `--profiling` flag to prevent 10MBs of text dumped to screen on error
* fix npm build
and more :)"
500996617,Use simple_typename when trying to repair a broken lock,entrez,2020-10-10 15:49:03+00:00,2020-10-11 15:08:19+00:00,{},"Using `doname` includes information like BUC level, so that the resulting message when <kbd>a</kbd>pplying a key on a broken box is something like \`\`You can't fix its broken lock with an uncursed key.'' -- this makes me feel like \`\`uncursed'' is being stressed, as if a blessed key *would* fix the lock (and so on for any other attributes `doname` can include). I think it's clearer to just say ``You can't fix the lock with a [skeleton key|credit card|lock pick].''"
499197360,Fix non-whirly monsters seeping through their shirts,copperwater,2020-10-07 12:00:55+00:00,2020-10-07 17:37:19+00:00,{},"Minor message bug. Checking sliparm is wrong here because that entire segment of code was already in a clause that had guaranteed sliparm. Assuming this is supposed to be a mirror of the player logic in polyself.c, the case for seeping through one's shirt should be limited to whirly monsters.

The weird message is reproducible by turning on monpolycontrol, getting some monster to pick up and put on a +5 shirt, and polymorphing it into something tiny like a newt that will trigger sliparm but is not whirly."
494280349,More level generation bug fixes,copperwater,2020-09-28 16:56:03+00:00,2020-09-28 17:01:34+00:00,{},"This contains a couple more fixes for bugs discovered later in xNetHack after the Lua changes in #347 were merged into it, plus a couple fixes for latent level generation bugs."
493779387,Fix: missing filled flags in various levels,copperwater,2020-09-27 21:21:59+00:00,2020-09-28 14:15:52+00:00,{},"This is an omission in the filled/prefilled unification. The default for
filled on regions now being 0 meant that regions that had previously had
no need for any fill declaration at all (regions' prefilled defaulted to
0 before this, the effect being to fill them) now failed to get filled.

The rule of thumb is that all des.regions with a type for which filled
is meaningful (e.g. special rooms) should declare the fill status. I
added it to a bunch of temples even though this doesn't really seem to
affect anything there (the priest and altar come with the altar
definition). I assigned temples filled=1 and filled=2 loosely based on
if there is ever being some other generation that would put other
furniture or items in a temple, but the distinction should not affect
anything right now.

Cases fixed where non-temple regions weren't getting filled:
- Barracks, a graveyard, and shops in Tou-goal
- The beehive in the Wizard's Tower"
489585402,"Fix the ""stuck pets"" bug (github issue #329)",copperwater,2020-09-18 23:46:51+00:00,2020-09-27 21:39:27+00:00,{},"This commit is intended to fix the bug where a pet will get fixated on
an unmoving monster and stop moving itself. I described the cause in the
github issue; the gist is that the pet AI chooses the unmoving monster
as its ranged target, doesn't do anything when it calls mattackm
(because it doesn't have ranged attacks), then returns a value
indicating it didn't move and can't take further actions.

I initially implemented a fix that refactored mattackm to distinguish
between ""attacker missed"" and ""attacker did nothing"", which the pet AI
could then use to determine whether the pet could continue doing things.
But then I realized that if mattackm is called with non-adjacent
monsters, a return of MM_MISS more or less unambiguously indicates that
the attacker did nothing (because the ranged functions it calls like
breamm don't actually check to see whether the target was hit, just
whether the monster initiated the attack.) So, this only really needed
to check whether mattackm returned with MM_MISS.

I also found a probable bug in mattackm, in that the thrwmm call isn't
treated the same as breamm or spitmm. In the latter two, mattackm
returns MM_HIT even though it doesn't check whether the ranged attack
actually hit its target. But there was no logic doing the same for
thrwmm, so this commit also adds that. (Otherwise, a pet could possibly
use a ranged weapon attack and then get to keep moving on its turn.)"
475978432,"Fix several issues with monster interruption checks, and an info leak",FredrIQ,2020-08-30 23:28:51+00:00,2020-09-19 03:37:19+00:00,{},"The automatic interruption system for approaching monsters was comparing
the old tile in cases where new tile was intended. Also, the way the checks
were constructed caused monsters seen by astral vision to constantly interrupt
you. There was also an information leak where the game would reveal monsters
without any attacks even if you were hallucinating. The game also stopped
interrupting you if you were confused, which was not only confusing to the
player, but also a pointless UI screw.

The interruption conditionals was changed. This is how the new system works:
Monsters interrupt you if:
* they are within 9 tiles (ball radius), can be spotted (vision or detection),
  and within LOS, and...
* it was outside 9 tiles ball radius, outside LOS or wasn't previously spotted.
* monster is hostile, has attacks, or you're hallucinating (since it conceals
  the information)"
475951444,libnethack,apowers313,2020-08-30 19:15:05+00:00,2020-10-05 04:37:22+00:00,{},"This PR has two new builds:
* `libnethack.a` -- a unix-ish library that can be linked against
* `nethack.js` -- a WebAssembly build of NetHack that can be run in the browser or node.js. This is also prepared to be published as a public [npm](https://www.npmjs.com/) module under `sys/lib/npm-package`.

See `sys/lib/README.md` for more details details about how to build and the library APIs."
474067694,Cygwin port,WillyHack,2020-08-26 18:03:56+00:00,,{},Trying this out in a new Cygwin Install
468386895,Fix player rendering as slime one turn early,copperwater,2020-08-16 02:17:35+00:00,2020-08-28 03:39:29+00:00,{},"This bug can be reproduced by getting Slimed, then waiting around until
the message ""You are turning into a green slime"", then moving. The
player renders as a green slime even though they have not yet become a
green slime and have one more action that could be used to negate the
sliming.

This is caused by the slime_dialogue() function causing the player to
appear as a green slime when the counter ticks down to 2, rather than 1
(which is the point at which ""You have become a green slime."" is shown
and the slime transformation actually happens). I *think* the original
purpose of doing it this way was because the next newsym() normally
wouldn't happen until the turn on which the timer ticks down to 1 - but
if the player forces a newsym by other means (such as moving) the bug is
exposed.

The fix here changes it so that the hero only starts rendering as a
green slime on that tick down to 1, then immediately calls newsym() to
show them as a slime during the ""You have become a green slime"" message
as originally intended."
468324283,Replace some checks on M3_DISPLACES with is_displacer(),copperwater,2020-08-15 14:39:16+00:00,2020-08-28 05:37:18+00:00,{},"There's no real reason to have it directly check M3_DISPLACES if there's
a macro that does this exact thing. No game logic is changed by this."
464770229,Fix aborted worm placement failing sanity check,entrez,2020-08-07 18:58:28+00:00,2020-08-08 03:37:20+00:00,{},"`initworm(worm.c)` sets `wx` and `wy` of `wheads[worm->wormno]` to `worm->mx` and `worm->my`. Because `place_worm_tail_randomly` reverses all the segments of the worm in the process of placing them, however, this segment with a `wx` and `wy` matching the worm ends up being the final tail segment rather than the head.

When `place_worm_tail_randomly` is forced to abort early, it calls `toss_wsegs`, which removes the `g.level.monsters` entry for each segment's `wx` and `wy` (based on the assumption that a segment having a `wx` and `wy` means it has been placed on the map). Since the final tail piece has a `wx` and `wy` that matches the worm itself, the worm ends up being removed from the map, and therefore causes `mon_sanity_check(mon.c)` to fail -- the worm is still in the list of monsters, but nothing exists on the map where it's supposed to be.

This problem can be avoided by preemptively setting the `wx` and `wy` of `wheads[worm->wormno]` to `0` in `place_worm_tail_randomly` before starting to reverse the worm's segments/place the worm."
459743941,Add instructions to zero mextra struct pointer in mextra documentation,copperwater,2020-07-31 03:12:04+00:00,2020-07-31 17:37:19+00:00,{},"It doesn't mention anywhere that newmextra() is responsible for
initializing struct mextra with null pointers to the various
sub-structs. So, when one follows the instructions and doesn't know or
remember to do this, they'll get segfaults when something tries to read
the uninitialized pointer to their new struct."
448029798,Check bones data directly for deja vu messages,entrez,2020-07-13 04:39:58+00:00,2021-01-01 06:37:34+00:00,{},"After modifications to the amnesia mechanic, \`deja vu' messages are now displayed upon entering a level containing bones of a previous character of the current player. This test is done simply by checking for a ghost on the level that shares a name with the current character.

However, since ghosts generated in other circumstances (for example, in the Valley of the Dead and other special levels) can have names pulled randomly from the high score list, etc, this message can be displayed on non-bones levels where a ghost has been generated with the character's name. Additionally, when a bones pile doesn't include a ghost (such as when the character in question was slimed, killed by a wraith, etc), the \`deja vu' message will not be displayed when it should be. This is all described in in NetHack/NetHack#322.

This pull request would change the method of testing for `familiarity' by adding a function to iterate through any bones data for the current level, searching for a match with the hero's name.

Would close NetHack/NetHack#322."
447896017,Test1 풀 리퀘스트,emalron,2020-07-12 12:49:18+00:00,2020-07-12 12:49:41+00:00,{},소소하게 수정해봤습니다
447822083,make paranoid_confirmation:pray result in yes/no,paranoidtimes,2020-07-11 21:59:56+00:00,2023-09-08 18:45:48+00:00,{},"This change removed the default paranoid_confirmation:pray and the special logic that goes into paranoid_pray. Instead the default is paranoid_confirmation:none, and #pray will result in being prompted y/n (as was the previous default behaviour), if a player sets OPTIONS=paranoid_confirmation:pray they will then be prompted for 'yes' or 'no' if they attempt to pray. Bringing the pray difference in line with the other paranoid options, and preserving the y/n behaviour for those who don't set it.
fixes #303 "
446936913,"Fix default epitaphs (and engravings, etc)",entrez,2020-07-09 15:32:44+00:00,2020-07-10 06:37:21+00:00,{},"Because no newline was appended to the default messages for dat/epitaph, dat/bogusmon, and dat/engrave, the first line in each of those files effectively concatenated the output of `xcrypt` for `deflt_content` and the first line of each respective plaintext source file.

In addition to the two being combined into a single line, since `xcrypt` is a state cipher (I think?), the appended first line doesn't decrypt correctly and looks like random gibberish -- e.g. ```xcrypt(""Om$equvaz0vjazu!K$uov((xdpa(Y!ci&Sgw|0hl$xu`aa"")``` returns ```No matter where I went, here I am.Cfux8xm&|}p`c``` (as seen in #369), while `xcrypt(""Om$equvaz0vjazu!K$uov((xdpa(Y!ci&"")` returns `No matter where I went, here I am.` and ```xcrypt(""Sgw|0hl$xu`aa"")``` returns `Rest in peace`.

Would fix #369 "
444858566,Properly reveal mimics targeted by mind flayer psychic blast,entrez,2020-07-06 15:47:16+00:00,2020-07-14 16:37:19+00:00,{},"Mimics targeted with a mind flayer's psychic attack are \`revealed' by name (``it locks on to the small mimic'') if they are mimicking an object, but are not actually \`unmimicked' with `seemimic`. This results in something of a disparity of information available to the player and the hero, and differs from normal monster-on-mimic attacks.

This commit reveals hidden mimics with `wakeup` if they are targeted & identified by a mind flayer's lock-on attack. Monsters targeted by the psychic blast are woken up anyway (currently via `m2->msleeping = 0`), so this behavior seems consistent with how the attack affects non-mimics already, as well as the typical logic of mimic interactions.

P.S. -- I had submitted a previous PR (#362) intended to address this issue in sort of the opposite way -- hiding the \`\`lock-on'' message entirely when the target is a mimic -- but not only does this seem less consistent with the way the attack works for other concealed/invisible monsters, the actual changes involved were useless, if not a step backwards (they prevented invisible monsters from being mentioned, normally \`\`it locks on to it'', and didn't actually affect how mimics are handled at all)."
444444275,Use <lvl>d8 + 1 instead of <lvl>d8 for mon->mhpmax,entrez,2020-07-05 18:35:03+00:00,2020-07-15 22:21:38+00:00,{},"Monster sanity checking now raises an error when monster max hp is less than `mon->m_lev + 1` (as of 7d7b98f), but `newmonhp` still just rolls \<level\>d8 to determine a monster's starting (max) hp. This means monsters can start with hp equal to their level, if every die rolled is a natural 1 (e.g. 1d8 can end up a 1, 5d8 can end up a 5, etc); to avoid tripping this new sanity check, this changes the formula for determining a monster's max hp to \<lvl\>d8 + 1."
444331119,Avoid revealing mimics with mind flayer lock-on,entrez,2020-07-04 21:42:43+00:00,2020-07-06 14:46:31+00:00,{},"Using `cansee` for feedback on the mind flayer psychic attack means that the message identifies the target by name, even if it's a cloaked mimic or other hiding monster, as long as you can see the square it's on. Using `canseemon` instead will skip printing the message if the target is concealed in some way."
432797991,Fix typo in Guidebook,jhlywa,2020-06-11 02:18:00+00:00,2020-06-20 03:37:21+00:00,{},
425740756,Track number of times player has cheated at Sokoban.,NullCGT,2020-06-01 04:11:52+00:00,2020-07-03 13:37:21+00:00,{},"Adds a conduct (u.uconduct.cheated) in order to track the number of times that the player has cheated at Sokoban. If the player receives the achievement for completing Sokoban, they are told the number of times that they cheated to do so.

Although this does not address the TODO mentioned in soko_guilt(), I think that it's a nice way of explicitly expressing that there are actions which count as cheating. Also, it feels vaguely evil, which is a plus."
425463706,Update G_IGNORE val to avoid collision with G_UNIQ,entrez,2020-05-30 13:06:56+00:00,2020-06-01 16:40:46+00:00,{},"The values of `G_IGNORE` and `G_UNIQ` (defined in include/monflag.h) have both been 0x1000 since the commit in which `G_IGNORE` was introduced (f18b5bb).

https://github.com/NetHack/NetHack/blob/4e677294b3e5a3cf1ea258fd90f83323c48b4984/include/monflag.h#L187-L204

Ultimately, by way of how `mkclass_aligned` uses these macros, this interferes with the code in `mk_gen_ok` that tests for extinction, so that extinct monsters are pronounced valid targets for generation regardless of the `spc` bitmask value provided to `mkclass`.

The value of `gmask` is defined in `mkclass_aligned` to be `((G_NOGEN | G_UNIQ) & ~spc) | (G_IGNORE & spc)` (where `spc` is an optional caller-provided bitmask for ignoring certain requirements):
https://github.com/NetHack/NetHack/blob/4e677294b3e5a3cf1ea258fd90f83323c48b4984/src/makemon.c#L1699-L1705

Then that value is compared with `G_IGNORE` via bitwise operations, to make sure the user hasn't explicitly set the function to ignore extinction:
https://github.com/NetHack/NetHack/blob/4e677294b3e5a3cf1ea258fd90f83323c48b4984/src/makemon.c#L1624-L1632

So the full statement which must be `FALSE` to respect extinction is `(((G_NOGEN | G_UNIQ) & ~spc) | (G_IGNORE & spc)) & G_IGNORE` -- ignoring `G_NOGEN`, since any effect it has is disregarded by the final `& G_IGNORE`, and knowing that `G_UNIQ = G_IGNORE = 0x1000`, this statement can be simplified to `((G_IGNORE & ~spc) | (G_IGNORE & spc)) & G_IGNORE`, then further to `(spc | ~spc) & G_IGNORE`, which always evaluates to `TRUE`.

To avoid this, I have changed the value of `G_IGNORE` from `0x1000` (`0b01000000000000`) to `0x2000` (`0b10000000000000`). This should resolve #352, as far as I can tell: with the change applied I no longer see geno'd monsters on Quest levels."
424330071,Reverting to original phrasing for pet displacement,G7Nation,2020-05-28 08:27:04+00:00,2021-06-17 01:10:48+00:00,{},"Comments:
- ""displaced"" was the original phrasing; no reason to change it
- more flexible for variants and future nethack versions:
  - hypothetical: perhaps a pet does not want to swap places into
    lava, but rather, be displaced to a spot of its own choosing
  - real-world: in slashem, the ""displacer beast"" exists because
    of the original wording
- regardless, past tense is appropriate"
419214468,Allow themed room subrooms to be filled,copperwater,2020-05-18 01:49:15+00:00,2020-09-27 21:40:08+00:00,{},"I noticed that any subrooms created within a themed room were bare - they never had any monsters, objects, traps, or anything really, regardless of whether filled = 1 was set on them. As a result, they're
pretty boring, and I wanted to fix this.

Then I noticed that special rooms incorporated into themed rooms (or just themed rooms defined with a type that wasn't ""ordinary"" or ""themed"") were being left empty as well. One thing led to another and I wound up refactoring some parts of the level creation code and fixing some bugs along the way. 

The broad strokes:
* Non-special subrooms of themerooms can now be filled (if filled=1), and get filled using the same routine as is used to populate a regular ordinary room.
* Special-type themerooms and subrooms of themerooms can now be filled.
* The confusing ""prefilled"" parameter is dropped; all des.room and des.region accept a ""filled"" table option. ""filled=2"" can be specified to produce a special room that sets level flags but isn't supposed to be stocked with anything (used mostly on Quests).
* Fixed bugs where monsters arriving on Ludios and wizard-1 would not be constrained properly.
* Identified the cause of occasional statues embedded in walls on medusa-2 and medusa-4.
* makelevel is restructured a bit; all special rooms on every level are left unstocked when they're first created, then stocked at the end of makelevel."
419150637,Fix: lua exposes incorrect room width and height to contents function,copperwater,2020-05-17 18:10:27+00:00,2020-09-24 05:37:19+00:00,{},"When a room was created using des.room, with w and h specified, I
noticed that the rm.width and rm.height exposed to its contents function
were smaller than they should be by 1. For instance, if I created a room
with w = 5, h = 5, and contents = function(rm), rm.width and rm.height
would both be 4.

This seems to be because the calculations for width and height were
(hx-lx) and (hy-ly), which is 1 too small. In this commit, I adjusted
those up by 1, and adjusted the uses of rm.width and rm.height in
themerms.lua to account for this change.

This does not affect the width and height exposed to the contents
function of a des.map() call; those appear to be accurate measures of
the map's width and height."
417714403,Enable themed rooms to be constrained by level difficulty,copperwater,2020-05-14 02:37:26+00:00,2020-09-29 14:35:55+00:00,{},"The system of themed rooms currently makes it so that any themed room
can potentially generate anywhere a themed room can be placed. This is
problematic in the long run, since it makes it difficult to design new
rooms that are an appropriate amount of challenge at all levels of the
dungeon. (A few themed rooms already have this problem: a hero starting
out on level 1 probably won't live very long when the neighboring room
is full of giant spiders, or an arch-lich has generated in a mausoleum
nearby).

This pull request adds optional ""mindiff"" and ""maxdiff"" properties for
themerooms defined as tables and exposes level_difficulty() to Lua. A
themeroom whose mindiff exceeds the current level difficulty, or whose
maxdiff is lower than the current level difficulty, is prevented from
being selected.

I've also applied minimum difficulty cutoffs to two themed rooms that
probably pose too much of a challenge on the uppermost floors. Note
that this does NOT fix the ""arch-lich in Mausoleum"" problem, which I've
confirmed in wizard mode actually does happen - the solution I would 
recommend for this is pull request #253."
409571905,Avoid disorder caused by horseback #untrapping,entrez,2020-04-27 15:23:49+00:00,2020-04-27 23:41:04+00:00,{},"`mon_sanity_check` can start spitting out error messages about contradictory steed position after a mounted hero gets ensnared by a failed `#untrap` attempt (#340). This is because
`move_into_trap` doesn't update `u.usteed->mx` and `my` like most other movement code does (e.g. `domove_core`, `u_on_newpos`), so those numbers get out of sync with the hero's new position.

https://github.com/NetHack/NetHack/blob/42ffce0e5d163754cb05c201345acc4c165bd050/src/hack.c#L1780-L1789

https://github.com/NetHack/NetHack/blob/42ffce0e5d163754cb05c201345acc4c165bd050/src/dungeon.c#L1437-L1461

Unlike the above two functions, `move_into_trap` only modifies `u.ux` and `u.uy`, which is why reported steed and player positions weren't matching after a failed `#untrap`:

https://github.com/NetHack/NetHack/blob/42ffce0e5d163754cb05c201345acc4c165bd050/src/trap.c#L4034-L4044

This commit adds a check to `move_into_trap` to explicitly handle updating a steed's position on the map just after moving the hero, making it closer to other position-modifying functions & hopefully fixing #340."
406200433,Sort output in discoveries list,GorillaSapiens,2020-04-20 17:31:23+00:00,2020-12-20 06:37:20+00:00,{},Sorts output for discoveries and class discoveries commands ( \ and ` )
405379075,Add 'ec2' to default GENERIC_USERS,stewartsmith,2020-04-17 23:17:55+00:00,2020-05-16 01:37:19+00:00,{},"On Amazon Linux (1 and 2), the default user is ""ec2-user"", which due to
how NetHack will filter out dashes from usernames gets shortened to
'ec2'. The GENERIC_USERS filter is applied *after* this filtering (see
unixmain.c snippet below):

    set_playmode(); /* sets plname to ""wizard"" for wizard mode */
    if (exact_username) {
	< filter out dash >
    }
    plnamesuffix();

So, if we add 'ec2' to the list, the net effect is that you'd be asked
for your name if launching as the generic user. This is probably better
than applying the filter twice or changing the logic of when the
filtering is done.

Signed-off-by: Stewart Smith <trawets@amazon.com>"
404814000,"Fix rnd(0) in create_gas_cloud, and blasts of fire that hit bodies of water create clouds of steam.",NullCGT,2020-04-16 22:55:10+00:00,2020-04-18 02:37:19+00:00,{},"This is a combination bug and feature pull request:

- If create_gas_cloud() is called with a damage of zero, the game will throw a panic for calling rnd(0). This pull request fixes this.
- If a bolt of fire hits a fountain or body of water, it produces a small area of clouds that fades after a few turns.

I originally wrote this feature for SpliceHack, but upon further reflection I think that it fits in well to vanilla. The messages ""you hear hissing gas"" and ""steam billows from the fountain"" imply the creation of steam, which can be easily represented using create_gas_cloud. I feel that giving the steam a visual representation increases the sense of interacting with the environment.

Fountains produce a larger area of clouds, since the message ""steam billows from the fountain"" seems to imply a greater amount of steam than ""you hear hissing gas.""

At present, this has no gameplay effects, but this feature could be extended to allow for scalding steam or blinding clouds of fog."
403507719,Allow specifying a montype on figurines in lua files,copperwater,2020-04-15 02:33:58+00:00,2020-04-15 03:49:03+00:00,{},"This was already allowed for the other montype-compatible objects like
statues, corpses, eggs and tins. I don't see a reason why figurines
shouldn't be part of this group; perhaps it was an oversight."
391287981,Fix typo/spelling error in code_style.txt,slondr,2020-03-19 23:43:30+00:00,2020-03-22 19:45:13+00:00,{},"This fixes the incorrect spelling of ""unindented"" in `DEVEL/code_style.txt`"
381947599,Lua enhancements,copperwater,2020-02-29 21:37:11+00:00,2020-09-05 12:13:50+00:00,{},"This adds several enhancements to the special level parsing code:

*  Lua scripts can now call d() to get dice results, or percent() to get a percent threshold, avoiding the necessity of using lots of math.random() calls.
*   Special level functions such as terrain() or replace_terrain() cannot overwrite stairs or ladders.
*    Implement selection.gradient(), re-enabling the selection gradient functionality present in 3.6.
"
381945767,Remove distance requirement for learning teleportation scroll,copperwater,2020-02-29 21:16:36+00:00,2020-09-19 03:37:20+00:00,{},"Since teleports now produce a ""materialize"" message, there is no point
in having the scroll only be automatically identified if you have
traveled a certain distance.

In the process of addressing this, I also managed to get rid of the
'telescroll' global variable, and the return value from scrolltele().
Because there's no longer a minimum distance, scrolltele can take care
of auto-identifying the scroll without having to turf the actual process
of doing that to teleds."
381935004,Lua enhancements,copperwater,2020-02-29 19:27:44+00:00,2020-02-29 20:21:10+00:00,{},"This adds several enhancements to the special level parsing code:
* Lua scripts can now call d() to get dice results, or percent() to get a percent threshold, avoiding the necessity of using lots of math.random() calls.
* In order to build the game, all lua files must pass a basic lua syntax check.
* Special level functions such as terrain() or replace_terrain() cannot overwrite stairs or ladders.
* Implement selection.gradient(), re-enabling the selection gradient functionality present in 3.6."
374366850,NetHack 3.7 htmldump,NHTangles,2020-02-12 15:19:46+00:00,,{},"This is my current work on HTML dump logs, for your consideration.  This code is live on the hardfought servers. (sample: https://au.hardfought.org/userdata/T/Tangles/nethack/dumplog/1580642779.nh.html)
Please let me know if I can do anything to help you get it merged.
Thanks
Tangles.
"
371671999,Add Sounds for Minotaurs,NullCGT,2020-02-06 02:02:09+00:00,2020-02-11 07:37:20+00:00,{},"Minotaurs, by and large, are very loud and rambunctious creatures. In NetHack, however, they are treated as silent. This pull request gives minotaurs growl sounds, as well as responses when #chatted with.
Rationale are as follows:

1. Minotaurs are generally depicted in media as being loud.

2. Minotaurs are dangerous enough that being able to identify them while blind is potentially useful.

3. Due to their high damage output and total lack of magic resistance, minotaurs are often tamed by the player. The game will be more fun if the player can interact with their pet minotaur in some way, however limited."
369944011,MSDOS compile error and statue glyphs,chasonr,2020-02-01 21:52:19+00:00,2020-02-02 07:37:41+00:00,{},"sys/msdos/Makefile1.cross: Add -DSTATUES_LOOK_LIKE_MONSTERS so the VESA mode can display statue glyphs. The 16 color mode already maps these back to the generic statue glyph.

src/options.c: A compile error I discovered while preparing this pull request. Remove a code fragment that appears to be a remnant of the ""soundcard"" option."
369912691,Update description of OPTIONS=video,chasonr,2020-02-01 16:07:42+00:00,2020-02-11 08:37:21+00:00,{},"A recent change to the Guidebook says that video_width and video_height work with video:vga. That setting in fact forces the 640x480x16 mode, in which video_width and video_height do not operate. The desired setting is video:vesa. Update the description of OPTIONS=video, video_width and video_height to reflect this.

Also, fix some syntax errors in Guidebook.tex encountered while trying to compile it.

Attempting to update Guidebook.txt, using the Makefile, produced many more differences than expected. I am leaving that file unchanged."
368214714,Allow Specification of the Length of the Sparkle Animation,Vivit-R,2020-01-28 20:31:05+00:00,,{},"`sparkle` used to be a boolean option whether or not to show the the sparkly magic resistance animation. This branch changes it to a compound option that specifies how many frames the animation should run for. The argument to the option is optional and the default value is 21, so there will be no change in the behavior of existing .nethackrcs.

I had opened a PR about this against 3.6 a few months ago, but it couldn't be done then because it required changing the flags, which would have broken save compatibility with the rest of 3.6. Now that 3.7 is being worked on, that won't be a problem."
367475686,Fix compiling with -fno-common,jer-gentoo,2020-01-27 12:55:51+00:00,2020-01-27 17:41:54+00:00,{},"GCC 10 will enable -fno-common by default[0], which causes the linker to
fail like this [1]:

```
ld: windows.o:(.bss+0x0): multiple definition of `WIN_STATUS';
decl.o:(.data+0x40): first defined here
collect2: error: ld returned 1 exit status
```

So considering that include/decl.h has:

```
E NEARDATA winid WIN_STATUS;
```
which is correct, and that just one of the .c files should use `extern`, and
that src/decl.c aligns nicely with include/decl.h, keep that definition
and remove those invalid defnitions from other .c files.

Contrast this with [2] https://github.com/NetHack/NetHack/pull/289 which
tries to second-guess the problem by checking for GCC 10 / Linux, both
of which are incorrect assumptions.

[0] https://gcc.gnu.org/gcc-10/porting_to.html#common
[1] https://bugs.gentoo.org/706320
[2] https://github.com/NetHack/NetHack/pull/289"
367177170,Extensions to the MS-DOS VESA mode,chasonr,2020-01-26 03:04:06+00:00,2020-01-27 08:17:21+00:00,{},"The first four commits, through ""More bits for linear frame buffer,"" are incremental changes, adding working support for 8 bit color modes and a linear frame buffer.

Subsequent changes overhaul the VESA BIOS support. Tile sets are no longer limited to 16x16 in 8 colors; any tile set in BMP or GIF format is supported."
367040960,Added guard for definition of WIN_STATUS for Linux and GCC 10,tachoknight,2020-01-24 22:28:18+00:00,2020-01-27 17:42:26+00:00,{},Compiling with GCC 10 causes a duplicate definition error during linking with the `WIN_STATUS` definition in `decl.c`.
364621339,Fix typo,Xaleth,2020-01-20 03:05:20+00:00,2020-01-20 08:37:21+00:00,{},
364387299,Refactor and simplify the rndmonst function,copperwater,2020-01-18 03:34:23+00:00,2020-02-23 06:37:19+00:00,{},"This changes rndmonst() to use a weighted reservoir sampling algorithm, rather than a unwieldy pre-computed cache of eligible monsters that needs to be updated every time the hero goes up or down a floor, gains or loses a level, or extincts or genocides a monster. It removes the rndmonst_cache global (and thus is not save compatible) and the reset_rndmonst function.

This algorithm still requires only a linear pass over the list of monsters (the same as what rndmonst() required even when not updating the cache). 

Many of NetHack's loops could benefit from being rewritten using [reservoir sampling](https://en.wikipedia.org/wiki/Reservoir_sampling), but rndmonst was one of the biggest candidates due to being able to get rid of the cache.

This is a code-only change and does not change the distribution of monsters selected by rndmonst() at all.

c1c90bb is the same commit in the consolidated pull request."
363393022,Consolidation pull request for more minor features,copperwater,2020-01-16 00:02:01+00:00,,{},"As with #265, the commits in here are mostly self-contained and independent of each other, with a few exceptions (small refactors needed to make the following commit work, like 07f1e54). I'm making a new pull request because it seems like #265 has already been reviewed and partially incorporated.

As before, the implementations of all of these are from xNetHack, though many are from other variants such as SpliceHack and SliceHack."
363151348,Add more YAFMs to the game,copperwater,2020-01-15 13:59:42+00:00,,{},"YAFM - Yet Another Funny Message. This is a consolidation of ones added to xNetHack, though as described in the commit messages some were created in other variants.

Most of these happen when you are hallucinating."
361877381,Add the Grudge Patch: monsters with natural enmity will fight each other,copperwater,2020-01-12 22:18:39+00:00,,{},"This ultimately derives from Nephi's Grudge Patch back in the 3.4.3 era,
plus some updates from SpliceHack and xNetHack. Its primary purpose is
to make the dungeon a richer, more interesting place by providing more
opportunities for natural monster-to-monster interactions. All of the
code necessary to support monster battling was already in place; this
merely adds more monster pairs to mm_aggression.

Monsters that will fight each other are:
- Quest guardians and hostile non-guardians
- Angels and demons
- Elves and orcs
- Hobbits and Nazguls

Monsters with a one-sided grudge (where the defending monster may
counterattack, but won't use its own turns to retaliate aggressively)
are:
- Baby purple worms against shriekers (purple worms already had this)
- Ravens against floating eyes
- Spiders against insects (x and a)
- Bats against flying insects
- Cats against rats
- Woodchucks against the Oracle

Pets will never attack other pets, even if they would normally be
hostile to each other."
361789648,Display weights of objects in inventory,copperwater,2020-01-12 03:12:29+00:00,,{},"The bulk of this pull request is the commit adding the 'invweight' option, which allows the player to see the weight of any object they are carrying. See its commit message for full details.

I also put in the complementary feature in which showing your inventory will display your total carried weight compared to your current carrying capacity, and your slots used/total."
359231508,Use recent GCC for DOS cross-builds on Linux,dimkr,2020-01-04 17:35:11+00:00,2020-08-18 14:44:55+00:00,{},
356473338,Fixes to build NetHack 3.7.0 on FreeDOS,chasonr,2019-12-23 23:05:32+00:00,2019-12-24 07:37:43+00:00,{},"These changes produced a successful build of NetHack 3.7.0 on FreeDOS 1.2 with the following software installed:
* Long file name support enabled in autoexec.bat
* PDCurses installed in C:\PDCurses
* Lua 5.3.5 installed in lib\lua535 under the NetHack root
* Vim 7.3 installed in c:\vim
* DJGPP packages bnu2331b, dif37b, djdev205, fil41br2, gcc920b and mak421b; I don't think dif37b is needed, but it is installed to work with Vim

Changes needed for successful build on FreeDOS:
* PDCurses archive built in four ar calls. 3.6.4 has this already; this was partially present, but incomplete
* Lua archive built in three ar calls
* Conditional for dat/quest.dat corrected; GNU make does not like having an ifndef in a dependency list
* sys/msdos/nhlua.h created, based on the nhlua.h created for the Unix port
* Empty sysconf created

Changes for a faster build:
* temp.a for the game binary built using S option to ar, so that ar does not create a symbol table over and over; ranlib added at end to build the symbol table
* monstr.c removed from build
* o/nethack.lnk no longer has any function and is removed
"
356050904,Peaceful displacement: move peaceful monsters aside just like pets,copperwater,2019-12-22 03:11:41+00:00,2020-04-15 06:00:08+00:00,{},"This is a very popular feature which has been implemented in several variants so far. It allows you to displace peaceful monsters out of the way, following the code which already exists for pets.

Specifically, this is xNetHack's implementation; there are a few other changes in xNetHack attached to the base implementation that I think work well with it.
* Refactoring a bunch of identical code blocks to occur only in one place (didnt_move).
* Some monsters can't be displaced at all: priests, shopkeepers, the Oracle, and your quest leader.
* Peaceful and tame monsters alike will refuse to switch places with you if you are on a trap or otherwise unsafe terrain for it (such as liquid). This indirectly fixes a source of extreme aggravation where a levitating or water walking hero accidentally displaces their pet onto water, instantly drowning it. It also prevents you from trivially killing any peaceful by the same method.
* Monsters can't be displaced out of a trap they are trapped in, meaning that the logic for untaming your pet by displacing it out of a trap no longer exists.
* Sleeping monsters count as immobilized. Additionally, immobilized monsters can't be displaced at all; there used to be a 1/6 chance of displacing them anyway. The 1/6 chance for sessile monsters is retained.

Other notes:
* I noticed when debugging that attempting to move onto a tame, disguised, mimic's space displaces and decloaks it with no message at all; this seemed weird but that appears to be the existing behavior."
354932144,Consolidation pull request for many minor features,copperwater,2019-12-19 03:58:19+00:00,2022-05-28 01:06:30+00:00,{},"Since there are a lot of these, it seems better to make a single pull request instead of over 20 little ones. The commits in here are more or less independent of one another and self-contained.

All of these are from xNetHack, though some originated in other variants. A lot of them are small enhancements to the interface, mostly via messages.

If I have other small feature commits to submit later on, I plan on adding them to this pull request."
353311180,Make the #terrain command work while impaired,copperwater,2019-12-15 20:28:11+00:00,2021-06-17 00:58:34+00:00,{},"This is an interface only command, acting just as an aid to remember
what the player has already seen, and removing its availability based on
whether the character is impaired is interface screw.

Note: This does not reveal true monster or object identities while
hallucinating; the hallucinatory glyphs will remain hallucinatory. (Even
though it shouldn't be possible to see monsters with #terrain anyway.)"
353310562,Allow rereading spellbooks to refresh memory at any time,copperwater,2019-12-15 20:21:08+00:00,2020-09-28 15:28:55+00:00,{},"Aimed at fixing the problem where the player knows they're going to
forget a spell in a few thousand turns, so they go back and get the
book... only to find out that they ""know it quite well already"", and
need to wait an indeterminate amount of time until they are on the verge
of forgetting it (< 2000 turns) before the book will let them read it
again.

This commit simply removes that 2000 turn limit, so the player can fully
restore their memory at any time with the spellbook. Naturally, this
still consumes a read charge, so the book won't ultimately last as long
if you keep rereading it early.

If you do have more than 2000 turns left, the game will prompt you to
confirm that you do want to refresh your memory anyway. As before,
rereading with fewer turns will not prompt."
353310289,Remove Sokoban luck penalties for things you can't cheat with,copperwater,2019-12-15 20:18:29+00:00,2020-01-06 04:37:44+00:00,{},"Jumping, Newton's 3rd Law hurtling, and throwing an iron ball:
attempting to do any of these in such a way that you would diagonally
pass between boulders/walls causes the Luck penalty. However, none of
these actually get you through the diagonal gap, thus they can't be used
to cheat and the penalty doesn't make sense."
353220637,"Add paranoid trap, which prevents accidental triggering of harmful traps",copperwater,2019-12-14 22:55:48+00:00,2023-09-09 03:37:18+00:00,{},"Primarily, this ports UnNetHack's paranoid_trap to the vanilla 3.6+
paranoid options system via xNetHack. When this option is enabled, the
player must type out ""yes"" before moving onto a known trap that apparently
poses a danger to them. When not enabled, the game behaves as it did
before, and there is no warning for moving onto traps.

If the hero is hallucinating, there is no way to determine what the trap
actually is, so they will always be prompted to confirm.  If the hero is
stunned or confused or has prefixed their movement command with 'm',
they will not be prompted regardless of the trap type (overriding
the hallucination case).

The bulk of the code in this commit is a new function, immune_to_trap,
which is how the game decides whether a given monster or the hero is
safe from a certain type of trap. This helps avoid interface annoyances
in places like levitating over the holes in the Castle (a levitating
hero can never trigger a hole just by moving onto the space, so they're
""immune"" to it). The function has three possible results: obviously
immune, obviously not immune, or immune but only by way of items or
intrinsics the hero might not have identified. Only the first case lets
you move onto that trap type freely. Since the game doesn't track your
knowledge of your own intrinsics, this is imperfect; a player with
innate fire resistance (and no other source of it) will still be
prompted before moving onto a fire trap.

I have not currently implemented logic allowing monsters to freely move
onto traps they have seen and are immune to, though this should
theoretically only require changing a couple lines in monmove.c."
352696341,Add paranoid swim for both water and lava,copperwater,2019-12-13 02:41:56+00:00,2022-02-13 14:24:52+00:00,{},"Adds ""swim"" to the list of paranoid options, which prevents you from
accidentally moving into liquids.

The mechanics are similar to what I believe NetHack4 has, where you
must use the 'm' movement prefix in order to deliberately move onto a liquid
space from a space with a different terrain type. Attempting to move into the
liquid without using 'm' will do nothing.

This behavior is suppressed if you are levitating, flying, wearing known
[fireproof] water walking boots, or have the option turned off.

I'm not sure that this fits better as a paranoid option than just a regular
option. It logically fits in, but it doesn't involve any prompts. As with all
the other paranoid options, it is settable via config file, as ""swim"". This
doesn't seem like the best name to me, but I don't have a better one.

In xNetHack, where this code comes from, the m-movement into liquids is
enforced for all players and ParanoidSwim just provides an additional failsafe,
but it turns out there are many players who want to have the ability to die by
making a typo and stepping into lava, so the implementation here allows this
current behavior by having the option off.

Final note: Since having no confirmation for walking on lava means you must
have fire resistance, there's a minor and extremely marginal exploit which
allows a player with identified fireproof water walking boots to informally
test whether an unidentified ring is fire resistance. I did not think it was
important enough to be worth adding code that figures out whether the player
knows they have fire resistance."
351280543,moc-qt5 is called just moc on Ubuntu,rockola,2019-12-10 09:18:10+00:00,2020-08-18 14:47:20+00:00,{},"moc-qt5 is called just moc on Ubuntu (at least on a system with just qt5 and no previous install of qt4).
This patch sets MOC to moc-qt5 if it is found in PATH (old default behaviour), if not, to moc if it is found in PATH. If neither moc nor moc-qt5 is found, an error is signaled.

This patch does not address the multiple ways in which moc is called (e.g. as $(QTDIR)/bin/moc in Makefile.src and elsewhere). However, this patch is sufficient for building NetHack 3.7 (and 3.6 if backported) on Ubuntu 19.10."
350444496,Allow teleportation onto the vibrating square in wizard mode,NullCGT,2019-12-08 19:15:27+00:00,2019-12-08 20:30:06+00:00,{},"The vibrating square is classified as a trap, and as such cannot be teleported onto. Testing the vibrating square in wizard mode can be frustrating, since it cannot be teleported onto directly."
350431703,Make mkclass usually unable to select an out-of-difficulty monster,copperwater,2019-12-08 16:48:02+00:00,,{},"This constitutes the surprisingly small ""compromise mkclass fix"", in
which mkclass always picks an in-difficulty monster from the target
class, unless there are none eligible, in which case a monster will be
selected from the set of monsters with the next lowest difficulty within
that class. The fix consists only of removing the 50% chance that
mkclass would push forward into out-of-difficulty territory when it
didn't need to.

Specific perennial problems that this fixes:
- The infamous master and arch-liches in the Castle, even when
  lower-level liches are valid targets, and even though master and
  arch-liches are supposed to generate only in Gehennom.
- Large and giant mimics generating in shops on very low dungeon levels,
  spelling pretty certain death for anyone who stumbled into them due to
  their stickiness and heavy attacks.
- The random h in the Gnomish Mines being a mind flayer or master mind
  flayer, which also tends to mean doom for low-level characters who are
  unequipped to handle them.

Basically any place mkclass is called is a possible thing fixed by this,
though most such cases are probably latent (e.g. there are no insects
that would be out of difficulty by the time the player is encountering
the summon insects spell). However, if very high difficulty monsters are
ever added to a class that mkclass is called with, this will continue to
work to prevent them from being selected.

Note that if the player manages to genocide or extinct all the
in-difficulty members of a class, the lowest out-of-difficulty one(s)
will still be chosen.

One of the concerns brought up about mkclass fixes in this vein was that
they would substantially wreck the intended difficulty of certain
levels, particularly the Healer quest's dragons. I haven't fully
reviewed all possible special levels for these types of things, but in
the case of the Healer quest the dragons are the same as before. (The
baby dragons of lower difficulty have 0 frequency and can't be chosen by
mkclass, while all of the adult dragons have the same 20 difficulty and
so get selected uniformly. This fix also avoids the bug in which the
first out-of-difficulty monster, such as gray dragon, would always be
selected. Note that if higher-difficulty dragons were added to the
end of the dragon list, those would *not* appear in the Healer quest
under this system unless the player were already at a very high
experience level to put them in-difficulty.)

Other proposed mkclass fixes, such as the one where if all eligible
monsters from a class are out-of-difficulty then no monster generates or
a random monster not in the desired class generates, would however throw
the balance of difficulty on those levels out of whack.

This does not change mkclass_poly, which is explicitly designed to
ignore difficulty considerations (and is only used for player polyself
or monpolycontrol in wizard mode)."
350430045,Allow teleportation onto the Vibrating Square,copperwater,2019-12-08 16:28:33+00:00,2019-12-08 23:37:44+00:00,{},"It's a minor annoyance when you forget you can't do this in vanilla and
then get relocated somewhere random on the level. Since it's not a
harmful ""trap"", just allow the adventurer to teleport directly onto it."
350358972,Remove the mysterious force,copperwater,2019-12-07 23:52:36+00:00,,{},"The mysterious force is the single most universally hated feature in
NetHack.

Backsliding through Gehennom has proven to be so boring and tedious for
the player, while adding nothing of value to the game, that nearly every
variant removes it. (The sole exception is NetHack4, which makes very
few gameplay changes.)

To compensate for this, all horizontal teleportation within a level is
blocked when carrying the Amulet, rather than 1/3 of the time.

This makes alignments slightly less differentiated, since there is no
longer an advantage to playing chaotic to make the force less odious.
However, this behavior was already on a shaky basis flavor-wise (Moloch
and Gehennom itself have no bias against any alignment, and plenty of
lawful devils and demon lords reside there).

I would also note that in the absence of the mysterious force, there are
several other proposals and implementations of ways to make post-Amulet
Gehennom more interesting than simply backtracking through completed
levels, ranging from monster spawning behavior to a boss rush of demon
lords to the entire branch beginning to collapse."
350291346,ANSI-fying,MaddTheSane,2019-12-07 08:38:34+00:00,2023-11-11 15:20:43+00:00,{'3.6': 1},"This moves NetHack away from K&R to ANSI C calling conventions.

This also replaces #10 "
350289889,Quiet most of the -Wcomma warnings,MaddTheSane,2019-12-07 08:16:59+00:00,,{'3.6': 1},"Xcode likes to enable `-Wcomma` warnings when upgrading projects. For the most part, just replacing the offending comma with a semicolon quiets the warning.
I'm not even going to touch those that are in a `for` declaration."
346320910,Fix alternate number pad interpretation only working for diagonals,FredrIQ,2019-11-27 16:12:59+00:00,2019-11-28 02:37:18+00:00,{},"This fixes the issue brought up in https://www.reddit.com/r/nethack/comments/dv3pae/curses_and_the_numberpad/?st=k3hgply6&sh=dbc2bf7d .

I don't know why the ""regular"" (tty) method doesn't seem to work for him,
but I'm going to chalk it up to a PDCurses oddity. What I do know, however,
is that the alternate method I added a year ago or maybe longer, that allows
numpad usage even with number_pad:0 (to retain the default keybindings in case
an user is used to them, while keeping number pad behaviour making sense,
similar to NetHack4+friends) was only partially implemented, for some reason.
This adds the rest of the keys, meaning that this means of key interpretation
should be more realible. KEY_A2/B1/B3/C2 are not standard keys in the Curses
documentation, and is thus behind an ifdef -- but PDCurses, amongst other
implementations, makes use of them.

As a side effect, Home/End/PgUp/PgDn are now interpreted as diagonal movement,
since some terminals interpret number_pad keys that way. I do not consider this
a problem since they went unused in normal gameplay anyway (This does not
interfere with menus or similar)."
336580164,Deal with FreeDOS bugs when building pdcurses.a,chasonr,2019-11-05 03:30:06+00:00,2019-11-05 08:37:26+00:00,{},"There is an incompatibility between FreeDOS and DJGPP that limits the number of command line arguments. The 3.6.2 Makefile.GCC deals with this bug by building libraries in stages and then linking them to form executables, in particular the main NetHack binary.

This change provides the same workaround for pdcurses.a, allowing NetHack to build on FreeDOS."
336175089,new unix hint: centos6-sing-tty-cur,hornlo,2019-11-04 09:10:26+00:00,2019-12-08 21:26:08+00:00,{},"CentOS 6 build for tty + curses, single-user

installs in $HOME:
  ~/lib/nethackdir
  ~/bin/nethack

built under:
  gcc: gcc (GCC) 4.4.7 20120313 (Red Hat 4.4.7-23)
  ncurses: 5.7.20090207
  linux: 2.6.32-754.23.1.el6.centos.plus.x86_64
"
336146306,.gitignore: add .vimrc,hornlo,2019-11-04 07:20:30+00:00,2019-12-08 21:26:44+00:00,{},"I prefer a local .vimrc to incorporate the Vim settings suggested in DEVEL/code_style.txt rather than alter my global preferences -- which may not always match these suggestions.

This prevents inadvertently adding my (or others') preferences to the repo.

"
332754696,Switched to Getopt::Long,Leoltron,2019-10-26 10:07:43+00:00,,{'3.6': 1},
329751488,curses - remove unused variable in curses_str_remainder(),NHTangles,2019-10-18 13:54:43+00:00,2019-10-18 20:37:25+00:00,{},"I noticed a previous attempt at removing this as a larger push to silence various compiler warnings resulted in an infinite loop in the message window (the first line of a split message repeated indefinitely until ESC is pressed), so this was reverted.  The issue was that a 'for' loop which affected the value of 'count' was removed, but a subsequent check on 'substr[count]' which relied on the value of 'count' after the for loop was left in.
This PR contains the correct fix."
329498431,Keep wintty.c's maxwin up-to-date.,heiner,2019-10-17 23:12:16+00:00,2019-10-23 04:50:16+00:00,{},"Otherwise the check in https://github.com/NetHack/NetHack/blob/2172c5e7ff40ea073e2749a0f7034db9e6a7f835/win/tty/wintty.c#L1423 doesn't seem to make sense.

An alternative would be to remove both the check and  `maxwin` altogether."
329312836,Invert symset.fallback to symset.explicit and centralize handling.,FredrIQ,2019-10-17 15:03:13+00:00,2019-10-18 04:38:19+00:00,{},"The invert allows us to default to FALSE, which means we only need
to handle symset.explicit in a single function (read_sym_file).

This allows removing the per-case setting of it, and as a result fixes
an inconsistency where OPTIONS=DECgraphics/IBMgraphics failed to set it
correctly, causing curses to ignore the option.

Tested: result

* no symset or DEC/IBMgraphics; curses
* DECgraphics, no symset: DECgraphics
* default symset: default
* ""default2"" symset (invalid): curses
* DECgraphics symset: DECgraphics

Trying to load more than one symset (by using DECgraphics and symset:default, for example) will use the last entry. This also happens if the last entry is invalid and a previous one wasn't. I believe this is consistent with tty."
329052604,The Colours of Magic,Vivit-R,2019-10-17 03:53:37+00:00,,{},"Currently, if you want to change the colors of explosions or zapped rays, e.g., to make lightning a different color than frost, or to make magic missiles a different color than sleep rays, you have to edit global constants arrays defined in `decl.c` and `mapglyph.c`. This branch extends the configurable color palette in `color.h` to cover rays and explosions as well as object materials."
329034028,Fix pluralization of Nazgûl in rumors.tru,sobjornstad,2019-10-17 02:20:26+00:00,2019-10-18 04:38:20+00:00,{},"Pedantic fix because it showed up in my game and made me cringe: the proper plural of Nazgûl is Nazgul, not Nazguls. A quick grep shows a note in the 3.6.0 fixes list referencing this exact issue, but the rumor was missed when correcting the game's pluralization.

A few references in case there's any doubt. :-)

- http://tolkiengateway.net/wiki/Nazgûl
- https://en.wikipedia.org/wiki/Nazgûl
- https://scifi.stackexchange.com/questions/214683/are-all-ringwraiths-called-nazgûl-in-lotr"
328412106,Curses symset,FredrIQ,2019-10-15 18:45:53+00:00,2019-10-17 06:39:59+00:00,{},"This patch makes the previous ""cursesgraphics"" symset into a fully fledged symset, as well as renaming it ""curses"". It also does some minor adjustments to the graphics set to complete a few missing cases where it's likely that the developer wanted more refinements, approximating IBMgraphics as much as possible while retaining the previous limitations in terms of character availability.

It also changes default symset handling under curses, to load the curses symset by default, unless ""default"" is configured explicitly (which will cause it to use the internal graphics symbols), either in the file, or via the O menu.

This PR also fixes a bug with DECgraphics handling (commit c557998), which should probably be merged even if the rest of this is dismissed."
327998143,Allow Specification of Length of Sparkle Animation,Vivit-R,2019-10-14 22:34:50+00:00,2020-01-28 20:17:01+00:00,{},"Currently, the sparkle animation is either 21 or 0 frames long, with no in-between, which is silly. This PR makes the `sparkle` option accept an integer argument to specify the length in frames of the sparkle animation. Under this new definition, `OPTION=nosparkle` is equivalent to `OPTION=sparkle:0`. ~~Config files that specify the default-redundant `OPTION=sparkle` will result in a missing parameter error, but game behavior will not be changed.~~ The behavior of any config file syntactically valid as of 3.6.2 should be unchanged."
327470089,DECgraphics in the curses windowport,FredrIQ,2019-10-12 14:36:53+00:00,2019-10-14 08:37:25+00:00,{},"Curses attempts (and fails) to disable DECgraphics due to incompatibilities.

Instead of fixing this, I simply just made curses able to handle DECgraphics."
323043366,Port the autounlock feature from UnNetHack,copperwater,2019-10-01 01:42:38+00:00,2019-12-27 18:37:48+00:00,{},"This adds a boolean option, autounlock, defaulting to true. When this is
set to TRUE, messages stating that some door or container is locked are
automatically followed by a prompt asking if you would like to unlock
it, if you are carrying an unlocking tool (key, lock pick, or credit
card).

Architecturally, this extends the pick_lock function to take three
additional arguments (door coordinates or a box on the ground you are
autounlocking).

Because this adds a new field to struct flag, this is not a
save-compatible change. I have not adjusted EDITLEVEL or
VERSION_COMPATIBILITY, though.

The code that selects an unlocking tool will always look first for a
skeleton key, then a lock pick, then a credit card. Since curses, rust,
and other attributes don't really have an effect on the viability of the
unlocking device, it didn't seem to warrant making a more complex
function for that."
322550700,Stop all forms of running when stepping over and reading engravings,copperwater,2019-09-29 23:18:11+00:00,2019-10-06 04:37:32+00:00,{},"I have been noticing that this happens with capital-letter running
(context.run = 1), but no other forms of it. I can't think of any reason
why capital-letter running should read the engraving but not stop, while
all other forms of running should behave differently and stop. It's also
weird because the ""There's some graffiti on the floor here"" message is
delivered when the character is paused on top of the engraving, and the
actual engraving text appears to be delivered after the character stops
running.  Particularly so because there's no map representation of
engravings to indicate where it was encountered.

This adjusts the case that checks context.run and stops when moving over
engravings to include capital-letter running."
321017669,Autopickup Exception Priority,Vivit-R,2019-09-25 00:56:16+00:00,2019-10-02 04:37:57+00:00,{},"One major limitation of the autopickup exception system is that you can't define an exception from an exception, despite both menucolors and msgtypes prioritizing rules based on the order they are defined in `.nethackrc`. This is because the ""always pickup"" and ""never pickup"" exceptions are tracked in different lists, and at runtime, when the player steps over an object, the game checks these lists seperately, with ""never pickup"" taking precedence. This means that if you want to pick up some but not all items matching a given expression, [you may need to write a long and kludgy list of regexes to get the behavior you want.](https://nethackwiki.com/mediawiki/index.php?title=Autopickup_exception&oldid=125825#Never_pick_up_corpses_except_lizards.2C_newts.2C_lichen.2C_wraiths.2C_and_floating_eyes)

I've edited the autopickup exception code to remove this necessity: now the exceptions are stored in one list, and conflicts between them are resolved based on their relative position in that list. Whether an exception was inclusive or exclusive was already tracked individually for each exception; I don't know why they were stored separately in the first place.  This edit makes the system both more convenient and more consistent with the semantics of menucolors and msgtypes.

With these changes, the 33 autopickup exception rules in the wiki article linked above may be replaced with the following 7 much simpler rules for the exact same effect:
```
AUTOPICKUP_EXCEPTION="">.* corpse.*""
AUTOPICKUP_EXCEPTION=""<.* newt corpse.*""
AUTOPICKUP_EXCEPTION=""<.* lichen corpse.*""
AUTOPICKUP_EXCEPTION=""<.* lizard corpse.*""
AUTOPICKUP_EXCEPTION=""<.* floating eye corpse.*""
AUTOPICKUP_EXCEPTION=""<.* wraith corpse.*
AUTOPICKUP_EXCEPTION="">.*>.*""
```"
318867033,Refactor mongets to return the object it creates,copperwater,2019-09-18 15:15:31+00:00,2020-04-05 18:14:39+00:00,{},"Most cases where mongets is used discard the returned value (which used
to be the created object's spe); the only places that do use it are the
series of statements that give various human monsters armor and prevent
them from getting too much armor. These statements included hardcoded
constants representing the base AC of the armor, which would have caused
discrepancies if armor's base AC were ever changed.

With mongets now returning a pointer to the created object, it can just
be passed into ARM_BONUS instead, which covers both the base AC and the
enchantment. (It will also cover erosion, if anyone ever decides that
armor should rarely generate as pre-eroded).

The overall algorithm is not changed by this; human monsters should
receive armor with the same probabilities as before.

The impetus for this was to avoid ugly constructions such as the one
below:

```c
mongets(mtmp, LONG_SWORD);
struct obj* sword = m_carrying(mtmp, LONG_SWORD);
if (sword)
    /* do thing to sword */
```

No such constructions appear in vanilla NetHack, but I did notice that there are a lot of mksobj calls followed by mpickobj, which could probably be replaced with this version of mongets. This would also cut down on some other code duplication (such as ensuring angels' gear is erodeproof and non-cursed)."
317160191,Use faster method to write characters to VGA,chasonr,2019-09-13 03:22:14+00:00,2019-09-13 12:37:36+00:00,{},"It was necessary, when updating the MS-DOS port for 3.6, to revise the screen-clearing and character-drawing functions, because the background color is no longer zero. But the 3.6.1 method is rather slow, using write mode 2 and a lot more calls to outportb.

outportb is expensive when running under a virtual machine, the typical use case for the MS-DOS port these days, because it traps to the hypervisor rather than actually writing to hardware.

This change restores the speed of the 3.4.3 version. The adapter is left in write mode 0. Clearing is accomplished by writing zero to planes where the background color has a zero bit, and 0xFF where  the background color has a one bit. Characters are drawn by writing 0x00, 0xFF, the font data, or the inverse of the font data, as appropriate, to each plane.

When testing, be sure to use OPTIONS=videomode:vga, because autodetect will go to VESA mode if it can."
315344960,Align add_opvars formats with their parameters,chasonr,2019-09-09 03:42:06+00:00,2020-01-26 15:09:15+00:00,{},"This change fixes all add_opvars calls in lev_comp.y and its Yacc output, lev_yacc.c. Most of the changes consist of changing 'i' formats to 'l'.

A separate commit bears the Clang plugin that I used to find these mismatches. You may or may not want this in your tree."
311377279,replaced hard-code url with devteam_url for junk mail message,andymule,2019-08-27 13:11:52+00:00,2019-09-15 08:37:33+00:00,{},"tiny, mostly meaningless fix. but it's a fix!"
310082880,Added missing period in unmul().,NullCGT,2019-08-22 18:18:51+00:00,2019-09-15 08:37:33+00:00,{},"Being resurrected while polymorphed produces an orphaned phrase. For example, a lifesaved player polymorphed into a lichen will see the following phrase in the middle of the message log:

> ""You are a lichen""

The orphaned message immediately runs into the next sentence, making events difficult to follow. This change simply fixes the typo by adding a period.

> ""You are a lichen."""
307021915,add a new option: autosave,ostrosablin,2019-08-13 18:19:54+00:00,,{},"This patch adds a new compound option: autosave (as proposed in GitHub
issue #208).

The idea behind patch is to allow artificially limiting game session
duration, by automatically saving-and-quitting after playing for N turns
(where N is argument of the option). This could be useful for public
servers, where *Robin accounts are used as a form of multiplayer and
players play for N turns, and then give control to another person.
Another use case is to use this option to just keep yourself from
playing too long game sessions (e.g. during coffee-break, etc.).

Option is specified like this:

OPTIONS=autosave:500

Which would save-and-quit after playing for 500 turns.

Defaults to -1 (autosave disabled). 0 is invalid value, because game
would then quit right after starting. Any positive value is used as turn
countdown, and when it reaches 0, game is saved and quit automatically.

Signed-off-by: Vitaly Ostrosablin <tmp6154@yandex.ru>"
299144855,"Fix typo in manpage, help text",cbracken,2019-07-19 00:50:53+00:00,2019-09-15 08:37:34+00:00,{},"Corrects ""at last"" to ""at least""."
295069567,phrasing clarification,G7Nation,2019-07-07 00:05:52+00:00,,{'3.6': 1},clarify message when a player displaces a monster
285723069,curses: Add nonl() call after raw() call.,ostrosablin,2019-06-06 09:42:08+00:00,2019-06-08 20:38:01+00:00,{},"Fixes #195

Various implementations of curses may deal differently with raw() call,
but unless explicitly requested with nonl() call, curses implementation
is not obliged to disable CR-to-LF mapping. NetHack already handles \r
in input very well and it's possible to use both \r and \n for prompts.

What's this useful for: When not in prompt, line feed (Ctrl+J) is also a
command for ""go down"". This can cause frustration and YASD, because if
you accidentally hit Enter or Ctrl+J, your character will run towards
bottom edge of map. However, if you will use Ctrl+M to answer the
prompts (or use `stty -icrnl` to make Enter default to carriage return),
this will work for prompts, but if you accidentally hit it while on map,
it will just yield:

Unknown command: ^M"
253688349,Better semantics for mintrinsics (and bug fix),copperwater,2019-02-17 05:12:07+00:00,2019-02-19 01:38:58+00:00,{},"This addresses a bug I found and wrote a report for, and then decided to
provide a fix for it along with the report. The bug consists of
monster intrinsics (resistances, such as from armor) being wiped when a
monster changes form, resulting in a monster that lacks the resistances
even though it is still wearing the armor that should confer them.

This addresses the problem by disentangling the two meanings that
mintrinsics was trying to cover: resistances granted by the monster
form, and resistances from other sources like armor. Now, mintrinsics
refers only to the second one.

The resists_* macros defined in mondata.h (which are what the game
always uses to check resistances, instead of directly reading
mintrinsics) have been changed to also check the permonst directly for
its resistances. Under this system, a monster will always have the
resistances that its form conveys (the same as before), while also being
able to gain resistances from other sources (the same as before). The
difference is that since the permonst no longer affects mintrinsics,
it's no longer possible to have bugs like this one.

This removes the mintrinsic updating code from set_mon_data, and
as such it makes it irrelevant whether set_mon_data is called with a
flag of 0 or 1. The only place it's ever actually _called_ with a flag
of 1 (which forced it to preserve the mintrinsics of the younger form as
well as taking on any new ones) is in grow_up(). Strictly speaking, this
new system won't preserve those younger form intrinsics, but I haven't
been able to locate any monsters in NetHack that lose resistances by
growing up, so I think it didn't actually matter in the first place."
252383033,Linux installation scripts,marceliwac,2019-02-12 16:27:06+00:00,2021-06-05 16:26:55+00:00,{},"Added the installation scripts for linux as discussed in #117 .

"
250253687,Update Makefile.ami,ethandicks,2019-02-05 01:11:40+00:00,2019-02-05 05:38:08+00:00,{},Added line continuations for dependency list for include/hack.h
242498263,Add hallucinatory trap names,copperwater,2019-01-06 14:47:25+00:00,2019-12-27 18:37:49+00:00,{},"This adds many funny, realistic, and nonsensical traps to the game, to be shown when the player is hallucinating. Started as a discussion on IRC, and it was evidently a pretty popular idea since a bunch of devteam members ended up tossing in names, so I thought I would write this up as a patch versus vanilla directly.

Architecturally, the biggest change is merging the what_trap macro and
the ""defsyms[trap_to_defsym(ttyp)].explanation"" pattern into a single
function ""trapname"", which returns the name of the trap, handling the
hallucination case. There is also a second parameter used for overriding
hallucination in the occasional cases where the actual trap name should
always be returned.

In addition, the what_trap and random_trap macros are now obsolete and
not used anywhere, so they are removed."
237333510,Autosearch implementation and game option,ghost,2018-12-10 14:11:16+00:00,2019-09-16 16:23:22+00:00,{},"* Default key binding for toggle: '%'
* 'multi' and 'save_cm' are used to queue a search command on walk.
* Autosearch will cost the player game turns which distinguishes it from intrinsic/extrinsic ""Searching""."
237135669,"Fix resurfacing of ""foxen"" pluralization bug",copperwater,2018-12-09 14:54:35+00:00,2018-12-09 21:37:53+00:00,{},"Inadvertently reintroduced in f9f1236. It was just the conditional
that was bad: due to resolving the possible buffer underflow when
comparing to ""muskox"", the pluralizer now only adds -es when the length
of the string is greater than 5. So for ""box"" and ""fox"" the pluralizer
will never add the -es ending, since they are greater than 5.

This commit checks for ""does not end in muskox"" correctly."
233358704,Always warn about encumbrance when removing items from BoH,suokko,2018-11-25 06:20:52+00:00,2018-11-26 05:38:02+00:00,{},"BoH applies rounding to total weight which means weight change for a
single object can't be known unless we count all other items in the bag.
Change determines correct rounding using weight() twice. First call
includes the item about to be removed and second call does see the item.

Fixes #153"
233354607,A few code simplifications to attribute handling,suokko,2018-11-25 03:58:37+00:00,2021-06-05 16:26:54+00:00,{},"I was reading the attribute code to understand how exactly training works. There was a couple of places that I tough could be simplified which makes it easier to read and improve algorithms in use. Changes keep functionally same except for attribute initialization where I considered _tryct_ as a bug instead of feature.

More details for each change can be found from commit messages.

I did only a few quick tests for each change.
- adjttrib changes were tested using a non-cursed tin of spinach, 20 cursed tins of spinach, amulet of magic breathing and two potion of restore ability. I tested restoring points after eating a tin works correctly. Then I tested raising the maximum with non-cursed spinach followed by cursed. Last I tested eating enough tins to go bellow three strength and restoring back to bellow earlier maximum.
- init_attr changes I checked with breakpoint inside the branch preventing going over the racial maximum attribute (I created three orc wizards). I didn't test redistribution branch (I don't even know how to trigger that branch with a few wizard mode turns.)
- role_abi changes was tested with a wizard and a _#levelchange_ to level 17. Wizard gained warning and teleport control like excepted."
232724398,Fixed scatter not updating the pile symbol.,NullCGT,2018-11-21 16:23:03+00:00,2018-11-25 05:37:53+00:00,{},"If you call scatter on a group of objects, the symbol for the pile is never actually updated, leading to an erroneous pile of objects on the screen that disappears as soon as the tile is updated. This pull request adds a call to newsym(), but only if the total number of objects scattered is greater than zero, thus fixing this bug."
224783353,Cygwin port,tslug,2018-10-22 19:15:28+00:00,2021-06-05 16:26:54+00:00,{},"I noticed people were having trouble getting nethack to compile under cygwin, so I added sys/cygwin to simplify this.  It permits playing inside a terminal emulator such as mintty instead of using a separate window.  It makes heavy use of the NewInstall-style sys/unix setup process to hopefully minimize the burden of maintaining cygwin-specific code.

Not sure I listed all the required cygwin packages in README.cygwin, so it would be great to get verification from someone else trying a build with a clean cygwin install to see if I missed anything."
221303525,Starting swap weapon bugfix,Chris-plus-alphanumericgibberish,2018-10-09 04:14:24+00:00,2018-10-14 16:37:17+00:00,{},"Starting swap weapon bug

If the character begins play with at least two weapons and a shield, whether or not they end up beginning play with a swap weapon equipped depends on the order in which the various items appear in their role's starting equipment list.

This bug does affect vanilla, it is why knights don't begin play with their lances equipped in the swap weapon slot."
218374398,fix out of bounds memory access,mp-t,2018-09-26 16:09:13+00:00,2018-09-27 04:37:22+00:00,{},Fixes [Issue 141](https://github.com/NetHack/NetHack/issues/141).
218176879,"Fix ""would flyif you weren't levitating"" - missing space",copperwater,2018-09-26 03:12:42+00:00,2018-09-26 08:40:17+00:00,{},
216837181,Grammar and punctuation fixes.,mogigoma,2018-09-20 03:50:29+00:00,2018-09-20 22:05:39+00:00,{},
216830116,Fix other spelling issues.,mogigoma,2018-09-20 02:51:50+00:00,2018-09-20 03:33:03+00:00,{},"Another slew of spelling corrections. These corrections come from going through the `doc` directory, but ignoring the `fixes*` files since those feel less 'timeless'. Propagated fixes for issues found in `doc` to rest of codebase where I felt it was appropriate. Tried to mitigate spacing changes that were caused.

This is the last of the 'obvious' and automate-able spelling fixes. Going to run some grammar checkers next to see if they can detect more subtle issues. Will try not to send lame fixes or ones that seem intentional (e.g., dialog choices)."
216824513,Correct Jon Wätte's name in many places to account for encoding.,mogigoma,2018-09-20 02:04:52+00:00,2018-09-20 03:33:37+00:00,{},"I noticed repeated references to `Jon W{tte` and variations of that in various places where credit was given (e.g., guidebook, copyrights). Grepping for `Jon W` showed me all of those references, in addition to two for `Jon Watte`. This seemed like an search-and-replace gone awry or a locale issue, but nothing in the Git history went back far enough. So I pulled down the source for 3.1.0 and found `Jon Watte` as expected, but also `Jon Wätte` (in LaTeX as `Jon W\""atte`).

This commit restores the name to its previous representation of `Jon Watte` in source code and other text files, and `Jon Wätte` in `Guidebook.tex`.

Note that the name `Janne Salmijärvi` is also represented outside of the ASCII (and Unicode) encoding in several places, but it isn't wacky the way Jon's name was.

(Disclaimer: I've never heard of any of these people, but I'm on a proofreading spree.)"
216790417,Fix spelling and capitalization issues in `dat` and `DEVEL`.,mogigoma,2018-09-19 22:03:54+00:00,2018-09-20 00:47:55+00:00,{},"These changes are all 'obviously wrong' to me. They don't occur in any stylistic or old-style dialect instances.

```
nicname         -> nickname
user-writeable  -> user-writable
legibile        -> legible
parenthese      -> parentheses
Satements       -> Statements
challanges      -> challenges
escae           -> escape
retrive         -> retrieve
flexs           -> flexes
entrace         -> entrance
```

This change was made in a heading and nearby, not every instance was changed in the codebase.

```
emacs -> Emacs
```

This change was made to make the usage consistent with the rest of the codebase, which uses the latter.

```
encumberance -> encumbrance
```"
216772219,Fix spelling mistake in README.,mogigoma,2018-09-19 20:50:10+00:00,2018-09-20 00:48:07+00:00,{},
214957277,Make monsters reassess equipment immediately after lifesaving.,NullCGT,2018-09-12 13:17:06+00:00,2018-09-15 04:37:18+00:00,{},"I implemented this a while back. If a monster uses an amulet of lifesaving, they never actually reassess their inventory. So a monster might be carrying three amulets of lifesaving, but never equip a new one after being killed the first time. This commit addresses this, at the cost of a single call to m_dowear() when a monster is lifesaved. This change also allows monsters who died due to disintegration to equip other items they might have."
214150336,Fix behavior of selection_do_grow,copperwater,2018-09-09 15:26:48+00:00,2018-09-21 04:38:01+00:00,{},"The function previously had two issues. First, the directional behavior
was reversed, so specifying a grow direction of ""north"" would actually
grow the selection downwards, etc. Second, the edge-of-map checks in the
function didn't actually correspond to isok() map boundaries, enabling
the function to, for instance, grow the selection into x=0, which could
break other things in the level. This commit fixes both.

The old behavior also was implemented with ""fanning-out"" behavior; that
is, a north grow from a single point would not only grow into the point
north of it, but it would also fan out into the points northwest and
northeast of it. Since this behavior might not always be wanted, I
removed it; the selection will only grow diagonally if it's specified to
grow in both adjacent cardinal directions. (I suppose this could
ultimately be added to the level compiler as a third argument to grow,
but I doubt there's a need for it right now.)"
213805629,Add makefile to build DOS version with a cross-compiler.,jwt27,2018-09-07 03:19:50+00:00,2021-06-05 16:26:54+00:00,{},"This makefile is based on the original one for DOS. I made some modifications so the utilities are built for the host system, and only the game for the target system. This file should be easier to maintain since it doesn't require any workarounds for short file names or the crippled default shell in MSDOS.
Parallel build doesn't work, but I guess that's no big deal. It's already a million times faster than building on a slow DOS machine."
213683141,Prevent 'Unknown command' from showing up in dumplog,k21971,2018-09-06 16:48:00+00:00,2018-09-06 17:37:34+00:00,{},"See this commit please - https://github.com/tnnt-devteam/tnnt/commit/0b8d2e464843eb23a062e133f5fb0b2c6ec4b53b
"
211613995,fix issue with wiz_identify and char unsigned,bobbydurrett,2018-08-29 03:00:40+00:00,2018-08-30 10:10:15+00:00,{},"I emailed the dev team about a problem I had with identify in wizard mode on the Raspberry Pi. If you press control-I twice in a row it is supposed to permanently identify the objects in your inventory. The first control-I shows the identified inventory but the second control-I does nothing and after you are done if you check the inventory the items you wanted to identify are still unidentified.

This issue is caused by the C compiler on the Raspberry Pi implementing the char type as unsigned. The wiz_identify code that was introduced in 3.6.0 assumes that char is signed. According to this Stackoverflow article there is no guarantee that char is signed in C:

https://stackoverflow.com/questions/2054939/is-char-signed-or-unsigned-by-default

Here are the lines in the 3.6.0 code that assume that char is signed:

line 2083 in invent.c:

        any.a_char = -1;

line 595 in cmd.c:

        if (display_inventory((char *) 0, TRUE) == -1)

On the Raspberry Pi with char being unsigned display_inventory((char *) 0, TRUE) returned 255 instead of -1.

This pull request just casts the output of display_inventory to a signed char and the 255 is converted back to -1 and the wiz_identify works. The dev team may choose to fix this another way. Maybe we could choose a different value besides -1 such as 127 which would be the same with signed or unsigned char types.

Bobby"
209298094,Elf Iron patch,brian-donovan,2018-08-18 06:43:19+00:00,2018-08-18 06:45:03+00:00,{},
207753422,Fix levl buffer overflow in wallify_map,copperwater,2018-08-11 02:30:42+00:00,2018-08-15 08:37:21+00:00,{},"Normally, wallify_map iterates through x and y coordinates on the map up
until (80,21) while looking for tiles to convert into walls, even though
column 80 and row 21 don't exist on the map.  This usually does nothing
bad, because position (79,20) is never a ROOM tile on any level where
WALLIFY is used.

However, if WALLIFY without arguments happens to be used on a map which
contains a ROOM tile at (79,20), such as a large open level containing
some rock formations that the programmer desires to wallify, then
wallify_map will write an HWALL into level.locations[80][21] (and
probably into a bunch of other nonexistent coordinates). These overflow
into the level.objects pointers, which results in segfaults when the
program tries to read them.

The fix is to add a check in wallify_map which causes it to ignore any
!isok() positions, which aren't on the map anyway."
203060003,Migrate MH_RACE flags to their own field in the permonst struct,NullCGT,2018-07-22 14:35:38+00:00,2018-09-12 23:38:47+00:00,{},"In monflag.h, there is a comment about possibly moving MH_HUMAN, MH_ELF, MH_DWARF, MH_GNOME, and MH_ORC to their own field, instead of having them mask the corresponding M2 bitflags. This pull request implements a race field. The changes are as follows:

1. There is now an ""mrace"" entry in the permonst struct in order to hold the monster race bitflags.
2. M2_HUMAN, M2_ELF, M2_DWARF, M2_GNOME, M2_ORC, M2_UNDEAD, M2_DEMON, M2_GIANT, and M2_WERE have been changed to mrace bitflags.
3. All monsters in monst.c have been retagged to support the new system, and artifacts now grant warning based on mrace instead of mflags2. All relevant references to one of the mentioned flags and mflags2 have been updated.

These changes have several distinct advantages:

1. Most importantly, the M2 bitflags now make more sense, since they are no longer a mix of races and monster features, and instead solely correspond to monster features.
2. Adding new races is now much easier, since it just involves adding another race bitflag and changing ROLE_RACEMASK.
3. There is now room for additional M2 bitflags, which were previously all filled.
4. These changes can be potentially expanded in the future to clean up some of the code in mondata.h. For example, an MH_FLAYER tag could be added in order to clean up the definiton for is_mind_flayer(ptr).
5. Having a separate monster race field allows for interesting changes to races that were not possible before without some sort of kludge, such as making all giants hostile to dwarves."
200869867,"proposed to link with -lncurses, not /usr/lib/libncurses.a",cxd4,2018-07-12 02:03:07+00:00,2019-10-03 00:37:29+00:00,{},"Following the instructions in `README.linux` to build the binary on Slackware 14.2 (i486) results in link-time failure.  The assumption of `libncurses.a` existing in `/usr/lib` does not appear to be a Linux-wide rule.

Following the original `-lncurses` suggestion specified in `Makefile.src` instead of trying to specify an absolute path to the library works perfectly.  I thought this change would prevent confusing anyone else on some distributions trying to build NetHack based on the `README.linux` instructions."
199085638,Antholes in .des files will not be filled,Chris-plus-alphanumericgibberish,2018-07-03 21:18:57+00:00,2018-07-04 04:37:28+00:00,{},"This is due to a missing case in the fill_zoo section of sp_lev.c

This bug is latent in NetHack, since no special levels include antholes."
199085236,Fix error leading to bad shopkeeper placement in some shops,Chris-plus-alphanumericgibberish,2018-07-03 21:16:56+00:00,2018-07-05 08:37:24+00:00,{},"Fix copy-paste error leading to bad shopkeeper placement in irregularly-shaped shops with the door at the top.

The last case from a set of 4 very similar if statements increments sx after testing sy. As a result, the shopkeeper is placed one space to the right of a north-facing door, instead of one space to the south (ie, the shopkeeper is placed in the wall next to the door, instead of behind it). As noted, this was pretty clearly a copy-paste error from the first pair of if statements, which do adjust the x coordinate.

This bug is latent in vanilla NetHack, because no levels include such a shop."
198555893,Fix copy-paste error causing bad shopkeeper placement in some shops,Chris-plus-alphanumericgibberish,2018-07-02 01:48:30+00:00,2018-07-03 21:15:53+00:00,{},"Fix copy-paste error leading to bad shopkeeper placement in irregularly-shaped shops with the door at the top.

The last case from a set of 4 very similar if statements increments sx after testing sy.  As a result, the shopkeeper is placed one space to the right of a north-facing door, instead of one space to the south (ie, the shopkeeper is placed in the wall next to the door, instead of behind it).  As noted, this was pretty clearly a copy-paste error from the first pair of if statements, which *do* adjust the x coordinate.

This bug is latent in vanilla NetHack, because no levels include such a shop."
190169160,"Build with Qt 5 on Linux, Windows and Mac OS X",chasonr,2018-05-24 04:50:11+00:00,2018-09-24 17:14:14+00:00,{},"This pull request provides needed changes to compile against Qt5 on Linux (my distribution is Fedora 28), Mac OS X and Win32.

For Mac, use the Qt 5 distribution from Homebrew.

For Win32, use the official Qt 5 installer. This comes with a MinGW distribution; the Makefile.GCC is tested against that distribution."
190149137,Changes to build for  MS-DOS,chasonr,2018-05-24 01:52:29+00:00,2018-11-14 13:38:59+00:00,{},"I build the MS-DOS version using FreeDOS in a VirtualBox VM, because DJGPP is painfully slow on DosBox. The changes presented here work around some FreeDOS quirks when running setup.bat.

Also, getreturn_enabled in sys/share/pcsys.c needs to be Win32-only, or the compile will fail."
189338732,Popeye sustain ability,rockola,2018-05-21 10:19:35+00:00,2018-07-11 04:37:22+00:00,{},"If the player is wearing a ring of sustain ability, eating spinach will not make strength go up. Does the player then feel like Popeye? I would think not. This patch will change the message to ""This makes you feel like Olive Oyl!"" (for female characters) or ""This makes you feel like Bluto!"" (for male characters)."
187081848,Fix number_pad bug,barthouse,2018-05-10 01:49:41+00:00,2018-11-22 14:46:36+00:00,{},"When we initialize command state, we initialize the state with the assumption that the number pad is on but we had not set Cmd.num_pad to TRUE."
186652338,Fix for bug H7132 - conflict between extra choice accelerator and menu accelerator,barthouse,2018-05-08 14:26:40+00:00,2018-05-10 04:37:24+00:00,{},"In nethackw, there can be conflicts between menu accelerators and an extra
choice accelerator.  For example, when engraving the using fingers options
conflicts with the unselect all menu accelerator.  The extra choice
accelerator should take precedence."
186506334,General cleanup for nttty.c,barthouse,2018-05-08 01:41:43+00:00,2018-05-19 00:40:47+00:00,{},
186395128,Introduced nhassert() macro to be used for assertions,barthouse,2018-05-07 16:09:24+00:00,2018-05-19 00:41:29+00:00,{},"Each port can decide to implement the macro as they see fit.  In the windows port, the macro is implemented for debug builds only.  When an assertion fails we generate a debug break point, when the debugger is present, and call error() to report the assertion failure.

Changes also include cleanup to mhdlg.c to use new macro and clean up some previously checked in debug code."
186229223,Implemented a fix to the lag problems that are happening with the Win32 console port,barthouse,2018-05-06 22:11:58+00:00,2018-05-19 00:42:22+00:00,{},The fix implements a console back buffer which significantly reduces the number of calls made to WriteConsoleOutputXXX and eliminates the lag users have been experiencing.
186194946,The following change addresses the recent lag issues with the Win32 console port,barthouse,2018-05-06 08:42:35+00:00,2018-05-06 22:05:30+00:00,{},
185684654,fix nonverbose CC on bsd make,lotheac,2018-05-03 11:17:52+00:00,2020-08-20 14:58:55+00:00,{},"Hi, attempting to build 3.6.1 on OpenBSD results in:

```
/tmp/NetHack/src 1 % CONFIG=simple-config GAMEDIR=lib/nethackdir-3.6.1 FILESDIR=/usr/ports/games/nethack/3.6/files make 
touch ../src/config.h-t
[CC] monst.c
[CC] objects.c
[CC] makedefs.c
Using $< in a non-suffix rule context is a GNUmake idiom (Makefile:268)
*** Error 2 in /tmp/NetHack/src (Makefile:643 '../util/makedefs')
```

This was introduced in 1ff4dfee854be09b14c434d49c1f5bf680554e7d. The simplest fix is to use $@ instead (printing ""foo.o"" instead of ""foo.c"")."
184667996,Specify both width and height when creating font for width testing.,barthouse,2018-04-27 16:20:09+00:00,2018-04-29 18:43:30+00:00,{},"When we are creating the console font for testing character widths, we were not specifying width.  Because of this, the created font's average width might be larger then what we expect and we might falsely detect that the font was inappropriate for playing Nethack.  Fix provides the width that we are expecting when creating the font."
184510786,Changed build to default to using latest SDK available on build machine,barthouse,2018-04-27 02:43:06+00:00,2018-04-28 16:43:51+00:00,{},"Modified build configuration to use latest SDK available by default.  This change will eliminate the need for us to hard code an SDK version into our configuration file and will eliminate the need for developers to set the SDK version when they do not have the matching SDK version installed.  Updated the Install.nt file removing the mention of having to set the SDK version.
"
184412398,Fix bug in really_close() which can cause standard input to be closed prematurely,barthouse,2018-04-26 17:31:53+00:00,2018-04-28 16:44:16+00:00,{},"Fix bug where user is unable to confirm exit.  If the user chooses to quit when prompted for player name to choose, then they will find that they can not confirm the exit by hitting the return key.  This is due to a bug in really_close() which mistakenly closes the file descriptor zero which is the input stream.  really_close() needs to test lftrack.init before it attempts to access and modify lftrack state."
179832746,Documentation for the level generation code,copperwater,2018-04-06 00:59:03+00:00,2021-06-05 16:28:13+00:00,{},"The level generation code is pretty poorly documented and a lot of functions lack any comments. Many of the important algorithms that shape the dungeon don't come with any explanation, and occasionally they do something unexpected or have some questionable code.

Since I'm planning on doing some work on level generation in the future and would otherwise be lost trying to figure out what everything does, I decided to go through the level generation code and add this documentation as a reference for me and anyone else wanting to work with it.

This pull request should consist of comments only; I may possibly have changed some indentation or added a brace somewhere, I can't remember, but none of the actual code is touched. (Though reading through it really makes one want to do several refactors.)

I don't consider this entirely complete yet; I haven't really touched sp_lev.c much, and I think there are some functions in mkmaze.c that I missed."
175336945,Allow user to add to the existing annotation,ostrosablin,2018-03-15 18:13:48+00:00,2019-05-21 04:00:32+00:00,{},"Often, it's more desirable to add to the current annotation, rather than replacing it completely. If you have some new piece of information you don't want to forget, naturally, you will probably add it to annotation.

If you add piece of information A into annotation, and then see B, you'll want to add it into annotation.
As it stands, you can only completely replace annotation, causing you to re-type both A and B. If you have even more information in annotation, it's even more tedious to maintain it.

This patch causes annotations to work similarly to engravings. If there's no annotation for current DLVL, annotation will be added as usual. But if annotation is already present, invoking #annotate will ask, whether you want to add to the existing annotation or replace it. Choosing to replace will work same way as it used to work, existing annotation is removed and new annotation is placed in it's place. If you choose to add to the current annotation, then resulting annotation will be a concatenation of existing annotation and newly typed piece of text (pretty much same way as it works for engravings).

Signed-off-by: Vitaly Ostrosablin <tmp6154@yandex.ru>"
174537310,There should be more stuff about ducks.,trevortomesh,2018-03-13 01:37:32+00:00,2018-03-13 01:38:18+00:00,{},I added a bit about ducks because there weren't ducks. DUCKS.
164958183,Add two famous engravings,spixi,2018-01-24 20:46:42+00:00,2019-05-21 20:57:14+00:00,{},I think they perfectly fit here.
161540260,Refactor getobj and add the ability to handle floor items/features to it,FredrIQ,2018-01-07 21:38:41+00:00,2021-01-07 20:42:07+00:00,{},"This pull request refactors getobj as to allow the selection of objects, or dungeon traps/features, from the floor. This is done by supplying a "","" reply when it asks for a letter. Doing so will pick the floor item/feature (if only one choice is valid) or give a list of items + feature, if there are multiple choices. '.' can also be selected, but it is merely an alias (it doesn't display as a valid option or similar), to allow for SLASH'EM muscle memory. If menulist is set to anything other than FULL, getobj prompts will work as they did earlier and prompt individually for each object or feature on the floor.

This code is not based on code from either SLASH'EM or NetHack4, but was created from scratch for 3.6.1. It works by, instead of having a list of object classes as a parameter for getobj, and having getobj special case basically every single case, use a callback for figuring out whether or not a choice is valid. The callback is an int, takes a normal object, NULL (for bare hands check) or &zeroobj (for dungeon feature/trap, if allow_floor is enabled), and returns 2 (valid option, and encouraged by being listed), 1 (possible choice, but not listed among choices or '?'), 0 (invalid).

This allows one to do away with all the special cases that surrounded getobj, meaning it only has the actual code for doing the logic in it.

Screenshots: http://home.fiq.se/nh/getobj.html"
160081977,Fix memory error by adding byte for null string terminator.,bobbydurrett,2017-12-26 04:17:57+00:00,2018-02-21 02:54:31+00:00,{},"Line 95 in mail.c introduced a bug by allocating one byte less than was needed.
The call to alloc was supposed to get enough bytes to hold a string but it
used strlen() to get the number of bytes. We should have allocated strlen()+1.
This didn't cause an error on Linux on x86-64 but it showed up on the
Raspberry Pi platform."
152082131,Implemented window port options scr_tile_width and scr_tile_heigt for Windows GUI.,barthouse,2017-11-12 00:32:56+00:00,2020-08-18 14:51:11+00:00,{},
148519820,Mistake - wrong repos,ghost,2017-10-24 21:38:06+00:00,2017-10-24 21:38:25+00:00,{},
148019846,Add configuration for Qt 5,chasonr,2017-10-22 23:42:10+00:00,2018-04-30 00:12:14+00:00,{},"I called the directory Qt4, but the source code also compiles with Qt 5, with a little help from the preprocessor.

With Qt 5, at least on Fedora 26, the needed packages are Qt5Gui Qt5Widgets Qt5Multimedia, the MOC is moc-qt5 and the source must be compiled with -fPIC. The linker complains if you don't use -fPIC.

This change adjusts sys/unix/hints/linux-qt4 to provide the variables QTGUI and MOC, with an alternate configuration for Qt 5, and adjusts sys/unix/Makefile.src to accept these variables."
147961948,WIN32 CONSOLE: Detect when the current console font has glyphs that are too wide,barthouse,2017-10-21 20:44:32+00:00,2017-10-25 08:05:21+00:00,{},"For Win32 console (NetHack.exe), added support to detect when the current console font has glyphs that are too wide and will cause rendering errors in the console.  If detected, we warn the user and change the code page to 437 and the font to Consolas.  At exit, if we had changed the font and code page then we will restore to the original font and code page.

NOTE: the warning is given using raw_print().  Currently, raw_print messages are lost when we transition to displaying game windows.  We need another pull request (#57) to be completed in order for this warning to show up properly.  This will need to be tested.
"
146629301,Changes to player selection dialog.,barthouse,2017-10-15 01:22:29+00:00,2017-10-25 07:52:19+00:00,{},Significant changes to player selection dialog that attempt to match recently made changes to the Qt and X11 window ports.
145533019,Clear selection count when reverting back to permanent inventory view.,barthouse,2017-10-09 19:47:44+00:00,2017-10-09 20:34:18+00:00,{},We need to clear selection counts after the permanent inventory window was used to select items.
145388365,Attempt to open defaults.nh from HACKDIR if not found for WIN32.,barthouse,2017-10-09 07:34:03+00:00,2017-10-11 01:52:15+00:00,{},
145372742,Use a back buffer for all status rendering eliminating all flickering.,barthouse,2017-10-09 04:24:32+00:00,2017-10-09 18:03:15+00:00,{},"We are still getting some flickering of the status window.  There are two sources of the flickering.  The first is due to the setting of a background brush in the status window class.  This cause the window to be filled with the background color when BeginPaint() is called.  Because there is a gap between the fill and the eventual rendering of the status text, the desktop compositor can catch the front buffer in this intermediate state and thus causing a flicker.  The second is once again small gaps between when text is filled with the background color and the text is rendered.  This gap is smaller and is within the DrawText call itself.  This can only be eliminated through the use of back buffer rendering.

We now maintain a back buffer or all rendering.  We render the entire status window into a back buffer and this back buffer is copied to the front buffer in a single BitBlt() operation.  This eliminates the flicker as the desktop compositor will now only see a fully coherent front buffer."
145361812,Fix bug with handling of hilite color NO_COLOR,barthouse,2017-10-09 00:43:00+00:00,2017-10-09 11:58:26+00:00,{},"If a status hilite color is set to NO_COLOR, we will map this color to white (0xffffff) instead of using default foreground color of status window.  This can cause the unexpected result of drawing white text on white in the case that the user has set their status window background to white.

Made a change to the background brush of the main window to be black.  The main window background color is used when we are hiding/showing child windows.  This is a better choice given that the map window's background brush is black.  In the case that all window backgrounds have been set to black, this gives a pleasing consistent user experience without any flashes of white."
145352527,MKoT change -- detect unseen.,FredrIQ,2017-10-08 20:46:24+00:00,2021-06-05 16:28:12+00:00,{},"Also, make detect unseen take a range parameter. This is BOLT_LIM
(same effect as previously) with the following exceptions:
* Master Key of Thievery has range 4 (cursed), 8 (uncursed),
  16 (blessed). Doubled if you're a Rogue.
* ^E wizard mode command will find secrets on the entire level

Done as a response to the TODO on 5c77360023f84a9a709f52fac10cf43fd3167d5f."
145309034,Fix permanent inventory window going away after pick item(s) operations.,barthouse,2017-10-07 21:10:36+00:00,2017-10-07 22:26:58+00:00,{},"In the windows GUI when permanent inventory is being used, there is an annoying bug where any command that uses the inventory window to pick an item (or items) will cause the inventory window to become hidden requiring the user to use 'i' to redisplay the inventory.

Another side effect of this problem is that a jarring white empty space is created if the user happens to be using window backgrounds other then white (such as black).

This fix is in two parts.  First, we don't hide the permanent inventory window when destroying its as a popup.  Second, after a pick operation where we just used the permanent inventory window we restore the proper display state of the inventory window (pick type NONE and no prompt).
"
145301707,Report Windows GUI WC2_HILITE_STATUS support avoiding raw_print on starutp.,barthouse,2017-10-07 17:54:03+00:00,2017-10-07 22:57:33+00:00,{},
145272768,Fix problem with defaults.nh not being found when debugging within VS IDE,barthouse,2017-10-07 02:00:42+00:00,2017-10-07 12:58:03+00:00,{},"When debugging using the Visual Studio IDE, by default the working directory is the project directory.
Because of this, both NetHack and NetHackW will fail to find defaults.nh.  This change simply changes
the default working directory to $BinDir allowing defaults.nh to be found along side the executable."
144892250,Minor tweaks to Cleaver behaviour,FredrIQ,2017-10-05 11:37:15+00:00,2021-06-05 16:28:12+00:00,{},"Most importantly, the player will no longer attack peacefuls in an arc without a confirmation."
144334556,Improve the handling of rawprint messages,barthouse,2017-10-03 04:31:18+00:00,2017-10-25 07:46:42+00:00,{},"There are several improvements in this pull request.  In particular if during program initialization you encounter problems causing multiple raw_print messages, all the messages will be displayed in a single dialog instead of getting a series of individual message dialogs for each raw_print message.

Fixed an undetected problem with building NetHack where we were defining MSWIN_GRAPHICS.

Implemented a mechanism for dynamically growing a string.  Leveraged this mechanism to reduce code complexity of splash window code.
"
144162322,Fix pet AI not following hero as intended,FredrIQ,2017-10-02 11:29:40+00:00,2017-11-02 10:18:01+00:00,{},"Done by cutting down (but not eliminating) use of mtrack:
* Not used for leashed pets
* Not used if <=5 tiles from hero
* Also, tin whistles now clear the mtrack record."
144051500,Fix flashing issue that is seen with STATUS_HILITES in Windows port.,barthouse,2017-10-01 01:20:47+00:00,2017-10-01 11:32:23+00:00,{},"Without this change, tty_status_update() will end up calling putstr() multiple times for the same status line which in turn will cause tty_putstr() to call cl_end() multiple times per status update.  On the Windows port, each call into cl_end() will cause us to immediately call into the console interface.  Since we end up calling cl_end() a couple dozen times for a status update, this causes a noticeable flash flash in the status area.

There are various ways to address this but chose this approach given the various trade offs with other approaches.

"
143030641,Dieroll fix,barthouse,2017-09-26 03:27:14+00:00,2017-10-01 11:45:56+00:00,{},"In uhitm.c, we keep a module level static value **dieroll** which is used in various spots in the module.

Because the general damage monster routine **hmon()** can get called from outside uhitm.c, we can call into **hmon()** without actually changing the value of **dieroll**. **Hmon**() in turn calls **hmon_hitmon**() which in turn uses **dierol**” for some decision making including calling **artifact_hit**() passing **dieroll**.

So, if you have a vorpal blade and you happen to chop a monsters head off (meaning that you have a **dieroll** of 1) you can then proceed to throw the vorpal blade at other monsters and assuming you hit, you will be guaranteed to chop off the monsters head since **dieroll** will not change when throwing weapons. (**dieroll** stored in uhitm.c, only changes on certain attacks).

Not that throwing vorpal blades makes a lot of sense …. But demonstrates the bug.
"
142804084,Addressing bug with the use of static dieroll in uhitm.c.,barthouse,2017-09-25 06:28:26+00:00,2017-10-01 11:46:46+00:00,{},"In uhitm.c, we keep a module level static value “dieroll” which is used in various spots in the module.

Because the general “damage monster” routine hmon() can get called from outside uhitm.c, we can call into hmon() without actually changing the value of “dieroll”.  Hmon() in turn calls hmon_hitmon() which in turn uses “dieroll” for some decision making including calling artifact_hit() passing “dieroll”.

So, if you have a vorpal blade and you happen to chop a monsters head off (meaning that you have a “dieroll” of 1) you can then proceed to throw the vorpal blade at other monsters and assuming you hit, you will be guaranteed to chop off the monsters head since “dieroll” will not change when throwing weapons.  (“dieroll” stored in uhitm.c, only changes on certain attacks).

Not that throwing vorpal blades makes a lot of sense …. But demonstrates the bug.

This changes does beg the question in a couple of spots as to what dieroll should we use when we are dropping objects on monsters in stuck traps and when throwing cream pies."
142686752,Improved readability on a few lines of code throughout detect.c,David-M-Nielsen,2017-09-22 23:19:15+00:00,2018-02-19 08:05:07+00:00,{},"Hello there! 

I did a quick lookover of detect.c in response to issue #38 and reformatted a few lines of code, as you can see. I hope the maintainers will let this trivial fix be my first contrib."
142612885,Changes to support game engine reentrancy.,barthouse,2017-09-22 15:55:45+00:00,2018-05-19 00:44:27+00:00,{},Created this pull request to allow devteam to review approach.  Like to get feedback on general approach.  Very likely we will need to tweak this before accepting.
141235577,Window ports NetHack and NetHackW changed to use a common engine.dll,barthouse,2017-09-15 06:13:43+00:00,2017-09-16 21:55:29+00:00,{},
140664701,Delete swap file,eyqs,2017-09-12 19:33:49+00:00,2018-03-12 08:15:46+00:00,{},
139208394,Improvements to build.bat scripts used in Windows builds.  Removed CRT warnings.,barthouse,2017-09-04 20:42:58+00:00,2017-09-05 10:14:57+00:00,{},
139035093,Added build support for Visual Studio 2017,barthouse,2017-09-03 04:15:34+00:00,2017-09-04 09:58:16+00:00,{},
139026751,Fix crash that occurs when closing application window while invetory is being displayed,barthouse,2017-09-02 21:17:56+00:00,2017-09-04 09:53:39+00:00,{},
139025080,Fix warnings in windows build.,barthouse,2017-09-02 20:17:56+00:00,2017-09-04 09:49:00+00:00,{},
136611298,Use iterative defines instead of absolute defines in skills.h,bosporos,2017-08-19 15:39:51+00:00,2017-10-07 14:22:03+00:00,{},
135436218,Quiet warnings generated by -Wcomma in Xcode 9 beta 5.,MaddTheSane,2017-08-11 23:35:01+00:00,2021-06-05 16:28:12+00:00,{},Note that there are a few in `for` loops that may be harder to quiet.
127418504,"Proper form of ""cannot"" with ""thou""",sebschmied,2017-06-26 08:14:01+00:00,2017-11-21 09:03:32+00:00,{},"When angered in sanctum or astral plane, your deity booms out:
**Thou cannot escape my wrath, mortal!** 
This is not in line with other god messages. They all use the 2nd singular except this one.

I suggest replacing it with
**Thou canst not escape my wrath, mortal!**


Shakespearean examples:
""Thou canst not speak of that thou dost not feel."" - Romeo and Juliet 3:3
""Thou canst not say I did it"" - Macbeth 3:4

This has bugged me since I first ~~reached the astral plane and angered my god~~ read the code."
120468654,Add several missing entries to the encyclopedia,copperwater,2017-05-14 00:55:01+00:00,2018-09-20 08:38:44+00:00,{},"This makes several edits to the encyclopedia, mostly for some entries that aren't already in there.
* Horned and barbed devils are merged since the descriptions are the same.
* Spotted jelly is the same passage as blue jelly, since the passage is more about their immobility than blue jelly specifically.
* Clay golem is the opening passage from Feet of Clay rather than the generic golem text.
* Ochre jelly and invisible stalker are given descriptions from D&D.
* Trident is the same passage as Poseidon.
* Water troll is given the paragraph from The Colour of Magic describing a water troll."
119292951,Achievement recording fixes,NHTangles,2017-05-06 09:07:43+00:00,2017-11-14 02:16:43+00:00,{},"This properly fixes the issues with mines and soko achievement recording, as follows:
1. record_achieve_special is mapped to corpsenm, which has a default value of -1.  Setting to 1 on the prize item and then checking for nonzero will always mark the achievement (current workaround is to also check the level at pickup time, but this has other issues outlined below).
2. only checking level and otyp when setting record_achieve_special opens the possibility that a random luckstone may be generated at mine-end, and this may be interpreted as the prize (this has possibly happened though it's hard to be conclusive as monsters pick things up and move them)
3. checking the level at pickup time is problematic if a monster picks up the prize and takes it to another level before the hero gets his hands on it (cases of this have been recorded)."
112758803,Livelog,NHTangles,2017-03-27 14:30:56+00:00,2021-06-05 16:28:11+00:00,{},"This is an improved version of the previous livelog submission, and is now in use on hardfought.org.
"
106741324,Add hint file for tty/x11 linux build,nikolas,2017-02-17 14:19:40+00:00,2020-08-18 14:57:45+00:00,{},"This is a hint file that builds a version of NetHack that can use both
tty and X11 window modes."
106735063,spelling fix: configruation -> configuration,nikolas,2017-02-17 13:42:51+00:00,2018-09-20 03:36:43+00:00,{},
104655378,Live logging,NHTangles,2017-02-04 09:19:57+00:00,2017-03-27 12:58:18+00:00,{},"Live logging patch as discussed on #nethack-dev over the last few days.

1. Pulled livelog_write_string(), etc from 3.4.3-nao patch set.
1a. Changed the livelog separator from ':' to '\t' for consistency with xlogfile.
2. Added sysconf option to control what types of messages (if any) to log, and introduced livelog types, which are passed as an additional arg to livelog_write_string(), and compared to the sysconf-configured types to determine whether or not to actually log the message.
3. Added LIVELOG_ENABLE to config.h to allow enable/disable at compile time.
4. Added livelog_printf() as a wrapper to livelog_write_string(), which does the obvious.
5. Added code to actually log messages as per 3.4.3-nao livelogging, and also achievements, unique kills, sacrifice gifts, crownings, broken conducts (there are a lot of these), and new levels.

Please consider :)
"
98758889,Added Tony the Tiger message on food that is not a corpse.,bobbydurrett,2016-12-20 14:32:19+00:00,2021-06-05 16:28:11+00:00,{},Modify eat.c so that Tony the Tiger message comes out when a player polymorphed into a tiger and hallucinating eats yummy food such as a meatball. This message already came out when a hallucinating tiger player ate yummy corpses such as an orc corpse.
98288699,Allow #exploremode to still be used by player name even if pw is null.,jackbunny,2016-12-16 07:17:50+00:00,2019-10-07 04:37:25+00:00,{},I hit a problem using explore mode on my private server. For whatever reason (possibly my configuration) pw was always null and so I could never activate explore mode after starting a game. This moves the check for using the player name to be before the check for if pw is null.
91517760,docs fixup,ericherman,2016-10-30 10:43:05+00:00,2018-03-25 14:28:06+00:00,{},"git repository location in DEVEL/Developer.txt didn't match README

 (also the ascii art is now correctly aligned)
"
86071919,Fix ascii art in DEVEL/Developer.txt,moon-chilled,2016-09-20 23:04:42+00:00,2018-04-29 18:45:20+00:00,{},"The top line was aligned wrong, and there was a bunch of extraneous white space.  Not that big of a deal, just a small enhancement. 
"
80150635,fix typo in dat/tribute: belive -> believe,nikolas,2016-08-04 21:12:27+00:00,2016-08-22 06:29:04+00:00,{},
80145976,fix typo in comment,nikolas,2016-08-04 20:41:03+00:00,2018-09-20 03:41:21+00:00,{},
75829551,Nethack 3.6.0.vs2015,barthouse,2016-06-30 14:30:35+00:00,2016-12-31 22:03:33+00:00,{},"This introduces a new method for building and running NetHack on Windows.  This method only requires opening a solution file, building and running.  This method is a significant improvement over the currently supported methods.

This change is generally only adding new project files to the repository with one exception.  When building with Visual Studio 2015 and the latest SDK, we now are running into a name conflict with the C standard runtime.  To avoid this conflict, terminate() was renamed nethack_terminate().
"
75814689,Nethack 3.6.0.ctype fixes,barthouse,2016-06-30 12:58:51+00:00,2016-12-25 09:02:23+00:00,{},"This fixes a problem with the use of ctype utility functions (e.g. isspace).  The ctype utility functions take an integer and expect them to be in a range of -1 to 255.  If the input is out of range, the ctype library will assert in debug builds of NetHack.  If we call a utility function with a signed char then we risk hitting this assert for extended characters.  All calls to the ctype functions must ensure the argument passed is a uchar to avoid passing in a value that is out of range due to sign extension.

A 100% repro example of this problem can be found by the following:
1. change your language settings to English UK allowing the entry of extended characters (like British pound)
2. Launch new game of nethack with pet using debug version
3. Name pet whose name starts with extended character followed by maximum number of other characters (no spaces)
4. Name item in inventory same as pet
5. Drop named item
6. Move one space and wait for pet to pick up item
7. When pet picks up item, you will assertion in update_topl() when calling isspace().

You can contact me at bart@barthouse.com.
"
73457722,Fix screen resize with Linux tty,bobbydurrett,2016-06-11 03:55:59+00:00,2018-03-03 19:41:04+00:00,{},"This fixes the issue that I emailed the devteam about where the screen does not resize properly on NAO. In my own Linux environment I found that the screen resize worked if the SVR4 flag was set in unixconf.h and did not without it. I tracked this down to line 68 of ioctl.c. If SVR4 is set then USE_WIN_IOCTL is set and this enables the resize of the screen. My fix was just to add LINUX as one of the flags checked so you don't have to rely on SVR4 being set when it wouldn't really make sense. I tested this on Oracle Enterprise Linux 6.8 (Redhat 6.8) 32 bit.
"
72654541,Fix crash with MAIL env variable,bobbydurrett,2016-06-06 04:15:52+00:00,2016-06-18 17:40:55+00:00,{},"This fix to mail.c prevents a core dump in free_maildata. I had the MAIL environment variable set to the path for my mailbox and whenever nethack exited it coredumped in free_maildata. Evidently the pointer being passed to free was not pointing to memory allocated in the heap. So, I modified the code to allocate a string off the heap for the mailbox path if this path came from an environment variable.

This issue was probably caused by the free mailbox at exit commit 3b38c75517846742000082f1f465d405f79c3983. This commit added code to free the mailbox memory but introduced a core dump because when an environment variable is set nh doesn't allocate memory off the heap.
"
72083230,doc: fix typo in fixes36.1 document,nikolas,2016-05-31 20:48:51+00:00,2018-04-29 18:45:42+00:00,{},
66553808,Change flag::sortloot to xchar,MaddTheSane,2016-04-14 21:05:51+00:00,2016-04-15 08:37:09+00:00,{},"When typedefed to C99's bool type, Clang complains in container_contents about ""comparison of constant 108 with expression of type 'boolean' (aka 'bool') is always false"".
"
65026149,Use rn2() instead of Rand() for selection_do_randline(),tung,2016-04-02 02:58:52+00:00,2016-04-13 08:37:16+00:00,{},"That is, use NetHack's RNG instead of the direct system RNG.  This fixes maps generated with randlines to interact correctly with potential future RNG system changes e.g. switching PRNG algorithms, supporting NAO343's RNG reseeding, and even supporting replays like NetHack 4.

Based on DynaHack commit e464f63 (lev_comp: Fix system RNG use in randline) by me.
"
63485852,Fix panic when picking up object,bobbydurrett,2016-03-20 03:31:51+00:00,2016-04-13 19:57:15+00:00,{},"The new sortloop code was not properly updating the
head of the list that pointed to objects at a
location on the floor. Modified the code to pass
a pointer the where the head of the list is
stored.
"
63191337,Full text scrolling for TTY text windows,tung,2016-03-17 09:06:42+00:00,2021-06-05 16:28:11+00:00,{},"Up until now, TTY text windows could only be scrolled forward, which is really inconvenient when reading anything longer than a single screen.

This new change allows the standard menu scrolling keys (`^` first page, `|` last page, `<` previous page and `>` next page) to work in TTY text windows, enabling e.g. message history and long-form documentation to be scrolled backwards and forwards.
"
63190892,TTY menu enhancements,tung,2016-03-17 09:02:22+00:00,2016-04-13 08:37:16+00:00,{},"Two minor improvements to TTY menus:
1. Stop `>` from closing TTY menus if the menu is scrolled to the last page (it can still be dismissed like this if space is used). This makes scrolling with `<` and `>` safe from the risk of accidentally closing menus.
2. Omit the ""a - "" part of ""a - whatever"" from menu coloring, to match NAO343.
"
63190617,attack_mode: enhanced alternative to confirm option,tung,2016-03-17 08:59:39+00:00,2021-06-05 16:28:11+00:00,{},"This option controls what happens when attempting to attack monsters.  The possible values are:
- p - `pacifist`: don't fight anything
- c - `chat`: chat with peaceful monsters, fight hostiles (default)
- a - `ask`: ask to fight peaceful monsters, fight hostiles
- f - `fightall`: fight peaceful and hostile monsters without asking

`attack_mode` replaces the old `confirm` option; `attack_mode:a` is equivalent to `confirm`, while `attack_mode:f` is equivalent to `noconfirm`.

`attack_mode:c` essentially waits a turn when the player bumps into a peaceful monster.  Note that it does NOT trigger the donation prompt of aligned priests.  Players can still accidentally hit peaceful monsters if they move into an 'I' and a peaceful monster is hiding underneath.

`attack_mode:p` avoids attacking any monsters knowingly.

Both pacifist and chat are overridden by stunning / confusion / hallucination, and by Stormbringer, correctly accounting for its override flag in the attack logic.

`attack_mode:c` should cut down on annoying prompt spam near peacefuls for most players, while `attack_mode:p` should be especially welcome to pacifist conduct players.
"
62629133,ANSI-fying,MaddTheSane,2016-03-12 03:04:13+00:00,2019-12-07 20:11:36+00:00,{},"This moves NetHack away from K&R to ANSI C calling conventions.
"
62508332,Fix billing/credit when hero nests their containers on a shop floor,tung,2016-03-11 07:49:53+00:00,2016-04-13 08:37:16+00:00,{},"This fixes a bug where the hero could accidentally donate the contents of their bag to a shopkeeper if they put it in another bag on the shop floor that also belonged to the hero.  To reproduce:
1. Drop a sack on the floor, but don't sell it.
2. Get another sack and put in hero-owned objects.
3. Put the sack with objects into the sack on the shop floor.
4. Take out the sack with the objects from the sack on the shop floor.

The shopkeeper will claim you owe them for the objects in the sack, and view the contents of the sack will show them as belonging to the shopkeeper.

In fixing this, this also fixes `SELL_DONTSELL` to do what it's supposed to for containers and contained gold.
"
62508169,Fix paid object on bill when angering another shopkeeper,tung,2016-03-11 07:47:44+00:00,2016-04-13 08:37:15+00:00,{},"To test:
1. Get a level layout with two shops facing each other, e.g. minetn-4.
2. Sell a fragile object to one of the shops.
3. Dig a pit in the other shop's door space so its shopkeeper stays out of the way.
4. Pick up an object in that other shop so it appears on your bill.
5. Zap a wand of striking at the first shop to break the fragile object.
6. 'p'ay for the object picked up.

Expected result: Object gets the standard prompt to pay for it.

Actual result: ""Paid object on bill??"" followed by ""Program in disorder perhaps you'd better #quit."" followed by the object being given to the player for free.

The cause?  This comment going all the way back to 2002:

```
/* FIXME: object handling should be limited to
   items which are on this particular shk's bill */
```

Originally reported by PaRaD0xx in FreeNode's #NetHack IRC channel whilst playing NAO343.

Based on DynaHack commit d995ed1 (Fix paid object on bill when angering another shkp) by me.
"
62507935,Fix Wizard of Yendor stealing quest artifacts,tung,2016-03-11 07:44:32+00:00,2021-06-05 16:28:10+00:00,{},"This removes the biggest reason that players neglect to use their role's quest artifact.  Players can now take advantage of their quest artifact's unique properties and abilities without the downside of losing it after waking Rodney, increasing the uniqueness of different roles.

Quest nemeses are still able to steal quest artifacts.
"
62507889,map_coloring: L's Coloured Walls and Floor v1 patch (adapted),tung,2016-03-11 07:43:47+00:00,2021-06-05 16:28:10+00:00,{},"This implements the Coloured Walls and Floor v1 patch by L (Leon Arnott):
- http://bilious.alt.org/?296
- http://l.j-factor.com/nethack/glyphcolor.diff

This recolors various features of the dungeon:
- Walls of the Wizard's Tower are magenta.
- Other walls in Gehennom (except the Valley) are red.
- Walls of the Gnomish Mines are brown, except for room walls.
- Walls of the Astral Plane are white.
- Altars are bright blue / gray / black / red depending on alignment, except on the Astral Plane, where they are all bright magenta.

This new feature can be toggled with the new `map_coloring` option (default on).

Compared to the original patch:
- The original patch had no option and was thus unconditional.
- Floors are no longer colored, since it looks ugly.
- Walls of Sokoban are bright blue.
- The Valley of the Dead is no longer grayscale, since it would be an interface screw.
- Beehives are not colored, since it interacts poorly with the way special rooms are handled.
- Lawful altars were white in the patch, but bright blue here, since white and gray are hard to distinguish.
- Room preservation has been adapted for the new level compiler.
- One of the tiny closets in Grotto Town is fixed to be colored as room wall instead of mine wall.
- Orc Town area is considered rooms instead of mine wall.
"
62507830,Fix travel moving player back and forth infinitely,tung,2016-03-11 07:42:46+00:00,2016-05-28 06:55:37+00:00,{},"This fixes a bug where hundreds of turns are wasted by the travel system moving the player back and forth when the player targets an unreachable space and sight-blocking obstacles occur in certain formations in-between.  The player will only be stopped if they're interrupted externally, e.g. growing hungry or being hit by a monster.  See the comment in the code for full details.

Based on DynaHack commit 02da53e (Fix travel moving player back and forth repeatedly) by me.
"
62507746,Fix C343-415: Mail daemons can be created when populating special levels with demons,tung,2016-03-11 07:41:38+00:00,2021-06-05 16:28:10+00:00,{},"The root cause of this was that special level creation was deliberately ignoring the `G_NOGEN` flag when making monsters by class, so a random `&` could create a mail daemon.

The mail daemon case had already been patched by commit 9e7df53b (spurious mail daemons (trunk only)), but further testing revealed that this bug also caused:
- `r` monsters creating wererats (animal form) in the Healer quest
- `S` monsters creating water moccasins in the Archaeologist quest and Medusa's Island levels
- `&` monsters creating water demons

... all of which are flagged `G_NOGEN` and thus were not supposed to be generated randomly.

The only reason that the special level system was ignoring `G_NOGEN` was to allow creation of random `;` (eel class) monsters which are all flagged `G_NOGEN`.  This fix replaces both that approach and the previous mail-daemon-only work-around patch by auto-detecting this condition and only relaxing the `G_NOGEN` restriction if it applies to the whole class of monsters requested; currently, only `S_EEL` and `S_KOP` fulfill this condition.

Incidentally, this is the same fix that prevents random chromatic dragons from spawning when special levels request random 'D' monsters in DynaHack (chromatic dragons are regular monsters in that variant).

Based on DynaHack commit b1532ff (Fix C343-415: Mail daemons can be created when populating special levels with demons) by me.
"
62216547,Remove unreachable break statements.,UniQP,2016-03-09 11:44:17+00:00,2016-04-13 08:37:15+00:00,{},
62205201,Return computed result instead of constant.,UniQP,2016-03-09 10:08:51+00:00,2016-04-13 08:37:15+00:00,{},"I did not tested the change (do not know how) but either ""result"" is unused or it should be returned. The patch tackles the latter case.
"
62204996,Remove unused variable.,UniQP,2016-03-09 10:07:18+00:00,2016-04-13 08:37:15+00:00,{},
